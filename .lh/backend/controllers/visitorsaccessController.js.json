{
    "sourceFile": "backend/controllers/visitorsaccessController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763866906427,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763867281466,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -138,4 +138,26 @@\n     console.error(\"❌ Error fetching visitor by ID:\", err);\n     res.status(500).json({ success: false, message: \"Server error\" });\n   }\n };\n+\n+// ================================\n+// ✅ Fetch visitor requests (all requests)\n+// For routes like GET /api/visitors/requests\n+// ================================\n+export const getVisitorRequests = async (req, res) => {\n+  try {\n+    const pool = await connectDB();\n+    const result = await pool.request()\n+      .query(`\n+        SELECT v.VisitorID, v.VisitorName, v.ResidentID, r.ResidentName, v.DateOfVisit, v.Status, v.CreatedAt\n+        FROM Visitors v\n+        JOIN Residents r ON v.ResidentID = r.ResidentID\n+        ORDER BY v.CreatedAt DESC\n+      `);\n+\n+    res.status(200).json(result.recordset);\n+  } catch (err) {\n+    console.error(\"❌ Error fetching visitor requests:\", err);\n+    res.status(500).json({ success: false, message: \"Server error fetching visitor requests\" });\n+  }\n+};\n"
                },
                {
                    "date": 1763867779281,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -140,10 +140,10 @@\n   }\n };\n \n // ================================\n-// ✅ Fetch visitor requests (all requests)\n-// For routes like GET /api/visitors/requests\n+// ✅ Fetch visitor requests (all requests for admin/security)\n+// Route: GET /api/visitors/requests\n // ================================\n export const getVisitorRequests = async (req, res) => {\n   try {\n     const pool = await connectDB();\n"
                }
            ],
            "date": 1763866906427,
            "name": "Commit-0",
            "content": "// ================================\n// controllers/visitorController.js\n// ================================\n\nimport sql from \"mssql\";\nimport { connectDB } from \"../config/db.js\";\n\n// ================================\n// ✅ Register one or multiple visitors\n// ================================\nexport const registerVisitors = async (req, res) => {\n  const { ResidentID, ResidentName, visitors } = req.body;\n\n  if (!ResidentID || !ResidentName || !Array.isArray(visitors) || visitors.length === 0) {\n    return res.status(400).json({ success: false, message: \"Missing or invalid data\" });\n  }\n\n  try {\n    const pool = await connectDB();\n\n    for (const v of visitors) {\n      await pool.request()\n        .input(\"ResidentID\", sql.Int, ResidentID)\n        .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n        .input(\"VisitorName\", sql.NVarChar(100), v.VisitorName)\n        .input(\"NationalID\", sql.NVarChar(50), v.NationalID || null)\n        .input(\"PhoneNumber\", sql.NVarChar(20), v.PhoneNumber || null)\n        .input(\"VehicleNumber\", sql.NVarChar(20), v.VehicleNumber || null)\n        .input(\"Purpose\", sql.NVarChar(200), v.Purpose || null)\n        .input(\"DateOfVisit\", sql.Date, v.DateOfVisit || new Date())\n        .query(`\n          INSERT INTO Visitors (\n            ResidentID, ResidentName, VisitorName, NationalID,\n            PhoneNumber, VehicleNumber, Purpose, DateOfVisit, CreatedAt\n          )\n          VALUES (\n            @ResidentID, @ResidentName, @VisitorName, @NationalID,\n            @PhoneNumber, @VehicleNumber, @Purpose, @DateOfVisit, GETDATE()\n          )\n        `);\n    }\n\n    res.json({ success: true, message: \"✅ Visitors registered successfully!\" });\n  } catch (err) {\n    console.error(\"❌ Error registering visitors:\", err);\n    res.status(500).json({ success: false, message: \"Server error during registration\" });\n  }\n};\n\n// ================================\n// ✅ Fetch all visitors\n// ================================\nexport const getAllVisitors = async (req, res) => {\n  try {\n    const pool = await connectDB();\n    const result = await pool.request()\n      .query(\"SELECT * FROM Visitors ORDER BY CreatedAt DESC\");\n    res.json(result.recordset);\n  } catch (err) {\n    console.error(\"❌ Error fetching visitors:\", err);\n    res.status(500).json({ success: false, message: \"Database fetch error\" });\n  }\n};\n\n// ================================\n// ✅ Fetch approved visitors\n// ================================\nexport const getApprovedVisitors = async (req, res) => {\n  try {\n    const pool = await connectDB();\n    const result = await pool.request().query(`\n      SELECT v.VisitorID, v.VisitorName, v.ResidentID, r.ResidentName, v.DateOfVisit AS Date, v.Status\n      FROM Visitors v\n      JOIN Residents r ON v.ResidentID = r.ResidentID\n      WHERE v.Status = 'Approved'\n      ORDER BY v.DateOfVisit DESC\n    `);\n    res.json(result.recordset);\n  } catch (err) {\n    console.error(\"❌ Error fetching approved visitors:\", err);\n    res.status(500).json({ error: \"Server error fetching approved visitors\" });\n  }\n};\n\n// ================================\n// ✅ Fetch pending visitors\n// ================================\nexport const getPendingVisitors = async (req, res) => {\n  try {\n    const pool = await connectDB();\n    const result = await pool.request().query(`\n      SELECT v.VisitorID, v.VisitorName, v.ResidentID, r.ResidentName, v.DateOfVisit AS Date, v.Status\n      FROM Visitors v\n      JOIN Residents r ON v.ResidentID = r.ResidentID\n      WHERE v.Status = 'Pending'\n      ORDER BY v.DateOfVisit DESC\n    `);\n    res.json(result.recordset);\n  } catch (err) {\n    console.error(\"❌ Error fetching pending visitors:\", err);\n    res.status(500).json({ error: \"Server error fetching pending visitors\" });\n  }\n};\n\n// ================================\n// ✅ Get visitor count for dashboard\n// ================================\nexport const getVisitorCount = async (req, res) => {\n  try {\n    const pool = await connectDB();\n    const result = await pool.request()\n      .query(\"SELECT COUNT(*) AS totalVisitors FROM Visitors\");\n    res.json({ totalVisitors: result.recordset[0].totalVisitors });\n  } catch (err) {\n    console.error(\"❌ Error counting visitors:\", err);\n    res.status(500).json({ success: false, message: \"Count fetch error\" });\n  }\n};\n\n// ================================\n// ✅ Fetch visitor by ID\n// ================================\nexport const getVisitorById = async (req, res) => {\n  const { id } = req.params;\n\n  try {\n    const pool = await connectDB();\n    const result = await pool.request()\n      .input(\"VisitorID\", sql.Int, id)\n      .query(\"SELECT * FROM Visitors WHERE VisitorID = @VisitorID\");\n\n    if (result.recordset.length === 0) {\n      return res.status(404).json({ success: false, message: \"Visitor not found\" });\n    }\n\n    res.json({ success: true, data: result.recordset[0] });\n  } catch (err) {\n    console.error(\"❌ Error fetching visitor by ID:\", err);\n    res.status(500).json({ success: false, message: \"Server error\" });\n  }\n};\n"
        }
    ]
}