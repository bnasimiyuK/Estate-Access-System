{
    "sourceFile": "frontend/js/payment.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1763621258549,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763621642153,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -131,9 +131,9 @@\n \n         res.data.forEach(b => {\n             tbody.innerHTML += `\n                 <tr>\n-                    <td>${b.Resident}</td>\n+                    <td>${b.ResidentName}</td>\n                     <td>${b.TotalPaid}</td>\n                     <td>${b.TotalDue}</td>\n                     <td>${b.Balance}</td>\n                 </tr>\n"
                },
                {
                    "date": 1763622428146,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,254 @@\n+//--------------------------------------\n+// GLOBALS\n+//--------------------------------------\n+const token = localStorage.getItem(\"accessToken\");\n+if (!token) {\n+    window.location.href = \"login.html\";\n+}\n+\n+const axiosAuth = axios.create({\n+    baseURL: \"/api\",\n+    headers: { Authorization: `Bearer ${token}` }\n+});\n+\n+//--------------------------------------\n+// DASHBOARD SUMMARY\n+//--------------------------------------\n+async function loadDashboardSummary() {\n+    try {\n+        const res = await axiosAuth.get(\"/payments/summary\");\n+\n+        const div = document.getElementById(\"dashboardSummary\");\n+        div.innerHTML = `\n+            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n+                <p class=\"font-bold text-indigo-700\">Total Payments</p>\n+                <p class=\"text-lg\">${res.data.totalPayments}</p>\n+            </div>\n+\n+            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n+                <p class=\"font-bold text-green-700\">Verified</p>\n+                <p class=\"text-lg\">${res.data.totalVerified}</p>\n+            </div>\n+\n+            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n+                <p class=\"font-bold text-red-700\">Pending</p>\n+                <p class=\"text-lg\">${res.data.totalPending}</p>\n+            </div>\n+        `;\n+    } catch (err) {\n+        console.error(\"Summary load error:\", err);\n+    }\n+}\n+\n+//--------------------------------------\n+// LOAD PAYMENT HISTORY\n+//--------------------------------------\n+async function loadPayments() {\n+    try {\n+        const res = await axiosAuth.get(\"/payments\");\n+        const tbody = document.getElementById(\"paymentsBody\");\n+        tbody.innerHTML = \"\";\n+\n+        res.data.forEach(p => {\n+            tbody.innerHTML += `\n+                <tr>\n+                    <td>${p.PaymentID}</td>\n+                    <td>${p.ResidentID}</td>\n+                    <td>${p.Amount}</td>\n+                    <td>${new Date(p.PaymentDate).toLocaleString()}</td>\n+                    <td class=\"${p.Status === 'Verified' ? 'text-green-600' : 'text-red-600'}\">${p.Status}</td>\n+                    <td>${p.Reference}</td>\n+                    <td>${p.PaymentMethod}</td>\n+                    <td>\n+                        ${p.Status !== \"Verified\"\n+                            ? `<button class=\"bg-green-600 text-white px-1 rounded text-xs\"\n+                                    onclick=\"verifyPayment(${p.PaymentID})\">Verify</button>`\n+                            : \"✔\"}\n+                    </td>\n+                    <td>${p.NationalID || \"\"}</td>\n+                    <td>${p.ServiceName || \"\"}</td>\n+                    <td>${p.PhoneNumber || \"\"}</td>\n+                    <td>${p.VerifiedDate ? new Date(p.VerifiedDate).toLocaleString() : \"\"}</td>\n+                </tr>\n+            `;\n+        });\n+\n+    } catch (err) {\n+        console.error(\"Error loading payments:\", err);\n+    }\n+}\n+\n+//--------------------------------------\n+// VERIFY PAYMENT\n+//--------------------------------------\n+async function verifyPayment(id) {\n+    if (!confirm(\"Confirm payment verification?\")) return;\n+\n+    try {\n+        await axiosAuth.put(`/payments/verify/${id}`);\n+        loadPayments();\n+        loadVerifiedPayments();\n+        loadBalances();\n+        loadDashboardSummary();\n+    } catch (err) {\n+        console.error(\"Verify error:\", err);\n+    }\n+}\n+\n+//--------------------------------------\n+// LOAD VERIFIED PAYMENTS\n+//--------------------------------------\n+async function loadVerifiedPayments() {\n+    try {\n+        const res = await axiosAuth.get(\"/payments/verified\");\n+        const tbody = document.getElementById(\"verifiedBody\");\n+        tbody.innerHTML = \"\";\n+\n+        res.data.forEach(v => {\n+            tbody.innerHTML += `\n+                <tr>\n+                    <td>${v.ResidentID}</td>\n+                    <td>${v.Amount}</td>\n+                    <td>${v.Reference}</td>\n+                    <td>${v.VerifiedDate ? new Date(v.VerifiedDate).toLocaleString() : \"\"}</td>\n+                </tr>\n+            `;\n+        });\n+\n+    } catch (err) {\n+        console.error(\"Verified payments load error:\", err);\n+    }\n+}\n+\n+//--------------------------------------\n+// LOAD BALANCES\n+//--------------------------------------\n+async function loadBalances() {\n+    try {\n+        const res = await axiosAuth.get(\"/payments/balances\");\n+        const tbody = document.getElementById(\"balanceBody\");\n+        tbody.innerHTML = \"\";\n+\n+        res.data.forEach(b => {\n+            tbody.innerHTML += `\n+                <tr>\n+                    <td>${b.ResidentName}</td>\n+                    <td>${b.TotalPaid}</td>\n+                    <td>${b.TotalDue}</td>\n+                    <td>${b.Balance}</td>\n+                </tr>\n+            `;\n+        });\n+\n+    } catch (err) {\n+        console.error(\"Balances load error:\", err);\n+    }\n+}\n+\n+//--------------------------------------\n+// FILTERS\n+//--------------------------------------\n+document.getElementById(\"filterInput\").addEventListener(\"input\", function () {\n+    const filter = this.value.toLowerCase();\n+    document.querySelectorAll(\"#paymentsBody tr\").forEach(row => {\n+        row.style.display = row.cells[1].innerText.toLowerCase().includes(filter)\n+            ? \"\"\n+            : \"none\";\n+    });\n+});\n+\n+document.getElementById(\"verifiedFilterInput\").addEventListener(\"input\", function () {\n+    const filter = this.value.toLowerCase();\n+    document.querySelectorAll(\"#verifiedBody tr\").forEach(row => {\n+        row.style.display = row.cells[0].innerText.toLowerCase().includes(filter)\n+            ? \"\"\n+            : \"none\";\n+    });\n+});\n+\n+//--------------------------------------\n+// EXPORT CSV & EXCEL\n+//--------------------------------------\n+function exportCSV(tableId) {\n+    const table = document.getElementById(tableId);\n+    const rows = table.querySelectorAll(\"tr\");\n+\n+    const csv = [...rows]\n+        .map(r => [...r.children].map(c => c.innerText).join(\",\"))\n+        .join(\"\\n\");\n+\n+    const file = new Blob([csv], { type: \"text/csv\" });\n+    const link = document.createElement(\"a\");\n+    link.href = URL.createObjectURL(file);\n+    link.download = `${tableId}.csv`;\n+    link.click();\n+}\n+\n+function exportExcel(tableId) {\n+    const table = document.getElementById(tableId);\n+    const wb = XLSX.utils.table_to_book(table);\n+    XLSX.writeFile(wb, `${tableId}.xlsx`);\n+}\n+\n+document.getElementById(\"exportCsv\").onclick = () => exportCSV(\"paymentsTable\");\n+document.getElementById(\"exportVerifiedCsv\").onclick = () => exportCSV(\"verifiedTable\");\n+document.getElementById(\"exportBalancesCsv\").onclick = () => exportCSV(\"balanceTable\");\n+document.getElementById(\"exportExcel\").onclick = () => exportExcel(\"paymentsTable\");\n+document.getElementById(\"exportVerifiedExcel\").onclick = () => exportExcel(\"verifiedTable\");\n+document.getElementById(\"exportBalancesExcel\").onclick = () => exportExcel(\"balanceTable\");\n+\n+//--------------------------------------\n+// MPESA PAYMENT\n+//--------------------------------------\n+document.getElementById(\"payBtn\").addEventListener(\"click\", async () => {\n+    const service = document.getElementById(\"serviceName\").value;\n+    const amount = document.getElementById(\"paymentAmount\").value;\n+    const phone = document.getElementById(\"phoneNumber\").value;\n+\n+    const result = document.getElementById(\"paymentResult\");\n+\n+    if (!service || !amount || !phone) {\n+        result.innerText = \"Please fill in all fields\";\n+        result.className = \"text-red-600 text-xs\";\n+        return;\n+    }\n+\n+    result.innerText = \"Processing...\";\n+    result.className = \"text-gray-600 text-xs\";\n+\n+    try {\n+        const res = await axiosAuth.post(\"/residents/pay\", {\n+            serviceName: service,\n+            amount,\n+            phone\n+        });\n+\n+        result.innerText = res.data.message || \"Payment successful\";\n+        result.className = \"text-green-600 text-xs\";\n+\n+        document.getElementById(\"serviceName\").value = \"\";\n+        document.getElementById(\"paymentAmount\").value = \"\";\n+        document.getElementById(\"phoneNumber\").value = \"\";\n+\n+        // reload\n+        loadPayments();\n+        loadVerifiedPayments();\n+        loadBalances();\n+        loadDashboardSummary();\n+\n+    } catch (err) {\n+        console.error(err);\n+        result.innerText = \"Payment failed\";\n+        result.className = \"text-red-600 text-xs\";\n+    }\n+});\n+\n+//--------------------------------------\n+// INITIAL LOAD\n+//--------------------------------------\n+window.addEventListener(\"DOMContentLoaded\", () => {\n+    loadDashboardSummary();\n+    loadPayments();\n+    loadVerifiedPayments();\n+    loadBalances();\n+});\n"
                },
                {
                    "date": 1763628360504,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,508 +1,440 @@\n-//--------------------------------------\n-// GLOBALS\n-//--------------------------------------\n-const token = localStorage.getItem(\"accessToken\");\n-if (!token) {\n-    window.location.href = \"login.html\";\n-}\n+ import { initializeApp } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js\";\n+  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js\";\n+  import { getFirestore, collection, onSnapshot, addDoc, doc, setLogLevel, serverTimestamp, query, orderBy } from \"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js\";\n \n-const axiosAuth = axios.create({\n-    baseURL: \"/api\",\n-    headers: { Authorization: `Bearer ${token}` }\n-});\n+  // --- GLOBAL FIREBASE/APP SETUP ---\n+  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';\n+  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');\n+  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;\n \n-//--------------------------------------\n-// DASHBOARD SUMMARY\n-//--------------------------------------\n-async function loadDashboardSummary() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments/summary\");\n+  let db, auth, userId;\n+  let allPayments = []; // Store all fetched data globally\n+  setLogLevel('Debug');\n \n-        const div = document.getElementById(\"dashboardSummary\");\n-        div.innerHTML = `\n-            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n-                <p class=\"font-bold text-indigo-700\">Total Payments</p>\n-                <p class=\"text-lg\">${res.data.totalPayments}</p>\n-            </div>\n+  // Utility to format date\n+  const formatDate = (timestamp) => {\n+      if (!timestamp || !timestamp.toDate) return 'N/A';\n+      return timestamp.toDate().toLocaleString('en-GB', {\n+          year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'\n+      });\n+  };\n \n-            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n-                <p class=\"font-bold text-green-700\">Verified</p>\n-                <p class=\"text-lg\">${res.data.totalVerified}</p>\n-            </div>\n+  // Utility to format currency\n+  const formatCurrency = (amount) => {\n+      return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES' }).format(amount);\n+  };\n \n-            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n-                <p class=\"font-bold text-red-700\">Pending</p>\n-                <p class=\"text-lg\">${res.data.totalPending}</p>\n-            </div>\n-        `;\n-    } catch (err) {\n-        console.error(\"Summary load error:\", err);\n-    }\n-}\n+  // --- DATA PROCESSING & RENDERING ---\n \n-//--------------------------------------\n-// LOAD PAYMENT HISTORY\n-//--------------------------------------\n-async function loadPayments() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments\");\n-        const tbody = document.getElementById(\"paymentsBody\");\n-        tbody.innerHTML = \"\";\n+  // NEW FUNCTION: Populates the Resident ID select dropdown\n+  function populateResidentSelect(payments) {\n+      const residentIds = new Set();\n+      // Extract unique Resident IDs from all payments\n+      payments.forEach(p => {\n+          if (p.ResidentID) {\n+              residentIds.add(p.ResidentID.toUpperCase().trim());\n+          }\n+      });\n \n-        res.data.forEach(p => {\n-            tbody.innerHTML += `\n-                <tr>\n-                    <td>${p.PaymentID}</td>\n-                    <td>${p.ResidentID}</td>\n-                    <td>${p.Amount}</td>\n-                    <td>${new Date(p.PaymentDate).toLocaleString()}</td>\n-                    <td class=\"${p.Status === 'Verified' ? 'text-green-600' : 'text-red-600'}\">${p.Status}</td>\n-                    <td>${p.Reference}</td>\n-                    <td>${p.PaymentMethod}</td>\n-                    <td>\n-                        ${p.Status !== \"Verified\"\n-                            ? `<button class=\"bg-green-600 text-white px-1 rounded text-xs\"\n-                                    onclick=\"verifyPayment(${p.PaymentID})\">Verify</button>`\n-                            : \"✔\"}\n-                    </td>\n-                    <td>${p.NationalID || \"\"}</td>\n-                    <td>${p.ServiceName || \"\"}</td>\n-                    <td>${p.PhoneNumber || \"\"}</td>\n-                    <td>${p.VerifiedDate ? new Date(p.VerifiedDate).toLocaleString() : \"\"}</td>\n-                </tr>\n-            `;\n-        });\n+      const selectElement = document.getElementById('residentIdSelect');\n+      if (!selectElement) return;\n \n-    } catch (err) {\n-        console.error(\"Error loading payments:\", err);\n-    }\n-}\n+      // Preserve the current selected value\n+      const currentSelection = selectElement.value;\n \n-//--------------------------------------\n-// VERIFY PAYMENT\n-//--------------------------------------\n-async function verifyPayment(id) {\n-    if (!confirm(\"Confirm payment verification?\")) return;\n+      // Clear existing options, but keep the disabled placeholder\n+      selectElement.innerHTML = '<option value=\"\" disabled selected>Select Resident ID (or enter new)</option>';\n \n-    try {\n-        await axiosAuth.put(`/payments/verify/${id}`);\n-        loadPayments();\n-        loadVerifiedPayments();\n-        loadBalances();\n-        loadDashboardSummary();\n-    } catch (err) {\n-        console.error(\"Verify error:\", err);\n-    }\n-}\n+      const sortedIds = Array.from(residentIds).sort();\n \n-//--------------------------------------\n-// LOAD VERIFIED PAYMENTS\n-//--------------------------------------\n-async function loadVerifiedPayments() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments/verified\");\n-        const tbody = document.getElementById(\"verifiedBody\");\n-        tbody.innerHTML = \"\";\n+      // Add options for each unique ID\n+      sortedIds.forEach(id => {\n+          const option = document.createElement('option');\n+          option.value = id;\n+          option.textContent = id;\n+          if (id === currentSelection) {\n+              option.selected = true;\n+          }\n+          selectElement.appendChild(option);\n+      });\n+  }\n \n-        res.data.forEach(v => {\n-            tbody.innerHTML += `\n-                <tr>\n-                    <td>${v.ResidentID}</td>\n-                    <td>${v.Amount}</td>\n-                    <td>${v.Reference}</td>\n-                    <td>${v.VerifiedDate ? new Date(v.VerifiedDate).toLocaleString() : \"\"}</td>\n-                </tr>\n-            `;\n-        });\n+  function calculateDashboardSummary(payments) {\n+      const totalPayments = payments.length;\n+      const verifiedPayments = payments.filter(p => p.Status === 'Verified').length;\n+      const totalVerifiedAmount = payments\n+          .filter(p => p.Status === 'Verified')\n+          .reduce((sum, p) => sum + p.Amount, 0);\n \n-    } catch (err) {\n-        console.error(\"Verified payments load error:\", err);\n-    }\n-}\n+      const summaryHtml = `\n+          <div class=\"bg-white p-4 rounded-xl shadow-md border border-gray-200\">\n+              <p class=\"text-xs text-gray-500\">Total Transactions</p>\n+              <p class=\"text-xl font-bold text-indigo-600\">${totalPayments}</p>\n+          </div>\n+          <div class=\"bg-white p-4 rounded-xl shadow-md border border-gray-200\">\n+              <p class=\"text-xs text-gray-500\">Verified Payments</p>\n+              <p class=\"text-xl font-bold text-green-600\">${verifiedPayments}</p>\n+          </div>\n+          <div class=\"bg-white p-4 rounded-xl shadow-md border border-gray-200\">\n+              <p class=\"text-xs text-gray-500\">Total Verified Amount</p>\n+              <p class=\"text-xl font-bold text-indigo-600\">${formatCurrency(totalVerifiedAmount)}</p>\n+          </div>\n+      `;\n+      document.getElementById('dashboardSummary').innerHTML = summaryHtml;\n+  }\n \n-//--------------------------------------\n-// LOAD BALANCES\n-//--------------------------------------\n-async function loadBalances() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments/balances\");\n-        const tbody = document.getElementById(\"balanceBody\");\n-        tbody.innerHTML = \"\";\n+  function calculateBalances(payments) {\n+      const balances = {};\n+      const requiredDue = {}; // Simple simulation: what they attempted to pay is their \"due\"\n+      const verifiedOnly = payments.filter(p => p.Status === 'Verified');\n \n-        res.data.forEach(b => {\n-            tbody.innerHTML += `\n-                <tr>\n-                    <td>${b.ResidentName}</td>\n-                    <td>${b.TotalPaid}</td>\n-                    <td>${b.TotalDue}</td>\n-                    <td>${b.Balance}</td>\n-                </tr>\n-            `;\n-        });\n+      verifiedOnly.forEach(p => {\n+          const id = p.ResidentID;\n+          if (!balances[id]) {\n+              balances[id] = { totalPaid: 0, totalDue: 0, ResidentID: id };\n+          }\n+          balances[id].totalPaid += p.Amount;\n+      });\n \n-    } catch (err) {\n-        console.error(\"Balances load error:\", err);\n-    }\n-}\n+      // Simple due simulation: sum of all attempted payment amounts\n+      payments.forEach(p => {\n+          const id = p.ResidentID;\n+          if (!balances[id]) {\n+              balances[id] = { totalPaid: 0, totalDue: 0, ResidentID: id };\n+          }\n+          balances[id].totalDue += p.Amount;\n+      });\n \n-//--------------------------------------\n-// FILTERS\n-//--------------------------------------\n-document.getElementById(\"filterInput\").addEventListener(\"input\", function () {\n-    const filter = this.value.toLowerCase();\n-    document.querySelectorAll(\"#paymentsBody tr\").forEach(row => {\n-        row.style.display = row.cells[1].innerText.toLowerCase().includes(filter)\n-            ? \"\"\n-            : \"none\";\n-    });\n-});\n+      // Render Balances Table\n+      const balanceBody = document.getElementById('balanceBody');\n+      balanceBody.innerHTML = '';\n+      const balanceArray = Object.values(balances);\n \n-document.getElementById(\"verifiedFilterInput\").addEventListener(\"input\", function () {\n-    const filter = this.value.toLowerCase();\n-    document.querySelectorAll(\"#verifiedBody tr\").forEach(row => {\n-        row.style.display = row.cells[0].innerText.toLowerCase().includes(filter)\n-            ? \"\"\n-            : \"none\";\n-    });\n-});\n+      // Sort by ResidentID for better display\n+      balanceArray.sort((a, b) => a.ResidentID.localeCompare(b.ResidentID));\n \n-//--------------------------------------\n-// EXPORT CSV & EXCEL\n-//--------------------------------------\n-function exportCSV(tableId) {\n-    const table = document.getElementById(tableId);\n-    const rows = table.querySelectorAll(\"tr\");\n+      balanceArray.forEach(b => {\n+          const balance = b.totalPaid - b.totalDue;\n+          const balanceClass = balance >= 0 ? 'text-green-600' : 'text-red-600 font-bold';\n+          const row = `\n+              <tr class=\"hover:bg-gray-50\">\n+                  <td class=\"px-3 py-2\">${b.ResidentID}</td>\n+                  <td class=\"px-3 py-2 text-right\">${formatCurrency(b.totalPaid)}</td>\n+                  <td class=\"px-3 py-2 text-right\">${formatCurrency(b.totalDue)}</td>\n+                  <td class=\"px-3 py-2 text-right ${balanceClass}\">${formatCurrency(balance)}</td>\n+              </tr>\n+          `;\n+          balanceBody.insertAdjacentHTML('beforeend', row);\n+      });\n+      return balanceArray;\n+  }\n \n-    const csv = [...rows]\n-        .map(r => [...r.children].map(c => c.innerText).join(\",\"))\n-        .join(\"\\n\");\n+  function renderPaymentsTable(data, tableId) {\n+      const body = document.getElementById(tableId);\n+      body.innerHTML = '';\n+      if (data.length === 0) {\n+          body.innerHTML = '<tr><td colspan=\"12\" class=\"text-center py-4 text-gray-500\">No payments found.</td></tr>';\n+          return;\n+      }\n \n-    const file = new Blob([csv], { type: \"text/csv\" });\n-    const link = document.createElement(\"a\");\n-    link.href = URL.createObjectURL(file);\n-    link.download = `${tableId}.csv`;\n-    link.click();\n-}\n+      data.forEach(p => {\n+          const statusClass = p.Status === 'Verified' ? 'bg-green-100 text-green-800' :\n+                             p.Status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :\n+                             'bg-red-100 text-red-800';\n \n-function exportExcel(tableId) {\n-    const table = document.getElementById(tableId);\n-    const wb = XLSX.utils.table_to_book(table);\n-    XLSX.writeFile(wb, `${tableId}.xlsx`);\n-}\n+          const row = `\n+              <tr class=\"hover:bg-gray-50\">\n+                  <td class=\"px-3 py-1.5\">${p.PaymentID.substring(0, 8)}...</td>\n+                  <td class=\"px-3 py-1.5 font-medium\">${p.ResidentID}</td>\n+                  <td class=\"px-3 py-1.5 text-right\">${formatCurrency(p.Amount)}</td>\n+                  <td class=\"px-3 py-1.5\">${formatDate(p.PaymentDate)}</td>\n+                  <td class=\"px-3 py-1.5\"><span class=\"px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}\">${p.Status}</span></td>\n+                  <td class=\"px-3 py-1.5\">${p.Reference}</td>\n+                  <td class=\"px-3 py-1.5\">${p.PaymentMethod}</td>\n+                  <td class=\"px-3 py-1.5\">${p.Action || 'View'}</td>\n+                  <td class=\"px-3 py-1.5\">${p.NationalID || 'N/A'}</td>\n+                  <td class=\"px-3 py-1.5\">${p.ServiceName || 'General'}</td>\n+                  <td class=\"px-3 py-1.5\">${p.PhoneNumber || 'N/A'}</td>\n+                  <td class=\"px-3 py-1.5\">${p.VerifiedDate ? formatDate(p.VerifiedDate) : 'Pending'}</td>\n+              </tr>\n+          `;\n+          body.insertAdjacentHTML('beforeend', row);\n+      });\n+  }\n \n-document.getElementById(\"exportCsv\").onclick = () => exportCSV(\"paymentsTable\");\n-document.getElementById(\"exportVerifiedCsv\").onclick = () => exportCSV(\"verifiedTable\");\n-document.getElementById(\"exportBalancesCsv\").onclick = () => exportCSV(\"balanceTable\");\n-document.getElementById(\"exportExcel\").onclick = () => exportExcel(\"paymentsTable\");\n-document.getElementById(\"exportVerifiedExcel\").onclick = () => exportExcel(\"verifiedTable\");\n-document.getElementById(\"exportBalancesExcel\").onclick = () => exportExcel(\"balanceTable\");\n+  function renderVerifiedTable(data) {\n+      const body = document.getElementById('verifiedBody');\n+      body.innerHTML = '';\n+      const verified = data.filter(p => p.Status === 'Verified');\n \n-//--------------------------------------\n-// MPESA PAYMENT\n-//--------------------------------------\n-document.getElementById(\"payBtn\").addEventListener(\"click\", async () => {\n-    const service = document.getElementById(\"serviceName\").value;\n-    const amount = document.getElementById(\"paymentAmount\").value;\n-    const phone = document.getElementById(\"phoneNumber\").value;\n+      if (verified.length === 0) {\n+          body.innerHTML = '<tr><td colspan=\"4\" class=\"text-center py-4 text-gray-500\">No verified payments found.</td></tr>';\n+          return;\n+      }\n \n-    const result = document.getElementById(\"paymentResult\");\n+      verified.forEach(p => {\n+          const row = `\n+              <tr class=\"hover:bg-gray-50\">\n+                  <td class=\"px-3 py-1.5 font-medium\">${p.ResidentID}</td>\n+                  <td class=\"px-3 py-1.5 text-right\">${formatCurrency(p.Amount)}</td>\n+                  <td class=\"px-3 py-1.5\">${p.Reference}</td>\n+                  <td class=\"px-3 py-1.5\">${formatDate(p.VerifiedDate)}</td>\n+              </tr>\n+          `;\n+          body.insertAdjacentHTML('beforeend', row);\n+      });\n+      return verified;\n+  }\n \n-    if (!service || !amount || !phone) {\n-        result.innerText = \"Please fill in all fields\";\n-        result.className = \"text-red-600 text-xs\";\n-        return;\n-    }\n+  // --- FIREBASE INTERACTION ---\n \n-    result.innerText = \"Processing...\";\n-    result.className = \"text-gray-600 text-xs\";\n+  async function initFirebase() {\n+      try {\n+          const app = initializeApp(firebaseConfig);\n+          db = getFirestore(app);\n+          auth = getAuth(app);\n \n-    try {\n-        const res = await axiosAuth.post(\"/residents/pay\", {\n-            serviceName: service,\n-            amount,\n-            phone\n-        });\n+          // Sign in using custom token or anonymously\n+          if (initialAuthToken) {\n+              await signInWithCustomToken(auth, initialAuthToken);\n+          } else {\n+              await signInAnonymously(auth);\n+          }\n \n-        result.innerText = res.data.message || \"Payment successful\";\n-        result.className = \"text-green-600 text-xs\";\n+          onAuthStateChanged(auth, (user) => {\n+              if (user) {\n+                  userId = user.uid;\n+                  document.getElementById('userInfo').textContent = `User ID: ${userId}`;\n+                  startRealtimeListener();\n+              } else {\n+                  console.error(\"User not authenticated.\");\n+                  document.getElementById('userInfo').textContent = 'Authentication Failed';\n+              }\n+          });\n+      } catch (error) {\n+          console.error(\"Error initializing Firebase:\", error);\n+          document.getElementById('userInfo').textContent = `Init Error: ${error.message}`;\n+      }\n+  }\n \n-        document.getElementById(\"serviceName\").value = \"\";\n-        document.getElementById(\"paymentAmount\").value = \"\";\n-        document.getElementById(\"phoneNumber\").value = \"\";\n+  function startRealtimeListener() {\n+      if (!db) return;\n \n-        // reload\n-        loadPayments();\n-        loadVerifiedPayments();\n-        loadBalances();\n-        loadDashboardSummary();\n+      const paymentsCollectionPath = `/artifacts/${appId}/public/data/payments`;\n+      const q = collection(db, paymentsCollectionPath);\n \n-    } catch (err) {\n-        console.error(err);\n-        result.innerText = \"Payment failed\";\n-        result.className = \"text-red-600 text-xs\";\n-    }\n-});\n+      // Listen for real-time updates\n+      onSnapshot(q, (snapshot) => {\n+          allPayments = snapshot.docs.map(doc => ({\n+              id: doc.id,\n+              ...doc.data()\n+          }));\n \n-//--------------------------------------\n-// INITIAL LOAD\n-//--------------------------------------\n-window.addEventListener(\"DOMContentLoaded\", () => {\n-    loadDashboardSummary();\n-    loadPayments();\n-    loadVerifiedPayments();\n-    loadBalances();\n-});\n-//--------------------------------------\n-// GLOBALS\n-//--------------------------------------\n-const token = localStorage.getItem(\"accessToken\");\n-if (!token) {\n-    window.location.href = \"login.html\";\n-}\n+          // Sort by PaymentDate descending\n+          allPayments.sort((a, b) => (b.PaymentDate?.toMillis() || 0) - (a.PaymentDate?.toMillis() || 0));\n \n-const axiosAuth = axios.create({\n-    baseURL: \"/api\",\n-    headers: { Authorization: `Bearer ${token}` }\n-});\n+          // Process and render data\n+          updateAllViews(allPayments);\n+      }, (error) => {\n+          console.error(\"Error listening to payments collection:\", error);\n+      });\n+  }\n \n-//--------------------------------------\n-// DASHBOARD SUMMARY\n-//--------------------------------------\n-async function loadDashboardSummary() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments/summary\");\n+  function updateAllViews(data) {\n+      // 1. Dashboard Summary\n+      calculateDashboardSummary(data);\n \n-        const div = document.getElementById(\"dashboardSummary\");\n-        div.innerHTML = `\n-            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n-                <p class=\"font-bold text-indigo-700\">Total Payments</p>\n-                <p class=\"text-lg\">${res.data.totalPayments}</p>\n-            </div>\n+      // 2. Populate the Resident ID Select Dropdown\n+      populateResidentSelect(data);\n \n-            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n-                <p class=\"font-bold text-green-700\">Verified</p>\n-                <p class=\"text-lg\">${res.data.totalVerified}</p>\n-            </div>\n+      // 3. Full Payment History Table (Default display, unfiltered)\n+      renderPaymentsTable(data, 'paymentsBody');\n \n-            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n-                <p class=\"font-bold text-red-700\">Pending</p>\n-                <p class=\"text-lg\">${res.data.totalPending}</p>\n-            </div>\n-        `;\n-    } catch (err) {\n-        console.error(\"Summary load error:\", err);\n-    }\n-}\n+      // 4. Verified Payments Table (Default display, unfiltered)\n+      renderVerifiedTable(data);\n \n-//--------------------------------------\n-// LOAD PAYMENT HISTORY\n-//--------------------------------------\n-async function loadPayments() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments\");\n-        const tbody = document.getElementById(\"paymentsBody\");\n-        tbody.innerHTML = \"\";\n+      // 5. Balances Table\n+      calculateBalances(data);\n+  }\n \n-        res.data.forEach(p => {\n-            tbody.innerHTML += `\n-                <tr>\n-                    <td>${p.PaymentID}</td>\n-                    <td>${p.ResidentID}</td>\n-                    <td>${p.Amount}</td>\n-                    <td>${new Date(p.PaymentDate).toLocaleString()}</td>\n-                    <td class=\"${p.Status === 'Verified' ? 'text-green-600' : 'text-red-600'}\">${p.Status}</td>\n-                    <td>${p.Reference}</td>\n-                    <td>${p.PaymentMethod}</td>\n-                    <td>\n-                        ${p.Status !== \"Verified\"\n-                            ? `<button class=\"bg-green-600 text-white px-1 rounded text-xs\"\n-                                    onclick=\"verifyPayment(${p.PaymentID})\">Verify</button>`\n-                            : \"✔\"}\n-                    </td>\n-                    <td>${p.NationalID || \"\"}</td>\n-                    <td>${p.ServiceName || \"\"}</td>\n-                    <td>${p.PhoneNumber || \"\"}</td>\n-                    <td>${p.VerifiedDate ? new Date(p.VerifiedDate).toLocaleString() : \"\"}</td>\n-                </tr>\n-            `;\n-        });\n \n-    } catch (err) {\n-        console.error(\"Error loading payments:\", err);\n-    }\n-}\n+  async function addPayment(residentId, serviceName, amount, phoneNumber) {\n+      if (!db || !userId) {\n+          console.error(\"Database not initialized or user not logged in.\");\n+          return { success: false, message: \"System error: Database not ready.\" };\n+      }\n \n-//--------------------------------------\n-// VERIFY PAYMENT\n-//--------------------------------------\n-async function verifyPayment(id) {\n-    if (!confirm(\"Confirm payment verification?\")) return;\n+      const paymentsCollectionPath = `/artifacts/${appId}/public/data/payments`;\n \n-    try {\n-        await axiosAuth.put(`/payments/verify/${id}`);\n-        loadPayments();\n-        loadVerifiedPayments();\n-        loadBalances();\n-        loadDashboardSummary();\n-    } catch (err) {\n-        console.error(\"Verify error:\", err);\n-    }\n-}\n+      // Simple logic to simulate verification/status based on amount\n+      const isVerified = amount > 1000; // Large payments auto-verified for simulation\n+      const status = isVerified ? 'Verified' : 'Pending';\n+      const reference = 'MPESA' + Math.random().toString(36).substring(2, 10).toUpperCase();\n \n-//--------------------------------------\n-// LOAD VERIFIED PAYMENTS\n-//--------------------------------------\n-async function loadVerifiedPayments() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments/verified\");\n-        const tbody = document.getElementById(\"verifiedBody\");\n-        tbody.innerHTML = \"\";\n+      const newPayment = {\n+          PaymentID: crypto.randomUUID(),\n+          ResidentID: residentId.toUpperCase().trim(),\n+          Amount: parseFloat(amount),\n+          PaymentDate: serverTimestamp(),\n+          Status: status,\n+          Reference: reference,\n+          PaymentMethod: 'MPESA',\n+          Action: 'Initial Payment',\n+          NationalID: '', // Placeholder\n+          ServiceName: serviceName,\n+          PhoneNumber: phoneNumber,\n+          VerifiedDate: isVerified ? serverTimestamp() : null\n+      };\n \n-        res.data.forEach(v => {\n-            tbody.innerHTML += `\n-                <tr>\n-                    <td>${v.ResidentID}</td>\n-                    <td>${v.Amount}</td>\n-                    <td>${v.Reference}</td>\n-                    <td>${v.VerifiedDate ? new Date(v.VerifiedDate).toLocaleString() : \"\"}</td>\n-                </tr>\n-            `;\n-        });\n+      try {\n+          await addDoc(collection(db, paymentsCollectionPath), newPayment);\n+          return {\n+              success: true,\n+              message: `Payment of ${formatCurrency(amount)} for ${residentId} initiated. Status: ${status}. Ref: ${reference}.`\n+          };\n+      } catch (e) {\n+          console.error(\"Error adding document: \", e);\n+          return { success: false, message: `Error processing payment: ${e.message}` };\n+      }\n+  }\n \n-    } catch (err) {\n-        console.error(\"Verified payments load error:\", err);\n-    }\n-}\n+  // --- UI/EVENT HANDLERS ---\n \n-//--------------------------------------\n-// LOAD BALANCES\n-//--------------------------------------\n-async function loadBalances() {\n-    try {\n-        const res = await axiosAuth.get(\"/payments/balances\");\n-        const tbody = document.getElementById(\"balanceBody\");\n-        tbody.innerHTML = \"\";\n+  document.addEventListener('DOMContentLoaded', () => {\n+      initFirebase();\n \n-        res.data.forEach(b => {\n-            tbody.innerHTML += `\n-                <tr>\n-                    <td>${b.ResidentName}</td>\n-                    <td>${b.TotalPaid}</td>\n-                    <td>${b.TotalDue}</td>\n-                    <td>${b.Balance}</td>\n-                </tr>\n-            `;\n-        });\n+      const payBtn = document.getElementById('payBtn');\n+      const payBtnText = document.getElementById('payBtnText');\n+      const paymentResult = document.getElementById('paymentResult');\n \n-    } catch (err) {\n-        console.error(\"Balances load error:\", err);\n-    }\n-}\n+      payBtn.addEventListener('click', async () => {\n+          // MODIFIED: Read value from select dropdown\n+          const residentId = document.getElementById('residentIdSelect').value;\n+          const serviceName = document.getElementById('serviceNameInput').value;\n+          const amount = document.getElementById('paymentAmountInput').value;\n+          const phoneNumber = document.getElementById('phoneNumberInput').value;\n \n-//--------------------------------------\n-// FILTERS\n-//--------------------------------------\n-document.getElementById(\"filterInput\").addEventListener(\"input\", function () {\n-    const filter = this.value.toLowerCase();\n-    document.querySelectorAll(\"#paymentsBody tr\").forEach(row => {\n-        row.style.display = row.cells[1].innerText.toLowerCase().includes(filter)\n-            ? \"\"\n-            : \"none\";\n-    });\n-});\n+          if (!residentId || !serviceName || !amount || !phoneNumber) {\n+              paymentResult.className = 'text-xs mt-2 p-2 rounded-lg text-red-700 bg-red-100 block';\n+              paymentResult.textContent = 'Please fill in all fields.';\n+              return;\n+          }\n \n-document.getElementById(\"verifiedFilterInput\").addEventListener(\"input\", function () {\n-    const filter = this.value.toLowerCase();\n-    document.querySelectorAll(\"#verifiedBody tr\").forEach(row => {\n-        row.style.display = row.cells[0].innerText.toLowerCase().includes(filter)\n-            ? \"\"\n-            : \"none\";\n-    });\n-});\n+          if (isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {\n+              paymentResult.className = 'text-xs mt-2 p-2 rounded-lg text-red-700 bg-red-100 block';\n+              paymentResult.textContent = 'Amount must be a valid positive number.';\n+              return;\n+          }\n \n-//--------------------------------------\n-// EXPORT CSV & EXCEL\n-//--------------------------------------\n-function exportCSV(tableId) {\n-    const table = document.getElementById(tableId);\n-    const rows = table.querySelectorAll(\"tr\");\n+          // Disable button and show loading\n+          payBtn.disabled = true;\n+          payBtnText.textContent = 'Processing...';\n+          paymentResult.textContent = '';\n+          paymentResult.classList.add('hidden');\n \n-    const csv = [...rows]\n-        .map(r => [...r.children].map(c => c.innerText).join(\",\"))\n-        .join(\"\\n\");\n+          const result = await addPayment(residentId, serviceName, amount, phoneNumber);\n \n-    const file = new Blob([csv], { type: \"text/csv\" });\n-    const link = document.createElement(\"a\");\n-    link.href = URL.createObjectURL(file);\n-    link.download = `${tableId}.csv`;\n-    link.click();\n-}\n+          // Re-enable button\n+          payBtn.disabled = false;\n+          payBtnText.textContent = 'Simulate Payment';\n \n-function exportExcel(tableId) {\n-    const table = document.getElementById(tableId);\n-    const wb = XLSX.utils.table_to_book(table);\n-    XLSX.writeFile(wb, `${tableId}.xlsx`);\n-}\n+          // Show result\n+          if (result.success) {\n+              paymentResult.className = 'text-xs mt-2 p-2 rounded-lg text-green-700 bg-green-100 block';\n+          } else {\n+              paymentResult.className = 'text-xs mt-2 p-2 rounded-lg text-red-700 bg-red-100 block';\n+          }\n+          paymentResult.textContent = result.message;\n \n-document.getElementById(\"exportCsv\").onclick = () => exportCSV(\"paymentsTable\");\n-document.getElementById(\"exportVerifiedCsv\").onclick = () => exportCSV(\"verifiedTable\");\n-document.getElementById(\"exportBalancesCsv\").onclick = () => exportCSV(\"balanceTable\");\n-document.getElementById(\"exportExcel\").onclick = () => exportExcel(\"paymentsTable\");\n-document.getElementById(\"exportVerifiedExcel\").onclick = () => exportExcel(\"verifiedTable\");\n-document.getElementById(\"exportBalancesExcel\").onclick = () => exportExcel(\"balanceTable\");\n+          // Clear form fields, reset select to default\n+          document.getElementById('residentIdSelect').value = '';\n+          document.getElementById('serviceNameInput').value = '';\n+          document.getElementById('paymentAmountInput').value = '';\n+          document.getElementById('phoneNumberInput').value = '';\n+      });\n \n-//--------------------------------------\n-// MPESA PAYMENT\n-//--------------------------------------\n-document.getElementById(\"payBtn\").addEventListener(\"click\", async () => {\n-    const service = document.getElementById(\"serviceName\").value;\n-    const amount = document.getElementById(\"paymentAmount\").value;\n-    const phone = document.getElementById(\"phoneNumber\").value;\n+      // --- FILTERING ---\n+      document.getElementById('filterInput').addEventListener('input', (e) => {\n+          const filterTerm = e.target.value.toLowerCase();\n+          const filteredData = allPayments.filter(p =>\n+              p.ResidentID.toLowerCase().includes(filterTerm) ||\n+              p.Status.toLowerCase().includes(filterTerm) ||\n+              p.Reference.toLowerCase().includes(filterTerm)\n+          );\n+          renderPaymentsTable(filteredData, 'paymentsBody');\n+      });\n \n-    const result = document.getElementById(\"paymentResult\");\n+      document.getElementById('verifiedFilterInput').addEventListener('input', (e) => {\n+          const filterTerm = e.target.value.toLowerCase();\n+          const verified = allPayments.filter(p => p.Status === 'Verified');\n+          const filteredData = verified.filter(p =>\n+              p.ResidentID.toLowerCase().includes(filterTerm)\n+          );\n+          renderVerifiedTable(filteredData);\n+      });\n \n-    if (!service || !amount || !phone) {\n-        result.innerText = \"Please fill in all fields\";\n-        result.className = \"text-red-600 text-xs\";\n-        return;\n-    }\n \n-    result.innerText = \"Processing...\";\n-    result.className = \"text-gray-600 text-xs\";\n+      // --- EXPORT LOGIC ---\n \n-    try {\n-        const res = await axiosAuth.post(\"/residents/pay\", {\n-            serviceName: service,\n-            amount,\n-            phone\n-        });\n+      function exportTable(data, filename) {\n+          const ws = XLSX.utils.json_to_sheet(data);\n+          const wb = XLSX.utils.book_new();\n+          XLSX.utils.book_append_sheet(wb, ws, \"Data\");\n+          XLSX.writeFile(wb, filename);\n+      }\n \n-        result.innerText = res.data.message || \"Payment successful\";\n-        result.className = \"text-green-600 text-xs\";\n+      function cleanDataForExport(data) {\n+          return data.map(p => ({\n+              PaymentID: p.PaymentID,\n+              ResidentID: p.ResidentID,\n+              Amount: p.Amount,\n+              PaymentDate: formatDate(p.PaymentDate),\n+              Status: p.Status,\n+              Reference: p.Reference,\n+              PaymentMethod: p.PaymentMethod,\n+              Action: p.Action,\n+              NationalID: p.NationalID,\n+              ServiceName: p.ServiceName,\n+              PhoneNumber: p.PhoneNumber,\n+              VerifiedDate: p.VerifiedDate ? formatDate(p.VerifiedDate) : 'N/A'\n+          }));\n+      }\n \n-        document.getElementById(\"serviceName\").value = \"\";\n-        document.getElementById(\"paymentAmount\").value = \"\";\n-        document.getElementById(\"phoneNumber\").value = \"\";\n+      // Full History Export\n+      document.getElementById('exportExcel').addEventListener('click', () => {\n+          exportTable(cleanDataForExport(allPayments), 'Athi_Payment_History.xlsx');\n+      });\n+      document.getElementById('exportCsv').addEventListener('click', () => {\n+          exportTable(cleanDataForExport(allPayments), 'Athi_Payment_History.csv');\n+      });\n \n-        // reload\n-        loadPayments();\n-        loadVerifiedPayments();\n-        loadBalances();\n-        loadDashboardSummary();\n+      // Verified Payments Export\n+      document.getElementById('exportVerifiedExcel').addEventListener('click', () => {\n+          const verified = allPayments.filter(p => p.Status === 'Verified');\n+          exportTable(cleanDataForExport(verified), 'Athi_Verified_Payments.xlsx');\n+      });\n+      document.getElementById('exportVerifiedCsv').addEventListener('click', () => {\n+          const verified = allPayments.filter(p => p.Status === 'Verified');\n+          exportTable(cleanDataForExport(verified), 'Athi_Verified_Payments.csv');\n+      });\n \n-    } catch (err) {\n-        console.error(err);\n-        result.innerText = \"Payment failed\";\n-        result.className = \"text-red-600 text-xs\";\n-    }\n-});\n-\n-//--------------------------------------\n-// INITIAL LOAD\n-//--------------------------------------\n-window.addEventListener(\"DOMContentLoaded\", () => {\n-    loadDashboardSummary();\n-    loadPayments();\n-    loadVerifiedPayments();\n-    loadBalances();\n-});\n+      // Balances Export\n+      document.getElementById('exportBalancesExcel').addEventListener('click', () => {\n+          const balances = calculateBalances(allPayments); // Recalculate balances\n+          exportTable(balances.map(b => ({\n+              ResidentID: b.ResidentID,\n+              TotalPaid: b.totalPaid,\n+              TotalDue: b.totalDue,\n+              Balance: b.totalPaid - b.totalDue\n+          })), 'Athi_Resident_Balances.xlsx');\n+      });\n+      document.getElementById('exportBalancesCsv').addEventListener('click', () => {\n+          const balances = calculateBalances(allPayments);\n+          exportTable(balances.map(b => ({\n+              ResidentID: b.ResidentID,\n+              TotalPaid: b.totalPaid,\n+              TotalDue: b.totalDue,\n+              Balance: b.totalPaid - b.totalDue\n+          })), 'Athi_Resident_Balances.csv');\n+      });\n+  });\n"
                }
            ],
            "date": 1763621258549,
            "name": "Commit-0",
            "content": "//--------------------------------------\n// GLOBALS\n//--------------------------------------\nconst token = localStorage.getItem(\"accessToken\");\nif (!token) {\n    window.location.href = \"login.html\";\n}\n\nconst axiosAuth = axios.create({\n    baseURL: \"/api\",\n    headers: { Authorization: `Bearer ${token}` }\n});\n\n//--------------------------------------\n// DASHBOARD SUMMARY\n//--------------------------------------\nasync function loadDashboardSummary() {\n    try {\n        const res = await axiosAuth.get(\"/payments/summary\");\n\n        const div = document.getElementById(\"dashboardSummary\");\n        div.innerHTML = `\n            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n                <p class=\"font-bold text-indigo-700\">Total Payments</p>\n                <p class=\"text-lg\">${res.data.totalPayments}</p>\n            </div>\n\n            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n                <p class=\"font-bold text-green-700\">Verified</p>\n                <p class=\"text-lg\">${res.data.totalVerified}</p>\n            </div>\n\n            <div class=\"bg-white p-3 rounded-xl shadow text-center\">\n                <p class=\"font-bold text-red-700\">Pending</p>\n                <p class=\"text-lg\">${res.data.totalPending}</p>\n            </div>\n        `;\n    } catch (err) {\n        console.error(\"Summary load error:\", err);\n    }\n}\n\n//--------------------------------------\n// LOAD PAYMENT HISTORY\n//--------------------------------------\nasync function loadPayments() {\n    try {\n        const res = await axiosAuth.get(\"/payments\");\n        const tbody = document.getElementById(\"paymentsBody\");\n        tbody.innerHTML = \"\";\n\n        res.data.forEach(p => {\n            tbody.innerHTML += `\n                <tr>\n                    <td>${p.PaymentID}</td>\n                    <td>${p.ResidentID}</td>\n                    <td>${p.Amount}</td>\n                    <td>${new Date(p.PaymentDate).toLocaleString()}</td>\n                    <td class=\"${p.Status === 'Verified' ? 'text-green-600' : 'text-red-600'}\">${p.Status}</td>\n                    <td>${p.Reference}</td>\n                    <td>${p.PaymentMethod}</td>\n                    <td>\n                        ${p.Status !== \"Verified\"\n                            ? `<button class=\"bg-green-600 text-white px-1 rounded text-xs\"\n                                    onclick=\"verifyPayment(${p.PaymentID})\">Verify</button>`\n                            : \"✔\"}\n                    </td>\n                    <td>${p.NationalID || \"\"}</td>\n                    <td>${p.ServiceName || \"\"}</td>\n                    <td>${p.PhoneNumber || \"\"}</td>\n                    <td>${p.VerifiedDate ? new Date(p.VerifiedDate).toLocaleString() : \"\"}</td>\n                </tr>\n            `;\n        });\n\n    } catch (err) {\n        console.error(\"Error loading payments:\", err);\n    }\n}\n\n//--------------------------------------\n// VERIFY PAYMENT\n//--------------------------------------\nasync function verifyPayment(id) {\n    if (!confirm(\"Confirm payment verification?\")) return;\n\n    try {\n        await axiosAuth.put(`/payments/verify/${id}`);\n        loadPayments();\n        loadVerifiedPayments();\n        loadBalances();\n        loadDashboardSummary();\n    } catch (err) {\n        console.error(\"Verify error:\", err);\n    }\n}\n\n//--------------------------------------\n// LOAD VERIFIED PAYMENTS\n//--------------------------------------\nasync function loadVerifiedPayments() {\n    try {\n        const res = await axiosAuth.get(\"/payments/verified\");\n        const tbody = document.getElementById(\"verifiedBody\");\n        tbody.innerHTML = \"\";\n\n        res.data.forEach(v => {\n            tbody.innerHTML += `\n                <tr>\n                    <td>${v.ResidentID}</td>\n                    <td>${v.Amount}</td>\n                    <td>${v.Reference}</td>\n                    <td>${v.VerifiedDate ? new Date(v.VerifiedDate).toLocaleString() : \"\"}</td>\n                </tr>\n            `;\n        });\n\n    } catch (err) {\n        console.error(\"Verified payments load error:\", err);\n    }\n}\n\n//--------------------------------------\n// LOAD BALANCES\n//--------------------------------------\nasync function loadBalances() {\n    try {\n        const res = await axiosAuth.get(\"/payments/balances\");\n        const tbody = document.getElementById(\"balanceBody\");\n        tbody.innerHTML = \"\";\n\n        res.data.forEach(b => {\n            tbody.innerHTML += `\n                <tr>\n                    <td>${b.Resident}</td>\n                    <td>${b.TotalPaid}</td>\n                    <td>${b.TotalDue}</td>\n                    <td>${b.Balance}</td>\n                </tr>\n            `;\n        });\n\n    } catch (err) {\n        console.error(\"Balances load error:\", err);\n    }\n}\n\n//--------------------------------------\n// FILTERS\n//--------------------------------------\ndocument.getElementById(\"filterInput\").addEventListener(\"input\", function () {\n    const filter = this.value.toLowerCase();\n    document.querySelectorAll(\"#paymentsBody tr\").forEach(row => {\n        row.style.display = row.cells[1].innerText.toLowerCase().includes(filter)\n            ? \"\"\n            : \"none\";\n    });\n});\n\ndocument.getElementById(\"verifiedFilterInput\").addEventListener(\"input\", function () {\n    const filter = this.value.toLowerCase();\n    document.querySelectorAll(\"#verifiedBody tr\").forEach(row => {\n        row.style.display = row.cells[0].innerText.toLowerCase().includes(filter)\n            ? \"\"\n            : \"none\";\n    });\n});\n\n//--------------------------------------\n// EXPORT CSV & EXCEL\n//--------------------------------------\nfunction exportCSV(tableId) {\n    const table = document.getElementById(tableId);\n    const rows = table.querySelectorAll(\"tr\");\n\n    const csv = [...rows]\n        .map(r => [...r.children].map(c => c.innerText).join(\",\"))\n        .join(\"\\n\");\n\n    const file = new Blob([csv], { type: \"text/csv\" });\n    const link = document.createElement(\"a\");\n    link.href = URL.createObjectURL(file);\n    link.download = `${tableId}.csv`;\n    link.click();\n}\n\nfunction exportExcel(tableId) {\n    const table = document.getElementById(tableId);\n    const wb = XLSX.utils.table_to_book(table);\n    XLSX.writeFile(wb, `${tableId}.xlsx`);\n}\n\ndocument.getElementById(\"exportCsv\").onclick = () => exportCSV(\"paymentsTable\");\ndocument.getElementById(\"exportVerifiedCsv\").onclick = () => exportCSV(\"verifiedTable\");\ndocument.getElementById(\"exportBalancesCsv\").onclick = () => exportCSV(\"balanceTable\");\ndocument.getElementById(\"exportExcel\").onclick = () => exportExcel(\"paymentsTable\");\ndocument.getElementById(\"exportVerifiedExcel\").onclick = () => exportExcel(\"verifiedTable\");\ndocument.getElementById(\"exportBalancesExcel\").onclick = () => exportExcel(\"balanceTable\");\n\n//--------------------------------------\n// MPESA PAYMENT\n//--------------------------------------\ndocument.getElementById(\"payBtn\").addEventListener(\"click\", async () => {\n    const service = document.getElementById(\"serviceName\").value;\n    const amount = document.getElementById(\"paymentAmount\").value;\n    const phone = document.getElementById(\"phoneNumber\").value;\n\n    const result = document.getElementById(\"paymentResult\");\n\n    if (!service || !amount || !phone) {\n        result.innerText = \"Please fill in all fields\";\n        result.className = \"text-red-600 text-xs\";\n        return;\n    }\n\n    result.innerText = \"Processing...\";\n    result.className = \"text-gray-600 text-xs\";\n\n    try {\n        const res = await axiosAuth.post(\"/residents/pay\", {\n            serviceName: service,\n            amount,\n            phone\n        });\n\n        result.innerText = res.data.message || \"Payment successful\";\n        result.className = \"text-green-600 text-xs\";\n\n        document.getElementById(\"serviceName\").value = \"\";\n        document.getElementById(\"paymentAmount\").value = \"\";\n        document.getElementById(\"phoneNumber\").value = \"\";\n\n        // reload\n        loadPayments();\n        loadVerifiedPayments();\n        loadBalances();\n        loadDashboardSummary();\n\n    } catch (err) {\n        console.error(err);\n        result.innerText = \"Payment failed\";\n        result.className = \"text-red-600 text-xs\";\n    }\n});\n\n//--------------------------------------\n// INITIAL LOAD\n//--------------------------------------\nwindow.addEventListener(\"DOMContentLoaded\", () => {\n    loadDashboardSummary();\n    loadPayments();\n    loadVerifiedPayments();\n    loadBalances();\n});\n"
        }
    ]
}