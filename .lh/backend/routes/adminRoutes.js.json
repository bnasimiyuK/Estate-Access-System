{
    "sourceFile": "backend/routes/adminRoutes.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 8,
            "patches": [
                {
                    "date": 1763783827213,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763882664412,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,9 @@\n import { Router } from 'express';\n import sql from 'mssql';\n import { dbPool } from '../server.js'; // Import the established pool connection\n import { authenticateJWT } from '../middleware/authMiddleware.js'; // Assuming you have an auth middleware\n+import { getAccessChart } from '../controllers/adminController.js';\n \n const router = Router();\n \n // Apply token verification to all admin routes\n@@ -109,6 +110,6 @@\n         console.error(\"Access Chart API Error (500):\", error.message || error);\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n-\n+outer.get('/admin/accesschart', getAccessChart);\n export default router;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763882959179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -110,6 +110,6 @@\n         console.error(\"Access Chart API Error (500):\", error.message || error);\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n-outer.get('/admin/accesschart', getAccessChart);\n+router.get('/admin/accesschart', getAccessChart);\n export default router;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763892303955,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,115 +1,87 @@\n import { Router } from 'express';\n-import sql from 'mssql';\n-import { dbPool } from '../server.js'; // Import the established pool connection\n-import { authenticateJWT } from '../middleware/authMiddleware.js'; // Assuming you have an auth middleware\n-import { getAccessChart } from '../controllers/adminController.js';\n+import { dbPool } from '../server.js';\n+import { authenticateJWT } from '../middleware/authMiddleware.js';\n \n const router = Router();\n \n-// Apply token verification to all admin routes\n+// Apply JWT to all admin routes\n router.use(authenticateJWT);\n \n-// ---\n-/**\n- * @route GET /api/admin/summary\n- * @description Fetches the main dashboard summary counts.\n- * FIX: Used dbo.accesslogs and dbo.Residents to resolve \"Invalid object name\" errors.\n- */\n+// ==============================\n+// DASHBOARD SUMMARY\n+// ==============================\n router.get('/summary', async (req, res) => {\n     try {\n         const pool = await dbPool;\n \n-        // 1. Total Residents\n-        // FIX: Corrected SQL syntax by comparing Status to the integer 1 (for active)\n-        const residentsResult = await pool.request()\n+        const totalResidentsResult = await pool.request()\n             .query(\"SELECT COUNT(*) AS total FROM dbo.Residents WHERE Status = 'Active'\");\n-        const totalResidents = residentsResult.recordset[0].total;\n+        const totalResidents = totalResidentsResult.recordset[0].total;\n \n-        // 2. Pending Payments (Assuming Status column exists in dbo.Payments)\n-        const paymentsResult = await pool.request()\n+        const pendingPaymentsResult = await pool.request()\n             .query(\"SELECT COUNT(*) AS pending FROM dbo.Payments WHERE Status = 'pending'\");\n-        const pendingPayments = paymentsResult.recordset[0].pending;\n+        const pendingPayments = pendingPaymentsResult.recordset[0].pending;\n \n-        // 3. Gate Overrides Today (Assuming Overrides are logged in dbo.accesslogs with Type='Override')\n         const overridesResult = await pool.request()\n             .query(`\n                 SELECT COUNT(*) AS overrides\n                 FROM dbo.accesslogs\n-                WHERE LogType = 'Override' \n+                WHERE LogType = 'Override'\n                 AND TimestampUtc >= CAST(GETDATE() AS DATE)\n             `);\n         const overrideCount = overridesResult.recordset[0].overrides;\n \n-        // 4. Compliance Percentage (Simple calculation: (Total Residents - Pending Payments) / Total Residents * 100)\n-        let compliancePct = 0;\n-        if (totalResidents > 0) {\n-            compliancePct = Math.round(((totalResidents - pendingPayments) / totalResidents) * 100);\n-        }\n+        const compliancePct = totalResidents > 0\n+            ? Math.round(((totalResidents - pendingPayments) / totalResidents) * 100)\n+            : 0;\n \n         res.json({\n             residents: totalResidents,\n-            pendingPayments: pendingPayments,\n+            pendingPayments,\n             compliance: compliancePct,\n             overrides: overrideCount\n         });\n-\n-    } catch (error) {\n-        // Log the detailed error on the server\n-        console.error(\"Summary API Error (500):\", error.message || error);\n+    } catch (err) {\n+        console.error(\"Summary API Error:\", err);\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n \n-// ---\n-\n-/**\n- * @route GET /api/admin/accesschart\n- * @description Fetches 14 days of access attempt data for the chart.\n- * FIX: Used dbo.accesslogs to resolve \"Invalid object name\" errors.\n- */\n+// ==============================\n+// ACCESS CHART (last 14 days)\n+// ==============================\n router.get('/accesschart', async (req, res) => {\n     try {\n         const pool = await dbPool;\n-\n-        // SQL query to count access attempts (including successful and denied) by date for the last 14 days\n-        const chartResult = await pool.request().query(`\n-            SELECT\n-                CAST(TimestampUtc AS DATE) AS LogDate,\n-                COUNT(*) AS AccessCount\n+        const result = await pool.request().query(`\n+            SELECT CAST(TimestampUtc AS DATE) AS LogDate, COUNT(*) AS AccessCount\n             FROM dbo.accesslogs\n             WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n             GROUP BY CAST(TimestampUtc AS DATE)\n-            ORDER BY LogDate;\n+            ORDER BY LogDate\n         `);\n \n-        // Prepare data for Chart.js (filling in zero for days with no logs)\n-        const days = [];\n-        const counts = [];\n         const dataMap = new Map();\n-\n-        // Map results for quick lookup\n-        chartResult.recordset.forEach(row => {\n-            // ISO Date format: YYYY-MM-DD\n\\ No newline at end of file\n+        result.recordset.forEach(row => {\n             dataMap.set(row.LogDate.toISOString().substring(0, 10), row.AccessCount);\n         });\n \n-        // Generate the last 14 days and populate counts\n+        const days = [];\n+        const counts = [];\n         for (let i = 13; i >= 0; i--) {\n             const date = new Date();\n             date.setDate(date.getDate() - i);\n             const dateString = date.toISOString().substring(0, 10);\n-            \n+\n             days.push(dateString);\n             counts.push(dataMap.get(dateString) || 0);\n         }\n \n         res.json({ days, counts });\n-\n-    } catch (error) {\n-        // Log the detailed error on the server\n-        console.error(\"Access Chart API Error (500):\", error.message || error);\n+    } catch (err) {\n+        console.error(\"Access Chart API Error:\", err);\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n-router.get('/admin/accesschart', getAccessChart);\n-export default router;\n+\n+export default router;\n"
                },
                {
                    "date": 1764013337477,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -83,5 +83,26 @@\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n \n-export default router;\n+// ./routes/adminRoutes.js\n+\n+import express from 'express';\n+// 1. UPDATED IMPORT: Use the correct function name 'getAccessChart'\n+import { getAccessChart, handleAdminRequest } from '../controllers/adminController.js'; \n+\n+\n+// =========================================================================\n+// ✅ FIX for: GET /api/residents/admin/accesschart 404 \n+// =========================================================================\n+\n+// 2. UPDATED ROUTE: Use the correct function name 'getAccessChart'\n+router.get('/residents/accesschart', getAccessChart); \n+\n+\n+// =========================================================================\n+// ✅ FIX for: POST /api/admin/requests 404\n+// =========================================================================\n+\n+router.post('/requests', handleAdminRequest);\n+\n+export default router;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1764013573857,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -83,26 +83,6 @@\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n \n-// ./routes/adminRoutes.js\n-\n-import express from 'express';\n-// 1. UPDATED IMPORT: Use the correct function name 'getAccessChart'\n-import { getAccessChart, handleAdminRequest } from '../controllers/adminController.js'; \n-\n-\n-// =========================================================================\n-// ✅ FIX for: GET /api/residents/admin/accesschart 404 \n-// =========================================================================\n-\n-// 2. UPDATED ROUTE: Use the correct function name 'getAccessChart'\n-router.get('/residents/accesschart', getAccessChart); \n-\n-\n-// =========================================================================\n-// ✅ FIX for: POST /api/admin/requests 404\n-// =========================================================================\n-\n-router.post('/requests', handleAdminRequest);\n-\n-export default router;\n\\ No newline at end of file\n+v\n+export default router;\n"
                },
                {
                    "date": 1764013589012,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -83,6 +83,6 @@\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n \n-v\n+\n export default router;\n"
                },
                {
                    "date": 1764014974578,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -83,6 +83,5 @@\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n \n-\n export default router;\n"
                },
                {
                    "date": 1764015117535,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,86 +1,92 @@\n-import { Router } from 'express';\n-import { dbPool } from '../server.js';\n-import { authenticateJWT } from '../middleware/authMiddleware.js';\n+import express from \"express\";\n+import sql from \"mssql\";\n+import { authenticateJWT, isAdmin } from \"../middleware/authMiddleware.js\";\n+import { dbPool } from \"../server.js\";\n \n-const router = Router();\n+const router = express.Router();\n \n-// Apply JWT to all admin routes\n-router.use(authenticateJWT);\n-\n-// ==============================\n-// DASHBOARD SUMMARY\n-// ==============================\n-router.get('/summary', async (req, res) => {\n+/* ============================================================\n+   DASHBOARD SUMMARY\n+=============================================================== */\n+router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, async (req, res) => {\n     try {\n         const pool = await dbPool;\n \n-        const totalResidentsResult = await pool.request()\n-            .query(\"SELECT COUNT(*) AS total FROM dbo.Residents WHERE Status = 'Active'\");\n-        const totalResidents = totalResidentsResult.recordset[0].total;\n+        const result = await pool.request().query(`\n+            SELECT\n+                (SELECT COUNT(*) FROM Residents WHERE Status='Approved') AS TotalResidents,\n+                (SELECT COUNT(*) FROM Visitors) AS TotalVisitors,\n+                (SELECT COUNT(*) FROM AccessLogs) AS TotalAccessLogs,\n+                (SELECT COUNT(*) FROM MembershipRequests WHERE Status='Pending') AS PendingRequests\n+        `);\n \n-        const pendingPaymentsResult = await pool.request()\n-            .query(\"SELECT COUNT(*) AS pending FROM dbo.Payments WHERE Status = 'pending'\");\n-        const pendingPayments = pendingPaymentsResult.recordset[0].pending;\n+        res.status(200).json(result.recordset[0]);\n+    } catch (error) {\n+        console.error(\"Error loading dashboard summary:\", error);\n+        res.status(500).json({ message: \"Server error\" });\n+    }\n+});\n \n-        const overridesResult = await pool.request()\n-            .query(`\n-                SELECT COUNT(*) AS overrides\n-                FROM dbo.accesslogs\n-                WHERE LogType = 'Override'\n-                AND TimestampUtc >= CAST(GETDATE() AS DATE)\n-            `);\n-        const overrideCount = overridesResult.recordset[0].overrides;\n+/* ============================================================\n+   ACCESS CHART\n+=============================================================== */\n+router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, async (req, res) => {\n+    try {\n+        const pool = await dbPool;\n \n-        const compliancePct = totalResidents > 0\n-            ? Math.round(((totalResidents - pendingPayments) / totalResidents) * 100)\n-            : 0;\n+        const result = await pool.request().query(`\n+            SELECT \n+                FORMAT(AccessTime, 'yyyy-MM') AS Month,\n+                COUNT(*) AS TotalAccess\n+            FROM AccessLogs\n+            GROUP BY FORMAT(AccessTime, 'yyyy-MM')\n+            ORDER BY Month\n+        `);\n \n-        res.json({\n-            residents: totalResidents,\n-            pendingPayments,\n-            compliance: compliancePct,\n-            overrides: overrideCount\n-        });\n-    } catch (err) {\n-        console.error(\"Summary API Error:\", err);\n+        res.status(200).json(result.recordset);\n+    } catch (error) {\n+        console.error(\"Error fetching access chart:\", error);\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n \n-// ==============================\n-// ACCESS CHART (last 14 days)\n-// ==============================\n-router.get('/accesschart', async (req, res) => {\n+/* ============================================================\n+   APPROVED RESIDENTS\n+=============================================================== */\n+router.get(\"/residents/approved\", authenticateJWT, isAdmin, async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const result = await pool.request().query(`\n-            SELECT CAST(TimestampUtc AS DATE) AS LogDate, COUNT(*) AS AccessCount\n-            FROM dbo.accesslogs\n-            WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n-            GROUP BY CAST(TimestampUtc AS DATE)\n-            ORDER BY LogDate\n+            SELECT ResidentID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName \n+            FROM Residents\n+            WHERE Status = 'Approved'\n         `);\n \n-        const dataMap = new Map();\n-        result.recordset.forEach(row => {\n-            dataMap.set(row.LogDate.toISOString().substring(0, 10), row.AccessCount);\n-        });\n+        res.status(200).json(result.recordset);\n+    } catch (error) {\n+        console.error(\"Error fetching approved residents:\", error);\n+        res.status(500).json({ message: \"Server error\" });\n+    }\n+});\n \n-        const days = [];\n-        const counts = [];\n-        for (let i = 13; i >= 0; i--) {\n-            const date = new Date();\n-            date.setDate(date.getDate() - i);\n-            const dateString = date.toISOString().substring(0, 10);\n+/* ============================================================\n+   PENDING MEMBERSHIP REQUESTS\n+=============================================================== */\n+router.get(\"/residents/pending\", authenticateJWT, isAdmin, async (req, res) => {\n+    try {\n+        const pool = await dbPool;\n+        const result = await pool.request().query(`\n+            SELECT RequestID, ResidentName, NationalID, PhoneNumber, Email,\n+                   HouseNumber, CourtName, RoleName, Status, RequestedAt\n+            FROM MembershipRequests\n+            WHERE Status = 'Pending'\n+            ORDER BY RequestedAt DESC\n+        `);\n \n-            days.push(dateString);\n-            counts.push(dataMap.get(dateString) || 0);\n-        }\n-\n-        res.json({ days, counts });\n-    } catch (err) {\n-        console.error(\"Access Chart API Error:\", err);\n+        res.status(200).json(result.recordset);\n+    } catch (error) {\n+        console.error(\"Error fetching pending requests:\", error);\n         res.status(500).json({ message: \"Server error\" });\n     }\n });\n \n"
                }
            ],
            "date": 1763783827213,
            "name": "Commit-0",
            "content": "import { Router } from 'express';\nimport sql from 'mssql';\nimport { dbPool } from '../server.js'; // Import the established pool connection\nimport { authenticateJWT } from '../middleware/authMiddleware.js'; // Assuming you have an auth middleware\n\nconst router = Router();\n\n// Apply token verification to all admin routes\nrouter.use(authenticateJWT);\n\n// ---\n/**\n * @route GET /api/admin/summary\n * @description Fetches the main dashboard summary counts.\n * FIX: Used dbo.accesslogs and dbo.Residents to resolve \"Invalid object name\" errors.\n */\nrouter.get('/summary', async (req, res) => {\n    try {\n        const pool = await dbPool;\n\n        // 1. Total Residents\n        // FIX: Corrected SQL syntax by comparing Status to the integer 1 (for active)\n        const residentsResult = await pool.request()\n            .query(\"SELECT COUNT(*) AS total FROM dbo.Residents WHERE Status = 'Active'\");\n        const totalResidents = residentsResult.recordset[0].total;\n\n        // 2. Pending Payments (Assuming Status column exists in dbo.Payments)\n        const paymentsResult = await pool.request()\n            .query(\"SELECT COUNT(*) AS pending FROM dbo.Payments WHERE Status = 'pending'\");\n        const pendingPayments = paymentsResult.recordset[0].pending;\n\n        // 3. Gate Overrides Today (Assuming Overrides are logged in dbo.accesslogs with Type='Override')\n        const overridesResult = await pool.request()\n            .query(`\n                SELECT COUNT(*) AS overrides\n                FROM dbo.accesslogs\n                WHERE LogType = 'Override' \n                AND TimestampUtc >= CAST(GETDATE() AS DATE)\n            `);\n        const overrideCount = overridesResult.recordset[0].overrides;\n\n        // 4. Compliance Percentage (Simple calculation: (Total Residents - Pending Payments) / Total Residents * 100)\n        let compliancePct = 0;\n        if (totalResidents > 0) {\n            compliancePct = Math.round(((totalResidents - pendingPayments) / totalResidents) * 100);\n        }\n\n        res.json({\n            residents: totalResidents,\n            pendingPayments: pendingPayments,\n            compliance: compliancePct,\n            overrides: overrideCount\n        });\n\n    } catch (error) {\n        // Log the detailed error on the server\n        console.error(\"Summary API Error (500):\", error.message || error);\n        res.status(500).json({ message: \"Server error\" });\n    }\n});\n\n// ---\n\n/**\n * @route GET /api/admin/accesschart\n * @description Fetches 14 days of access attempt data for the chart.\n * FIX: Used dbo.accesslogs to resolve \"Invalid object name\" errors.\n */\nrouter.get('/accesschart', async (req, res) => {\n    try {\n        const pool = await dbPool;\n\n        // SQL query to count access attempts (including successful and denied) by date for the last 14 days\n        const chartResult = await pool.request().query(`\n            SELECT\n                CAST(TimestampUtc AS DATE) AS LogDate,\n                COUNT(*) AS AccessCount\n            FROM dbo.accesslogs\n            WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n            GROUP BY CAST(TimestampUtc AS DATE)\n            ORDER BY LogDate;\n        `);\n\n        // Prepare data for Chart.js (filling in zero for days with no logs)\n        const days = [];\n        const counts = [];\n        const dataMap = new Map();\n\n        // Map results for quick lookup\n        chartResult.recordset.forEach(row => {\n            // ISO Date format: YYYY-MM-DD\n            dataMap.set(row.LogDate.toISOString().substring(0, 10), row.AccessCount);\n        });\n\n        // Generate the last 14 days and populate counts\n        for (let i = 13; i >= 0; i--) {\n            const date = new Date();\n            date.setDate(date.getDate() - i);\n            const dateString = date.toISOString().substring(0, 10);\n            \n            days.push(dateString);\n            counts.push(dataMap.get(dateString) || 0);\n        }\n\n        res.json({ days, counts });\n\n    } catch (error) {\n        // Log the detailed error on the server\n        console.error(\"Access Chart API Error (500):\", error.message || error);\n        res.status(500).json({ message: \"Server error\" });\n    }\n});\n\nexport default router;"
        }
    ]
}