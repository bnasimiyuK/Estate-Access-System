{
    "sourceFile": "backend/middleware/authMiddleware.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1763668053706,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763668948105,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,6 +74,8 @@\n         return res.status(403).json({ success: false, message: \"Forbidden: Admin privileges required.\" });\n     }\n     next();\n };\n+\n+\n // Alias for routes\n export const verifyToken = authenticateJWT;\n"
                },
                {
                    "date": 1763695525824,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,78 +4,53 @@\n dotenv.config();\n \n const JWT_SECRET = process.env.JWT_SECRET || \"supersecretkey\";\n \n-/**\n- * Generates a JWT token for the provided payload.\n- */\n+/* ----------------------------------------\n+   Generate Token\n+---------------------------------------- */\n export function generateToken(payload) {\n     return jwt.sign(payload, JWT_SECRET, { expiresIn: \"14d\" });\n }\n \n-/**\n- * Middleware to verify the JWT from the Authorization header and attach user data to req.user.\n- */\n-export const authenticateJWT = (req, res, next) => {\n+/* ----------------------------------------\n+   Verify Token (MAIN middleware)\n+---------------------------------------- */\n+export function verifyToken(req, res, next) {\n     const authHeader = req.headers[\"authorization\"];\n     if (!authHeader) {\n         return res.status(401).json({ success: false, message: \"No token provided.\" });\n     }\n \n-    const parts = authHeader.split(\" \");\n-    if (parts.length !== 2 || parts[0] !== \"Bearer\") {\n-        return res.status(401).json({ success: false, message: \"Invalid token format.\" });\n-    }\n+    const token = authHeader.split(\" \")[1];\n \n-    const token = parts[1];\n-\n     jwt.verify(token, JWT_SECRET, (err, decoded) => {\n         if (err) {\n-            console.error(\"Token verification failed:\", err.message);\n             return res.status(401).json({ success: false, message: \"Invalid or expired token.\" });\n         }\n \n-        /**\n-         * Attach user info:\n-         * - Residents have ResidentID\n-         * - Admin/Security have userId\n-         * - role is always lowercase for middleware checks\n-         */\n         req.user = {\n-            ResidentID: decoded.ResidentID || null,\n-            userId: decoded.userId || null,       // admin/security ID\n+            id: decoded.ResidentID || decoded.userId || null,\n             role: (decoded.role || \"resident\").toLowerCase(),\n             fullName: decoded.fullName || \"\",\n             email: decoded.email || \"\",\n             NationalID: decoded.NationalID || \"\"\n         };\n \n         next();\n     });\n-};\n+}\n \n-/**\n- * Middleware to restrict access to users with the 'admin' role.\n- */\n-export const requireAdmin = (req, res, next) => {\n+/* ----------------------------------------\n+   Only Admin OR Security\n+---------------------------------------- */\n+export function isAdmin(req, res, next) {\n     if (!req.user || !req.user.role) {\n-        return res.status(401).json({ error: \"Access denied. Role information missing.\" });\n+        return res.status(403).json({ error: \"Access denied.\" });\n     }\n-const role = req.user.role;\n-    if (role !== 'admin' && role !=='security') {\n-        return res.status(403).json({ error: \"Access denied. Admin privileges required.\" });\n+\n+    if (req.user.role !== \"admin\" && req.user.role !== \"security\") {\n+        return res.status(403).json({ error: \"Admin/Security access required.\" });\n     }\n \n     next();\n-};\n-export const verifyAdmin = (req, res, next) => {\n-    // 1. Assume verifyToken has already run and attached req.user\n-    if (!req.user || req.user.role !== 'Admin') {\n-        // This sends the 403 status expected by the client.\n-        return res.status(403).json({ success: false, message: \"Forbidden: Admin privileges required.\" });\n-    }\n-    next();\n-};\n-\n-\n-// Alias for routes\n-export const verifyToken = authenticateJWT;\n+}\n"
                },
                {
                    "date": 1763696336648,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,56 +1,66 @@\n+// ===============================================\n+// authMiddleware.js (FINAL CLEAN VERSION)\n+// ===============================================\n import jwt from \"jsonwebtoken\";\n import dotenv from \"dotenv\";\n \n dotenv.config();\n \n const JWT_SECRET = process.env.JWT_SECRET || \"supersecretkey\";\n \n-/* ----------------------------------------\n-   Generate Token\n----------------------------------------- */\n+/* ----------------------------------------------\n+   Generate JWT Token\n+---------------------------------------------- */\n export function generateToken(payload) {\n     return jwt.sign(payload, JWT_SECRET, { expiresIn: \"14d\" });\n }\n \n-/* ----------------------------------------\n-   Verify Token (MAIN middleware)\n----------------------------------------- */\n-export function verifyToken(req, res, next) {\n-    const authHeader = req.headers[\"authorization\"];\n-    if (!authHeader) {\n-        return res.status(401).json({ success: false, message: \"No token provided.\" });\n+/* ----------------------------------------------\n+   authenticateJWT\n+   Validates token and attaches decoded user info\n+---------------------------------------------- */\n+export const authenticateJWT = (req, res, next) => {\n+    const authHeader = req.headers.authorization;\n+\n+    if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\n+        return res.status(401).json({ message: \"Access denied. No token provided.\" });\n     }\n \n     const token = authHeader.split(\" \")[1];\n \n-    jwt.verify(token, JWT_SECRET, (err, decoded) => {\n-        if (err) {\n-            return res.status(401).json({ success: false, message: \"Invalid or expired token.\" });\n-        }\n+    try {\n+        const decoded = jwt.verify(token, JWT_SECRET);\n \n+        // Standardized user structure\n         req.user = {\n-            id: decoded.ResidentID || decoded.userId || null,\n-            role: (decoded.role || \"resident\").toLowerCase(),\n-            fullName: decoded.fullName || \"\",\n-            email: decoded.email || \"\",\n-            NationalID: decoded.NationalID || \"\"\n+            UserID: decoded.userId || decoded.ResidentID || null,\n+            ResidentID: decoded.ResidentID || null,\n+            Email: decoded.email || \"\",\n+            FullName: decoded.fullName || \"\",\n+            NationalID: decoded.NationalID || \"\",\n+            Role: (decoded.role || decoded.Role || \"resident\").toLowerCase() // â† normalize role\n         };\n \n         next();\n-    });\n-}\n+    } catch (err) {\n+        return res.status(403).json({ message: \"Invalid or expired token.\" });\n+    }\n+};\n \n-/* ----------------------------------------\n-   Only Admin OR Security\n----------------------------------------- */\n-export function isAdmin(req, res, next) {\n-    if (!req.user || !req.user.role) {\n-        return res.status(403).json({ error: \"Access denied.\" });\n+/* ----------------------------------------------\n+   isAdmin\n+   Only Admin OR Security can access certain routes\n+---------------------------------------------- */\n+export const isAdmin = (req, res, next) => {\n+    if (!req.user || !req.user.Role) {\n+        return res.status(403).json({ error: \"Access denied. No role found.\" });\n     }\n \n-    if (req.user.role !== \"admin\" && req.user.role !== \"security\") {\n+    const role = req.user.Role.toLowerCase();\n+\n+    if (role !== \"admin\" && role !== \"security\") {\n         return res.status(403).json({ error: \"Admin/Security access required.\" });\n     }\n \n     next();\n-}\n+};\n"
                }
            ],
            "date": 1763668053706,
            "name": "Commit-0",
            "content": "import jwt from \"jsonwebtoken\";\nimport dotenv from \"dotenv\";\n\ndotenv.config();\n\nconst JWT_SECRET = process.env.JWT_SECRET || \"supersecretkey\";\n\n/**\n * Generates a JWT token for the provided payload.\n */\nexport function generateToken(payload) {\n    return jwt.sign(payload, JWT_SECRET, { expiresIn: \"14d\" });\n}\n\n/**\n * Middleware to verify the JWT from the Authorization header and attach user data to req.user.\n */\nexport const authenticateJWT = (req, res, next) => {\n    const authHeader = req.headers[\"authorization\"];\n    if (!authHeader) {\n        return res.status(401).json({ success: false, message: \"No token provided.\" });\n    }\n\n    const parts = authHeader.split(\" \");\n    if (parts.length !== 2 || parts[0] !== \"Bearer\") {\n        return res.status(401).json({ success: false, message: \"Invalid token format.\" });\n    }\n\n    const token = parts[1];\n\n    jwt.verify(token, JWT_SECRET, (err, decoded) => {\n        if (err) {\n            console.error(\"Token verification failed:\", err.message);\n            return res.status(401).json({ success: false, message: \"Invalid or expired token.\" });\n        }\n\n        /**\n         * Attach user info:\n         * - Residents have ResidentID\n         * - Admin/Security have userId\n         * - role is always lowercase for middleware checks\n         */\n        req.user = {\n            ResidentID: decoded.ResidentID || null,\n            userId: decoded.userId || null,       // admin/security ID\n            role: (decoded.role || \"resident\").toLowerCase(),\n            fullName: decoded.fullName || \"\",\n            email: decoded.email || \"\",\n            NationalID: decoded.NationalID || \"\"\n        };\n\n        next();\n    });\n};\n\n/**\n * Middleware to restrict access to users with the 'admin' role.\n */\nexport const requireAdmin = (req, res, next) => {\n    if (!req.user || !req.user.role) {\n        return res.status(401).json({ error: \"Access denied. Role information missing.\" });\n    }\nconst role = req.user.role;\n    if (role !== 'admin' && role !=='security') {\n        return res.status(403).json({ error: \"Access denied. Admin privileges required.\" });\n    }\n\n    next();\n};\nexport const verifyAdmin = (req, res, next) => {\n    // 1. Assume verifyToken has already run and attached req.user\n    if (!req.user || req.user.role !== 'Admin') {\n        // This sends the 403 status expected by the client.\n        return res.status(403).json({ success: false, message: \"Forbidden: Admin privileges required.\" });\n    }\n    next();\n};\n// Alias for routes\nexport const verifyToken = authenticateJWT;\n"
        }
    ]
}