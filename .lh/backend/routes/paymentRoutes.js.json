{
    "sourceFile": "backend/routes/paymentRoutes.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 9,
            "patches": [
                {
                    "date": 1763621546663,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763621747753,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,10 @@\n   getPayments,\n   getVerifiedPayments,\n   getBalances,\n   makePayment,\n-  verifyPayment\n+  verifyPayment,\n+  getPaymentSummary\n } from \"../controllers/paymentsController.js\";\n \n import { verifyToken } from \"../middleware/verifyToken.js\";\n import { getPool } from \"../db.js\"; // assuming you have a db.js exporting getPool\n"
                },
                {
                    "date": 1763626684650,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,29 +1,30 @@\n-// backend/routes/paymentsRoutes.js\n import express from \"express\";\n import {\n-  getPayments,\n-  getVerifiedPayments,\n-  getBalances,\n-  makePayment,\n-  verifyPayment,\n-  getPaymentSummary\n+ getPayments,\n+ getVerifiedPayments,\n+ getBalances,\n+ makePayment,\n+ verifyPayment,\n+ getPaymentSummary\n } from \"../controllers/paymentsController.js\";\n+import { dbPool } from \"../server.js\"; // Import dbPool directly from server\n+import { verifyToken } from \"../middleware/authMiddleware.js\"; // Use common middleware import\n \n-import { verifyToken } from \"../middleware/verifyToken.js\";\n-import { getPool } from \"../db.js\"; // assuming you have a db.js exporting getPool\n-\n const router = express.Router();\n \n+// Helper to get pool (replaces getPool() from assumed db.js)\n+const getPool = () => dbPool; \n+\n // ------------------ Payments ------------------\n \n-// Get all payments\n+// Get all payments (Admin & Resident specific)\n router.get(\"/\", verifyToken, getPayments);\n \n-// Get verified payments\n+// Get verified payments (Admin & Resident specific)\n router.get(\"/verified\", verifyToken, getVerifiedPayments);\n \n-// Get balances\n+// Get balances (Admin & Resident specific)\n router.get(\"/balances\", verifyToken, getBalances);\n \n // Make payment\n router.post(\"/make\", verifyToken, makePayment);\n@@ -31,79 +32,85 @@\n // Verify payment (admin only)\n router.put(\"/verify/:id\", verifyToken, verifyPayment);\n \n // ------------------ Payment Reports / Summaries ------------------\n-// Add this to backend/routes/paymentRoutes.js (alongside other routes)\n \n // Get payment summary for dashboard\n router.get(\"/summary\", verifyToken, getPaymentSummary);\n+\n // Monthly summary (bar/line chart)\n router.get(\"/summary/monthly\", verifyToken, async (req, res) => {\n-  try {\n-    const pool = await getPool();\n+ try {\n+  const pool = await getPool();\n \n-    const result = await pool.request().query(`\n-      SELECT \n-        DATENAME(MONTH, PaymentDate) AS MonthName,\n-        SUM(Amount) AS TotalAmount\n-      FROM Payments\n-      GROUP BY DATENAME(MONTH, PaymentDate), MONTH(PaymentDate)\n-      ORDER BY MONTH(PaymentDate)\n-    `);\n+  const result = await pool.request().query(`\n+   SELECT \n+    FORMAT(PaymentDate, 'yyyy-MM') AS PaymentMonth,\n+    DATENAME(MONTH, PaymentDate) AS MonthName,\n+    ISNULL(SUM(Amount), 0) AS TotalAmount\n+   FROM Payments\n+   WHERE Status = 'Verified' -- Only count verified payments\n+   GROUP BY FORMAT(PaymentDate, 'yyyy-MM'), DATENAME(MONTH, PaymentDate)\n+   ORDER BY PaymentMonth;\n+  `);\n \n-    res.json({\n-      labels: result.recordset.map(r => r.MonthName),\n-      totals: result.recordset.map(r => r.TotalAmount)\n-    });\n-  } catch (err) {\n-    console.error(\"Monthly summary error:\", err);\n-    res.status(500).json({ message: \"Failed to load monthly summary\" });\n-  }\n+  res.json({\n+   labels: result.recordset.map(r => r.MonthName),\n+   totals: result.recordset.map(r => parseFloat(r.TotalAmount))\n+  });\n+ } catch (err) {\n+  console.error(\"Monthly summary error:\", err);\n+  res.status(500).json({ message: \"Failed to load monthly summary\" });\n+ }\n });\n \n // Payment method distribution (donut chart)\n router.get(\"/summary/methods\", verifyToken, async (req, res) => {\n-  try {\n-    const pool = await getPool();\n+ try {\n+  const pool = await getPool();\n \n-    const result = await pool.request().query(`\n-      SELECT Method, COUNT(*) AS Count\n-      FROM Payments\n-      GROUP BY Method\n-    `);\n+  const result = await pool.request().query(`\n+   SELECT PaymentMethod, COUNT(*) AS Count\n+   FROM Payments\n+   WHERE Status = 'Verified' -- Only count verified payments\n+   GROUP BY PaymentMethod\n+  `);\n \n-    res.json({\n-      labels: result.recordset.map(r => r.Method),\n-      counts: result.recordset.map(r => r.Count)\n-    });\n-  } catch (err) {\n-    console.error(\"Payment method summary error:\", err);\n-    res.status(500).json({ message: \"Failed to load method summary\" });\n-  }\n+  res.json({\n+   labels: result.recordset.map(r => r.PaymentMethod),\n+   counts: result.recordset.map(r => parseInt(r.Count))\n+  });\n+ } catch (err) {\n+  console.error(\"Payment method summary error:\", err);\n+  res.status(500).json({ message: \"Failed to load method summary\" });\n+ }\n });\n \n // Recent payments\n router.get(\"/recent\", verifyToken, async (req, res) => {\n   try {\n-    const limit = Number(req.query.limit) || 20;\n+    const limit = Number(req.query.limit) || 10;\n     const pool = await getPool();\n-\n+  \n+    // NOTE: Assuming the Payments table joins to Residents to get the name\n     const result = await pool.request().query(`\n       SELECT TOP(${limit})\n-        PaymentID,\n-        ResidentName,\n-        Amount,\n-        Method,\n-        PaymentDate,\n-        Reference\n-      FROM Payments\n-      ORDER BY PaymentDate DESC\n+        p.PaymentID,\n+        r.ResidentName,\n+        p.Amount,\n+        p.PaymentMethod,\n+        p.PaymentDate,\n+        p.Reference,\n+                p.Status\n+      FROM Payments p\n+      JOIN Residents r ON p.ResidentID = r.ResidentID\n+      ORDER BY p.PaymentDate DESC\n     `);\n-\n+  \n     res.json(result.recordset);\n   } catch (err) {\n     console.error(\"Recent payments error:\", err);\n     res.status(500).json({ message: \"Failed to fetch payments\" });\n   }\n });\n \n-export default router;\n+export default router;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763632334875,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,20 +1,21 @@\n import express from \"express\";\n+import { dbPool } from \"../server.js\"; // Direct pool import\n+import { verifyToken } from \"../middleware/authMiddleware.js\";\n import {\n- getPayments,\n- getVerifiedPayments,\n- getBalances,\n- makePayment,\n- verifyPayment,\n- getPaymentSummary\n-} from \"../controllers/paymentsController.js\";\n-import { dbPool } from \"../server.js\"; // Import dbPool directly from server\n-import { verifyToken } from \"../middleware/authMiddleware.js\"; // Use common middleware import\n+  getPayments,\n+  getVerifiedPayments,\n+  getBalances,\n+  makePayment,\n+  verifyPayment,\n+  getPaymentSummary,\n+  verifyPaymentAndArchive\n+} from \"../controllers/paymentsController.js\"; // Consolidated controller imports\n \n const router = express.Router();\n \n-// Helper to get pool (replaces getPool() from assumed db.js)\n-const getPool = () => dbPool; \n+// Helper to get the database pool\n+const getPool = () => dbPool;\n \n // ------------------ Payments ------------------\n \n // Get all payments (Admin & Resident specific)\n@@ -25,92 +26,89 @@\n \n // Get balances (Admin & Resident specific)\n router.get(\"/balances\", verifyToken, getBalances);\n \n-// Make payment\n-router.post(\"/make\", verifyToken, makePayment);\n+// Make a payment\n+router.post(\"/\", verifyToken, makePayment);\n \n-// Verify payment (admin only)\n-router.put(\"/verify/:id\", verifyToken, verifyPayment);\n+// Verify a pending payment (admin only)\n+router.patch(\"/:id/verify\", verifyToken, verifyPaymentAndArchive);\n \n // ------------------ Payment Reports / Summaries ------------------\n \n // Get payment summary for dashboard\n router.get(\"/summary\", verifyToken, getPaymentSummary);\n \n // Monthly summary (bar/line chart)\n router.get(\"/summary/monthly\", verifyToken, async (req, res) => {\n- try {\n-  const pool = await getPool();\n+  try {\n+    const pool = await getPool();\n+    const result = await pool.request().query(`\n+      SELECT \n+        FORMAT(PaymentDate, 'yyyy-MM') AS PaymentMonth,\n+        DATENAME(MONTH, PaymentDate) AS MonthName,\n+        ISNULL(SUM(Amount), 0) AS TotalAmount\n+      FROM Payments\n+      WHERE Status = 'Verified'\n+      GROUP BY FORMAT(PaymentDate, 'yyyy-MM'), DATENAME(MONTH, PaymentDate)\n+      ORDER BY PaymentMonth;\n+    `);\n \n-  const result = await pool.request().query(`\n-   SELECT \n-    FORMAT(PaymentDate, 'yyyy-MM') AS PaymentMonth,\n-    DATENAME(MONTH, PaymentDate) AS MonthName,\n-    ISNULL(SUM(Amount), 0) AS TotalAmount\n-   FROM Payments\n-   WHERE Status = 'Verified' -- Only count verified payments\n-   GROUP BY FORMAT(PaymentDate, 'yyyy-MM'), DATENAME(MONTH, PaymentDate)\n-   ORDER BY PaymentMonth;\n-  `);\n-\n-  res.json({\n-   labels: result.recordset.map(r => r.MonthName),\n-   totals: result.recordset.map(r => parseFloat(r.TotalAmount))\n-  });\n- } catch (err) {\n-  console.error(\"Monthly summary error:\", err);\n-  res.status(500).json({ message: \"Failed to load monthly summary\" });\n- }\n+    res.json({\n+      labels: result.recordset.map(r => r.MonthName),\n+      totals: result.recordset.map(r => parseFloat(r.TotalAmount))\n+    });\n+  } catch (err) {\n+    console.error(\"Monthly summary error:\", err);\n+    res.status(500).json({ message: \"Failed to load monthly summary\" });\n+  }\n });\n \n // Payment method distribution (donut chart)\n router.get(\"/summary/methods\", verifyToken, async (req, res) => {\n- try {\n-  const pool = await getPool();\n+  try {\n+    const pool = await getPool();\n+    const result = await pool.request().query(`\n+      SELECT PaymentMethod, COUNT(*) AS Count\n+      FROM Payments\n+      WHERE Status = 'Verified'\n+      GROUP BY PaymentMethod\n+    `);\n \n-  const result = await pool.request().query(`\n-   SELECT PaymentMethod, COUNT(*) AS Count\n-   FROM Payments\n-   WHERE Status = 'Verified' -- Only count verified payments\n-   GROUP BY PaymentMethod\n-  `);\n-\n-  res.json({\n-   labels: result.recordset.map(r => r.PaymentMethod),\n-   counts: result.recordset.map(r => parseInt(r.Count))\n-  });\n- } catch (err) {\n-  console.error(\"Payment method summary error:\", err);\n-  res.status(500).json({ message: \"Failed to load method summary\" });\n\\ No newline at end of file\n- }\n+    res.json({\n+      labels: result.recordset.map(r => r.PaymentMethod),\n+      counts: result.recordset.map(r => parseInt(r.Count))\n+    });\n+  } catch (err) {\n+    console.error(\"Payment method summary error:\", err);\n+    res.status(500).json({ message: \"Failed to load method summary\" });\n+  }\n });\n \n-// Recent payments\n+// Recent payments (with optional limit)\n router.get(\"/recent\", verifyToken, async (req, res) => {\n   try {\n     const limit = Number(req.query.limit) || 10;\n     const pool = await getPool();\n-  \n-    // NOTE: Assuming the Payments table joins to Residents to get the name\n+\n     const result = await pool.request().query(`\n       SELECT TOP(${limit})\n         p.PaymentID,\n         r.ResidentName,\n         p.Amount,\n         p.PaymentMethod,\n         p.PaymentDate,\n         p.Reference,\n-                p.Status\n+        p.Status\n       FROM Payments p\n       JOIN Residents r ON p.ResidentID = r.ResidentID\n       ORDER BY p.PaymentDate DESC\n     `);\n-  \n+\n     res.json(result.recordset);\n   } catch (err) {\n     console.error(\"Recent payments error:\", err);\n     res.status(500).json({ message: \"Failed to fetch payments\" });\n   }\n });\n \n-export default router;\n+export default router;\n"
                },
                {
                    "date": 1763634114990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,114 +1,204 @@\n-import express from \"express\";\n-import { dbPool } from \"../server.js\"; // Direct pool import\n-import { verifyToken } from \"../middleware/authMiddleware.js\";\n-import {\n-  getPayments,\n-  getVerifiedPayments,\n-  getBalances,\n-  makePayment,\n-  verifyPayment,\n-  getPaymentSummary,\n-  verifyPaymentAndArchive\n-} from \"../controllers/paymentsController.js\"; // Consolidated controller imports\n+import sql from 'mssql';\n+import { dbConfig } from '../config/dbConfig.js';\n+import axios from 'axios';\n+import dotenv from 'dotenv';\n+import moment from 'moment';\n \n-const router = express.Router();\n+dotenv.config();\n \n-// Helper to get the database pool\n-const getPool = () => dbPool;\n+// M-Pesa API details from .env\n+const {\n+    MPESA_SHORTCODE,\n+    MPESA_PASSKEY,\n+    MPESA_CONSUMER_KEY,\n+    MPESA_CONSUMER_SECRET,\n+    MPESA_CALLBACK_URL\n+} = process.env;\n \n-// ------------------ Payments ------------------\n+// Helper function to get M-Pesa access token\n+const getAccessToken = async () => {\n+    const auth = Buffer.from(`${MPESA_CONSUMER_KEY}:${MPESA_CONSUMER_SECRET}`).toString('base64');\n+    const url = 'https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials';\n \n-// Get all payments (Admin & Resident specific)\n-router.get(\"/\", verifyToken, getPayments);\n+    try {\n+        const response = await axios.get(url, {\n+            headers: {\n+                Authorization: `Basic ${auth}`,\n+            },\n+        });\n+        return response.data.access_token;\n+    } catch (error) {\n+        console.error('Error getting M-Pesa access token:', error.message);\n+        throw new Error('Failed to get M-Pesa access token');\n+    }\n+};\n \n-// Get verified payments (Admin & Resident specific)\n-router.get(\"/verified\", verifyToken, getVerifiedPayments);\n+/**\n+ * Initiates the M-Pesa STK Push payment process.\n+ * Requires: residentId, amount, phoneNumber\n+ */\n+export const stkPush = async (req, res) => {\n+    const { residentId, amount, phoneNumber } = req.body;\n \n-// Get balances (Admin & Resident specific)\n-router.get(\"/balances\", verifyToken, getBalances);\n+    if (!residentId || !amount || !phoneNumber) {\n+        return res.status(400).json({ message: 'Missing required fields: residentId, amount, and phoneNumber.' });\n+    }\n \n-// Make a payment\n-router.post(\"/\", verifyToken, makePayment);\n+    try {\n+        const accessToken = await getAccessToken();\n+        const timestamp = moment().format('YYYYMMDDHHmmss');\n+        const password = Buffer.from(`${MPESA_SHORTCODE}${MPESA_PASSKEY}${timestamp}`).toString('base64');\n \n-// Verify a pending payment (admin only)\n-router.patch(\"/:id/verify\", verifyToken, verifyPaymentAndArchive);\n+        const stkUrl = 'https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest';\n \n-// ------------------ Payment Reports / Summaries ------------------\n+        const stkPayload = {\n+            BusinessShortCode: MPESA_SHORTCODE,\n+            Password: password,\n+            Timestamp: timestamp,\n+            TransactionType: 'CustomerPayBillOnline',\n+            Amount: amount,\n+            PartyA: phoneNumber,\n+            PartyB: MPESA_SHORTCODE,\n+            PhoneNumber: phoneNumber,\n+            CallBackURL: MPESA_CALLBACK_URL,\n+            AccountReference: residentId.toString(), // Use residentId as reference\n+            TransactionDesc: `Payment for Resident ID: ${residentId}`,\n+        };\n \n-// Get payment summary for dashboard\n-router.get(\"/summary\", verifyToken, getPaymentSummary);\n+        const mpesaResponse = await axios.post(stkUrl, stkPayload, {\n+            headers: {\n+                Authorization: `Bearer ${accessToken}`,\n+                'Content-Type': 'application/json',\n+            },\n+        });\n \n-// Monthly summary (bar/line chart)\n-router.get(\"/summary/monthly\", verifyToken, async (req, res) => {\n-  try {\n-    const pool = await getPool();\n-    const result = await pool.request().query(`\n-      SELECT \n-        FORMAT(PaymentDate, 'yyyy-MM') AS PaymentMonth,\n-        DATENAME(MONTH, PaymentDate) AS MonthName,\n-        ISNULL(SUM(Amount), 0) AS TotalAmount\n-      FROM Payments\n-      WHERE Status = 'Verified'\n-      GROUP BY FORMAT(PaymentDate, 'yyyy-MM'), DATENAME(MONTH, PaymentDate)\n-      ORDER BY PaymentMonth;\n-    `);\n+        const {\n+            ResponseCode,\n+            ResponseDescription,\n+            CustomerMessage,\n+            CheckoutRequestID,\n+            MerchantRequestID\n+        } = mpesaResponse.data;\n \n-    res.json({\n-      labels: result.recordset.map(r => r.MonthName),\n-      totals: result.recordset.map(r => parseFloat(r.TotalAmount))\n-    });\n-  } catch (err) {\n-    console.error(\"Monthly summary error:\", err);\n-    res.status(500).json({ message: \"Failed to load monthly summary\" });\n-  }\n-});\n+        if (ResponseCode === '0') {\n+            // Save initial request details to the database (Payment table)\n+            await sql.connect(dbConfig);\n+            await sql.query`\n+                INSERT INTO Payments (ResidentID, Amount, PaymentDate, PaymentStatus, MpesaCheckoutRequestID, MpesaMerchantRequestID)\n+                VALUES (${residentId}, ${amount}, GETDATE(), 'Pending', ${CheckoutRequestID}, ${MerchantRequestID})\n+            `;\n \n-// Payment method distribution (donut chart)\n-router.get(\"/summary/methods\", verifyToken, async (req, res) => {\n-  try {\n-    const pool = await getPool();\n-    const result = await pool.request().query(`\n-      SELECT PaymentMethod, COUNT(*) AS Count\n-      FROM Payments\n-      WHERE Status = 'Verified'\n-      GROUP BY PaymentMethod\n-    `);\n+            res.status(200).json({\n+                success: true,\n+                message: 'STK Push initiated successfully. Please complete the transaction on your phone.',\n+                CheckoutRequestID,\n+            });\n+        } else {\n+            res.status(400).json({\n+                success: false,\n+                message: ResponseDescription || 'STK Push failed to initiate.',\n+                details: CustomerMessage,\n+            });\n+        }\n+    } catch (error) {\n+        console.error('STK Push Error:', error);\n+        res.status(500).json({ message: 'Internal Server Error during STK push initiation.' });\n+    }\n+};\n \n-    res.json({\n-      labels: result.recordset.map(r => r.PaymentMethod),\n-      counts: result.recordset.map(r => parseInt(r.Count))\n-    });\n-  } catch (err) {\n-    console.error(\"Payment method summary error:\", err);\n-    res.status(500).json({ message: \"Failed to load method summary\" });\n-  }\n-});\n+/**\n+ * Handles the M-Pesa Callback (Confirmation URL).\n+ * This endpoint is hit by Safaricom once the user completes the STK transaction.\n+ */\n+export const handleCallback = async (req, res) => {\n+    const callbackData = req.body;\n+    console.log('M-Pesa Callback Received:', JSON.stringify(callbackData, null, 2));\n \n-// Recent payments (with optional limit)\n-router.get(\"/recent\", verifyToken, async (req, res) => {\n-  try {\n-    const limit = Number(req.query.limit) || 10;\n-    const pool = await getPool();\n+    try {\n+        const { Body } = callbackData;\n+        const { stkCallback } = Body || {};\n+        const {\n+            MerchantRequestID,\n+            CheckoutRequestID,\n+            ResultCode,\n+            ResultDesc,\n+            CallbackMetadata\n+        } = stkCallback || {};\n \n-    const result = await pool.request().query(`\n-      SELECT TOP(${limit})\n-        p.PaymentID,\n-        r.ResidentName,\n-        p.Amount,\n-        p.PaymentMethod,\n-        p.PaymentDate,\n-        p.Reference,\n-        p.Status\n-      FROM Payments p\n-      JOIN Residents r ON p.ResidentID = r.ResidentID\n-      ORDER BY p.PaymentDate DESC\n-    `);\n+        let paymentStatus = 'Failed';\n+        let transactionCode = null;\n \n-    res.json(result.recordset);\n-  } catch (err) {\n-    console.error(\"Recent payments error:\", err);\n-    res.status(500).json({ message: \"Failed to fetch payments\" });\n-  }\n-});\n+        if (ResultCode === 0) {\n+            paymentStatus = 'Completed';\n+            const item = CallbackMetadata.Item.find(i => i.Name === 'MpesaReceiptNumber');\n+            transactionCode = item ? item.Value : null;\n+        } else if (ResultCode === 1032) {\n+            paymentStatus = 'Cancelled';\n+        }\n \n-export default router;\n+        // Update the database record using CheckoutRequestID\n+        await sql.connect(dbConfig);\n+        await sql.query`\n+            UPDATE Payments\n+            SET\n+                PaymentStatus = ${paymentStatus},\n+                MpesaReceiptNumber = ${transactionCode},\n+                MpesaResponseData = ${JSON.stringify(callbackData)},\n+                PaymentDate = GETDATE()\n+            WHERE\n+                MpesaCheckoutRequestID = ${CheckoutRequestID}\n+        `;\n+\n+        // Safaricom expects a success response immediately\n+        res.status(200).json({ \"ResultCode\": 0, \"ResultDesc\": \"Callback processed successfully.\" });\n+\n+    } catch (error) {\n+        console.error('M-Pesa Callback Processing Error:', error);\n+        // Still return a 200 to Safaricom to prevent repeated callbacks\n+        res.status(200).json({ \"ResultCode\": 0, \"ResultDesc\": \"Internal error, but acknowledged.\" });\n+    }\n+};\n+\n+/**\n+ * Allows a client to check the status of a specific payment request by its ID.\n+ * Requires: checkoutRequestId\n+ */\n+export const verifyPayment = async (req, res) => {\n+    const { checkoutRequestId } = req.params; // Using params for GET request\n+\n+    if (!checkoutRequestId) {\n+        return res.status(400).json({ message: 'Missing required parameter: checkoutRequestId.' });\n+    }\n+\n+    try {\n+        await sql.connect(dbConfig);\n+        const result = await sql.query`\n+            SELECT\n+                PaymentID,\n+                ResidentID,\n+                Amount,\n+                PaymentDate,\n+                PaymentStatus,\n+                MpesaReceiptNumber\n+            FROM\n+                Payments\n+            WHERE\n+                MpesaCheckoutRequestID = ${checkoutRequestId}\n+        `;\n+\n+        if (result.recordset.length === 0) {\n+            return res.status(404).json({ message: 'Payment request not found.' });\n+        }\n+\n+        const payment = result.recordset[0];\n+        res.status(200).json({\n+            success: true,\n+            status: payment.PaymentStatus,\n+            paymentDetails: payment\n+        });\n+\n+    } catch (error) {\n+        console.error('Verify Payment Error:', error);\n+        res.status(500).json({ message: 'Internal Server Error while verifying payment status.' });\n+    }\n+};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763634689877,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n import sql from 'mssql';\n-import { dbConfig } from '../config/dbConfig.js';\n+import dbConfig from '../config/dbConfig.js';\n import axios from 'axios';\n import dotenv from 'dotenv';\n import moment from 'moment';\n \n"
                },
                {
                    "date": 1763634717410,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,10 +1,9 @@\n import sql from 'mssql';\n-import dbConfig from '../config/dbConfig.js';\n import axios from 'axios';\n import dotenv from 'dotenv';\n import moment from 'moment';\n-\n+import dbConfig, { connectDB } from '../config/dbConfig.js';\n dotenv.config();\n \n // M-Pesa API details from .env\n const {\n"
                },
                {
                    "date": 1763634852067,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -199,5 +199,6 @@\n     } catch (error) {\n         console.error('Verify Payment Error:', error);\n         res.status(500).json({ message: 'Internal Server Error while verifying payment status.' });\n     }\n-};\n\\ No newline at end of file\n+};\n+export default router;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763634897491,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,9 @@\n import dotenv from 'dotenv';\n import moment from 'moment';\n import dbConfig, { connectDB } from '../config/dbConfig.js';\n dotenv.config();\n-\n+const router = Router();\n // M-Pesa API details from .env\n const {\n     MPESA_SHORTCODE,\n     MPESA_PASSKEY,\n"
                },
                {
                    "date": 1763634935810,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n import axios from 'axios';\n import dotenv from 'dotenv';\n import moment from 'moment';\n import dbConfig, { connectDB } from '../config/dbConfig.js';\n+import { Router } from 'express';\n dotenv.config();\n const router = Router();\n // M-Pesa API details from .env\n const {\n"
                }
            ],
            "date": 1763621546663,
            "name": "Commit-0",
            "content": "// backend/routes/paymentsRoutes.js\nimport express from \"express\";\nimport {\n  getPayments,\n  getVerifiedPayments,\n  getBalances,\n  makePayment,\n  verifyPayment\n} from \"../controllers/paymentsController.js\";\n\nimport { verifyToken } from \"../middleware/verifyToken.js\";\nimport { getPool } from \"../db.js\"; // assuming you have a db.js exporting getPool\n\nconst router = express.Router();\n\n// ------------------ Payments ------------------\n\n// Get all payments\nrouter.get(\"/\", verifyToken, getPayments);\n\n// Get verified payments\nrouter.get(\"/verified\", verifyToken, getVerifiedPayments);\n\n// Get balances\nrouter.get(\"/balances\", verifyToken, getBalances);\n\n// Make payment\nrouter.post(\"/make\", verifyToken, makePayment);\n\n// Verify payment (admin only)\nrouter.put(\"/verify/:id\", verifyToken, verifyPayment);\n\n// ------------------ Payment Reports / Summaries ------------------\n// Add this to backend/routes/paymentRoutes.js (alongside other routes)\n\n// Get payment summary for dashboard\nrouter.get(\"/summary\", verifyToken, getPaymentSummary);\n// Monthly summary (bar/line chart)\nrouter.get(\"/summary/monthly\", verifyToken, async (req, res) => {\n  try {\n    const pool = await getPool();\n\n    const result = await pool.request().query(`\n      SELECT \n        DATENAME(MONTH, PaymentDate) AS MonthName,\n        SUM(Amount) AS TotalAmount\n      FROM Payments\n      GROUP BY DATENAME(MONTH, PaymentDate), MONTH(PaymentDate)\n      ORDER BY MONTH(PaymentDate)\n    `);\n\n    res.json({\n      labels: result.recordset.map(r => r.MonthName),\n      totals: result.recordset.map(r => r.TotalAmount)\n    });\n  } catch (err) {\n    console.error(\"Monthly summary error:\", err);\n    res.status(500).json({ message: \"Failed to load monthly summary\" });\n  }\n});\n\n// Payment method distribution (donut chart)\nrouter.get(\"/summary/methods\", verifyToken, async (req, res) => {\n  try {\n    const pool = await getPool();\n\n    const result = await pool.request().query(`\n      SELECT Method, COUNT(*) AS Count\n      FROM Payments\n      GROUP BY Method\n    `);\n\n    res.json({\n      labels: result.recordset.map(r => r.Method),\n      counts: result.recordset.map(r => r.Count)\n    });\n  } catch (err) {\n    console.error(\"Payment method summary error:\", err);\n    res.status(500).json({ message: \"Failed to load method summary\" });\n  }\n});\n\n// Recent payments\nrouter.get(\"/recent\", verifyToken, async (req, res) => {\n  try {\n    const limit = Number(req.query.limit) || 20;\n    const pool = await getPool();\n\n    const result = await pool.request().query(`\n      SELECT TOP(${limit})\n        PaymentID,\n        ResidentName,\n        Amount,\n        Method,\n        PaymentDate,\n        Reference\n      FROM Payments\n      ORDER BY PaymentDate DESC\n    `);\n\n    res.json(result.recordset);\n  } catch (err) {\n    console.error(\"Recent payments error:\", err);\n    res.status(500).json({ message: \"Failed to fetch payments\" });\n  }\n});\n\nexport default router;\n"
        }
    ]
}