{
    "sourceFile": "backend/controllers/authController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763696949726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763739437631,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,87 +1,83 @@\n-// backend/controllers/authController.js\n-\n import sql from \"mssql\";\n import bcrypt from \"bcryptjs\";\n import { generateToken } from \"../middleware/authMiddleware.js\";\n-import { dbPool } from \"../server.js\";\n+// üõë FIX: We are changing the path to point to the main server file \n+// (e.g., server.js) where dbPool is actually defined and exported.\n+import { dbPool } from \"../server.js\"; \n+// If your main server file is named app.js, use: import { dbPool } from \"../app.js\";\n \n+\n /**\n- * @desc Login user (Resident/Admin/Security) and issue JWT\n- * @route POST /api/auth/login\n- * @access Public\n+ * POST /api/auth/login\n+ * Body: { Email, Password }\n+ * Response: { message, accessToken, fullName, email, role, roleId, phone, NationalID, userId }\n  */\n export async function loginUser(req, res) {\n-    const { Email, Password } = req.body;\n+  const { Email, Password } = req.body;\n \n-    if (!Email || !Password) {\n-        return res.status(400).json({ message: \"Email and password required.\" });\n-    }\n+  if (!Email || !Password) {\n+    return res.status(400).json({ message: \"Email and password required.\" });\n+  }\n \n-    try {\n-        // Use shared dbPool connection\n-        const pool = await dbPool;\n+  try {\n+    const pool = await dbPool; // This now correctly awaits the pool promise\n \n-        // Fetch user and role info\n-        const result = await pool.request()\n-            .input(\"Email\", sql.NVarChar, Email)\n-            .query(`\n-                SELECT TOP 1 \n-                    U.UserID,\n-                    U.Email,\n-                    U.PasswordHash,\n-                    U.FullName,\n-                    U.RoleID,\n-                    U.NationalID,\n-                    U.PhoneNumber,\n-                    R.RoleName AS Role\n-                FROM Users U\n-                JOIN Roles R ON U.RoleID = R.RoleID\n-                WHERE U.Email = @Email\n-            `);\n+    const result = await pool.request()\n+      .input(\"Email\", sql.NVarChar, Email)\n+      .query(`\n+        SELECT TOP 1\n+          U.UserID,\n+          U.Email,\n+          U.PasswordHash,\n+          U.FullName,\n+          U.RoleID,\n+          U.NationalID,\n+          U.PhoneNumber,\n+          R.RoleName AS RoleName\n+        FROM Users U\n+        JOIN Roles R ON U.RoleID = R.RoleID\n+        WHERE U.Email = @Email;\n+      `);\n \n-        const user = result.recordset[0];\n+    const user = result.recordset[0];\n \n-        if (!user) {\n-            return res.status(404).json({ message: \"User not found.\" });\n-        }\n+    if (!user) {\n+      return res.status(404).json({ message: \"User not found.\" });\n+    }\n \n-        // Compare password with stored hash\n-        const isPasswordValid = await bcrypt.compare(Password, user.PasswordHash);\n-        if (!isPasswordValid) {\n-            return res.status(401).json({ message: \"Incorrect password.\" });\n-        }\n+    const isPasswordValid = await bcrypt.compare(Password, user.PasswordHash || \"\");\n+    if (!isPasswordValid) {\n+      return res.status(401).json({ message: \"Incorrect password.\" });\n+    }\n \n-        // Prepare JWT payload\n-        const payload = {\n-            ResidentID: user.Role.toLowerCase() === \"resident\" ? user.UserID : null,\n-            userId: user.UserID, // Admin/Security\n-            NationalID: user.NationalID || null,\n-            email: user.Email,\n-            fullName: user.FullName,\n-            role: user.Role.toLowerCase(),\n-            roleId: Number(user.RoleID)\n-        };\n+    const roleNormalized = (user.RoleName || \"resident\").toLowerCase();\n \n-        // Generate access token (use shared middleware function)\n-        const token = generateToken(payload);\n+    const payload = {\n+      userId: user.UserID,\n+      ResidentID: roleNormalized === \"resident\" ? user.UserID : null,\n+      email: user.Email,\n+      fullName: user.FullName,\n+      NationalID: user.NationalID || null,\n+      role: roleNormalized,\n+      roleId: Number(user.RoleID),\n+    };\n \n-        // Respond with token + user info\n-        res.status(200).json({\n-            message: \"Login successful\",\n-            token,\n-            user: {\n-                userId: user.UserID,\n-                fullName: user.FullName,\n-                role: user.Role,\n-                roleId: Number(user.RoleID),\n-                email: user.Email,\n-                NationalID: user.NationalID,\n-                phone: user.PhoneNumber\n-            }\n-        });\n+    const accessToken = generateToken(payload);\n \n-    } catch (err) {\n-        console.error(\"‚ùå Login error:\", err);\n-        res.status(500).json({ message: \"Server error during login.\" });\n-    }\n-}\n+    return res.status(200).json({\n+      message: \"Login successful\",\n+      accessToken,\n+      fullName: user.FullName,\n+      email: user.Email,\n+      role: roleNormalized,\n+      roleId: Number(user.RoleID),\n+      phone: user.PhoneNumber,\n+      NationalID: user.NationalID,\n+      userId: user.UserID,\n+    });\n+\n+  } catch (err) {\n+    console.error(\"‚ùå Login error:\", err);\n+    return res.status(500).json({ message: \"Server error during login.\" });\n+  }\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1763696949726,
            "name": "Commit-0",
            "content": "// backend/controllers/authController.js\n\nimport sql from \"mssql\";\nimport bcrypt from \"bcryptjs\";\nimport { generateToken } from \"../middleware/authMiddleware.js\";\nimport { dbPool } from \"../server.js\";\n\n/**\n * @desc Login user (Resident/Admin/Security) and issue JWT\n * @route POST /api/auth/login\n * @access Public\n */\nexport async function loginUser(req, res) {\n    const { Email, Password } = req.body;\n\n    if (!Email || !Password) {\n        return res.status(400).json({ message: \"Email and password required.\" });\n    }\n\n    try {\n        // Use shared dbPool connection\n        const pool = await dbPool;\n\n        // Fetch user and role info\n        const result = await pool.request()\n            .input(\"Email\", sql.NVarChar, Email)\n            .query(`\n                SELECT TOP 1 \n                    U.UserID,\n                    U.Email,\n                    U.PasswordHash,\n                    U.FullName,\n                    U.RoleID,\n                    U.NationalID,\n                    U.PhoneNumber,\n                    R.RoleName AS Role\n                FROM Users U\n                JOIN Roles R ON U.RoleID = R.RoleID\n                WHERE U.Email = @Email\n            `);\n\n        const user = result.recordset[0];\n\n        if (!user) {\n            return res.status(404).json({ message: \"User not found.\" });\n        }\n\n        // Compare password with stored hash\n        const isPasswordValid = await bcrypt.compare(Password, user.PasswordHash);\n        if (!isPasswordValid) {\n            return res.status(401).json({ message: \"Incorrect password.\" });\n        }\n\n        // Prepare JWT payload\n        const payload = {\n            ResidentID: user.Role.toLowerCase() === \"resident\" ? user.UserID : null,\n            userId: user.UserID, // Admin/Security\n            NationalID: user.NationalID || null,\n            email: user.Email,\n            fullName: user.FullName,\n            role: user.Role.toLowerCase(),\n            roleId: Number(user.RoleID)\n        };\n\n        // Generate access token (use shared middleware function)\n        const token = generateToken(payload);\n\n        // Respond with token + user info\n        res.status(200).json({\n            message: \"Login successful\",\n            token,\n            user: {\n                userId: user.UserID,\n                fullName: user.FullName,\n                role: user.Role,\n                roleId: Number(user.RoleID),\n                email: user.Email,\n                NationalID: user.NationalID,\n                phone: user.PhoneNumber\n            }\n        });\n\n    } catch (err) {\n        console.error(\"‚ùå Login error:\", err);\n        res.status(500).json({ message: \"Server error during login.\" });\n    }\n}\n"
        }
    ]
}