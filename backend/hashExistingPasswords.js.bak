import sql from "mssql";
import bcrypt from "bcryptjs";
import dbConfig from "./config/dbConfig.js";

(async () => {
  try {
    console.log("ğŸ”— Connecting to database...");
    const pool = await sql.connect(dbConfig);

    console.log("ğŸ“¦ Fetching users...");
    const users = await pool.request().query("SELECT UserID, PasswordHash FROM Users");

    let updated = 0;
    for (const u of users.recordset) {
      // only hash if it's not already bcrypt (bcrypt hashes start with $2)
      if (!u.PasswordHash.startsWith("$2")) {
        const newHash = await bcrypt.hash(u.PasswordHash, 10);
        await pool.request()
          .input("UserID", sql.Int, u.UserID)
          .input("PasswordHash", sql.VarChar, newHash)
          .query("UPDATE Users SET PasswordHash = @PasswordHash WHERE UserID = @UserID");

        updated++;
        console.log(`âœ… Hashed password for UserID ${u.UserID}`);
      }
    }

    console.log(`ğŸ‰ Done! Hashed ${updated} user(s).`);
    process.exit(0);
  } catch (err) {
    console.error("âŒ Error hashing passwords:", err);
    process.exit(1);
  }
})();
