{
    "sourceFile": "backend/controllers/adminController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763882913805,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763882913805,
            "name": "Commit-0",
            "content": "// backend/controllers/adminController.js\r\nimport sql from \"mssql\";\r\nimport dbConfig from \"../config/dbConfig.js\";\r\n\r\n// ‚úÖ Get all membership requests\r\nexport const getAllMemberships = async (req, res) => {\r\n  try {\r\n    const pool = await sql.connect(dbConfig);\r\n    const result = await pool.request().query(`\r\n      SELECT RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, Status, RequestedAt\r\n      FROM MembershipRequests\r\n      ORDER BY RequestedAt DESC\r\n    `);\r\n\r\n    res.json(result.recordset);\r\n  } catch (error) {\r\n    console.error(\"‚ùå Error fetching memberships:\", error);\r\n    res.status(500).json({ message: \"Server error fetching memberships\" });\r\n  }\r\n};\r\n\r\n// ‚úÖ Approve a membership\r\nexport const approveResident = async (req, res) => {\r\n  try {\r\n    const { requestId } = req.body;\r\n    const pool = await sql.connect(dbConfig);\r\n\r\n    await pool.request()\r\n      .input(\"RequestID\", sql.Int, requestId)\r\n      .query(`UPDATE MembershipRequests SET Status = 'Approved' WHERE RequestID = @RequestID`);\r\n\r\n    res.json({ message: \"Membership approved ‚úÖ\" });\r\n  } catch (error) {\r\n    console.error(\"‚ùå Error approving membership:\", error);\r\n    res.status(500).json({ message: \"Server error approving membership\" });\r\n  }\r\n};\r\n// üåü NEW: Move Verified Payment to VerifiedPayments Table\r\nexport const movePaymentToVerified = async (req, res) => {\r\n    const { paymentId } = req.body; \r\n\r\n    if (!paymentId) {\r\n        return res.status(400).json({ error: \"Payment ID is required for verification.\" });\r\n    }\r\n\r\n    // You can optionally add a role check here to ensure only Admins run this\r\n\r\n    let pool;\r\n    try {\r\n        pool = await sql.connect(dbConfig);\r\n        \r\n        // Use a SQL Transaction to ensure both the INSERT and the UPDATE are atomic (all or nothing)\r\n        const transaction = new sql.Transaction(pool);\r\n        await transaction.begin();\r\n        \r\n        try {\r\n            // STEP 1: INSERT the verified data into VerifiedPayments\r\n            const insertResult = await transaction.request()\r\n                .input(\"PaymentID\", sql.Int, paymentId)\r\n                .query(`\r\n                    -- Joins Payments (p) with Users (u) to get the ResidentName\r\n                    INSERT INTO VerifiedPayments (\r\n                        PaymentID, \r\n                        ResidentID, \r\n                        ResidentName, \r\n                        Amount, \r\n                        Reference, \r\n                        VerifiedDate, \r\n                        NationalID,\r\n                        PaymentMethod, -- Include the PaymentMethod column\r\n                        serviceName    -- Include the serviceName column\r\n                    )\r\n                    SELECT \r\n                        p.PaymentID, \r\n                        p.ResidentID, \r\n                        u.FullName, \r\n                        p.Amount, \r\n                        p.Reference, \r\n                        p.VerifiedDate, \r\n                        p.NationalID,\r\n                        p.PaymentMethod,\r\n                        p.serviceName\r\n                    FROM Payments p\r\n                    -- We rely on the ResidentID from the Payments table to link to the Users table\r\n                    JOIN Users u ON p.ResidentID = u.UserID\r\n                    WHERE p.PaymentID = @PaymentID AND p.Status = 'Paid';\r\n                `);\r\n\r\n            if (insertResult.rowsAffected[0] === 0) {\r\n                await transaction.rollback();\r\n                return res.status(404).json({ error: \"Payment not found or not yet marked as Paid.\" });\r\n            }\r\n\r\n            // STEP 2: Mark the record in the original Payments table as 'Archived' (Terminal State)\r\n            await transaction.request()\r\n                .input(\"PaymentID\", sql.Int, paymentId)\r\n                .query(`\r\n                    UPDATE Payments\r\n                    SET Status = 'Archived' \r\n                    WHERE PaymentID = @PaymentID;\r\n                `);\r\n\r\n            await transaction.commit();\r\n            res.status(200).json({ message: \"Payment successfully verified and moved to archives. ‚úÖ\" });\r\n\r\n        } catch (txnError) {\r\n            await transaction.rollback();\r\n            throw txnError; \r\n        }\r\n\r\n    } catch (error) {\r\n        console.error(\"‚ùå Verification error:\", error);\r\n        res.status(500).json({\r\n            message: \"Server error during payment verification.\",\r\n            details: error.message\r\n        });\r\n    }\r\n};\r\nexport async function getAccessChart(req, res) {\r\n  try {\r\n    // Example: return last 7 days of access attempts\r\n    const data = {\r\n      days: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],\r\n      counts: [10, 12, 5, 8, 15, 7, 9]\r\n    };\r\n    res.json(data);\r\n  } catch (err) {\r\n    console.error(err);\r\n    res.status(500).json({ message: 'Failed to load access chart data' });\r\n  }\r\n}\r\n"
        }
    ]
}