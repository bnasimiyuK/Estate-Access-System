{
    "sourceFile": "backend/routes/residentsRoutes.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 9,
            "patches": [
                {
                    "date": 1763695983088,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763696096179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n // residentsRoutes.js\n \n import { Router } from \"express\";\n import sql from \"mssql\";\n-import { authenticateJWT, requireAdmin, verifyToken } from \"../middleware/authMiddleware.js\";\n+import { authenticateJWT, requireAdmin } from \"../middleware/authMiddleware.js\";\n import {\n     getResidentProfile,\n     getAllResidents,\n     getVisitorsAccess,\n@@ -20,79 +20,89 @@\n \n const router = Router();\n \n // ================================\n-// PROTECTED ROUTES (Requires authenticateJWT)\n+// PROTECTED ROUTES (Residents)\n // ================================\n \n-// GET: Resident Profile (for the logged-in user)\n+// Resident Profile\n router.get(\"/profile\", authenticateJWT, getResidentProfile);\n \n-// GET: Visitor Access (for the logged-in user)\n+// Visitor Access\n router.get(\"/visitors\", authenticateJWT, getVisitorsAccess);\n \n-// GET: Membership Requests (filtered by user's NationalID)\n+// Membership Requests\n router.get(\"/membership-requests\", authenticateJWT, getMembershipRequests);\n \n-// POST: Pay for Service\n+// Pay for service\n router.post(\"/pay\", authenticateJWT, payForService);\n \n-// GET: Visitor Passes (Dashboard Overview)\n+// Visitor Passes\n router.get(\"/visitorsaccess\", authenticateJWT, getVisitorPasses);\n \n // ================================\n-// ADMIN ROUTES (Requires authenticateJWT AND requireAdmin)\n+// ADMIN ROUTES\n // ================================\n \n-// GET: Dashboard Summary Data\n+// Dashboard Summary\n router.get(\"/dashboard/summary\", authenticateJWT, requireAdmin, getDashboardSummary);\n \n-// GET: Access Chart Data\n+// Access Chart Data\n router.get(\"/admin/accesschart\", authenticateJWT, requireAdmin, getAccessChartData);\n \n-// GET: All Residents\n+// All Residents\n router.get(\"/all\", authenticateJWT, requireAdmin, getAllResidents);\n \n-// GET: Approved Residents\n-router.get(\"/approved\", verifyToken, requireAdmin, getApprovedResidents);\n+// Approved Residents\n+router.get(\"/approved\", authenticateJWT, requireAdmin, getApprovedResidents);\n \n-// POST: Sync Residents\n+// Sync Residents\n router.post(\"/sync\", authenticateJWT, requireAdmin, syncResidents);\n \n // ================================\n-// UNPROTECTED / QUERY ROUTES\n+// PUBLIC ROUTES\n // ================================\n \n-// GET: Payment Status (Query-based, uses phone number)\n+// Query Payment Status\n router.get(\"/payment-status\", loadPaymentStatus);\n \n // ================================\n-// VERIFY PAYMENT ROUTE\n+// VERIFY PAYMENT (ADMIN ONLY)\n // ================================\n-router.put(\"/payments/verify/:id\", verifyToken, async (req, res) => {\n+router.put(\"/payments/verify/:id\", authenticateJWT, requireAdmin, async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const { id } = req.params;\n \n-        // Update PaymentHistory status\n+        // Update payment status\n         await pool.request()\n             .input(\"PaymentID\", sql.Int, id)\n-            .query(`UPDATE PaymentHistory SET Status='Verified' WHERE PaymentID=@PaymentID`);\n+            .query(`\n+                UPDATE PaymentHistory\n+                SET Status = 'Verified'\n+                WHERE PaymentID = @PaymentID\n+            `);\n \n-        // Insert into VerifiedPayments with Resident info\n+        // Insert into VerifiedPayments table\n         await pool.request()\n             .input(\"PaymentID\", sql.Int, id)\n             .query(`\n                 INSERT INTO VerifiedPayments (PaymentID, ResidentID, ResidentName, Amount, Reference, VerifiedDate)\n-                SELECT p.PaymentID, p.ResidentID, r.ResidentName, p.Amount, p.Reference, GETDATE()\n+                SELECT \n+                    p.PaymentID, \n+                    p.ResidentID, \n+                    r.ResidentName, \n+                    p.Amount, \n+                    p.Reference, \n+                    GETDATE()\n                 FROM PaymentHistory p\n                 LEFT JOIN Residents r ON r.ResidentID = p.ResidentID\n                 WHERE p.PaymentID = @PaymentID\n             `);\n \n         res.json({ message: \"Payment verified successfully\" });\n     } catch (err) {\n-        console.error(err);\n+        console.error(\"Payment verification error:\", err);\n         res.status(500).json({ message: \"Error verifying payment\" });\n     }\n });\n \n"
                },
                {
                    "date": 1763696608741,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n // residentsRoutes.js\n \n import { Router } from \"express\";\n import sql from \"mssql\";\n-import { authenticateJWT, requireAdmin } from \"../middleware/authMiddleware.js\";\n+import { authenticateJWT, isAdmin } from \"../middleware/authMiddleware.js\";\n import {\n     getResidentProfile,\n     getAllResidents,\n     getVisitorsAccess,\n@@ -19,91 +19,97 @@\n import { dbPool } from \"../server.js\";\n \n const router = Router();\n \n-// ================================\n-// PROTECTED ROUTES (Residents)\n-// ================================\n+/* ============================================\n+   RESIDENT ROUTES (Protected)\n+============================================ */\n \n-// Resident Profile\n+// Get logged-in resident profile\n router.get(\"/profile\", authenticateJWT, getResidentProfile);\n \n-// Visitor Access\n+// Get visitor access log for one resident\n router.get(\"/visitors\", authenticateJWT, getVisitorsAccess);\n \n-// Membership Requests\n+// Get membership requests for this resident\n router.get(\"/membership-requests\", authenticateJWT, getMembershipRequests);\n \n-// Pay for service\n+// Process payment (M-Pesa)\n router.post(\"/pay\", authenticateJWT, payForService);\n \n-// Visitor Passes\n+// Dashboard visitor passes\n router.get(\"/visitorsaccess\", authenticateJWT, getVisitorPasses);\n \n-// ================================\n-// ADMIN ROUTES\n-// ================================\n \n-// Dashboard Summary\n-router.get(\"/dashboard/summary\", authenticateJWT, requireAdmin, getDashboardSummary);\n+/* ============================================\n+   ADMIN ROUTES (Protected: Admin Only)\n+============================================ */\n \n-// Access Chart Data\n-router.get(\"/admin/accesschart\", authenticateJWT, requireAdmin, getAccessChartData);\n+// Dashboard summary widgets\n+router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n \n-// All Residents\n-router.get(\"/all\", authenticateJWT, requireAdmin, getAllResidents);\n+// Dashboard access chart\n+router.get(\"/admin/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n \n-// Approved Residents\n-router.get(\"/approved\", authenticateJWT, requireAdmin, getApprovedResidents);\n+// Fetch all residents\n+router.get(\"/all\", authenticateJWT, isAdmin, getAllResidents);\n \n-// Sync Residents\n-router.post(\"/sync\", authenticateJWT, requireAdmin, syncResidents);\n+// Fetch only approved residents\n+router.get(\"/approved\", authenticateJWT, isAdmin, getApprovedResidents);\n \n-// ================================\n-// PUBLIC ROUTES\n-// ================================\n+// Sync local resident DB with cloud/external system\n+router.post(\"/sync\", authenticateJWT, isAdmin, syncResidents);\n \n-// Query Payment Status\n+\n+/* ============================================\n+   PUBLIC ROUTES\n+============================================ */\n+\n+// Payment status query (does NOT require token)\n router.get(\"/payment-status\", loadPaymentStatus);\n \n-// ================================\n-// VERIFY PAYMENT (ADMIN ONLY)\n-// ================================\n-router.put(\"/payments/verify/:id\", authenticateJWT, requireAdmin, async (req, res) => {\n+\n+/* ============================================\n+   ADMIN PAYMENT VERIFICATION (Protected)\n+============================================ */\n+router.put(\"/payments/verify/:id\", authenticateJWT, isAdmin, async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const { id } = req.params;\n \n-        // Update payment status\n+        // 1. Update payment status\n         await pool.request()\n             .input(\"PaymentID\", sql.Int, id)\n             .query(`\n                 UPDATE PaymentHistory\n                 SET Status = 'Verified'\n                 WHERE PaymentID = @PaymentID\n             `);\n \n-        // Insert into VerifiedPayments table\n+        // 2. Insert into VerifiedPayments\n         await pool.request()\n             .input(\"PaymentID\", sql.Int, id)\n             .query(`\n-                INSERT INTO VerifiedPayments (PaymentID, ResidentID, ResidentName, Amount, Reference, VerifiedDate)\n+                INSERT INTO VerifiedPayments \n+                (PaymentID, ResidentID, ResidentName, Amount, Reference, VerifiedDate)\n                 SELECT \n-                    p.PaymentID, \n-                    p.ResidentID, \n-                    r.ResidentName, \n-                    p.Amount, \n-                    p.Reference, \n+                    p.PaymentID,\n+                    p.ResidentID,\n+                    r.ResidentName,\n+                    p.Amount,\n+                    p.Reference,\n                     GETDATE()\n                 FROM PaymentHistory p\n                 LEFT JOIN Residents r ON r.ResidentID = p.ResidentID\n                 WHERE p.PaymentID = @PaymentID\n             `);\n \n         res.json({ message: \"Payment verified successfully\" });\n+\n     } catch (err) {\n         console.error(\"Payment verification error:\", err);\n         res.status(500).json({ message: \"Error verifying payment\" });\n     }\n });\n \n+\n export default router;\n"
                },
                {
                    "date": 1763844056398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,14 +13,15 @@\n     payForService,\n     syncResidents,\n     getDashboardSummary,\n     getAccessChartData,\n-    getVisitorPasses\n+    getVisitorPasses,\n+     getResidentIDs\n } from \"../controllers/residentsController.js\";\n import { dbPool } from \"../server.js\";\n \n const router = Router();\n-\n+router.get(\"/ids\", getResidentIDs);\n /* ============================================\n    RESIDENT ROUTES (Protected)\n ============================================ */\n \n"
                },
                {
                    "date": 1763844070489,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,9 +14,9 @@\n     syncResidents,\n     getDashboardSummary,\n     getAccessChartData,\n     getVisitorPasses,\n-     getResidentIDs\n+    getResidentIDs\n } from \"../controllers/residentsController.js\";\n import { dbPool } from \"../server.js\";\n \n const router = Router();\n"
                },
                {
                    "date": 1763845915535,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,5 @@\n // residentsRoutes.js\n-\n import { Router } from \"express\";\n import sql from \"mssql\";\n import { authenticateJWT, isAdmin } from \"../middleware/authMiddleware.js\";\n import {\n@@ -12,16 +11,19 @@\n     loadPaymentStatus,\n     payForService,\n     syncResidents,\n     getDashboardSummary,\n-    getAccessChartData,\n+    // getAccessChartData, // Uncomment if implemented\n     getVisitorPasses,\n     getResidentIDs\n } from \"../controllers/residentsController.js\";\n import { dbPool } from \"../server.js\";\n \n const router = Router();\n+\n+// ------------------------ RESIDENT IDS ------------------------\n router.get(\"/ids\", getResidentIDs);\n+\n /* ============================================\n    RESIDENT ROUTES (Protected)\n ============================================ */\n \n@@ -47,10 +49,10 @@\n \n // Dashboard summary widgets\n router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n \n-// Dashboard access chart\n-router.get(\"/admin/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n+// Dashboard access chart (optional - uncomment if implemented)\n+// router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n \n // Fetch all residents\n router.get(\"/all\", authenticateJWT, isAdmin, getAllResidents);\n \n@@ -72,45 +74,44 @@\n /* ============================================\n    ADMIN PAYMENT VERIFICATION (Protected)\n ============================================ */\n router.put(\"/payments/verify/:id\", authenticateJWT, isAdmin, async (req, res) => {\n+    const { id } = req.params;\n+    const pool = await dbPool;\n+    const transaction = new sql.Transaction(pool);\n+\n     try {\n-        const pool = await dbPool;\n-        const { id } = req.params;\n+        await transaction.begin();\n+        const request = new sql.Request(transaction);\n \n-        // 1. Update payment status\n-        await pool.request()\n-            .input(\"PaymentID\", sql.Int, id)\n-            .query(`\n-                UPDATE PaymentHistory\n-                SET Status = 'Verified'\n-                WHERE PaymentID = @PaymentID\n-            `);\n+        // 1️⃣ Update payment status\n+        await request.input(\"PaymentID\", sql.Int, id)\n+                     .query(`UPDATE PaymentHistory SET Status = 'Verified' WHERE PaymentID = @PaymentID`);\n \n-        // 2. Insert into VerifiedPayments\n-        await pool.request()\n-            .input(\"PaymentID\", sql.Int, id)\n-            .query(`\n-                INSERT INTO VerifiedPayments \n-                (PaymentID, ResidentID, ResidentName, Amount, Reference, VerifiedDate)\n-                SELECT \n-                    p.PaymentID,\n-                    p.ResidentID,\n-                    r.ResidentName,\n-                    p.Amount,\n-                    p.Reference,\n-                    GETDATE()\n-                FROM PaymentHistory p\n-                LEFT JOIN Residents r ON r.ResidentID = p.ResidentID\n-                WHERE p.PaymentID = @PaymentID\n-            `);\n+        // 2️⃣ Insert into VerifiedPayments\n+        await request.input(\"PaymentID\", sql.Int, id)\n+                     .query(`\n+                        INSERT INTO VerifiedPayments\n+                        (PaymentID, ResidentID, ResidentName, Amount, Reference, VerifiedDate)\n+                        SELECT \n+                            p.PaymentID,\n+                            p.ResidentID,\n+                            r.ResidentName,\n+                            p.Amount,\n+                            p.Reference,\n+                            GETDATE()\n+                        FROM PaymentHistory p\n+                        LEFT JOIN Residents r ON r.ResidentID = p.ResidentID\n+                        WHERE p.PaymentID = @PaymentID\n+                     `);\n \n+        await transaction.commit();\n         res.json({ message: \"Payment verified successfully\" });\n \n     } catch (err) {\n+        await transaction.rollback();\n         console.error(\"Payment verification error:\", err);\n         res.status(500).json({ message: \"Error verifying payment\" });\n     }\n });\n \n-\n export default router;\n"
                },
                {
                    "date": 1763932720323,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,9 +50,9 @@\n // Dashboard summary widgets\n router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n \n // Dashboard access chart (optional - uncomment if implemented)\n-// router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n+router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n \n // Fetch all residents\n router.get(\"/all\", authenticateJWT, isAdmin, getAllResidents);\n \n"
                },
                {
                    "date": 1763932749614,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -47,9 +47,9 @@\n    ADMIN ROUTES (Protected: Admin Only)\n ============================================ */\n \n // Dashboard summary widgets\n-router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n+//router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n \n // Dashboard access chart (optional - uncomment if implemented)\n router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n \n"
                },
                {
                    "date": 1763932852444,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -47,12 +47,12 @@\n    ADMIN ROUTES (Protected: Admin Only)\n ============================================ */\n \n // Dashboard summary widgets\n-//router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n+router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n \n // Dashboard access chart (optional - uncomment if implemented)\n-router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n+// router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n \n // Fetch all residents\n router.get(\"/all\", authenticateJWT, isAdmin, getAllResidents);\n \n"
                },
                {
                    "date": 1763932990837,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,9 +11,9 @@\n     loadPaymentStatus,\n     payForService,\n     syncResidents,\n     getDashboardSummary,\n-    // getAccessChartData, // Uncomment if implemented\n+    getAccessChartData, // Uncomment if implemented\n     getVisitorPasses,\n     getResidentIDs\n } from \"../controllers/residentsController.js\";\n import { dbPool } from \"../server.js\";\n@@ -50,9 +50,9 @@\n // Dashboard summary widgets\n router.get(\"/dashboard/summary\", authenticateJWT, isAdmin, getDashboardSummary);\n \n // Dashboard access chart (optional - uncomment if implemented)\n-// router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n+router.get(\"/dashboard/accesschart\", authenticateJWT, isAdmin, getAccessChartData);\n \n // Fetch all residents\n router.get(\"/all\", authenticateJWT, isAdmin, getAllResidents);\n \n"
                }
            ],
            "date": 1763695983088,
            "name": "Commit-0",
            "content": "// residentsRoutes.js\n\nimport { Router } from \"express\";\nimport sql from \"mssql\";\nimport { authenticateJWT, requireAdmin, verifyToken } from \"../middleware/authMiddleware.js\";\nimport {\n    getResidentProfile,\n    getAllResidents,\n    getVisitorsAccess,\n    getMembershipRequests,\n    getApprovedResidents,\n    loadPaymentStatus,\n    payForService,\n    syncResidents,\n    getDashboardSummary,\n    getAccessChartData,\n    getVisitorPasses\n} from \"../controllers/residentsController.js\";\nimport { dbPool } from \"../server.js\";\n\nconst router = Router();\n\n// ================================\n// PROTECTED ROUTES (Requires authenticateJWT)\n// ================================\n\n// GET: Resident Profile (for the logged-in user)\nrouter.get(\"/profile\", authenticateJWT, getResidentProfile);\n\n// GET: Visitor Access (for the logged-in user)\nrouter.get(\"/visitors\", authenticateJWT, getVisitorsAccess);\n\n// GET: Membership Requests (filtered by user's NationalID)\nrouter.get(\"/membership-requests\", authenticateJWT, getMembershipRequests);\n\n// POST: Pay for Service\nrouter.post(\"/pay\", authenticateJWT, payForService);\n\n// GET: Visitor Passes (Dashboard Overview)\nrouter.get(\"/visitorsaccess\", authenticateJWT, getVisitorPasses);\n\n// ================================\n// ADMIN ROUTES (Requires authenticateJWT AND requireAdmin)\n// ================================\n\n// GET: Dashboard Summary Data\nrouter.get(\"/dashboard/summary\", authenticateJWT, requireAdmin, getDashboardSummary);\n\n// GET: Access Chart Data\nrouter.get(\"/admin/accesschart\", authenticateJWT, requireAdmin, getAccessChartData);\n\n// GET: All Residents\nrouter.get(\"/all\", authenticateJWT, requireAdmin, getAllResidents);\n\n// GET: Approved Residents\nrouter.get(\"/approved\", verifyToken, requireAdmin, getApprovedResidents);\n\n// POST: Sync Residents\nrouter.post(\"/sync\", authenticateJWT, requireAdmin, syncResidents);\n\n// ================================\n// UNPROTECTED / QUERY ROUTES\n// ================================\n\n// GET: Payment Status (Query-based, uses phone number)\nrouter.get(\"/payment-status\", loadPaymentStatus);\n\n// ================================\n// VERIFY PAYMENT ROUTE\n// ================================\nrouter.put(\"/payments/verify/:id\", verifyToken, async (req, res) => {\n    try {\n        const pool = await dbPool;\n        const { id } = req.params;\n\n        // Update PaymentHistory status\n        await pool.request()\n            .input(\"PaymentID\", sql.Int, id)\n            .query(`UPDATE PaymentHistory SET Status='Verified' WHERE PaymentID=@PaymentID`);\n\n        // Insert into VerifiedPayments with Resident info\n        await pool.request()\n            .input(\"PaymentID\", sql.Int, id)\n            .query(`\n                INSERT INTO VerifiedPayments (PaymentID, ResidentID, ResidentName, Amount, Reference, VerifiedDate)\n                SELECT p.PaymentID, p.ResidentID, r.ResidentName, p.Amount, p.Reference, GETDATE()\n                FROM PaymentHistory p\n                LEFT JOIN Residents r ON r.ResidentID = p.ResidentID\n                WHERE p.PaymentID = @PaymentID\n            `);\n\n        res.json({ message: \"Payment verified successfully\" });\n    } catch (err) {\n        console.error(err);\n        res.status(500).json({ message: \"Error verifying payment\" });\n    }\n});\n\nexport default router;\n"
        }
    ]
}