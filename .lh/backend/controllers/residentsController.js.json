{
    "sourceFile": "backend/controllers/residentsController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763641226781,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763697101451,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,15 +1,12 @@\n-// residentsController.js\n+// backend/controllers/residentsController.js\n \n-// ============================================================\n-// IMPORTS\n-// ============================================================\n import sql from \"mssql\";\n import { dbPool } from \"../server.js\";\n \n-// ============================================================\n-// DASHBOARD SUMMARY (ADMIN)\n-// ============================================================\n+/* ===========================================================\n+   DASHBOARD SUMMARY (Admin)\n+=========================================================== */\n export const getDashboardSummary = async (req, res) => {\n     const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n     const OVERRIDES_TABLE = \"[EstateAccessManagementSystem].[dbo].[gate_overrides]\";\n \n@@ -71,11 +68,11 @@\n         res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// ACCESS CHART (ADMIN)\n-// ============================================================\n+/* ===========================================================\n+   ACCESS CHART DATA (Admin)\n+=========================================================== */\n export const getAccessChartData = async (req, res) => {\n     const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n \n     try {\n@@ -100,18 +97,17 @@\n         res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// RESIDENT PROFILE\n-// ============================================================\n+/* ===========================================================\n+   RESIDENT PROFILE\n+=========================================================== */\n export const getResidentProfile = async (req, res) => {\n     try {\n         const residentId = req.user?.ResidentID;\n         if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n \n         const pool = await dbPool;\n-\n         const result = await pool.request()\n             .input(\"ResidentID\", sql.Int, residentId)\n             .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n \n@@ -123,11 +119,11 @@\n         res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// ALL RESIDENTS (ADMIN)\n-// ============================================================\n+/* ===========================================================\n+   ALL RESIDENTS (Admin)\n+=========================================================== */\n export const getAllResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const result = await pool.request().query(\"SELECT * FROM Residents ORDER BY ResidentName ASC\");\n@@ -136,11 +132,11 @@\n         res.status(500).json({ error: \"Failed to load residents\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// VISITOR ACCESS\n-// ============================================================\n+/* ===========================================================\n+   VISITOR ACCESS\n+=========================================================== */\n export const getVisitorsAccess = async (req, res) => {\n     try {\n         const residentId = req.user?.ResidentID;\n         if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n@@ -156,11 +152,11 @@\n         res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// VISITOR PASSES\n-// ============================================================\n+/* ===========================================================\n+   VISITOR PASSES\n+=========================================================== */\n export const getVisitorPasses = async (req, res) => {\n     const residentID = req.user?.ResidentID;\n     if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n \n@@ -181,45 +177,36 @@\n         res.status(500).json({ error: \"Failed to retrieve visitor passes\" });\n     }\n };\n \n-// ============================================================\n-// MEMBERSHIP REQUESTS (MODIFIED for Admin/Resident split)\n-// ============================================================\n+/* ===========================================================\n+   MEMBERSHIP REQUESTS\n+=========================================================== */\n export const getMembershipRequests = async (req, res) => {\n     const residentNationalID = req.user?.NationalID;\n-    const residentRole = req.user?.RoleName; // Assuming RoleName is passed in the token\n-    \n-    // Determine if the user is an Admin (or similar high-privilege role)\n-    // IMPORTANT: Adjust this check if your admin role is named differently or if you use a dedicated isAdmin flag.\n-    const isAdmin = residentRole && residentRole.toLowerCase() === 'admin';\n-    \n+    const role = req.user?.role;\n+\n     try {\n         const pool = await dbPool;\n+        let request = pool.request();\n         let query;\n-        let request = pool.request();\n \n-        if (isAdmin) {\n-            // Admin: Fetch all membership requests\n+        if (role === 'admin') {\n             query = `\n-                SELECT \n-                    RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n+                SELECT RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n                 FROM MembershipRequests \n                 ORDER BY RequestedAt DESC\n             `;\n         } else if (residentNationalID) {\n-            // Resident: Fetch only their own requests\n             request = request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n             query = `\n-                SELECT \n-                    RequestID, ResidentName, Status, RequestedAt \n+                SELECT RequestID, ResidentName, Status, RequestedAt \n                 FROM MembershipRequests \n                 WHERE NationalID = @NationalID \n                 ORDER BY RequestedAt DESC\n             `;\n         } else {\n-            // Unauthorized or invalid token for non-admin\n-             return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n+            return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n         }\n \n         const result = await request.query(query);\n         res.status(200).json(result.recordset);\n@@ -229,11 +216,11 @@\n         res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// ADMIN ACTION: APPROVE RESIDENT\n-// ============================================================\n+/* ===========================================================\n+   APPROVE / REJECT / SYNC RESIDENTS (Admin)\n+=========================================================== */\n export const approveResidentController = async (req, res) => {\n     const { requestID } = req.body;\n     if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n \n@@ -242,40 +229,32 @@\n         const tx = new sql.Transaction(pool);\n         await tx.begin();\n \n         try {\n-            // 1. Update MembershipRequest status to 'Approved'\n-            const updateRequestResult = await tx.request()\n+            const updateRequest = await tx.request()\n                 .input(\"RequestID\", sql.Int, requestID)\n                 .input(\"StatusApproved\", sql.NVarChar, 'Approved')\n                 .query(\"UPDATE MembershipRequests SET Status = @StatusApproved WHERE RequestID = @RequestID AND Status <> 'Synced'\");\n \n-            if (updateRequestResult.rowsAffected[0] === 0) {\n-                 await tx.rollback();\n-                 return res.status(404).json({ error: \"Request not found or already processed.\" });\n+            if (updateRequest.rowsAffected[0] === 0) {\n+                await tx.rollback();\n+                return res.status(404).json({ error: \"Request not found or already processed.\" });\n             }\n \n-            // 2. Insert the resident into the Residents table (sync logic)\n             const requestDataResult = await tx.request()\n                 .input(\"RequestID\", sql.Int, requestID)\n                 .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n             \n             const r = requestDataResult.recordset[0];\n-            if (!r) {\n-                await tx.rollback();\n-                return res.status(404).json({ error: \"Original request data not found.\" });\n-            }\n-            \n-            // Check if the resident already exists in the Residents table (optional, for safety)\n+            if (!r) { await tx.rollback(); return res.status(404).json({ error: \"Request data not found.\" }); }\n+\n             const existingResidentCheck = await tx.request()\n                 .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                 .query(\"SELECT ResidentID FROM Residents WHERE NationalID = @NationalID\");\n-            \n+\n             let newResidentID;\n-            \n             if (existingResidentCheck.recordset.length === 0) {\n-                 // Insert new resident\n-                 const insertResult = await tx.request()\n+                const insertResult = await tx.request()\n                     .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n                     .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                     .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n                     .input(\"Email\", sql.NVarChar, r.Email)\n@@ -289,40 +268,31 @@\n                         (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n                         OUTPUT INSERTED.ResidentID\n                         VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n                     `);\n-                    newResidentID = insertResult.recordset[0].ResidentID;\n+                newResidentID = insertResult.recordset[0].ResidentID;\n             } else {\n-                 // Resident already exists, use existing ID and update request status to synced\n-                 newResidentID = existingResidentCheck.recordset[0].ResidentID;\n+                newResidentID = existingResidentCheck.recordset[0].ResidentID;\n             }\n \n-            // 3. Update the Request with the new ResidentID (RecordID) and set status to Synced\n             await tx.request()\n                 .input(\"RecordID\", sql.Int, newResidentID)\n                 .input(\"RequestID\", sql.Int, requestID)\n                 .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n                 .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n \n-\n             await tx.commit();\n             res.status(200).json({ message: \"Resident approved and synced successfully.\", residentID: newResidentID });\n-\n         } catch (err) {\n             await tx.rollback();\n             throw err;\n         }\n-\n     } catch (err) {\n         console.error(\"Approve resident error:\", err);\n         res.status(500).json({ error: \"Failed to approve resident\", details: err.message });\n     }\n };\n \n-\n-// ============================================================\n-// ADMIN ACTION: REJECT RESIDENT\n-// ============================================================\n export const rejectResidentController = async (req, res) => {\n     const { requestID, reason } = req.body;\n     if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n \n@@ -333,40 +303,36 @@\n             .input(\"StatusRejected\", sql.NVarChar(50), 'Rejected')\n             .input(\"Reason\", sql.NVarChar(255), reason || 'Rejected by administrator.')\n             .query(\"UPDATE MembershipRequests SET Status = @StatusRejected, AdminNotes = @Reason WHERE RequestID = @RequestID AND Status = 'Pending'\");\n \n-        if (result.rowsAffected[0] === 0) {\n-            return res.status(404).json({ error: \"Request not found or already processed.\" });\n-        }\n+        if (result.rowsAffected[0] === 0) return res.status(404).json({ error: \"Request not found or already processed.\" });\n \n         res.status(200).json({ message: `Membership request ${requestID} rejected.` });\n-\n     } catch (err) {\n         console.error(\"Reject resident error:\", err);\n         res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n     }\n };\n \n-\n-// ============================================================\n-// APPROVED RESIDENTS\n-// ============================================================\n+/* ===========================================================\n+   APPROVED RESIDENTS LIST\n+=========================================================== */\n export const getApprovedResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const result = await pool.request()\n-            .input(\"StatusApproved\", sql.NVarChar(50), 'Active') // Fetches 'Active' status from Residents table\n+            .input(\"StatusApproved\", sql.NVarChar(50), 'Active')\n             .query(\"SELECT * FROM Residents WHERE Status = @StatusApproved ORDER BY ResidentName ASC\");\n         res.status(200).json(result.recordset);\n     } catch (err) {\n         console.error(err);\n         res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// PAYMENT STATUS\n-// ============================================================\n+/* ===========================================================\n+   PAYMENT STATUS\n+=========================================================== */\n export const getPaymentStatusController = async (req, res) => {\n     const phone = req.query.phone;\n     if (!phone) return res.status(400).json({ error: \"Phone required\" });\n \n@@ -393,17 +359,13 @@\n         res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n     }\n };\n \n-// Alias for backward compatibility\n export const loadPaymentStatus = getPaymentStatusController;\n \n-// ============================================================\n-// PAY FOR SERVICE\n-// ============================================================\n-// ------------------------------------------------------------------\n-// PAY FOR SERVICE (records in Payments + PaymentHistory)\n-// ------------------------------------------------------------------\n+/* ===========================================================\n+   PAY FOR SERVICE\n+=========================================================== */\n export const payForService = async (req, res) => {\n     try {\n         const { phone, serviceName, amount } = req.body;\n         const nationalID = req.user.NationalID;\n@@ -416,9 +378,8 @@\n             return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n \n         const pool = await dbPool;\n \n-        // 1️⃣ Insert into Payments\n         const result = await pool.request()\n             .input(\"PhoneNumber\", sql.VarChar(20), phone)\n             .input(\"NationalID\", sql.VarChar(50), nationalID)\n             .input(\"ResidentID\", sql.Int, residentID)\n@@ -427,22 +388,21 @@\n             .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n             .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n             .query(`\n                 INSERT INTO Payments\n-                    (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n+                (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n                 OUTPUT INSERTED.*\n                 VALUES\n-                    (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n+                (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n             `);\n \n-        // 2️⃣ Insert into PaymentHistory with additional columns\n         await pool.request()\n             .input(\"ResidentID\", sql.Int, residentID)\n             .input(\"Amount\", sql.Decimal(18, 2), amount)\n             .input(\"NationalID\", sql.VarChar(50), nationalID)\n             .input(\"ServiceName\", sql.NVarChar(100), serviceName || null)\n             .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .input(\"VerifiedDate\", sql.DateTime, null) // initially null\n+            .input(\"VerifiedDate\", sql.DateTime, null)\n             .input(\"Reference\", sql.VarChar(100), serviceName || null)\n             .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n             .query(`\n                 INSERT INTO PaymentHistory \n@@ -450,9 +410,8 @@\n                 VALUES \n                 (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n             `);\n \n-\n         res.status(201).json({\n             message: \"Payment initialized and history recorded\",\n             payment: result.recordset[0],\n         });\n@@ -464,12 +423,13 @@\n         });\n     }\n };\n \n+export const payController = payForService;\n \n-// ============================================================\n-// SYNC RESIDENTS (Utility function, kept for reference but logic moved to approveResidentController)\n-// ============================================================\n+/* ===========================================================\n+   SYNC RESIDENTS\n+=========================================================== */\n export const syncResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const tx = new sql.Transaction(pool);\n@@ -528,5 +488,4 @@\n         console.error(err);\n         res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n     }\n };\n-export const payController = payForService;\n\\ No newline at end of file\n"
                }
            ],
            "date": 1763641226781,
            "name": "Commit-0",
            "content": "// residentsController.js\n\n// ============================================================\n// IMPORTS\n// ============================================================\nimport sql from \"mssql\";\nimport { dbPool } from \"../server.js\";\n\n// ============================================================\n// DASHBOARD SUMMARY (ADMIN)\n// ============================================================\nexport const getDashboardSummary = async (req, res) => {\n    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n    const OVERRIDES_TABLE = \"[EstateAccessManagementSystem].[dbo].[gate_overrides]\";\n\n    try {\n        const pool = await dbPool;\n\n        const totalResidentsResult = await pool.request().query(\n            \"SELECT COUNT(ResidentID) AS residents FROM Residents\"\n        );\n        const residents = totalResidentsResult.recordset[0]?.residents || 0;\n\n        const pendingPaymentsResult = await pool\n            .request()\n            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n            .query(\"SELECT COUNT(PaymentID) AS pendingPayments FROM Payments WHERE Status = @StatusPending\");\n        const pendingPayments = pendingPaymentsResult.recordset[0]?.pendingPayments || 0;\n\n        const paidResidentsCountResult = await pool\n            .request()\n            .input(\"StatusVerified\", sql.NVarChar(50), 'Verified')\n            .query(\"SELECT COUNT(DISTINCT ResidentID) AS paidResidents FROM Payments WHERE Status = @StatusVerified\");\n        const paidResidents = paidResidentsCountResult.recordset[0]?.paidResidents || 0;\n\n        const compliance = residents > 0 ? Math.round((parseFloat(paidResidents) / residents) * 100) : 0;\n\n        const overrideMetricsResult = await pool.request().query(`\n            SELECT COUNT(id) AS overrideCount\n            FROM ${OVERRIDES_TABLE}\n            WHERE CAST(createdAt AS DATE) = CAST(GETDATE() AS DATE);\n        `);\n        const overrideCount = overrideMetricsResult.recordset[0]?.overrideCount || 0;\n\n        const accessMetricsResult = await pool.request().query(`\n            SELECT \n                SUM(CASE WHEN [Action] = 'CheckIn' THEN 1 ELSE 0 END) AS visitorscheckedin,\n                SUM(CASE WHEN [Action] = 'CheckOut' THEN 1 ELSE 0 END) AS visitorscheckedout,\n                SUM(CASE WHEN [Action] = 'Access Denied' THEN 1 ELSE 0 END) AS rejects \n            FROM ${ACCESS_LOGS_TABLE}\n            WHERE CAST(TimestampUtc AS DATE) = CAST(GETDATE() AS DATE);\n        `);\n        const accessData = accessMetricsResult.recordset[0] || {\n            visitorscheckedin: 0,\n            visitorscheckedout: 0,\n            rejects: 0,\n        };\n\n        res.status(200).json({\n            residents,\n            pendingPayments,\n            compliance,\n            overrideCount,\n            visitorscheckedin: accessData.visitorscheckedin,\n            visitorscheckedout: accessData.visitorscheckedout,\n            rejects: accessData.rejects,\n        });\n\n    } catch (err) {\n        console.error(\"Dashboard summary error:\", err.stack);\n        res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n    }\n};\n\n// ============================================================\n// ACCESS CHART (ADMIN)\n// ============================================================\nexport const getAccessChartData = async (req, res) => {\n    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n\n    try {\n        const pool = await dbPool;\n\n        const result = await pool.request().query(`\n            SELECT \n                FORMAT(TimestampUtc, 'MM/dd') AS DayLabel,\n                COUNT(*) AS AccessCount\n            FROM ${ACCESS_LOGS_TABLE}\n            WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n            GROUP BY FORMAT(TimestampUtc, 'MM/dd')\n            ORDER BY MIN(TimestampUtc) ASC;\n        `);\n\n        res.status(200).json({\n            days: result.recordset.map(r => r.DayLabel),\n            counts: result.recordset.map(r => r.AccessCount),\n        });\n    } catch (err) {\n        console.error(\"Access chart error:\", err.stack);\n        res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n    }\n};\n\n// ============================================================\n// RESIDENT PROFILE\n// ============================================================\nexport const getResidentProfile = async (req, res) => {\n    try {\n        const residentId = req.user?.ResidentID;\n        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n\n        const pool = await dbPool;\n\n        const result = await pool.request()\n            .input(\"ResidentID\", sql.Int, residentId)\n            .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n\n        if (!result.recordset.length) return res.status(404).json({ error: \"Resident not found\" });\n\n        res.status(200).json(result.recordset[0]);\n    } catch (err) {\n        console.error(\"Resident profile error:\", err);\n        res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n    }\n};\n\n// ============================================================\n// ALL RESIDENTS (ADMIN)\n// ============================================================\nexport const getAllResidents = async (req, res) => {\n    try {\n        const pool = await dbPool;\n        const result = await pool.request().query(\"SELECT * FROM Residents ORDER BY ResidentName ASC\");\n        res.status(200).json(result.recordset);\n    } catch (err) {\n        res.status(500).json({ error: \"Failed to load residents\", details: err.message });\n    }\n};\n\n// ============================================================\n// VISITOR ACCESS\n// ============================================================\nexport const getVisitorsAccess = async (req, res) => {\n    try {\n        const residentId = req.user?.ResidentID;\n        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"ResidentID\", sql.Int, residentId)\n            .query(\"SELECT TOP 50 * FROM Visitors WHERE ResidentID = @ResidentID ORDER BY VisitDate DESC\");\n\n        res.status(200).json({ visitors: result.recordset });\n    } catch (err) {\n        console.error(\"Failed to load visitor access\", err);\n        res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n    }\n};\n\n// ============================================================\n// VISITOR PASSES\n// ============================================================\nexport const getVisitorPasses = async (req, res) => {\n    const residentID = req.user?.ResidentID;\n    if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input('ResidentID', sql.Int, residentID)\n            .query(`\n                SELECT VisitorName, AccessCode, Status \n                FROM VisitorsAccess\n                WHERE ResidentID = @ResidentID\n                ORDER BY CreatedAt DESC\n            `);\n\n        res.status(200).json(result.recordset || []);\n    } catch (err) {\n        console.error(\"Error retrieving visitor passes:\", err);\n        res.status(500).json({ error: \"Failed to retrieve visitor passes\" });\n    }\n};\n\n// ============================================================\n// MEMBERSHIP REQUESTS (MODIFIED for Admin/Resident split)\n// ============================================================\nexport const getMembershipRequests = async (req, res) => {\n    const residentNationalID = req.user?.NationalID;\n    const residentRole = req.user?.RoleName; // Assuming RoleName is passed in the token\n    \n    // Determine if the user is an Admin (or similar high-privilege role)\n    // IMPORTANT: Adjust this check if your admin role is named differently or if you use a dedicated isAdmin flag.\n    const isAdmin = residentRole && residentRole.toLowerCase() === 'admin';\n    \n    try {\n        const pool = await dbPool;\n        let query;\n        let request = pool.request();\n\n        if (isAdmin) {\n            // Admin: Fetch all membership requests\n            query = `\n                SELECT \n                    RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n                FROM MembershipRequests \n                ORDER BY RequestedAt DESC\n            `;\n        } else if (residentNationalID) {\n            // Resident: Fetch only their own requests\n            request = request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n            query = `\n                SELECT \n                    RequestID, ResidentName, Status, RequestedAt \n                FROM MembershipRequests \n                WHERE NationalID = @NationalID \n                ORDER BY RequestedAt DESC\n            `;\n        } else {\n            // Unauthorized or invalid token for non-admin\n             return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n        }\n\n        const result = await request.query(query);\n        res.status(200).json(result.recordset);\n\n    } catch (err) {\n        console.error(\"Failed to load membership requests:\", err);\n        res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n    }\n};\n\n// ============================================================\n// ADMIN ACTION: APPROVE RESIDENT\n// ============================================================\nexport const approveResidentController = async (req, res) => {\n    const { requestID } = req.body;\n    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n\n    try {\n        const pool = await dbPool;\n        const tx = new sql.Transaction(pool);\n        await tx.begin();\n\n        try {\n            // 1. Update MembershipRequest status to 'Approved'\n            const updateRequestResult = await tx.request()\n                .input(\"RequestID\", sql.Int, requestID)\n                .input(\"StatusApproved\", sql.NVarChar, 'Approved')\n                .query(\"UPDATE MembershipRequests SET Status = @StatusApproved WHERE RequestID = @RequestID AND Status <> 'Synced'\");\n\n            if (updateRequestResult.rowsAffected[0] === 0) {\n                 await tx.rollback();\n                 return res.status(404).json({ error: \"Request not found or already processed.\" });\n            }\n\n            // 2. Insert the resident into the Residents table (sync logic)\n            const requestDataResult = await tx.request()\n                .input(\"RequestID\", sql.Int, requestID)\n                .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n            \n            const r = requestDataResult.recordset[0];\n            if (!r) {\n                await tx.rollback();\n                return res.status(404).json({ error: \"Original request data not found.\" });\n            }\n            \n            // Check if the resident already exists in the Residents table (optional, for safety)\n            const existingResidentCheck = await tx.request()\n                .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                .query(\"SELECT ResidentID FROM Residents WHERE NationalID = @NationalID\");\n            \n            let newResidentID;\n            \n            if (existingResidentCheck.recordset.length === 0) {\n                 // Insert new resident\n                 const insertResult = await tx.request()\n                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n                    .input(\"Email\", sql.NVarChar, r.Email)\n                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n                    .input(\"DateJoined\", sql.DateTime, new Date())\n                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n                    .query(`\n                        INSERT INTO Residents\n                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n                        OUTPUT INSERTED.ResidentID\n                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n                    `);\n                    newResidentID = insertResult.recordset[0].ResidentID;\n            } else {\n                 // Resident already exists, use existing ID and update request status to synced\n                 newResidentID = existingResidentCheck.recordset[0].ResidentID;\n            }\n\n            // 3. Update the Request with the new ResidentID (RecordID) and set status to Synced\n            await tx.request()\n                .input(\"RecordID\", sql.Int, newResidentID)\n                .input(\"RequestID\", sql.Int, requestID)\n                .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n                .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n\n\n            await tx.commit();\n            res.status(200).json({ message: \"Resident approved and synced successfully.\", residentID: newResidentID });\n\n        } catch (err) {\n            await tx.rollback();\n            throw err;\n        }\n\n    } catch (err) {\n        console.error(\"Approve resident error:\", err);\n        res.status(500).json({ error: \"Failed to approve resident\", details: err.message });\n    }\n};\n\n\n// ============================================================\n// ADMIN ACTION: REJECT RESIDENT\n// ============================================================\nexport const rejectResidentController = async (req, res) => {\n    const { requestID, reason } = req.body;\n    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"RequestID\", sql.Int, requestID)\n            .input(\"StatusRejected\", sql.NVarChar(50), 'Rejected')\n            .input(\"Reason\", sql.NVarChar(255), reason || 'Rejected by administrator.')\n            .query(\"UPDATE MembershipRequests SET Status = @StatusRejected, AdminNotes = @Reason WHERE RequestID = @RequestID AND Status = 'Pending'\");\n\n        if (result.rowsAffected[0] === 0) {\n            return res.status(404).json({ error: \"Request not found or already processed.\" });\n        }\n\n        res.status(200).json({ message: `Membership request ${requestID} rejected.` });\n\n    } catch (err) {\n        console.error(\"Reject resident error:\", err);\n        res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n    }\n};\n\n\n// ============================================================\n// APPROVED RESIDENTS\n// ============================================================\nexport const getApprovedResidents = async (req, res) => {\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"StatusApproved\", sql.NVarChar(50), 'Active') // Fetches 'Active' status from Residents table\n            .query(\"SELECT * FROM Residents WHERE Status = @StatusApproved ORDER BY ResidentName ASC\");\n        res.status(200).json(result.recordset);\n    } catch (err) {\n        console.error(err);\n        res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n    }\n};\n\n// ============================================================\n// PAYMENT STATUS\n// ============================================================\nexport const getPaymentStatusController = async (req, res) => {\n    const phone = req.query.phone;\n    if (!phone) return res.status(400).json({ error: \"Phone required\" });\n\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n            .query(\"SELECT TOP 1 * FROM Payments WHERE PhoneNumber = @PhoneNumber ORDER BY PaymentID DESC\");\n\n        if (!result.recordset.length) return res.status(200).json({ isPaid: false, status: \"No Record Found\", phone });\n\n        const p = result.recordset[0];\n        const isPaid = [\"paid\", \"verified\"].includes(p.Status?.toLowerCase());\n\n        res.status(200).json({\n            phone: p.PhoneNumber,\n            status: p.Status,\n            amount: p.Amount,\n            paymentDate: p.PaymentDate,\n            isPaid,\n        });\n    } catch (err) {\n        console.error(err);\n        res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n    }\n};\n\n// Alias for backward compatibility\nexport const loadPaymentStatus = getPaymentStatusController;\n\n// ============================================================\n// PAY FOR SERVICE\n// ============================================================\n// ------------------------------------------------------------------\n// PAY FOR SERVICE (records in Payments + PaymentHistory)\n// ------------------------------------------------------------------\nexport const payForService = async (req, res) => {\n    try {\n        const { phone, serviceName, amount } = req.body;\n        const nationalID = req.user.NationalID;\n        const residentID = req.user.ResidentID;\n\n        if (!nationalID || !residentID)\n            return res.status(401).json({ error: \"Missing resident data in token\" });\n\n        if (!phone || !serviceName || !amount)\n            return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n\n        const pool = await dbPool;\n\n        // 1️⃣ Insert into Payments\n        const result = await pool.request()\n            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n            .input(\"NationalID\", sql.VarChar(50), nationalID)\n            .input(\"ResidentID\", sql.Int, residentID)\n            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n            .input(\"Amount\", sql.Decimal(18, 2), amount)\n            .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n            .query(`\n                INSERT INTO Payments\n                    (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n                OUTPUT INSERTED.*\n                VALUES\n                    (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n            `);\n\n        // 2️⃣ Insert into PaymentHistory with additional columns\n        await pool.request()\n            .input(\"ResidentID\", sql.Int, residentID)\n            .input(\"Amount\", sql.Decimal(18, 2), amount)\n            .input(\"NationalID\", sql.VarChar(50), nationalID)\n            .input(\"ServiceName\", sql.NVarChar(100), serviceName || null)\n            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n            .input(\"VerifiedDate\", sql.DateTime, null) // initially null\n            .input(\"Reference\", sql.VarChar(100), serviceName || null)\n            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n            .query(`\n                INSERT INTO PaymentHistory \n                (ResidentID, Amount, NationalID, ServiceName, PhoneNumber, VerifiedDate, Status, PaymentDate, Reference)\n                VALUES \n                (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n            `);\n\n\n        res.status(201).json({\n            message: \"Payment initialized and history recorded\",\n            payment: result.recordset[0],\n        });\n\n    } catch (err) {\n        res.status(500).json({\n            error: \"Payment failed\",\n            details: err.message,\n        });\n    }\n};\n\n\n// ============================================================\n// SYNC RESIDENTS (Utility function, kept for reference but logic moved to approveResidentController)\n// ============================================================\nexport const syncResidents = async (req, res) => {\n    try {\n        const pool = await dbPool;\n        const tx = new sql.Transaction(pool);\n        await tx.begin();\n\n        try {\n            const pendingRequestsResult = await tx.request()\n                .input(\"StatusApproved\", sql.NVarChar(50), 'Approved')\n                .query(\"SELECT * FROM MembershipRequests WHERE Status = @StatusApproved AND RecordID IS NULL\");\n\n            const pending = pendingRequestsResult.recordset;\n            if (!pending.length) {\n                await tx.commit();\n                return res.status(200).json({ message: \"No new residents to sync.\" });\n            }\n\n            let synced = 0;\n            for (const r of pending) {\n                const insertResult = await tx.request()\n                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n                    .input(\"Email\", sql.NVarChar, r.Email)\n                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n                    .input(\"DateJoined\", sql.DateTime, new Date())\n                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n                    .query(`\n                        INSERT INTO Residents\n                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n                        OUTPUT INSERTED.ResidentID\n                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n                    `);\n\n                const newResidentID = insertResult.recordset[0].ResidentID;\n\n                await tx.request()\n                    .input(\"RecordID\", sql.Int, newResidentID)\n                    .input(\"RequestID\", sql.Int, r.RequestID)\n                    .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n                    .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n\n                synced++;\n            }\n\n            await tx.commit();\n            res.status(200).json({ message: `Successfully synced ${synced} resident(s).` });\n\n        } catch (err) {\n            await tx.rollback();\n            throw err;\n        }\n\n    } catch (err) {\n        console.error(err);\n        res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n    }\n};\nexport const payController = payForService;"
        }
    ]
}