{
    "sourceFile": "backend/controllers/membershipController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 16,
            "patches": [
                {
                    "date": 1763695091299,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763697199040,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,30 +1,26 @@\n // ==========================================\n // controllers/membershipController.js\n // Unified controller for Residents + Admins\n-// FIX APPLIED: submitMembershipRequest now generates RequestID and uses RoleName from body.\n // ==========================================\n \n import sql from \"mssql\";\n import dotenv from \"dotenv\";\n dotenv.config();\n \n // ==========================================\n-// Database Configuration (Consolidated from your snippets)\n+// Database Configuration\n // ==========================================\n-// NOTE: This assumes 'dbConfig' is not imported from a separate file (e.g., ../config/dbConfig.js) \n-// but is defined inline, as suggested by your initial context.\n const dbConfig = {\n     user: process.env.DB_USER || \"Beverly\",\n     password: process.env.DB_PASS || \"Bev@1234567\",\n     server: process.env.DB_SERVER || \"localhost\",\n     database: process.env.DB_NAME || \"EstateAccessManagementSystem\",\n     options: { encrypt: true, trustServerCertificate: true },\n };\n \n-\n // ====================================================\n-// RESIDENT / ADMIN: Submit membership request (FIXED)\n+// RESIDENT: Submit membership request\n // ====================================================\n export const submitMembershipRequest = async (req, res) => {\n     const {\n         ResidentName,\n@@ -32,96 +28,57 @@\n         PhoneNumber,\n         Email,\n         HouseNumber,\n         CourtName,\n-        RoleName, // <--- Get RoleName from form body\n-        // Action is also sent in the body if the form includes it, but omitted here for simplicity\n+        RoleName,\n     } = req.body;\n \n     try {\n-        // ==========================================\n-        // VALIDATION\n-        // ==========================================\n+        if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+            return res.status(400).json({ success: false, message: \"Missing required fields\" });\n+        }\n \n-        // 1ï¸âƒ£ Validate required fields\n-        if (\n-            !ResidentName ||\n-            !NationalID ||\n-            !PhoneNumber ||\n-            !Email ||\n-            !HouseNumber ||\n-            !CourtName ||\n-            !RoleName\n-        ) {\n-            return res\n-                .status(400)\n-                .json({ success: false, message: \"Missing required fields\" });\n-        }\n-        \n         const pool = await sql.connect(dbConfig);\n-        \n-        // 2ï¸âƒ£ ðŸ”¥ FIX: Manually calculate the next sequential RequestID\n-        const maxRequestResult = await pool.request().query(\n-            \"SELECT ISNULL(MAX(RequestID), 0) AS maxID FROM MembershipRequests\"\n-        );\n+\n+        // Calculate next RequestID\n+        const maxRequestResult = await pool.request().query(\"SELECT ISNULL(MAX(RequestID), 0) AS maxID FROM MembershipRequests\");\n         const nextRequestID = maxRequestResult.recordset[0].maxID + 1;\n \n-\n-        // ==========================================\n-        // INSERT MEMBERSHIP REQUEST\n-        // ==========================================\n-\n-        await pool\n-            .request()\n-            .input(\"RequestID\", sql.Int, nextRequestID) // <--- INSERT NEWLY GENERATED ID\n-            // UserID is omitted because the user is unauthenticated (no token)\n-            // Action is omitted from insertion if not explicitly sent by the simple form\n+        // Insert new membership request\n+        await pool.request()\n+            .input(\"RequestID\", sql.Int, nextRequestID)\n             .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n             .input(\"NationalID\", sql.NVarChar(50), NationalID)\n             .input(\"PhoneNumber\", sql.NVarChar(50), PhoneNumber)\n             .input(\"Email\", sql.NVarChar(100), Email)\n             .input(\"HouseNumber\", sql.NVarChar(50), HouseNumber)\n             .input(\"CourtName\", sql.NVarChar(50), CourtName)\n-            .input(\"RoleName\", sql.NVarChar(50), RoleName) // <--- Use RoleName from form body\n+            .input(\"RoleName\", sql.NVarChar(50), RoleName)\n             .input(\"Status\", sql.NVarChar(50), \"Pending\")\n             .input(\"RequestedAt\", sql.DateTime, new Date())\n             .query(`\n                 INSERT INTO MembershipRequests\n-                  (RequestID, ResidentName, NationalID, PhoneNumber, Email, \n-                   HouseNumber, CourtName, RoleName, Status, RequestedAt)\n+                (RequestID, ResidentName, NationalID, PhoneNumber, Email, \n+                 HouseNumber, CourtName, RoleName, Status, RequestedAt)\n                 VALUES \n-                  (@RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, \n-                   @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n+                (@RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, \n+                 @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n             `);\n \n-        // ==========================================\n-        // SUCCESS\n-        // ==========================================\n-        return res.status(200).json({\n-            success: true,\n-            message: \"Membership request submitted successfully. Awaiting approval.\",\n-        });\n+        return res.status(200).json({ success: true, message: \"Membership request submitted successfully. Awaiting approval.\" });\n     } catch (err) {\n         console.error(\"âŒ submitMembershipRequest Error:\", err);\n-        return res.status(500).json({\n-            success: false,\n-            message: \"Server error during submission\",\n-            error: err.message,\n-        });\n+        return res.status(500).json({ success: false, message: \"Server error during submission\", error: err.message });\n     }\n };\n \n-\n // ====================================================\n-// ADMIN: View all membership requests\n+// ADMIN: Get all membership requests\n // ====================================================\n export const getAllMembershipRequests = async (req, res) => {\n     try {\n         const pool = await sql.connect(dbConfig);\n-        const result = await pool\n-            .request()\n-            .query(\"SELECT TOP (1000) * FROM MembershipRequests ORDER BY RequestedAt DESC\");\n-\n+        const result = await pool.request().query(\"SELECT TOP (1000) * FROM MembershipRequests ORDER BY RequestedAt DESC\");\n         res.status(200).json({ success: true, data: result.recordset });\n     } catch (err) {\n         console.error(\"âŒ getAllMembershipRequests Error:\", err);\n         res.status(500).json({ success: false, message: \"Server error\" });\n@@ -131,230 +88,157 @@\n // ====================================================\n // ADMIN: Approve membership request\n // ====================================================\n export const approveMembershipRequest = async (req, res) => {\n-   const { RequestID } = req.params;\n+    const { RequestID } = req.params;\n+    try {\n+        const pool = await sql.connect(dbConfig);\n \n-   try {\n-    const pool = await sql.connect(dbConfig);\n+        // Get request details\n+        const requestResult = await pool.request()\n+            .input(\"RequestID\", sql.Int, RequestID)\n+            .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n \n-    // 1. Get request details\n-    const requestResult = await pool\n-        .request()\n-        .input(\"RequestID\", sql.Int, RequestID)\n-        .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n+        if (requestResult.recordset.length === 0) return res.status(404).json({ success: false, message: \"Request not found\" });\n \n-    if (requestResult.recordset.length === 0) {\n-       return res.status(404).json({ success: false, message: \"Request not found\" });\n-    }\n+        const r = requestResult.recordset[0];\n \n-    const r = requestResult.recordset[0];\n+        // Calculate next RecordID\n+        const maxRecordResult = await pool.request().query(\"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\");\n+        const nextRecordID = maxRecordResult.recordset[0].maxID + 1;\n \n-    // 2. ðŸ”¥ MANUALLY CALCULATE NEXT RecordID (CRITICAL FIX)\n-    const maxRecordResult = await pool.request().query(\n-        \"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\"\n-    );\n-    const nextRecordID = maxRecordResult.recordset[0].maxID + 1;\n-    \n-    // 3. Update status to Approved\n-    await pool\n-        .request()\n-        .input(\"RequestID\", sql.Int, RequestID)\n-        .query(\"UPDATE MembershipRequests SET Status = 'Approved' WHERE RequestID = @RequestID\");\n+        // Update request status to Approved\n+        await pool.request()\n+            .input(\"RequestID\", sql.Int, RequestID)\n+            .query(\"UPDATE MembershipRequests SET Status = 'Approved' WHERE RequestID = @RequestID\");\n \n-    // 4. Move approved request into MembershipRecords\n-    await pool\n-        .request()\n-        .input(\"RequestID\", sql.Int, RequestID)\n-        .input(\"RecordID\", sql.Int, nextRecordID) // <-- NEW: Input the calculated ID\n-        .input(\"ResidentName\", sql.NVarChar(100), r.ResidentName)\n-        .input(\"NationalID\", sql.NVarChar(50), r.NationalID)\n-        .input(\"PhoneNumber\", sql.NVarChar(50), r.PhoneNumber)\n-        .input(\"Email\", sql.NVarChar(100), r.Email)\n-        .input(\"HouseNumber\", sql.NVarChar(50), r.HouseNumber)\n-        .input(\"CourtName\", sql.NVarChar(50), r.CourtName)\n-        .input(\"RoleName\", sql.NVarChar(50), r.RoleName)\n-        .input(\"Status\", sql.NVarChar(50), \"Approved\")\n-        .input(\"RequestedAt\", sql.DateTime, r.RequestedAt)\n-        .input(\"Action\", sql.NVarChar(50), r.Action)\n-        .query(`\n-         INSERT INTO MembershipRecords\n-         (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n-         VALUES (@RecordID, @RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt, @Action)\n-        `); \n-\n-    res.json({\n-       success: true,\n-       message: \"Request approved and moved to records successfully\",\n-    });\n-   } catch (err) {\n-    console.error(\"âŒ approveMembershipRequest Error:\", err);\n-    res.status(500).json({ success: false, message: \"Server error\" });\n-   }\n-};\n-\n-// ====================================================\n-// ADMIN: Sync MembershipRequests â†’ MembershipRecords\n-// ====================================================\n-export const syncMembershipRecords = async (req, res) => {\n-   try {\n-    const pool = await sql.connect(dbConfig);\n-\n-    // 1. Fetch the current maximum RecordID\n-    const maxRecordResult = await pool.request().query(\n-        \"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\"\n-    );\n-    const startingRecordID = maxRecordResult.recordset[0].maxID;\n-\n-    // 2. Perform the bulk insert using the startingRecordID to offset the Row Number.\n-    const syncResult = await pool\n-            .request()\n-            .input(\"StartingID\", sql.Int, startingRecordID) \n+        // Move approved request to MembershipRecords\n+        await pool.request()\n+            .input(\"RecordID\", sql.Int, nextRecordID)\n+            .input(\"RequestID\", sql.Int, RequestID)\n+            .input(\"ResidentName\", sql.NVarChar(100), r.ResidentName)\n+            .input(\"NationalID\", sql.NVarChar(50), r.NationalID)\n+            .input(\"PhoneNumber\", sql.NVarChar(50), r.PhoneNumber)\n+            .input(\"Email\", sql.NVarChar(100), r.Email)\n+            .input(\"HouseNumber\", sql.NVarChar(50), r.HouseNumber)\n+            .input(\"CourtName\", sql.NVarChar(50), r.CourtName)\n+            .input(\"RoleName\", sql.NVarChar(50), r.RoleName)\n+            .input(\"Status\", sql.NVarChar(50), \"Approved\")\n+            .input(\"RequestedAt\", sql.DateTime, r.RequestedAt)\n+            .input(\"Action\", sql.NVarChar(50), r.Action)\n             .query(`\n-                -- CTE to identify requests that need to be synced\n-                WITH RequestsToSync AS (\n-                    SELECT \n-                        r.RequestID, \n-                        r.ResidentName, \n-                        r.NationalID, \n-                        r.PhoneNumber, \n-                        r.Email, \n-                        r.HouseNumber, \n-                        r.CourtName, \n-                        r.RoleName, \n-                        r.Status, \n-                        r.RequestedAt, \n-                        r.Action\n-                    FROM MembershipRequests r\n-                    WHERE NOT EXISTS (\n-                        SELECT 1 FROM MembershipRecords m WHERE m.RequestID = r.RequestID\n-                    )\n-                ),\n-                -- CTE to assign a sequential row number to the new records\n-                NumberedRequests AS (\n-                    SELECT \n-                        *,\n-                        ROW_NUMBER() OVER (ORDER BY RequestedAt ASC) as RowNum\n-                    FROM RequestsToSync\n-                )\n-                -- Final Insert statement\n-            INSERT INTO MembershipRecords\n-            (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n-            SELECT \n-                        (@StartingID + nr.RowNum) as CalculatedRecordID, -- Calculate new unique ID: MAX(ID) + RowNum\n-                        nr.RequestID, \n-                        nr.ResidentName, \n-                        nr.NationalID, \n-                        nr.PhoneNumber, \n-                        nr.Email, \n-                        nr.HouseNumber, \n-                        nr.CourtName, \n-                        nr.RoleName, \n-                        nr.Status, \n-                        nr.RequestedAt, \n-                        nr.Action\n-            FROM NumberedRequests nr;\n-    `);\n-    \n-    const rowsInserted = syncResult.rowsAffected[0];\n+                INSERT INTO MembershipRecords\n+                (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n+                VALUES (@RecordID, @RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt, @Action)\n+            `);\n \n-    res.json({ \n-        success: true, \n-        message: `${rowsInserted} record(s) synced successfully.` \n-    });\n-\n-   } catch (err) {\n-    console.error(\"âŒ syncMembershipRecords Error:\", err);\n-    res.status(500).json({ success: false, message: \"Sync failed. Check server logs for SQL error.\" });\n-   }\n+        res.json({ success: true, message: \"Request approved and moved to records successfully\" });\n+    } catch (err) {\n+        console.error(\"âŒ approveMembershipRequest Error:\", err);\n+        res.status(500).json({ success: false, message: \"Server error\" });\n+    }\n };\n \n-\n // ====================================================\n-// ADMIN: Get latest RequestID and RecordID for frontend\n+// ADMIN: Reject membership request\n // ====================================================\n-export const getLatestMembershipIDs = async (req, res) => {\n+export const rejectMembershipRequest = async (req, res) => {\n+    const { RequestID } = req.params;\n     try {\n         const pool = await sql.connect(dbConfig);\n+        await pool.request()\n+            .input(\"RequestID\", sql.Int, RequestID)\n+            .query(\"UPDATE MembershipRequests SET Status = 'Rejected' WHERE RequestID = @RequestID\");\n \n-        const result = await pool.request().query(`\n-            SELECT \n-                (SELECT ISNULL(MAX(RequestID), 0) FROM MembershipRequests) AS lastRequestID,\n-                (SELECT ISNULL(MAX(RecordID), 0) FROM MembershipRecords) AS lastRecordID;\n-        `);\n-\n-        const { lastRequestID, lastRecordID } = result.recordset[0];\n-\n-        res.status(200).json({\n-            success: true,\n-            lastRequestID,\n-            lastRecordID\n-        });\n-\n+        res.status(200).json({ success: true, message: \"Request rejected successfully\" });\n     } catch (err) {\n-        console.error(\"âŒ getLatestMembershipIDs Error:\", err);\n-        res.status(500).json({\n-            success: false,\n-            message: \"Failed to retrieve latest IDs.\",\n-            lastRequestID: 0,\n-            lastRecordID: 0\n-        });\n+        console.error(\"âŒ rejectMembershipRequest Error:\", err);\n+        res.status(500).json({ success: false, message: \"Server error\" });\n     }\n };\n \n // ====================================================\n-// ADMIN: Delete membership request (PLACEHOLDER)\n+// ADMIN: Delete membership request\n // ====================================================\n export const deleteMembershipRequest = async (req, res) => {\n     const { RequestID } = req.params;\n     try {\n         const pool = await sql.connect(dbConfig);\n-        const result = await pool\n\\ No newline at end of file\n-            .request()\n+        const result = await pool.request()\n             .input(\"RequestID\", sql.Int, RequestID)\n             .query(\"DELETE FROM MembershipRequests WHERE RequestID = @RequestID\");\n-        \n-        if (result.rowsAffected[0] === 0) {\n-            return res.status(404).json({ success: false, message: \"Request not found\" });\n-        }\n+\n+        if (result.rowsAffected[0] === 0) return res.status(404).json({ success: false, message: \"Request not found\" });\n+\n         res.status(200).json({ success: true, message: \"Request deleted successfully\" });\n     } catch (err) {\n         console.error(\"âŒ deleteMembershipRequest Error:\", err);\n         res.status(500).json({ success: false, message: \"Server error\" });\n     }\n };\n \n // ====================================================\n-// ADMIN: Reject membership request (PLACEHOLDER)\n+// ADMIN: Sync MembershipRequests â†’ MembershipRecords\n // ====================================================\n-export const rejectMembershipRequest = async (req, res) => {\n-    const { RequestID } = req.params;\n+export const syncMembershipRecords = async (req, res) => {\n     try {\n         const pool = await sql.connect(dbConfig);\n-        await pool\n-            .request()\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .query(\"UPDATE MembershipRequests SET Status = 'Rejected' WHERE RequestID = @RequestID\");\n \n-        res.status(200).json({ success: true, message: \"Request rejected successfully\" });\n+        const maxRecordResult = await pool.request().query(\"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\");\n+        const startingRecordID = maxRecordResult.recordset[0].maxID;\n+\n+        await pool.request()\n+            .input(\"StartingID\", sql.Int, startingRecordID)\n+            .query(`\n+                WITH RequestsToSync AS (\n+                    SELECT r.RequestID, r.ResidentName, r.NationalID, r.PhoneNumber, r.Email, r.HouseNumber, r.CourtName, r.RoleName, r.Status, r.RequestedAt, r.Action\n+                    FROM MembershipRequests r\n+                    WHERE NOT EXISTS (SELECT 1 FROM MembershipRecords m WHERE m.RequestID = r.RequestID)\n+                ),\n+                NumberedRequests AS (\n+                    SELECT *, ROW_NUMBER() OVER (ORDER BY RequestedAt ASC) as RowNum FROM RequestsToSync\n+                )\n+                INSERT INTO MembershipRecords\n+                (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n+                SELECT (@StartingID + nr.RowNum) as CalculatedRecordID, nr.RequestID, nr.ResidentName, nr.NationalID, nr.PhoneNumber, nr.Email, nr.HouseNumber, nr.CourtName, nr.RoleName, nr.Status, nr.RequestedAt, nr.Action\n+                FROM NumberedRequests nr;\n+            `);\n+\n+        res.json({ success: true, message: \"Membership requests synced successfully.\" });\n     } catch (err) {\n-        console.error(\"âŒ rejectMembershipRequest Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error\" });\n+        console.error(\"âŒ syncMembershipRecords Error:\", err);\n+        res.status(500).json({ success: false, message: \"Sync failed. Check server logs for SQL error.\" });\n     }\n };\n \n // ====================================================\n-// ADMIN: Get all membership records (PLACEHOLDER)\n+// ADMIN: Get all membership records\n // ====================================================\n export const getAllMembershipRecords = async (req, res) => {\n     try {\n         const pool = await sql.connect(dbConfig);\n-        const result = await pool\n-            .request()\n-            .query(\"SELECT TOP (1000) * FROM MembershipRecords ORDER BY RequestedAt DESC\");\n-\n+        const result = await pool.request().query(\"SELECT TOP (1000) * FROM MembershipRecords ORDER BY RequestedAt DESC\");\n         res.status(200).json({ success: true, data: result.recordset });\n     } catch (err) {\n         console.error(\"âŒ getAllMembershipRecords Error:\", err);\n         res.status(500).json({ success: false, message: \"Server error\" });\n     }\n-};\n+};\n+\n+// ====================================================\n+// ADMIN: Get latest RequestID & RecordID\n+// ====================================================\n+export const getLatestMembershipIDs = async (req, res) => {\n+    try {\n+        const pool = await sql.connect(dbConfig);\n+        const result = await pool.request().query(`\n+            SELECT \n+                (SELECT ISNULL(MAX(RequestID), 0) FROM MembershipRequests) AS lastRequestID,\n+                (SELECT ISNULL(MAX(RecordID), 0) FROM MembershipRecords) AS lastRecordID;\n+        `);\n+        const { lastRequestID, lastRecordID } = result.recordset[0];\n+        res.status(200).json({ success: true, lastRequestID, lastRecordID });\n+    } catch (err) {\n+        console.error(\"âŒ getLatestMembershipIDs Error:\", err);\n+        res.status(500).json({ success: false, message: \"Failed to retrieve latest IDs.\", lastRequestID: 0, lastRecordID: 0 });\n+    }\n+};\n"
                },
                {
                    "date": 1763697576501,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,17 +21,9 @@\n // ====================================================\n // RESIDENT: Submit membership request\n // ====================================================\n export const submitMembershipRequest = async (req, res) => {\n-    const {\n-        ResidentName,\n-        NationalID,\n-        PhoneNumber,\n-        Email,\n-        HouseNumber,\n-        CourtName,\n-        RoleName,\n-    } = req.body;\n+    const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName } = req.body;\n \n     try {\n         if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n             return res.status(400).json({ success: false, message: \"Missing required fields\" });\n@@ -226,9 +218,9 @@\n \n // ====================================================\n // ADMIN: Get latest RequestID & RecordID\n // ====================================================\n-export const getLatestMembershipIDs = async (req, res) => {\n+export const getLatestMembershipRequest = async (req, res) => {\n     try {\n         const pool = await sql.connect(dbConfig);\n         const result = await pool.request().query(`\n             SELECT \n@@ -237,8 +229,8 @@\n         `);\n         const { lastRequestID, lastRecordID } = result.recordset[0];\n         res.status(200).json({ success: true, lastRequestID, lastRecordID });\n     } catch (err) {\n-        console.error(\"âŒ getLatestMembershipIDs Error:\", err);\n+        console.error(\"âŒ getLatestMembershipRequest Error:\", err);\n         res.status(500).json({ success: false, message: \"Failed to retrieve latest IDs.\", lastRequestID: 0, lastRecordID: 0 });\n     }\n };\n"
                },
                {
                    "date": 1763729260363,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,236 +1,135 @@\n-// ==========================================\n // controllers/membershipController.js\n-// Unified controller for Residents + Admins\n-// ==========================================\n-\n import sql from \"mssql\";\n import dotenv from \"dotenv\";\n dotenv.config();\n \n-// ==========================================\n-// Database Configuration\n-// ==========================================\n+// ==============================\n+// DB CONFIG - Loads connection settings from environment variables\n+// ==============================\n const dbConfig = {\n-    user: process.env.DB_USER || \"Beverly\",\n-    password: process.env.DB_PASS || \"Bev@1234567\",\n-    server: process.env.DB_SERVER || \"localhost\",\n-    database: process.env.DB_NAME || \"EstateAccessManagementSystem\",\n-    options: { encrypt: true, trustServerCertificate: true },\n+  user: process.env.DB_USER || \"Beverly\",\n+  password: process.env.DB_PASSWORD || \"Bev@1234567\",\n+  server: process.env.DB_SERVER || \"localhost\",\n+  database: process.env.DB_NAME || \"EstateAccessManagementSystem\",\n+  options: { encrypt: true, trustServerCertificate: true },\n };\n \n // ====================================================\n-// RESIDENT: Submit membership request\n+// SUBMIT MEMBERSHIP REQUEST (POST /api/membership)\n // ====================================================\n export const submitMembershipRequest = async (req, res) => {\n-    const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName } = req.body;\n+  const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action } = req.body;\n \n-    try {\n-        if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n-            return res.status(400).json({ success: false, message: \"Missing required fields\" });\n-        }\n+  // List of valid roles\n+  const validRoles = [\"Resident\", \"Security\", \"Admin\", \"Visitor\"];\n+  \n+  // 400 Bad Request if essential fields are missing\n+  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+    return res.status(400).json({ success: false, message: \"All fields except Action are required.\" });\n+  }\n \n-        const pool = await sql.connect(dbConfig);\n+  // Validate the role against the allowed list (to prevent \"Unknown role\" DB error)\n+  if (!validRoles.includes(RoleName)) {\n+      return res.status(400).json({ \n+          success: false, \n+          message: `Invalid role selected: ${RoleName}. Please select one of ${validRoles.join(', ')}.` \n+      });\n+  }\n \n-        // Calculate next RequestID\n-        const maxRequestResult = await pool.request().query(\"SELECT ISNULL(MAX(RequestID), 0) AS maxID FROM MembershipRequests\");\n-        const nextRequestID = maxRequestResult.recordset[0].maxID + 1;\n+  try {\n+    const pool = await sql.connect(dbConfig);\n \n-        // Insert new membership request\n-        await pool.request()\n-            .input(\"RequestID\", sql.Int, nextRequestID)\n-            .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n-            .input(\"NationalID\", sql.NVarChar(50), NationalID)\n-            .input(\"PhoneNumber\", sql.NVarChar(50), PhoneNumber)\n-            .input(\"Email\", sql.NVarChar(100), Email)\n-            .input(\"HouseNumber\", sql.NVarChar(50), HouseNumber)\n-            .input(\"CourtName\", sql.NVarChar(50), CourtName)\n-            .input(\"RoleName\", sql.NVarChar(50), RoleName)\n-            .input(\"Status\", sql.NVarChar(50), \"Pending\")\n-            .input(\"RequestedAt\", sql.DateTime, new Date())\n-            .query(`\n-                INSERT INTO MembershipRequests\n-                (RequestID, ResidentName, NationalID, PhoneNumber, Email, \n-                 HouseNumber, CourtName, RoleName, Status, RequestedAt)\n-                VALUES \n-                (@RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, \n-                 @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n-            `);\n+    await pool.request()\n+      // Use robust NVarChar data types\n+      .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n+      .input(\"NationalID\", sql.NVarChar(50), NationalID)\n+      .input(\"PhoneNumber\", sql.NVarChar(50), PhoneNumber)\n+      .input(\"Email\", sql.NVarChar(100), Email)\n+      .input(\"HouseNumber\", sql.NVarChar(50), HouseNumber)\n+      .input(\"CourtName\", sql.NVarChar(50), CourtName)\n+      .input(\"RoleName\", sql.NVarChar(50), RoleName)\n+      // Pass NULL if Action is empty\n+      .input(\"Action\", sql.NVarChar(100), Action || null) \n+      .query(`\n+        INSERT INTO MembershipRequests\n+        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n+        VALUES\n+        (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, 'Pending', GETDATE())\n+      `);\n \n-        return res.status(200).json({ success: true, message: \"Membership request submitted successfully. Awaiting approval.\" });\n-    } catch (err) {\n-        console.error(\"âŒ submitMembershipRequest Error:\", err);\n-        return res.status(500).json({ success: false, message: \"Server error during submission\", error: err.message });\n-    }\n-};\n+    res.status(201).json({ success: true, message: \"Membership request submitted successfully.\" });\n \n-// ====================================================\n-// ADMIN: Get all membership requests\n-// ====================================================\n-export const getAllMembershipRequests = async (req, res) => {\n-    try {\n-        const pool = await sql.connect(dbConfig);\n-        const result = await pool.request().query(\"SELECT TOP (1000) * FROM MembershipRequests ORDER BY RequestedAt DESC\");\n-        res.status(200).json({ success: true, data: result.recordset });\n-    } catch (err) {\n-        console.error(\"âŒ getAllMembershipRequests Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error\" });\n-    }\n+  } catch (err) {\n+    console.error(\"âŒ Membership request failed:\", err);\n+    res.status(500).json({ \n+        success: false, \n+        message: \"Server error or Database connection failed.\", \n+        details: err.message \n+    });\n+  }\n };\n \n // ====================================================\n-// ADMIN: Approve membership request\n+// APPROVE MEMBERSHIP REQUEST (PUT /api/membership/approve/:RequestID)\n // ====================================================\n export const approveMembershipRequest = async (req, res) => {\n-    const { RequestID } = req.params;\n-    try {\n-        const pool = await sql.connect(dbConfig);\n+  const { RequestID } = req.params;\n+  try {\n+    const pool = await sql.connect(dbConfig);\n+    const result = await pool.request()\n+      .input(\"RequestID\", sql.Int, RequestID)\n+      .query(\"UPDATE MembershipRequests SET Status = 'Approved' WHERE RequestID = @RequestID AND Status = 'Pending'\");\n \n-        // Get request details\n-        const requestResult = await pool.request()\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n+    if (result.rowsAffected[0] === 0) {\n+      return res.status(404).json({ success: false, message: \"Request ID not found or already processed.\" });\n+    }\n \n-        if (requestResult.recordset.length === 0) return res.status(404).json({ success: false, message: \"Request not found\" });\n-\n-        const r = requestResult.recordset[0];\n-\n-        // Calculate next RecordID\n-        const maxRecordResult = await pool.request().query(\"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\");\n-        const nextRecordID = maxRecordResult.recordset[0].maxID + 1;\n-\n-        // Update request status to Approved\n-        await pool.request()\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .query(\"UPDATE MembershipRequests SET Status = 'Approved' WHERE RequestID = @RequestID\");\n-\n-        // Move approved request to MembershipRecords\n-        await pool.request()\n-            .input(\"RecordID\", sql.Int, nextRecordID)\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .input(\"ResidentName\", sql.NVarChar(100), r.ResidentName)\n-            .input(\"NationalID\", sql.NVarChar(50), r.NationalID)\n-            .input(\"PhoneNumber\", sql.NVarChar(50), r.PhoneNumber)\n-            .input(\"Email\", sql.NVarChar(100), r.Email)\n-            .input(\"HouseNumber\", sql.NVarChar(50), r.HouseNumber)\n-            .input(\"CourtName\", sql.NVarChar(50), r.CourtName)\n-            .input(\"RoleName\", sql.NVarChar(50), r.RoleName)\n-            .input(\"Status\", sql.NVarChar(50), \"Approved\")\n-            .input(\"RequestedAt\", sql.DateTime, r.RequestedAt)\n-            .input(\"Action\", sql.NVarChar(50), r.Action)\n-            .query(`\n-                INSERT INTO MembershipRecords\n-                (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n-                VALUES (@RecordID, @RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt, @Action)\n-            `);\n-\n-        res.json({ success: true, message: \"Request approved and moved to records successfully\" });\n-    } catch (err) {\n-        console.error(\"âŒ approveMembershipRequest Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error\" });\n-    }\n+    res.json({ success: true, message: \"Request approved successfully.\" });\n+  } catch (err) {\n+    console.error(\"âŒ approveMembershipRequest Error:\", err);\n+    res.status(500).json({ success: false, message: \"Server error\", details: err.message });\n+  }\n };\n \n // ====================================================\n-// ADMIN: Reject membership request\n+// REJECT MEMBERSHIP REQUEST (PUT /api/membership/reject/:RequestID)\n // ====================================================\n export const rejectMembershipRequest = async (req, res) => {\n-    const { RequestID } = req.params;\n-    try {\n-        const pool = await sql.connect(dbConfig);\n-        await pool.request()\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .query(\"UPDATE MembershipRequests SET Status = 'Rejected' WHERE RequestID = @RequestID\");\n+  const { RequestID } = req.params;\n+  try {\n+    const pool = await sql.connect(dbConfig);\n+    const result = await pool.request()\n+      .input(\"RequestID\", sql.Int, RequestID)\n+      .query(\"UPDATE MembershipRequests SET Status = 'Rejected' WHERE RequestID = @RequestID AND Status = 'Pending'\");\n \n-        res.status(200).json({ success: true, message: \"Request rejected successfully\" });\n-    } catch (err) {\n-        console.error(\"âŒ rejectMembershipRequest Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error\" });\n+    if (result.rowsAffected[0] === 0) {\n+      return res.status(404).json({ success: false, message: \"Request ID not found or already processed.\" });\n     }\n-};\n \n-// ====================================================\n-// ADMIN: Delete membership request\n-// ====================================================\n-export const deleteMembershipRequest = async (req, res) => {\n-    const { RequestID } = req.params;\n-    try {\n-        const pool = await sql.connect(dbConfig);\n-        const result = await pool.request()\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .query(\"DELETE FROM MembershipRequests WHERE RequestID = @RequestID\");\n-\n-        if (result.rowsAffected[0] === 0) return res.status(404).json({ success: false, message: \"Request not found\" });\n-\n-        res.status(200).json({ success: true, message: \"Request deleted successfully\" });\n-    } catch (err) {\n-        console.error(\"âŒ deleteMembershipRequest Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error\" });\n-    }\n+    res.json({ success: true, message: \"Request rejected successfully.\" });\n+  } catch (err) {\n+    console.error(\"âŒ rejectMembershipRequest Error:\", err);\n+    res.status(500).json({ success: false, message: \"Server error\", details: err.message });\n+  }\n };\n \n // ====================================================\n-// ADMIN: Sync MembershipRequests â†’ MembershipRecords\n+// GET ALL MEMBERSHIP REQUESTS (GET /api/membership)\n // ====================================================\n-export const syncMembershipRecords = async (req, res) => {\n+export const getMembershipRequests = async (req, res) => {\n     try {\n         const pool = await sql.connect(dbConfig);\n-\n-        const maxRecordResult = await pool.request().query(\"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\");\n-        const startingRecordID = maxRecordResult.recordset[0].maxID;\n-\n-        await pool.request()\n-            .input(\"StartingID\", sql.Int, startingRecordID)\n-            .query(`\n-                WITH RequestsToSync AS (\n-                    SELECT r.RequestID, r.ResidentName, r.NationalID, r.PhoneNumber, r.Email, r.HouseNumber, r.CourtName, r.RoleName, r.Status, r.RequestedAt, r.Action\n-                    FROM MembershipRequests r\n-                    WHERE NOT EXISTS (SELECT 1 FROM MembershipRecords m WHERE m.RequestID = r.RequestID)\n-                ),\n-                NumberedRequests AS (\n-                    SELECT *, ROW_NUMBER() OVER (ORDER BY RequestedAt ASC) as RowNum FROM RequestsToSync\n-                )\n-                INSERT INTO MembershipRecords\n-                (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n-                SELECT (@StartingID + nr.RowNum) as CalculatedRecordID, nr.RequestID, nr.ResidentName, nr.NationalID, nr.PhoneNumber, nr.Email, nr.HouseNumber, nr.CourtName, nr.RoleName, nr.Status, nr.RequestedAt, nr.Action\n-                FROM NumberedRequests nr;\n-            `);\n-\n-        res.json({ success: true, message: \"Membership requests synced successfully.\" });\n-    } catch (err) {\n-        console.error(\"âŒ syncMembershipRecords Error:\", err);\n-        res.status(500).json({ success: false, message: \"Sync failed. Check server logs for SQL error.\" });\n-    }\n-};\n-\n-// ====================================================\n-// ADMIN: Get all membership records\n-// ====================================================\n-export const getAllMembershipRecords = async (req, res) => {\n-    try {\n-        const pool = await sql.connect(dbConfig);\n-        const result = await pool.request().query(\"SELECT TOP (1000) * FROM MembershipRecords ORDER BY RequestedAt DESC\");\n-        res.status(200).json({ success: true, data: result.recordset });\n-    } catch (err) {\n-        console.error(\"âŒ getAllMembershipRecords Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error\" });\n-    }\n-};\n-\n-// ====================================================\n-// ADMIN: Get latest RequestID & RecordID\n-// ====================================================\n-export const getLatestMembershipRequest = async (req, res) => {\n-    try {\n-        const pool = await sql.connect(dbConfig);\n         const result = await pool.request().query(`\n             SELECT \n-                (SELECT ISNULL(MAX(RequestID), 0) FROM MembershipRequests) AS lastRequestID,\n-                (SELECT ISNULL(MAX(RecordID), 0) FROM MembershipRecords) AS lastRecordID;\n+                RequestID, ResidentName, NationalID, PhoneNumber, Email, \n+                HouseNumber, CourtName, RoleName, Status, RequestedAt\n+            FROM MembershipRequests \n+            ORDER BY RequestedAt DESC\n         `);\n-        const { lastRequestID, lastRecordID } = result.recordset[0];\n-        res.status(200).json({ success: true, lastRequestID, lastRecordID });\n+\n+        res.json({ success: true, requests: result.recordset });\n     } catch (err) {\n-        console.error(\"âŒ getLatestMembershipRequest Error:\", err);\n-        res.status(500).json({ success: false, message: \"Failed to retrieve latest IDs.\", lastRequestID: 0, lastRecordID: 0 });\n+        console.error(\"âŒ getMembershipRequests Error:\", err);\n+        res.status(500).json({ success: false, message: \"Server error fetching requests\", details: err.message });\n     }\n-};\n+};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763731261805,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,8 +17,10 @@\n // ====================================================\n // SUBMIT MEMBERSHIP REQUEST (POST /api/membership)\n // ====================================================\n export const submitMembershipRequest = async (req, res) => {\n+    console.log(\"--- MEMBERSHIP PAYLOAD ---\", req.body); // <--- CHECK THIS LINE\n+    // ...\n   const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action } = req.body;\n \n   // List of valid roles\n   const validRoles = [\"Resident\", \"Security\", \"Admin\", \"Visitor\"];\n"
                },
                {
                    "date": 1763746368595,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -133,5 +133,21 @@\n     } catch (err) {\n         console.error(\"âŒ getMembershipRequests Error:\", err);\n         res.status(500).json({ success: false, message: \"Server error fetching requests\", details: err.message });\n     }\n+};\n+// GET TOTAL MEMBERSHIP REQUEST COUNT\n+// ===============================\n+export const getMembershipCount = async (req, res) => {\n+  try {\n+    const pool = await sql.connect(dbConfig);\n+    const result = await pool.request()\n+      .query(`SELECT COUNT(*) AS totalRequests FROM MembershipRequests`);\n+\n+    const count = result.recordset[0]?.totalRequests || 0;\n+    res.status(200).json({ totalRequests: count });\n+\n+  } catch (err) {\n+    console.error(\"âŒ getMembershipCount Error:\", err);\n+    res.status(500).json({ success: false, message: \"Failed to fetch membership count\", details: err.message });\n+  }\n };\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763758525373,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,127 +1,173 @@\n // controllers/membershipController.js\n+\n import sql from \"mssql\";\n-import dotenv from \"dotenv\";\n-dotenv.config();\n+// ðŸ’¡ IMPORTANT: Import the global connection pool from server.js\n+import { dbPool } from \"../server.js\"; \n \n-// ==============================\n-// DB CONFIG - Loads connection settings from environment variables\n-// ==============================\n-const dbConfig = {\n-  user: process.env.DB_USER || \"Beverly\",\n-  password: process.env.DB_PASSWORD || \"Bev@1234567\",\n-  server: process.env.DB_SERVER || \"localhost\",\n-  database: process.env.DB_NAME || \"EstateAccessManagementSystem\",\n-  options: { encrypt: true, trustServerCertificate: true },\n-};\n \n // ====================================================\n // SUBMIT MEMBERSHIP REQUEST (POST /api/membership)\n // ====================================================\n export const submitMembershipRequest = async (req, res) => {\n-    console.log(\"--- MEMBERSHIP PAYLOAD ---\", req.body); // <--- CHECK THIS LINE\n-    // ...\n-  const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action } = req.body;\n+    console.log(\"--- MEMBERSHIP PAYLOAD ---\", req.body);\n+    const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action } = req.body;\n \n-  // List of valid roles\n-  const validRoles = [\"Resident\", \"Security\", \"Admin\", \"Visitor\"];\n-  \n-  // 400 Bad Request if essential fields are missing\n-  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n-    return res.status(400).json({ success: false, message: \"All fields except Action are required.\" });\n-  }\n+    // List of valid roles\n+    const validRoles = [\"Resident\", \"Security\", \"Admin\", \"Visitor\"];\n+    \n+    // 400 Bad Request if essential fields are missing\n+    if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+        return res.status(400).json({ success: false, message: \"All fields except Action are required.\" });\n+    }\n \n-  // Validate the role against the allowed list (to prevent \"Unknown role\" DB error)\n-  if (!validRoles.includes(RoleName)) {\n-      return res.status(400).json({ \n-          success: false, \n-          message: `Invalid role selected: ${RoleName}. Please select one of ${validRoles.join(', ')}.` \n-      });\n-  }\n+    // Validate the role against the allowed list\n+    if (!validRoles.includes(RoleName)) {\n+        return res.status(400).json({ \n+            success: false, \n+            message: `Invalid role selected: ${RoleName}. Please select one of ${validRoles.join(', ')}.` \n+        });\n+    }\n \n-  try {\n-    const pool = await sql.connect(dbConfig);\n+    try {\n+        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n+        const pool = await dbPool; \n \n-    await pool.request()\n-      // Use robust NVarChar data types\n-      .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n-      .input(\"NationalID\", sql.NVarChar(50), NationalID)\n-      .input(\"PhoneNumber\", sql.NVarChar(50), PhoneNumber)\n-      .input(\"Email\", sql.NVarChar(100), Email)\n-      .input(\"HouseNumber\", sql.NVarChar(50), HouseNumber)\n-      .input(\"CourtName\", sql.NVarChar(50), CourtName)\n-      .input(\"RoleName\", sql.NVarChar(50), RoleName)\n-      // Pass NULL if Action is empty\n-      .input(\"Action\", sql.NVarChar(100), Action || null) \n-      .query(`\n-        INSERT INTO MembershipRequests\n-        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n-        VALUES\n-        (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, 'Pending', GETDATE())\n-      `);\n+        const result = await pool.request()\n+            .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n+            .input(\"NationalID\", sql.NVarChar(50), NationalID)\n+            .input(\"PhoneNumber\", sql.NVarChar(50), PhoneNumber)\n+            .input(\"Email\", sql.NVarChar(100), Email)\n+            .input(\"HouseNumber\", sql.NVarChar(50), HouseNumber)\n+            .input(\"CourtName\", sql.NVarChar(50), CourtName)\n+            .input(\"RoleName\", sql.NVarChar(50), RoleName)\n+            .input(\"Action\", sql.NVarChar(100), Action || null) \n+            .query(`\n+                INSERT INTO MembershipRequests\n+                (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n+                OUTPUT INSERTED.RequestID -- Use OUTPUT to return the new ID\n+                VALUES\n+                (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, 'Pending', GETDATE());\n+            `);\n \n-    res.status(201).json({ success: true, message: \"Membership request submitted successfully.\" });\n+        // Get the new RequestID for the frontend response\n+        const newRequestID = result.recordset[0].RequestID;\n \n-  } catch (err) {\n-    console.error(\"âŒ Membership request failed:\", err);\n-    res.status(500).json({ \n-        success: false, \n-        message: \"Server error or Database connection failed.\", \n-        details: err.message \n-    });\n-  }\n+        res.status(201).json({ \n+            success: true, \n+            message: \"Membership request submitted successfully.\",\n+            requestID: newRequestID \n+        });\n+\n+    } catch (err) {\n+        console.error(\"âŒ Membership request failed:\", err.message);\n+        // Check for common DB errors (e.g., duplicate NationalID)\n+        if (err.number === 2627) {\n+             return res.status(409).json({ success: false, message: \"A request with this National ID already exists.\" });\n+        }\n+        res.status(500).json({ \n+            success: false, \n+            message: \"Server error or Database operation failed.\", \n+            details: err.message \n+        });\n+    }\n };\n \n // ====================================================\n // APPROVE MEMBERSHIP REQUEST (PUT /api/membership/approve/:RequestID)\n+// ðŸ›‘ FIX 2: Use a SQL TRANSACTION for atomicity (Update + Insert) ðŸ›‘\n // ====================================================\n export const approveMembershipRequest = async (req, res) => {\n-  const { RequestID } = req.params;\n-  try {\n-    const pool = await sql.connect(dbConfig);\n-    const result = await pool.request()\n-      .input(\"RequestID\", sql.Int, RequestID)\n-      .query(\"UPDATE MembershipRequests SET Status = 'Approved' WHERE RequestID = @RequestID AND Status = 'Pending'\");\n+    const { RequestID } = req.params;\n+    const pool = await dbPool;\n+    const transaction = pool.transaction(); // Start transaction\n \n-    if (result.rowsAffected[0] === 0) {\n-      return res.status(404).json({ success: false, message: \"Request ID not found or already processed.\" });\n+    try {\n+        await transaction.begin();\n+\n+        // 1. SELECT the request data (must be 'Pending')\n+        let requestDataResult = await transaction.request()\n+            .input(\"RequestID\", sql.Int, RequestID)\n+            .query(`\n+                SELECT ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName \n+                FROM MembershipRequests \n+                WHERE RequestID = @RequestID AND Status = 'Pending';\n+            `);\n+        \n+        const residentData = requestDataResult.recordset[0];\n+\n+        if (!residentData) {\n+            await transaction.rollback();\n+            return res.status(404).json({ success: false, message: \"Pending Request ID not found or already processed.\" });\n+        }\n+\n+        // 2. INSERT into the Residents table\n+        let insertResidentRequest = transaction.request();\n+        // Bind parameters from the fetched data\n+        insertResidentRequest.input('ResidentName', sql.NVarChar(100), residentData.ResidentName);\n+        insertResidentRequest.input('NationalID', sql.NVarChar(50), residentData.NationalID);\n+        insertResidentRequest.input('PhoneNumber', sql.NVarChar(50), residentData.PhoneNumber);\n+        insertResidentRequest.input('Email', sql.NVarChar(100), residentData.Email);\n+        insertResidentRequest.input('HouseNumber', sql.NVarChar(50), residentData.HouseNumber);\n+        insertResidentRequest.input('CourtName', sql.NVarChar(50), residentData.CourtName);\n+        insertResidentRequest.input('RoleName', sql.NVarChar(50), residentData.RoleName);\n+        \n+        await insertResidentRequest.query(`\n+            INSERT INTO Residents (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RegistrationDate)\n+            VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, 'Approved', GETDATE());\n+        `);\n+\n+        // 3. UPDATE the MembershipRequest status to 'Approved'\n+        await transaction.request()\n+            .input(\"RequestID_Update\", sql.Int, RequestID)\n+            .query(\"UPDATE MembershipRequests SET Status = 'Approved', ApprovalDate = GETDATE() WHERE RequestID = @RequestID_Update\");\n+\n+        // Success: Commit both changes\n+        await transaction.commit(); \n+        res.json({ success: true, message: \"Request approved and Resident created successfully.\" });\n+\n+    } catch (err) {\n+        // Failure: Rollback both changes\n+        await transaction.rollback();\n+        console.error(\"âŒ approveMembershipRequest Error:\", err);\n+        // Check if the INSERT failed due to a constraint violation in the Residents table\n+        if (err.number === 2627) { \n+            return res.status(409).json({ success: false, message: \"The resident already exists in the approved list.\" });\n+        }\n+        res.status(500).json({ success: false, message: \"Server error during approval process.\", details: err.message });\n     }\n-\n-    res.json({ success: true, message: \"Request approved successfully.\" });\n-  } catch (err) {\n-    console.error(\"âŒ approveMembershipRequest Error:\", err);\n-    res.status(500).json({ success: false, message: \"Server error\", details: err.message });\n-  }\n };\n \n // ====================================================\n // REJECT MEMBERSHIP REQUEST (PUT /api/membership/reject/:RequestID)\n // ====================================================\n export const rejectMembershipRequest = async (req, res) => {\n-  const { RequestID } = req.params;\n-  try {\n-    const pool = await sql.connect(dbConfig);\n-    const result = await pool.request()\n-      .input(\"RequestID\", sql.Int, RequestID)\n-      .query(\"UPDATE MembershipRequests SET Status = 'Rejected' WHERE RequestID = @RequestID AND Status = 'Pending'\");\n+    const { RequestID } = req.params;\n+    try {\n+        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n+        const pool = await dbPool; \n+        const result = await pool.request()\n+            .input(\"RequestID\", sql.Int, RequestID)\n+            .query(\"UPDATE MembershipRequests SET Status = 'Rejected', ApprovalDate = GETDATE() WHERE RequestID = @RequestID AND Status = 'Pending'\");\n \n-    if (result.rowsAffected[0] === 0) {\n-      return res.status(404).json({ success: false, message: \"Request ID not found or already processed.\" });\n+        if (result.rowsAffected[0] === 0) {\n+            return res.status(404).json({ success: false, message: \"Pending Request ID not found or already processed.\" });\n+        }\n+\n+        res.json({ success: true, message: \"Request rejected successfully.\" });\n+    } catch (err) {\n+        console.error(\"âŒ rejectMembershipRequest Error:\", err);\n+        res.status(500).json({ success: false, message: \"Server error\", details: err.message });\n     }\n-\n-    res.json({ success: true, message: \"Request rejected successfully.\" });\n-  } catch (err) {\n-    console.error(\"âŒ rejectMembershipRequest Error:\", err);\n-    res.status(500).json({ success: false, message: \"Server error\", details: err.message });\n-  }\n };\n \n // ====================================================\n // GET ALL MEMBERSHIP REQUESTS (GET /api/membership)\n // ====================================================\n export const getMembershipRequests = async (req, res) => {\n     try {\n-        const pool = await sql.connect(dbConfig);\n+        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n+        const pool = await dbPool;\n         const result = await pool.request().query(`\n             SELECT \n                 RequestID, ResidentName, NationalID, PhoneNumber, Email, \n                 HouseNumber, CourtName, RoleName, Status, RequestedAt\n@@ -134,20 +180,23 @@\n         console.error(\"âŒ getMembershipRequests Error:\", err);\n         res.status(500).json({ success: false, message: \"Server error fetching requests\", details: err.message });\n     }\n };\n-// GET TOTAL MEMBERSHIP REQUEST COUNT\n-// ===============================\n+\n+// ====================================================\n+// GET TOTAL MEMBERSHIP REQUEST COUNT (GET /api/membership/count - assuming you define this route)\n+// ====================================================\n export const getMembershipCount = async (req, res) => {\n-  try {\n-    const pool = await sql.connect(dbConfig);\n-    const result = await pool.request()\n-      .query(`SELECT COUNT(*) AS totalRequests FROM MembershipRequests`);\n+    try {\n+        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .query(`SELECT COUNT(*) AS totalRequests FROM MembershipRequests`);\n \n-    const count = result.recordset[0]?.totalRequests || 0;\n-    res.status(200).json({ totalRequests: count });\n+        const count = result.recordset[0]?.totalRequests || 0;\n+        res.status(200).json({ totalRequests: count });\n \n-  } catch (err) {\n-    console.error(\"âŒ getMembershipCount Error:\", err);\n-    res.status(500).json({ success: false, message: \"Failed to fetch membership count\", details: err.message });\n-  }\n+    } catch (err) {\n+        console.error(\"âŒ getMembershipCount Error:\", err);\n+        res.status(500).json({ success: false, message: \"Failed to fetch membership count\", details: err.message });\n+    }\n };\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763841099331,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,202 +1,139 @@\n-// controllers/membershipController.js\n+import { dbPool } from \"../server.js\";\n+import sql from \"mssql\"; // Ensure sql type definitions are imported\n \n-import sql from \"mssql\";\n-// ðŸ’¡ IMPORTANT: Import the global connection pool from server.js\n-import { dbPool } from \"../server.js\"; \n+// ======================================\n+// Submit a new membership request (PUBLIC)\n+// Inserts directly into MembershipRecords with Status='Pending'\n+// ======================================\n+export async function submitMembershipRequest(req, res) {\n+ try {\n+  const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName } = req.body;\n \n+  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+   return res.status(400).json({ message: \"All fields are required\" });\n+  }\n \n-// ====================================================\n-// SUBMIT MEMBERSHIP REQUEST (POST /api/membership)\n-// ====================================================\n-export const submitMembershipRequest = async (req, res) => {\n-    console.log(\"--- MEMBERSHIP PAYLOAD ---\", req.body);\n-    const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action } = req.body;\n+  const pool = await dbPool;\n \n-    // List of valid roles\n-    const validRoles = [\"Resident\", \"Security\", \"Admin\", \"Visitor\"];\n-    \n-    // 400 Bad Request if essential fields are missing\n-    if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n-        return res.status(400).json({ success: false, message: \"All fields except Action are required.\" });\n-    }\n+  // Use sql types for security and type consistency\n+  const result = await pool.request()\n+   .input(\"ResidentName\", sql.NVarChar, ResidentName)\n+   .input(\"NationalID\", sql.NVarChar, NationalID)\n+   .input(\"PhoneNumber\", sql.NVarChar, PhoneNumber)\n+   .input(\"Email\", sql.NVarChar, Email)\n+   .input(\"HouseNumber\", sql.NVarChar, HouseNumber)\n+   .input(\"CourtName\", sql.NVarChar, CourtName)\n+   .input(\"RoleName\", sql.NVarChar, RoleName)\n+   .input(\"Status\", sql.NVarChar, \"Pending\")\n+   .input(\"RequestedAt\", sql.DateTime, new Date())\n+   .query(`\n+    INSERT INTO MembershipRecords\n+    (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt)\n+    VALUES\n+    (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n+    SELECT SCOPE_IDENTITY() AS RequestID\n+   `);\n \n-    // Validate the role against the allowed list\n-    if (!validRoles.includes(RoleName)) {\n-        return res.status(400).json({ \n-            success: false, \n-            message: `Invalid role selected: ${RoleName}. Please select one of ${validRoles.join(', ')}.` \n-        });\n-    }\n+  // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n+  const newRequestId = result.recordset[0].RequestID;\n \n-    try {\n-        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n-        const pool = await dbPool; \n+  res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n \n-        const result = await pool.request()\n-            .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n-            .input(\"NationalID\", sql.NVarChar(50), NationalID)\n-            .input(\"PhoneNumber\", sql.NVarChar(50), PhoneNumber)\n-            .input(\"Email\", sql.NVarChar(100), Email)\n-            .input(\"HouseNumber\", sql.NVarChar(50), HouseNumber)\n-            .input(\"CourtName\", sql.NVarChar(50), CourtName)\n-            .input(\"RoleName\", sql.NVarChar(50), RoleName)\n-            .input(\"Action\", sql.NVarChar(100), Action || null) \n-            .query(`\n-                INSERT INTO MembershipRequests\n-                (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n-                OUTPUT INSERTED.RequestID -- Use OUTPUT to return the new ID\n-                VALUES\n-                (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, 'Pending', GETDATE());\n-            `);\n+ } catch (err) {\n+  console.error(\"Error submitting membership request:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n \n-        // Get the new RequestID for the frontend response\n-        const newRequestID = result.recordset[0].RequestID;\n+// ======================================\n+// Approve a membership request (PROTECTED)\n+// ======================================\n+export async function approveMembershipRequest(req, res) {\n+ try {\n+  const { RequestID } = req.params;\n+  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n-        res.status(201).json({ \n-            success: true, \n-            message: \"Membership request submitted successfully.\",\n-            requestID: newRequestID \n-        });\n+  const pool = await dbPool;\n \n-    } catch (err) {\n-        console.error(\"âŒ Membership request failed:\", err.message);\n-        // Check for common DB errors (e.g., duplicate NationalID)\n-        if (err.number === 2627) {\n-             return res.status(409).json({ success: false, message: \"A request with this National ID already exists.\" });\n-        }\n-        res.status(500).json({ \n-            success: false, \n-            message: \"Server error or Database operation failed.\", \n-            details: err.message \n-        });\n-    }\n-};\n+  await pool.request()\n+   .input(\"RequestID\", sql.Int, RequestID)\n+   .input(\"ApprovedAt\", sql.DateTime, new Date())\n+   .query(`\n+    UPDATE MembershipRecords\n+    SET Status = 'Approved', ApprovedAt = @ApprovedAt\n+    WHERE RequestID = @RequestID\n+   `);\n \n-// ====================================================\n-// APPROVE MEMBERSHIP REQUEST (PUT /api/membership/approve/:RequestID)\n-// ðŸ›‘ FIX 2: Use a SQL TRANSACTION for atomicity (Update + Insert) ðŸ›‘\n-// ====================================================\n-export const approveMembershipRequest = async (req, res) => {\n-    const { RequestID } = req.params;\n-    const pool = await dbPool;\n-    const transaction = pool.transaction(); // Start transaction\n+  res.status(200).json({ message: \"Membership request approved successfully\" });\n \n-    try {\n-        await transaction.begin();\n+ } catch (err) {\n+  console.error(\"Error approving membership request:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n \n-        // 1. SELECT the request data (must be 'Pending')\n-        let requestDataResult = await transaction.request()\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .query(`\n-                SELECT ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName \n-                FROM MembershipRequests \n-                WHERE RequestID = @RequestID AND Status = 'Pending';\n-            `);\n-        \n-        const residentData = requestDataResult.recordset[0];\n+// ======================================\n+// Reject a membership request (PROTECTED)\n+// ======================================\n+export async function rejectMembershipRequest(req, res) {\n+ try {\n+  const { RequestID } = req.params;\n+  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n-        if (!residentData) {\n-            await transaction.rollback();\n-            return res.status(404).json({ success: false, message: \"Pending Request ID not found or already processed.\" });\n-        }\n+  const pool = await dbPool;\n \n-        // 2. INSERT into the Residents table\n-        let insertResidentRequest = transaction.request();\n-        // Bind parameters from the fetched data\n-        insertResidentRequest.input('ResidentName', sql.NVarChar(100), residentData.ResidentName);\n-        insertResidentRequest.input('NationalID', sql.NVarChar(50), residentData.NationalID);\n-        insertResidentRequest.input('PhoneNumber', sql.NVarChar(50), residentData.PhoneNumber);\n-        insertResidentRequest.input('Email', sql.NVarChar(100), residentData.Email);\n-        insertResidentRequest.input('HouseNumber', sql.NVarChar(50), residentData.HouseNumber);\n-        insertResidentRequest.input('CourtName', sql.NVarChar(50), residentData.CourtName);\n-        insertResidentRequest.input('RoleName', sql.NVarChar(50), residentData.RoleName);\n-        \n-        await insertResidentRequest.query(`\n-            INSERT INTO Residents (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RegistrationDate)\n-            VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, 'Approved', GETDATE());\n-        `);\n+  await pool.request()\n+   .input(\"RequestID\", sql.Int, RequestID)\n+   .query(`\n+    UPDATE MembershipRecords\n+    SET Status = 'Rejected', ApprovedAt = NULL\n+    WHERE RequestID = @RequestID\n+   `);\n \n-        // 3. UPDATE the MembershipRequest status to 'Approved'\n-        await transaction.request()\n-            .input(\"RequestID_Update\", sql.Int, RequestID)\n-            .query(\"UPDATE MembershipRequests SET Status = 'Approved', ApprovalDate = GETDATE() WHERE RequestID = @RequestID_Update\");\n+  res.status(200).json({ message: \"Membership request rejected successfully\" });\n \n-        // Success: Commit both changes\n-        await transaction.commit(); \n\\ No newline at end of file\n-        res.json({ success: true, message: \"Request approved and Resident created successfully.\" });\n+ } catch (err) {\n+  console.error(\"Error rejecting membership request:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n \n-    } catch (err) {\n-        // Failure: Rollback both changes\n-        await transaction.rollback();\n-        console.error(\"âŒ approveMembershipRequest Error:\", err);\n-        // Check if the INSERT failed due to a constraint violation in the Residents table\n-        if (err.number === 2627) { \n-            return res.status(409).json({ success: false, message: \"The resident already exists in the approved list.\" });\n-        }\n-        res.status(500).json({ success: false, message: \"Server error during approval process.\", details: err.message });\n-    }\n-};\n+// ======================================\n+// Get all membership records (PROTECTED)\n+// ======================================\n+export async function getMembershipRequests(req, res) {\n+ try {\n+  const pool = await dbPool;\n \n-// ====================================================\n-// REJECT MEMBERSHIP REQUEST (PUT /api/membership/reject/:RequestID)\n-// ====================================================\n-export const rejectMembershipRequest = async (req, res) => {\n-    const { RequestID } = req.params;\n-    try {\n-        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n-        const pool = await dbPool; \n-        const result = await pool.request()\n-            .input(\"RequestID\", sql.Int, RequestID)\n-            .query(\"UPDATE MembershipRequests SET Status = 'Rejected', ApprovalDate = GETDATE() WHERE RequestID = @RequestID AND Status = 'Pending'\");\n+  const result = await pool.request()\n+   .query(`\n+    SELECT *\n+    FROM MembershipRecords\n+    ORDER BY RequestedAt DESC\n+   `);\n \n-        if (result.rowsAffected[0] === 0) {\n-            return res.status(404).json({ success: false, message: \"Pending Request ID not found or already processed.\" });\n-        }\n+  res.status(200).json(result.recordset);\n \n-        res.json({ success: true, message: \"Request rejected successfully.\" });\n-    } catch (err) {\n-        console.error(\"âŒ rejectMembershipRequest Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error\", details: err.message });\n-    }\n-};\n+ } catch (err) {\n+  console.error(\"Error fetching membership records:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n+// ======================================\n+// Get total membership count (PUBLIC)\n+// ======================================\n+export async function getMembershipCount(req, res) {\n+  try {\n+    const pool = await dbPool;\n \n-// ====================================================\n-// GET ALL MEMBERSHIP REQUESTS (GET /api/membership)\n-// ====================================================\n-export const getMembershipRequests = async (req, res) => {\n-    try {\n-        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n-        const pool = await dbPool;\n-        const result = await pool.request().query(`\n-            SELECT \n-                RequestID, ResidentName, NationalID, PhoneNumber, Email, \n-                HouseNumber, CourtName, RoleName, Status, RequestedAt\n-            FROM MembershipRequests \n-            ORDER BY RequestedAt DESC\n-        `);\n+    const result = await pool.request().query(`\n+      SELECT COUNT(*) AS totalRequests FROM MembershipRecords\n+    `);\n \n-        res.json({ success: true, requests: result.recordset });\n-    } catch (err) {\n-        console.error(\"âŒ getMembershipRequests Error:\", err);\n-        res.status(500).json({ success: false, message: \"Server error fetching requests\", details: err.message });\n-    }\n-};\n+    res.status(200).json({ totalRequests: result.recordset[0].totalRequests });\n \n-// ====================================================\n-// GET TOTAL MEMBERSHIP REQUEST COUNT (GET /api/membership/count - assuming you define this route)\n-// ====================================================\n-export const getMembershipCount = async (req, res) => {\n-    try {\n-        // ðŸ›‘ FIX 1: Use the global connection pool (dbPool) ðŸ›‘\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .query(`SELECT COUNT(*) AS totalRequests FROM MembershipRequests`);\n-\n-        const count = result.recordset[0]?.totalRequests || 0;\n-        res.status(200).json({ totalRequests: count });\n-\n-    } catch (err) {\n-        console.error(\"âŒ getMembershipCount Error:\", err);\n-        res.status(500).json({ success: false, message: \"Failed to fetch membership count\", details: err.message });\n-    }\n-};\n+  } catch (err) {\n+    console.error(\"Error fetching membership count:\", err);\n+    res.status(500).json({ message: \"Server error\" });\n+  }\n+}\n"
                },
                {
                    "date": 1763928505706,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,139 +1,98 @@\n-import { dbPool } from \"../server.js\";\n-import sql from \"mssql\"; // Ensure sql type definitions are imported\n+import sql from \"mssql\";\n+// Import the global database pool exported from server.js\n+import { dbPool } from \"../server.js\"; \n \n-// ======================================\n-// Submit a new membership request (PUBLIC)\n-// Inserts directly into MembershipRecords with Status='Pending'\n-// ======================================\n-export async function submitMembershipRequest(req, res) {\n- try {\n-  const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName } = req.body;\n+/**\n+ * Endpoint 1: GET /api/membership/count\n+ * Fetches the total count of approved residents.\n+ */\n+export const getMembershipCount = async (req, res) => {\n+    try {\n+        const result = await dbPool.request().query(\n+            // We count distinct National IDs of residents whose requests are approved.\n+            `SELECT COUNT(DISTINCT NationalID) AS count FROM [MembershipRequests] \n+             WHERE [Status] = 'Approved' AND [RoleName] = 'Resident'`\n+        );\n+        \n+        // Return the count\n+        res.json({ count: result.recordset[0].count });\n+    } catch (err) {\n+        console.error('Error fetching membership count:', err);\n+        res.status(500).json({ message: 'Internal Server Error: Could not fetch membership count.' });\n+    }\n+};\n \n-  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n-   return res.status(400).json({ message: \"All fields are required\" });\n-  }\n+/**\n+ * Endpoint 2: GET /api/membership/courts\n+ * Fetches the list of unique court names for the dropdown.\n+ */\n+export const getCourtList = async (req, res) => {\n+    try {\n+        // Fetch unique court names from the table\n+        const result = await dbPool.request().query(\n+            `SELECT DISTINCT CourtName \n+             FROM [MembershipRequests] \n+             WHERE CourtName IS NOT NULL AND CourtName <> '' \n+             ORDER BY CourtName`\n+        );\n+        \n+        // Return the list of courts\n+        res.json(result.recordset);\n+    } catch (err) {\n+        console.error('Error fetching courts:', err);\n+        res.status(500).json({ message: 'Internal Server Error: Could not load court list.' });\n+    }\n+};\n \n-  const pool = await dbPool;\n+/**\n+ * Endpoint 3: POST /api/membership/request\n+ * Submits a new membership request.\n+ */\n+export const submitMembershipRequest = async (req, res) => {\n+    const { \n+        ResidentName, NationalID, PhoneNumber, Email, \n+        HouseNumber, CourtName, RoleName, Action \n+    } = req.body;\n \n-  // Use sql types for security and type consistency\n-  const result = await pool.request()\n-   .input(\"ResidentName\", sql.NVarChar, ResidentName)\n-   .input(\"NationalID\", sql.NVarChar, NationalID)\n-   .input(\"PhoneNumber\", sql.NVarChar, PhoneNumber)\n-   .input(\"Email\", sql.NVarChar, Email)\n-   .input(\"HouseNumber\", sql.NVarChar, HouseNumber)\n-   .input(\"CourtName\", sql.NVarChar, CourtName)\n-   .input(\"RoleName\", sql.NVarChar, RoleName)\n-   .input(\"Status\", sql.NVarChar, \"Pending\")\n-   .input(\"RequestedAt\", sql.DateTime, new Date())\n-   .query(`\n-    INSERT INTO MembershipRecords\n-    (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt)\n-    VALUES\n-    (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n-    SELECT SCOPE_IDENTITY() AS RequestID\n-   `);\n+    // Server-side validation\n+    if (!ResidentName || !NationalID || !Email || !CourtName || !RoleName) {\n+        return res.status(400).json({ message: 'Missing required fields: Name, ID, Email, Court, and Role are mandatory.' });\n+    }\n \n-  // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n-  const newRequestId = result.recordset[0].RequestID;\n+    try {\n+        const request = dbPool.request();\n+        \n+        // --- Input Parameters (Crucial for SQL Injection Prevention) ---\n+        // Use appropriate SQL types based on your database schema\n+        request.input('ResidentName', sql.NVarChar(100), ResidentName);\n+        request.input('NationalID', sql.VarChar(8), NationalID);\n+        request.input('PhoneNumber', sql.VarChar(20), PhoneNumber);\n+        request.input('Email', sql.NVarChar(100), Email);\n+        request.input('HouseNumber', sql.VarChar(50), HouseNumber);\n+        request.input('CourtName', sql.VarChar(100), CourtName);\n+        request.input('RoleName', sql.VarChar(50), RoleName);\n+        request.input('Action', sql.NVarChar(sql.MAX), Action || ''); \n+        \n+        const insertQuery = `\n+            INSERT INTO [MembershipRequests] \n+            (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n+            VALUES \n+            (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, 'Pending', GETDATE());\n+        `;\n \n-  res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n+        await request.query(insertQuery);\n+        \n+        // Successful submission\n+        res.status(201).json({ message: 'Membership request submitted successfully. Awaiting approval.' });\n \n- } catch (err) {\n-  console.error(\"Error submitting membership request:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n-}\n+    } catch (err) {\n+        console.error('Error inserting membership request:', err);\n+        \n+        // Check for specific unique constraint error (e.g., if NationalID is a unique key)\n+        if (err.number === 2627) { \n+             return res.status(409).json({ message: 'A membership request with this National ID already exists.' });\n+        }\n \n-// ======================================\n-// Approve a membership request (PROTECTED)\n-// ======================================\n-export async function approveMembershipRequest(req, res) {\n- try {\n-  const { RequestID } = req.params;\n-  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n-\n-  const pool = await dbPool;\n-\n-  await pool.request()\n-   .input(\"RequestID\", sql.Int, RequestID)\n-   .input(\"ApprovedAt\", sql.DateTime, new Date())\n-   .query(`\n-    UPDATE MembershipRecords\n-    SET Status = 'Approved', ApprovedAt = @ApprovedAt\n-    WHERE RequestID = @RequestID\n-   `);\n-\n-  res.status(200).json({ message: \"Membership request approved successfully\" });\n-\n- } catch (err) {\n-  console.error(\"Error approving membership request:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n-}\n-\n-// ======================================\n-// Reject a membership request (PROTECTED)\n-// ======================================\n-export async function rejectMembershipRequest(req, res) {\n- try {\n-  const { RequestID } = req.params;\n-  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n-\n-  const pool = await dbPool;\n-\n-  await pool.request()\n-   .input(\"RequestID\", sql.Int, RequestID)\n-   .query(`\n-    UPDATE MembershipRecords\n-    SET Status = 'Rejected', ApprovedAt = NULL\n-    WHERE RequestID = @RequestID\n-   `);\n-\n-  res.status(200).json({ message: \"Membership request rejected successfully\" });\n-\n- } catch (err) {\n-  console.error(\"Error rejecting membership request:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n-}\n-\n-// ======================================\n-// Get all membership records (PROTECTED)\n-// ======================================\n-export async function getMembershipRequests(req, res) {\n- try {\n-  const pool = await dbPool;\n-\n-  const result = await pool.request()\n-   .query(`\n-    SELECT *\n-    FROM MembershipRecords\n-    ORDER BY RequestedAt DESC\n-   `);\n-\n-  res.status(200).json(result.recordset);\n-\n- } catch (err) {\n-  console.error(\"Error fetching membership records:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n-}\n-// ======================================\n-// Get total membership count (PUBLIC)\n-// ======================================\n-export async function getMembershipCount(req, res) {\n-  try {\n-    const pool = await dbPool;\n-\n-    const result = await pool.request().query(`\n-      SELECT COUNT(*) AS totalRequests FROM MembershipRecords\n-    `);\n-\n-    res.status(200).json({ totalRequests: result.recordset[0].totalRequests });\n-\n-  } catch (err) {\n-    console.error(\"Error fetching membership count:\", err);\n-    res.status(500).json({ message: \"Server error\" });\n-  }\n-}\n+        res.status(500).json({ message: 'An unexpected internal server error occurred.' });\n+    }\n+};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763928637156,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,98 +1,139 @@\n-import sql from \"mssql\";\n-// Import the global database pool exported from server.js\n-import { dbPool } from \"../server.js\"; \n+import { dbPool } from \"../server.js\";\n+import sql from \"mssql\"; // Ensure sql type definitions are imported\n \n-/**\n- * Endpoint 1: GET /api/membership/count\n- * Fetches the total count of approved residents.\n- */\n-export const getMembershipCount = async (req, res) => {\n-    try {\n-        const result = await dbPool.request().query(\n-            // We count distinct National IDs of residents whose requests are approved.\n-            `SELECT COUNT(DISTINCT NationalID) AS count FROM [MembershipRequests] \n-             WHERE [Status] = 'Approved' AND [RoleName] = 'Resident'`\n-        );\n-        \n-        // Return the count\n-        res.json({ count: result.recordset[0].count });\n-    } catch (err) {\n-        console.error('Error fetching membership count:', err);\n-        res.status(500).json({ message: 'Internal Server Error: Could not fetch membership count.' });\n-    }\n-};\n+// ======================================\n+// Submit a new membership request (PUBLIC)\n+// Inserts directly into MembershipRecords with Status='Pending'\n+// ======================================\n+export async function submitMembershipRequest(req, res) {\n+ try {\n+  const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName } = req.body;\n \n-/**\n- * Endpoint 2: GET /api/membership/courts\n- * Fetches the list of unique court names for the dropdown.\n- */\n-export const getCourtList = async (req, res) => {\n-    try {\n-        // Fetch unique court names from the table\n-        const result = await dbPool.request().query(\n-            `SELECT DISTINCT CourtName \n-             FROM [MembershipRequests] \n-             WHERE CourtName IS NOT NULL AND CourtName <> '' \n-             ORDER BY CourtName`\n-        );\n-        \n-        // Return the list of courts\n-        res.json(result.recordset);\n-    } catch (err) {\n-        console.error('Error fetching courts:', err);\n-        res.status(500).json({ message: 'Internal Server Error: Could not load court list.' });\n-    }\n-};\n+  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+   return res.status(400).json({ message: \"All fields are required\" });\n+  }\n \n-/**\n- * Endpoint 3: POST /api/membership/request\n- * Submits a new membership request.\n- */\n-export const submitMembershipRequest = async (req, res) => {\n-    const { \n-        ResidentName, NationalID, PhoneNumber, Email, \n-        HouseNumber, CourtName, RoleName, Action \n-    } = req.body;\n+  const pool = await dbPool;\n \n-    // Server-side validation\n-    if (!ResidentName || !NationalID || !Email || !CourtName || !RoleName) {\n-        return res.status(400).json({ message: 'Missing required fields: Name, ID, Email, Court, and Role are mandatory.' });\n-    }\n+  // Use sql types for security and type consistency\n+  const result = await pool.request()\n+   .input(\"ResidentName\", sql.NVarChar, ResidentName)\n+   .input(\"NationalID\", sql.NVarChar, NationalID)\n+   .input(\"PhoneNumber\", sql.NVarChar, PhoneNumber)\n+   .input(\"Email\", sql.NVarChar, Email)\n+   .input(\"HouseNumber\", sql.NVarChar, HouseNumber)\n+   .input(\"CourtName\", sql.NVarChar, CourtName)\n+   .input(\"RoleName\", sql.NVarChar, RoleName)\n+   .input(\"Status\", sql.NVarChar, \"Pending\")\n+   .input(\"RequestedAt\", sql.DateTime, new Date())\n+   .query(`\n+    INSERT INTO MembershipRecords\n+    (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt)\n+    VALUES\n+    (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n+    SELECT SCOPE_IDENTITY() AS RequestID\n+   `);\n \n-    try {\n-        const request = dbPool.request();\n-        \n-        // --- Input Parameters (Crucial for SQL Injection Prevention) ---\n-        // Use appropriate SQL types based on your database schema\n-        request.input('ResidentName', sql.NVarChar(100), ResidentName);\n\\ No newline at end of file\n-        request.input('NationalID', sql.VarChar(8), NationalID);\n-        request.input('PhoneNumber', sql.VarChar(20), PhoneNumber);\n-        request.input('Email', sql.NVarChar(100), Email);\n-        request.input('HouseNumber', sql.VarChar(50), HouseNumber);\n-        request.input('CourtName', sql.VarChar(100), CourtName);\n-        request.input('RoleName', sql.VarChar(50), RoleName);\n-        request.input('Action', sql.NVarChar(sql.MAX), Action || ''); \n-        \n-        const insertQuery = `\n-            INSERT INTO [MembershipRequests] \n-            (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n-            VALUES \n-            (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, 'Pending', GETDATE());\n-        `;\n+  // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n+  const newRequestId = result.recordset[0].RequestID;\n \n-        await request.query(insertQuery);\n-        \n-        // Successful submission\n-        res.status(201).json({ message: 'Membership request submitted successfully. Awaiting approval.' });\n+  res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n \n-    } catch (err) {\n-        console.error('Error inserting membership request:', err);\n-        \n-        // Check for specific unique constraint error (e.g., if NationalID is a unique key)\n-        if (err.number === 2627) { \n-             return res.status(409).json({ message: 'A membership request with this National ID already exists.' });\n-        }\n+ } catch (err) {\n+  console.error(\"Error submitting membership request:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n \n-        res.status(500).json({ message: 'An unexpected internal server error occurred.' });\n-    }\n-};\n+// ======================================\n+// Approve a membership request (PROTECTED)\n+// ======================================\n+export async function approveMembershipRequest(req, res) {\n+ try {\n+  const { RequestID } = req.params;\n+  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+\n+  const pool = await dbPool;\n+\n+  await pool.request()\n+   .input(\"RequestID\", sql.Int, RequestID)\n+   .input(\"ApprovedAt\", sql.DateTime, new Date())\n+   .query(`\n+    UPDATE MembershipRecords\n+    SET Status = 'Approved', ApprovedAt = @ApprovedAt\n+    WHERE RequestID = @RequestID\n+   `);\n+\n+  res.status(200).json({ message: \"Membership request approved successfully\" });\n+\n+ } catch (err) {\n+  console.error(\"Error approving membership request:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n+\n+// ======================================\n+// Reject a membership request (PROTECTED)\n+// ======================================\n+export async function rejectMembershipRequest(req, res) {\n+ try {\n+  const { RequestID } = req.params;\n+  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+\n+  const pool = await dbPool;\n+\n+  await pool.request()\n+   .input(\"RequestID\", sql.Int, RequestID)\n+   .query(`\n+    UPDATE MembershipRecords\n+    SET Status = 'Rejected', ApprovedAt = NULL\n+    WHERE RequestID = @RequestID\n+   `);\n+\n+  res.status(200).json({ message: \"Membership request rejected successfully\" });\n+\n+ } catch (err) {\n+  console.error(\"Error rejecting membership request:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n+\n+// ======================================\n+// Get all membership records (PROTECTED)\n+// ======================================\n+export async function getMembershipRequests(req, res) {\n+ try {\n+  const pool = await dbPool;\n+\n+  const result = await pool.request()\n+   .query(`\n+    SELECT *\n+    FROM MembershipRecords\n+    ORDER BY RequestedAt DESC\n+   `);\n+\n+  res.status(200).json(result.recordset);\n+\n+ } catch (err) {\n+  console.error(\"Error fetching membership records:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n+// ======================================\n+// Get total membership count (PUBLIC)\n+// ======================================\n+export async function getMembershipCount(req, res) {\n+  try {\n+    const pool = await dbPool;\n+\n+    const result = await pool.request().query(`\n+      SELECT COUNT(*) AS totalRequests FROM MembershipRecords\n+    `);\n+\n+    res.status(200).json({ totalRequests: result.recordset[0].totalRequests });\n+\n+  } catch (err) {\n+    console.error(\"Error fetching membership count:\", err);\n+    res.status(500).json({ message: \"Server error\" });\n+  }\n+}\n"
                },
                {
                    "date": 1763928981674,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,139 +1,156 @@\n import { dbPool } from \"../server.js\";\n import sql from \"mssql\"; // Ensure sql type definitions are imported\n \n+// NOTE: All functions now use the table name 'MembershipRecords'\n+// -------------------------------------------------------------\n+\n // ======================================\n // Submit a new membership request (PUBLIC)\n // Inserts directly into MembershipRecords with Status='Pending'\n // ======================================\n export async function submitMembershipRequest(req, res) {\n- try {\n-  const { ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName } = req.body;\n+try {\n+ const { \n+        ResidentName, NationalID, PhoneNumber, Email, \n+        HouseNumber, CourtName, RoleName, Action // Added Action back\n+    } = req.body;\n \n-  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n-   return res.status(400).json({ message: \"All fields are required\" });\n-  }\n+ if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+ return res.status(400).json({ message: \"All fields are required\" });\n+ }\n \n-  const pool = await dbPool;\n+ const pool = await dbPool;\n \n-  // Use sql types for security and type consistency\n-  const result = await pool.request()\n-   .input(\"ResidentName\", sql.NVarChar, ResidentName)\n-   .input(\"NationalID\", sql.NVarChar, NationalID)\n-   .input(\"PhoneNumber\", sql.NVarChar, PhoneNumber)\n-   .input(\"Email\", sql.NVarChar, Email)\n-   .input(\"HouseNumber\", sql.NVarChar, HouseNumber)\n-   .input(\"CourtName\", sql.NVarChar, CourtName)\n-   .input(\"RoleName\", sql.NVarChar, RoleName)\n-   .input(\"Status\", sql.NVarChar, \"Pending\")\n-   .input(\"RequestedAt\", sql.DateTime, new Date())\n-   .query(`\n-    INSERT INTO MembershipRecords\n-    (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt)\n-    VALUES\n-    (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n-    SELECT SCOPE_IDENTITY() AS RequestID\n-   `);\n+ // Use sql types for security and type consistency\n+ const result = await pool.request()\n+ .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n+ .input(\"NationalID\", sql.VarChar(8), NationalID)\n+ .input(\"PhoneNumber\", sql.VarChar(20), PhoneNumber)\n+ .input(\"Email\", sql.NVarChar(100), Email)\n+ .input(\"HouseNumber\", sql.VarChar(50), HouseNumber)\n+ .input(\"CourtName\", sql.VarChar(100), CourtName)\n+ .input(\"RoleName\", sql.VarChar(50), RoleName)\n+ .input(\"Action\", sql.NVarChar(sql.MAX), Action || '') // Optional field, default to empty string\n+ .input(\"Status\", sql.VarChar(50), \"Pending\")\n+ .input(\"RequestedAt\", sql.DateTime, new Date())\n+ .query(`\n+  INSERT INTO MembershipRecords\n+  (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n+  VALUES\n+  (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, @Status, @RequestedAt);\n+  SELECT SCOPE_IDENTITY() AS RequestID;\n+ `);\n \n-  // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n-  const newRequestId = result.recordset[0].RequestID;\n+ // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n+ const newRequestId = result.recordset[0].RequestID;\n \n-  res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n+ res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n \n- } catch (err) {\n-  console.error(\"Error submitting membership request:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n+} catch (err) {\n+ console.error(\"Error submitting membership request:\", err);\n+    // Check for unique constraint violation (assuming NationalID is unique)\n+    if (err.number === 2627) { \n+        return res.status(409).json({ message: 'A membership request with this National ID already exists.' });\n+    }\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n \n // ======================================\n // Approve a membership request (PROTECTED)\n // ======================================\n export async function approveMembershipRequest(req, res) {\n- try {\n-  const { RequestID } = req.params;\n-  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+try {\n+ const { RequestID } = req.params;\n+ if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n-  const pool = await dbPool;\n+ const pool = await dbPool;\n \n-  await pool.request()\n-   .input(\"RequestID\", sql.Int, RequestID)\n-   .input(\"ApprovedAt\", sql.DateTime, new Date())\n-   .query(`\n-    UPDATE MembershipRecords\n-    SET Status = 'Approved', ApprovedAt = @ApprovedAt\n-    WHERE RequestID = @RequestID\n-   `);\n+ await pool.request()\n+ .input(\"RequestID\", sql.Int, RequestID)\n+ .input(\"ApprovedAt\", sql.DateTime, new Date())\n+ .query(`\n+  UPDATE MembershipRecords\n+  SET Status = 'Approved', ApprovedAt = @ApprovedAt\n+  WHERE RequestID = @RequestID\n+ `);\n \n-  res.status(200).json({ message: \"Membership request approved successfully\" });\n+ res.status(200).json({ message: \"Membership request approved successfully\" });\n \n- } catch (err) {\n-  console.error(\"Error approving membership request:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n+} catch (err) {\n+ console.error(\"Error approving membership request:\", err);\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n \n // ======================================\n // Reject a membership request (PROTECTED)\n // ======================================\n export async function rejectMembershipRequest(req, res) {\n- try {\n-  const { RequestID } = req.params;\n-  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+try {\n+ const { RequestID } = req.params;\n+ if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n-  const pool = await dbPool;\n+ const pool = await dbPool;\n \n-  await pool.request()\n-   .input(\"RequestID\", sql.Int, RequestID)\n-   .query(`\n-    UPDATE MembershipRecords\n-    SET Status = 'Rejected', ApprovedAt = NULL\n-    WHERE RequestID = @RequestID\n-   `);\n+ await pool.request()\n+ .input(\"RequestID\", sql.Int, RequestID)\n+ .query(`\n+  UPDATE MembershipRecords\n+  SET Status = 'Rejected', ApprovedAt = NULL\n+  WHERE RequestID = @RequestID\n+ `);\n \n-  res.status(200).json({ message: \"Membership request rejected successfully\" });\n+ res.status(200).json({ message: \"Membership request rejected successfully\" });\n \n- } catch (err) {\n-  console.error(\"Error rejecting membership request:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n+} catch (err) {\n+ console.error(\"Error rejecting membership request:\", err);\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n \n // ======================================\n // Get all membership records (PROTECTED)\n // ======================================\n export async function getMembershipRequests(req, res) {\n- try {\n-  const pool = await dbPool;\n+try {\n+ const pool = await dbPool;\n \n-  const result = await pool.request()\n-   .query(`\n-    SELECT *\n-    FROM MembershipRecords\n-    ORDER BY RequestedAt DESC\n-   `);\n+ const result = await pool.request()\n+ .query(`\n+  SELECT *\n+  FROM MembershipRecords\n+  ORDER BY RequestedAt DESC\n+ `);\n \n-  res.status(200).json(result.recordset);\n+ res.status(200).json(result.recordset);\n \n- } catch (err) {\n-  console.error(\"Error fetching membership records:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n+} catch (err) {\n+ console.error(\"Error fetching membership records:\", err);\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n+\n // ======================================\n // Get total membership count (PUBLIC)\n+// --------------------------------------\n+// FIX: This now counts APPROVED, DISTINCT National IDs (Actual Members)\n // ======================================\n export async function getMembershipCount(req, res) {\n-  try {\n-    const pool = await dbPool;\n+ try {\n+  const pool = await dbPool;\n \n-    const result = await pool.request().query(`\n-      SELECT COUNT(*) AS totalRequests FROM MembershipRecords\n-    `);\n+  const result = await pool.request().query(`\n+   SELECT COUNT(DISTINCT NationalID) AS count \n+   FROM MembershipRecords\n+   WHERE Status = 'Approved' AND RoleName = 'Resident'\n+  `);\n \n-    res.status(200).json({ totalRequests: result.recordset[0].totalRequests });\n+  // NOTE: The frontend expects the field name 'count', not 'totalRequests'\n+  res.status(200).json({ count: result.recordset[0].count });\n \n-  } catch (err) {\n-    console.error(\"Error fetching membership count:\", err);\n-    res.status(500).json({ message: \"Server error\" });\n-  }\n-}\n+ } catch (err) {\n+  console.error(\"Error fetching membership count:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763929372728,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,149 +8,170 @@\n // Submit a new membership request (PUBLIC)\n // Inserts directly into MembershipRecords with Status='Pending'\n // ======================================\n export async function submitMembershipRequest(req, res) {\n-try {\n- const { \n+Â try {\n+Â  const { \n         ResidentName, NationalID, PhoneNumber, Email, \n         HouseNumber, CourtName, RoleName, Action // Added Action back\n     } = req.body;\n \n- if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n- return res.status(400).json({ message: \"All fields are required\" });\n- }\n+Â  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+Â  Â return res.status(400).json({ message: \"All fields are required\" });\n+Â  }\n \n- const pool = await dbPool;\n+Â  const pool = await dbPool;\n \n- // Use sql types for security and type consistency\n- const result = await pool.request()\n- .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n- .input(\"NationalID\", sql.VarChar(8), NationalID)\n- .input(\"PhoneNumber\", sql.VarChar(20), PhoneNumber)\n- .input(\"Email\", sql.NVarChar(100), Email)\n- .input(\"HouseNumber\", sql.VarChar(50), HouseNumber)\n- .input(\"CourtName\", sql.VarChar(100), CourtName)\n- .input(\"RoleName\", sql.VarChar(50), RoleName)\n- .input(\"Action\", sql.NVarChar(sql.MAX), Action || '') // Optional field, default to empty string\n- .input(\"Status\", sql.VarChar(50), \"Pending\")\n- .input(\"RequestedAt\", sql.DateTime, new Date())\n- .query(`\n-  INSERT INTO MembershipRecords\n-  (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n-  VALUES\n-  (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, @Status, @RequestedAt);\n-  SELECT SCOPE_IDENTITY() AS RequestID;\n- `);\n+Â  // Use sql types for security and type consistency\n+Â  const result = await pool.request()\n+Â  Â .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n+Â  Â .input(\"NationalID\", sql.VarChar(8), NationalID)\n+Â  Â .input(\"PhoneNumber\", sql.VarChar(20), PhoneNumber)\n+Â  Â .input(\"Email\", sql.NVarChar(100), Email)\n+Â  Â .input(\"HouseNumber\", sql.VarChar(50), HouseNumber)\n+Â  Â .input(\"CourtName\", sql.VarChar(100), CourtName)\n+Â  Â .input(\"RoleName\", sql.VarChar(50), RoleName)\n+Â  Â .input(\"Action\", sql.NVarChar(sql.MAX), Action || '') // Optional field, default to empty string\n+Â  Â .input(\"Status\", sql.VarChar(50), \"Pending\")\n+Â  Â .input(\"RequestedAt\", sql.DateTime, new Date())\n+Â  Â .query(`\n+Â  Â  INSERT INTO MembershipRecords\n+Â  Â  (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n+Â  Â  VALUES\n+Â  Â  (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, @Status, @RequestedAt);\n+Â  Â  SELECT SCOPE_IDENTITY() AS RequestID;\n+Â  Â `);\n \n- // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n- const newRequestId = result.recordset[0].RequestID;\n+Â  // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n+Â  const newRequestId = result.recordset[0].RequestID;\n \n- res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n+Â  res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n \n-} catch (err) {\n- console.error(\"Error submitting membership request:\", err);\n+Â } catch (err) {\n+Â  console.error(\"Error submitting membership request:\", err);\n     // Check for unique constraint violation (assuming NationalID is unique)\n     if (err.number === 2627) { \n         return res.status(409).json({ message: 'A membership request with this National ID already exists.' });\n     }\n- res.status(500).json({ message: \"Server error\" });\n+Â  res.status(500).json({ message: \"Server error\" });\n+Â }\n }\n-}\n \n // ======================================\n // Approve a membership request (PROTECTED)\n // ======================================\n export async function approveMembershipRequest(req, res) {\n-try {\n- const { RequestID } = req.params;\n- if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+Â try {\n+Â  const { RequestID } = req.params;\n+Â  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n- const pool = await dbPool;\n+Â  const pool = await dbPool;\n \n- await pool.request()\n- .input(\"RequestID\", sql.Int, RequestID)\n- .input(\"ApprovedAt\", sql.DateTime, new Date())\n- .query(`\n-  UPDATE MembershipRecords\n-  SET Status = 'Approved', ApprovedAt = @ApprovedAt\n-  WHERE RequestID = @RequestID\n- `);\n+Â  await pool.request()\n+Â  Â .input(\"RequestID\", sql.Int, RequestID)\n+Â  Â .input(\"ApprovedAt\", sql.DateTime, new Date())\n+Â  Â .query(`\n+Â  Â  UPDATE MembershipRecords\n+Â  Â  SET Status = 'Approved', ApprovedAt = @ApprovedAt\n+Â  Â  WHERE RequestID = @RequestID\n+Â  Â `);\n \n- res.status(200).json({ message: \"Membership request approved successfully\" });\n+Â  res.status(200).json({ message: \"Membership request approved successfully\" });\n \n-} catch (err) {\n- console.error(\"Error approving membership request:\", err);\n- res.status(500).json({ message: \"Server error\" });\n+Â } catch (err) {\n+Â  console.error(\"Error approving membership request:\", err);\n+Â  res.status(500).json({ message: \"Server error\" });\n+Â }\n }\n-}\n \n // ======================================\n // Reject a membership request (PROTECTED)\n // ======================================\n export async function rejectMembershipRequest(req, res) {\n-try {\n- const { RequestID } = req.params;\n- if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+Â try {\n+Â  const { RequestID } = req.params;\n+Â  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n- const pool = await dbPool;\n+Â  const pool = await dbPool;\n \n- await pool.request()\n- .input(\"RequestID\", sql.Int, RequestID)\n- .query(`\n-  UPDATE MembershipRecords\n-  SET Status = 'Rejected', ApprovedAt = NULL\n-  WHERE RequestID = @RequestID\n- `);\n+Â  await pool.request()\n+Â  Â .input(\"RequestID\", sql.Int, RequestID)\n+Â  Â .query(`\n+Â  Â  UPDATE MembershipRecords\n+Â  Â  SET Status = 'Rejected', ApprovedAt = NULL\n+Â  Â  WHERE RequestID = @RequestID\n+Â  Â `);\n \n- res.status(200).json({ message: \"Membership request rejected successfully\" });\n+Â  res.status(200).json({ message: \"Membership request rejected successfully\" });\n \n-} catch (err) {\n- console.error(\"Error rejecting membership request:\", err);\n- res.status(500).json({ message: \"Server error\" });\n+Â } catch (err) {\n+Â  console.error(\"Error rejecting membership request:\", err);\n+Â  res.status(500).json({ message: \"Server error\" });\n+Â }\n }\n-}\n \n // ======================================\n // Get all membership records (PROTECTED)\n // ======================================\n export async function getMembershipRequests(req, res) {\n-try {\n- const pool = await dbPool;\n+Â try {\n+Â  const pool = await dbPool;\n \n- const result = await pool.request()\n- .query(`\n-  SELECT *\n-  FROM MembershipRecords\n-  ORDER BY RequestedAt DESC\n- `);\n+Â  const result = await pool.request()\n+Â  Â .query(`\n+Â  Â  SELECT *\n+Â  Â  FROM MembershipRecords\n+Â  Â  ORDER BY RequestedAt DESC\n+Â  Â `);\n \n- res.status(200).json(result.recordset);\n+Â  res.status(200).json(result.recordset);\n \n-} catch (err) {\n- console.error(\"Error fetching membership records:\", err);\n- res.status(500).json({ message: \"Server error\" });\n+Â } catch (err) {\n+Â  console.error(\"Error fetching membership records:\", err);\n+Â  res.status(500).json({ message: \"Server error\" });\n+Â }\n }\n-}\n \n // ======================================\n // Get total membership count (PUBLIC)\n-// --------------------------------------\n-// FIX: This now counts APPROVED, DISTINCT National IDs (Actual Members)\n // ======================================\n export async function getMembershipCount(req, res) {\n- try {\n-  const pool = await dbPool;\n+Â  try {\n+Â  Â  const pool = await dbPool;\n \n-  const result = await pool.request().query(`\n-   SELECT COUNT(DISTINCT NationalID) AS count \n-   FROM MembershipRecords\n-   WHERE Status = 'Approved' AND RoleName = 'Resident'\n-  `);\n+Â  Â  const result = await pool.request().query(`\n+Â  Â  Â  SELECT COUNT(DISTINCT NationalID) AS count \n+Â  Â  Â  FROM MembershipRecords\n+Â  Â  Â  WHERE Status = 'Approved' AND RoleName = 'Resident'\n+Â  Â  `);\n \n-  // NOTE: The frontend expects the field name 'count', not 'totalRequests'\n-  res.status(200).json({ count: result.recordset[0].count });\n+Â  Â  res.status(200).json({ count: result.recordset[0].count });\n \n- } catch (err) {\n-  console.error(\"Error fetching membership count:\", err);\n-  res.status(500).json({ message: \"Server error\" });\n- }\n+Â  } catch (err) {\n+Â  Â  console.error(\"Error fetching membership count:\", err);\n+Â  Â  res.status(500).json({ message: \"Server error\" });\n+Â  }\n+}\n+\n+// ======================================\n+// Get unique court list (PUBLIC)\n+// FIX: Querying the dedicated 'Courts' table instead of 'MembershipRecords'\n+// ======================================\n+export async function getCourtList(req, res) {\n+    try {\n+        const pool = await dbPool;\n+\n+        // Querying the dedicated Courts table as per the database schema provided\n+        const result = await pool.request().query(\n+            `SELECT CourtName \n+             FROM Courts\n+             WHERE CourtName IS NOT NULL AND CourtName <> '' \n+             ORDER BY CourtName`\n+        );\n+        \n+        // Returns the list of courts as an array of objects: [{ CourtName: \"...\" }, ...]\n+        res.json(result.recordset);\n+    } catch (err) {\n+        console.error('Error fetching courts:', err);\n+        res.status(500).json({ message: 'Internal Server Error: Could not load court list.' });\n+    }\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763929563655,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -153,25 +153,39 @@\n }\n \n // ======================================\n // Get unique court list (PUBLIC)\n-// FIX: Querying the dedicated 'Courts' table instead of 'MembershipRecords'\n // ======================================\n export async function getCourtList(req, res) {\n+    console.log('Attempting to fetch court list from database...');\n     try {\n         const pool = await dbPool;\n \n-        // Querying the dedicated Courts table as per the database schema provided\n-        const result = await pool.request().query(\n-            `SELECT CourtName \n-             FROM Courts\n-             WHERE CourtName IS NOT NULL AND CourtName <> '' \n-             ORDER BY CourtName`\n-        );\n+        // Check if the pool is connected (optional but helpful for immediate debugging)\n+        if (!pool) {\n+            console.error('CRITICAL ERROR: Database pool is null or undefined.');\n+            return res.status(503).json({ message: 'Database service unavailable.' });\n+        }\n+\n+        console.log('Database pool acquired successfully.');\n         \n+        // Use [dbo].[Courts] for explicit schema referencing, which sometimes resolves errors\n+        const query = `\n+            SELECT CourtName \n+            FROM [dbo].[Courts]\n+            WHERE CourtName IS NOT NULL AND CourtName <> '' \n+            ORDER BY CourtName\n+        `;\n+        \n+        const result = await pool.request().query(query);\n+        \n+        console.log(`Successfully fetched ${result.recordset.length} court names.`);\n+        \n         // Returns the list of courts as an array of objects: [{ CourtName: \"...\" }, ...]\n         res.json(result.recordset);\n     } catch (err) {\n-        console.error('Error fetching courts:', err);\n-        res.status(500).json({ message: 'Internal Server Error: Could not load court list.' });\n+        // Output the specific SQL error number and message for fast diagnosis\n+        console.error('CRITICAL SERVER ERROR: Failed to fetch court list.');\n+        console.error(`SQL Error Number: ${err.number}, Message: ${err.message}`);\n+        res.status(500).json({ message: 'Internal Server Error: Could not load court list. See server log for details.' });\n     }\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763930654889,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -155,36 +155,29 @@\n // ======================================\n // Get unique court list (PUBLIC)\n // ======================================\n export async function getCourtList(req, res) {\n+    let pool;\n     console.log('Attempting to fetch court list from database...');\n     try {\n-        const pool = await dbPool;\n-\n-        // Check if the pool is connected (optional but helpful for immediate debugging)\n-        if (!pool) {\n-            console.error('CRITICAL ERROR: Database pool is null or undefined.');\n-            return res.status(503).json({ message: 'Database service unavailable.' });\n-        }\n-\n-        console.log('Database pool acquired successfully.');\n+        // Await the globally defined dbPool to get the pool instance\n+        pool = await dbPool;\n         \n-        // Use [dbo].[Courts] for explicit schema referencing, which sometimes resolves errors\n+        // **FIXED: Reverting to [dbo].[Courts] which is standard when DB is in connection config.**\n         const query = `\n             SELECT CourtName \n-            FROM [dbo].[Courts]\n+            FROM [dbo].[Courts] \n             WHERE CourtName IS NOT NULL AND CourtName <> '' \n             ORDER BY CourtName\n         `;\n         \n         const result = await pool.request().query(query);\n         \n-        console.log(`Successfully fetched ${result.recordset.length} court names.`);\n+        console.log(`SUCCESS: Fetched ${result.recordset.length} court names.`);\n         \n-        // Returns the list of courts as an array of objects: [{ CourtName: \"...\" }, ...]\n         res.json(result.recordset);\n     } catch (err) {\n-        // Output the specific SQL error number and message for fast diagnosis\n+        // This detailed logging is the key diagnostic tool.\n         console.error('CRITICAL SERVER ERROR: Failed to fetch court list.');\n         console.error(`SQL Error Number: ${err.number}, Message: ${err.message}`);\n         res.status(500).json({ message: 'Internal Server Error: Could not load court list. See server log for details.' });\n     }\n"
                },
                {
                    "date": 1763930844084,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,149 +8,149 @@\n // Submit a new membership request (PUBLIC)\n // Inserts directly into MembershipRecords with Status='Pending'\n // ======================================\n export async function submitMembershipRequest(req, res) {\n-Â try {\n-Â  const { \n+try {\n+ const { \n         ResidentName, NationalID, PhoneNumber, Email, \n         HouseNumber, CourtName, RoleName, Action // Added Action back\n     } = req.body;\n \n-Â  if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n-Â  Â return res.status(400).json({ message: \"All fields are required\" });\n-Â  }\n+ if (!ResidentName || !NationalID || !PhoneNumber || !Email || !HouseNumber || !CourtName || !RoleName) {\n+ return res.status(400).json({ message: \"All fields are required\" });\n+ }\n \n-Â  const pool = await dbPool;\n+ const pool = await dbPool;\n \n-Â  // Use sql types for security and type consistency\n-Â  const result = await pool.request()\n-Â  Â .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n-Â  Â .input(\"NationalID\", sql.VarChar(8), NationalID)\n-Â  Â .input(\"PhoneNumber\", sql.VarChar(20), PhoneNumber)\n-Â  Â .input(\"Email\", sql.NVarChar(100), Email)\n-Â  Â .input(\"HouseNumber\", sql.VarChar(50), HouseNumber)\n-Â  Â .input(\"CourtName\", sql.VarChar(100), CourtName)\n-Â  Â .input(\"RoleName\", sql.VarChar(50), RoleName)\n-Â  Â .input(\"Action\", sql.NVarChar(sql.MAX), Action || '') // Optional field, default to empty string\n-Â  Â .input(\"Status\", sql.VarChar(50), \"Pending\")\n-Â  Â .input(\"RequestedAt\", sql.DateTime, new Date())\n-Â  Â .query(`\n-Â  Â  INSERT INTO MembershipRecords\n-Â  Â  (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n-Â  Â  VALUES\n-Â  Â  (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, @Status, @RequestedAt);\n-Â  Â  SELECT SCOPE_IDENTITY() AS RequestID;\n-Â  Â `);\n+ // Use sql types for security and type consistency\n+ const result = await pool.request()\n+ .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n+ .input(\"NationalID\", sql.VarChar(8), NationalID)\n+ .input(\"PhoneNumber\", sql.VarChar(20), PhoneNumber)\n+ .input(\"Email\", sql.NVarChar(100), Email)\n+ .input(\"HouseNumber\", sql.VarChar(50), HouseNumber)\n+ .input(\"CourtName\", sql.VarChar(100), CourtName)\n+ .input(\"RoleName\", sql.VarChar(50), RoleName)\n+ .input(\"Action\", sql.NVarChar(sql.MAX), Action || '') // Optional field, default to empty string\n+ .input(\"Status\", sql.VarChar(50), \"Pending\")\n+ .input(\"RequestedAt\", sql.DateTime, new Date())\n+ .query(`\n+  INSERT INTO MembershipRecords\n+  (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Action, Status, RequestedAt)\n+  VALUES\n+  (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Action, @Status, @RequestedAt);\n+  SELECT SCOPE_IDENTITY() AS RequestID;\n+ `);\n \n-Â  // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n-Â  const newRequestId = result.recordset[0].RequestID;\n+ // SCOPE_IDENTITY() returns the ID of the last inserted row in the current session\n+ const newRequestId = result.recordset[0].RequestID;\n \n-Â  res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n+ res.status(201).json({ message: \"Membership request submitted successfully\", RequestID: newRequestId });\n \n-Â } catch (err) {\n-Â  console.error(\"Error submitting membership request:\", err);\n+} catch (err) {\n+ console.error(\"Error submitting membership request:\", err);\n     // Check for unique constraint violation (assuming NationalID is unique)\n     if (err.number === 2627) { \n         return res.status(409).json({ message: 'A membership request with this National ID already exists.' });\n     }\n-Â  res.status(500).json({ message: \"Server error\" });\n-Â }\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n \n // ======================================\n // Approve a membership request (PROTECTED)\n // ======================================\n export async function approveMembershipRequest(req, res) {\n-Â try {\n-Â  const { RequestID } = req.params;\n-Â  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+try {\n+ const { RequestID } = req.params;\n+ if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n-Â  const pool = await dbPool;\n+ const pool = await dbPool;\n \n-Â  await pool.request()\n-Â  Â .input(\"RequestID\", sql.Int, RequestID)\n-Â  Â .input(\"ApprovedAt\", sql.DateTime, new Date())\n-Â  Â .query(`\n-Â  Â  UPDATE MembershipRecords\n-Â  Â  SET Status = 'Approved', ApprovedAt = @ApprovedAt\n-Â  Â  WHERE RequestID = @RequestID\n-Â  Â `);\n+ await pool.request()\n+ .input(\"RequestID\", sql.Int, RequestID)\n+ .input(\"ApprovedAt\", sql.DateTime, new Date())\n+ .query(`\n+  UPDATE MembershipRecords\n+  SET Status = 'Approved', ApprovedAt = @ApprovedAt\n+  WHERE RequestID = @RequestID\n+ `);\n \n-Â  res.status(200).json({ message: \"Membership request approved successfully\" });\n+ res.status(200).json({ message: \"Membership request approved successfully\" });\n \n-Â } catch (err) {\n-Â  console.error(\"Error approving membership request:\", err);\n-Â  res.status(500).json({ message: \"Server error\" });\n-Â }\n+} catch (err) {\n+ console.error(\"Error approving membership request:\", err);\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n \n // ======================================\n // Reject a membership request (PROTECTED)\n // ======================================\n export async function rejectMembershipRequest(req, res) {\n-Â try {\n-Â  const { RequestID } = req.params;\n-Â  if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n+try {\n+ const { RequestID } = req.params;\n+ if (!RequestID) return res.status(400).json({ message: \"RequestID is required\" });\n \n-Â  const pool = await dbPool;\n+ const pool = await dbPool;\n \n-Â  await pool.request()\n-Â  Â .input(\"RequestID\", sql.Int, RequestID)\n-Â  Â .query(`\n-Â  Â  UPDATE MembershipRecords\n-Â  Â  SET Status = 'Rejected', ApprovedAt = NULL\n-Â  Â  WHERE RequestID = @RequestID\n-Â  Â `);\n+ await pool.request()\n+ .input(\"RequestID\", sql.Int, RequestID)\n+ .query(`\n+  UPDATE MembershipRecords\n+  SET Status = 'Rejected', ApprovedAt = NULL\n+  WHERE RequestID = @RequestID\n+ `);\n \n-Â  res.status(200).json({ message: \"Membership request rejected successfully\" });\n+ res.status(200).json({ message: \"Membership request rejected successfully\" });\n \n-Â } catch (err) {\n-Â  console.error(\"Error rejecting membership request:\", err);\n-Â  res.status(500).json({ message: \"Server error\" });\n-Â }\n+} catch (err) {\n+ console.error(\"Error rejecting membership request:\", err);\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n \n // ======================================\n // Get all membership records (PROTECTED)\n // ======================================\n export async function getMembershipRequests(req, res) {\n-Â try {\n-Â  const pool = await dbPool;\n+try {\n+ const pool = await dbPool;\n \n-Â  const result = await pool.request()\n-Â  Â .query(`\n-Â  Â  SELECT *\n-Â  Â  FROM MembershipRecords\n-Â  Â  ORDER BY RequestedAt DESC\n-Â  Â `);\n+ const result = await pool.request()\n+ .query(`\n+  SELECT *\n+  FROM MembershipRecords\n+  ORDER BY RequestedAt DESC\n+ `);\n \n-Â  res.status(200).json(result.recordset);\n+ res.status(200).json(result.recordset);\n \n-Â } catch (err) {\n-Â  console.error(\"Error fetching membership records:\", err);\n-Â  res.status(500).json({ message: \"Server error\" });\n-Â }\n+} catch (err) {\n+ console.error(\"Error fetching membership records:\", err);\n+ res.status(500).json({ message: \"Server error\" });\n }\n+}\n \n // ======================================\n // Get total membership count (PUBLIC)\n // ======================================\n export async function getMembershipCount(req, res) {\n-Â  try {\n-Â  Â  const pool = await dbPool;\n+ try {\n+  const pool = await dbPool;\n \n-Â  Â  const result = await pool.request().query(`\n-Â  Â  Â  SELECT COUNT(DISTINCT NationalID) AS count \n-Â  Â  Â  FROM MembershipRecords\n-Â  Â  Â  WHERE Status = 'Approved' AND RoleName = 'Resident'\n-Â  Â  `);\n+  const result = await pool.request().query(`\n+   SELECT COUNT(DISTINCT NationalID) AS count \n+   FROM MembershipRecords\n+   WHERE Status = 'Approved' AND RoleName = 'Resident'\n+  `);\n \n-Â  Â  res.status(200).json({ count: result.recordset[0].count });\n+  res.status(200).json({ count: result.recordset[0].count });\n \n-Â  } catch (err) {\n-Â  Â  console.error(\"Error fetching membership count:\", err);\n-Â  Â  res.status(500).json({ message: \"Server error\" });\n-Â  }\n+ } catch (err) {\n+  console.error(\"Error fetching membership count:\", err);\n+  res.status(500).json({ message: \"Server error\" });\n+ }\n }\n \n // ======================================\n // Get unique court list (PUBLIC)\n"
                },
                {
                    "date": 1763956400208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -154,31 +154,31 @@\n \n // ======================================\n // Get unique court list (PUBLIC)\n // ======================================\n+// Get unique court list (PUBLIC)\n export async function getCourtList(req, res) {\n-    let pool;\n-    console.log('Attempting to fetch court list from database...');\n     try {\n-        // Await the globally defined dbPool to get the pool instance\n-        pool = await dbPool;\n-        \n-        // **FIXED: Reverting to [dbo].[Courts] which is standard when DB is in connection config.**\n+        const pool = await dbPool;\n+\n         const query = `\n-            SELECT CourtName \n+            SELECT CourtID, CourtName \n             FROM [dbo].[Courts] \n             WHERE CourtName IS NOT NULL AND CourtName <> '' \n             ORDER BY CourtName\n         `;\n-        \n+\n         const result = await pool.request().query(query);\n-        \n-        console.log(`SUCCESS: Fetched ${result.recordset.length} court names.`);\n-        \n-        res.json(result.recordset);\n+\n+        // Map to frontend-friendly format\n\\ No newline at end of file\n+        const courts = result.recordset.map(court => ({\n+            CourtID: court.CourtID,\n+            CourtName: court.CourtName\n+        }));\n+\n+        res.json(courts);\n+\n     } catch (err) {\n-        // This detailed logging is the key diagnostic tool.\n-        console.error('CRITICAL SERVER ERROR: Failed to fetch court list.');\n-        console.error(`SQL Error Number: ${err.number}, Message: ${err.message}`);\n-        res.status(500).json({ message: 'Internal Server Error: Could not load court list. See server log for details.' });\n+        console.error('Failed to fetch court list:', err);\n+        res.status(500).json({ message: 'Could not load courts' });\n     }\n-}\n+}\n"
                },
                {
                    "date": 1763960304831,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -155,30 +155,34 @@\n // ======================================\n // Get unique court list (PUBLIC)\n // ======================================\n // Get unique court list (PUBLIC)\n+// controllers/membershipController.js\n+\n export async function getCourtList(req, res) {\n+    let pool;\n+    console.log('Attempting to fetch court list from database...');\n     try {\n-        const pool = await dbPool;\n-\n+        pool = await dbPool;\n+        \n+        // Use TRIM(CourtName) to remove any leading/trailing spaces\n+        // that might be causing the comparison to fail.\n         const query = `\n-            SELECT CourtID, CourtName \n+            SELECT CourtName \n             FROM [dbo].[Courts] \n-            WHERE CourtName IS NOT NULL AND CourtName <> '' \n+            WHERE \n+                CourtName IS NOT NULL \n+                AND TRIM(CourtName) <> ''  \n             ORDER BY CourtName\n         `;\n-\n+        \n         const result = await pool.request().query(query);\n-\n-        // Map to frontend-friendly format\n-        const courts = result.recordset.map(court => ({\n-            CourtID: court.CourtID,\n-            CourtName: court.CourtName\n-        }));\n-\n-        res.json(courts);\n-\n+        \n+        console.log(`SUCCESS: Fetched ${result.recordset.length} court names.`);\n+        \n+        res.json(result.recordset); \n     } catch (err) {\n-        console.error('Failed to fetch court list:', err);\n-        res.status(500).json({ message: 'Could not load courts' });\n+        console.error('CRITICAL SERVER ERROR: Failed to fetch court list.');\n+        console.error(`SQL Error Number: ${err.number}, Message: ${err.message}`);\n+        res.status(500).json({ message: 'Internal Server Error: Could not load court list.' });\n     }\n }\n\\ No newline at end of file\n"
                }
            ],
            "date": 1763695091299,
            "name": "Commit-0",
            "content": "// ==========================================\n// controllers/membershipController.js\n// Unified controller for Residents + Admins\n// FIX APPLIED: submitMembershipRequest now generates RequestID and uses RoleName from body.\n// ==========================================\n\nimport sql from \"mssql\";\nimport dotenv from \"dotenv\";\ndotenv.config();\n\n// ==========================================\n// Database Configuration (Consolidated from your snippets)\n// ==========================================\n// NOTE: This assumes 'dbConfig' is not imported from a separate file (e.g., ../config/dbConfig.js) \n// but is defined inline, as suggested by your initial context.\nconst dbConfig = {\n    user: process.env.DB_USER || \"Beverly\",\n    password: process.env.DB_PASS || \"Bev@1234567\",\n    server: process.env.DB_SERVER || \"localhost\",\n    database: process.env.DB_NAME || \"EstateAccessManagementSystem\",\n    options: { encrypt: true, trustServerCertificate: true },\n};\n\n\n// ====================================================\n// RESIDENT / ADMIN: Submit membership request (FIXED)\n// ====================================================\nexport const submitMembershipRequest = async (req, res) => {\n    const {\n        ResidentName,\n        NationalID,\n        PhoneNumber,\n        Email,\n        HouseNumber,\n        CourtName,\n        RoleName, // <--- Get RoleName from form body\n        // Action is also sent in the body if the form includes it, but omitted here for simplicity\n    } = req.body;\n\n    try {\n        // ==========================================\n        // VALIDATION\n        // ==========================================\n\n        // 1ï¸âƒ£ Validate required fields\n        if (\n            !ResidentName ||\n            !NationalID ||\n            !PhoneNumber ||\n            !Email ||\n            !HouseNumber ||\n            !CourtName ||\n            !RoleName\n        ) {\n            return res\n                .status(400)\n                .json({ success: false, message: \"Missing required fields\" });\n        }\n        \n        const pool = await sql.connect(dbConfig);\n        \n        // 2ï¸âƒ£ ðŸ”¥ FIX: Manually calculate the next sequential RequestID\n        const maxRequestResult = await pool.request().query(\n            \"SELECT ISNULL(MAX(RequestID), 0) AS maxID FROM MembershipRequests\"\n        );\n        const nextRequestID = maxRequestResult.recordset[0].maxID + 1;\n\n\n        // ==========================================\n        // INSERT MEMBERSHIP REQUEST\n        // ==========================================\n\n        await pool\n            .request()\n            .input(\"RequestID\", sql.Int, nextRequestID) // <--- INSERT NEWLY GENERATED ID\n            // UserID is omitted because the user is unauthenticated (no token)\n            // Action is omitted from insertion if not explicitly sent by the simple form\n            .input(\"ResidentName\", sql.NVarChar(100), ResidentName)\n            .input(\"NationalID\", sql.NVarChar(50), NationalID)\n            .input(\"PhoneNumber\", sql.NVarChar(50), PhoneNumber)\n            .input(\"Email\", sql.NVarChar(100), Email)\n            .input(\"HouseNumber\", sql.NVarChar(50), HouseNumber)\n            .input(\"CourtName\", sql.NVarChar(50), CourtName)\n            .input(\"RoleName\", sql.NVarChar(50), RoleName) // <--- Use RoleName from form body\n            .input(\"Status\", sql.NVarChar(50), \"Pending\")\n            .input(\"RequestedAt\", sql.DateTime, new Date())\n            .query(`\n                INSERT INTO MembershipRequests\n                  (RequestID, ResidentName, NationalID, PhoneNumber, Email, \n                   HouseNumber, CourtName, RoleName, Status, RequestedAt)\n                VALUES \n                  (@RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, \n                   @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt)\n            `);\n\n        // ==========================================\n        // SUCCESS\n        // ==========================================\n        return res.status(200).json({\n            success: true,\n            message: \"Membership request submitted successfully. Awaiting approval.\",\n        });\n    } catch (err) {\n        console.error(\"âŒ submitMembershipRequest Error:\", err);\n        return res.status(500).json({\n            success: false,\n            message: \"Server error during submission\",\n            error: err.message,\n        });\n    }\n};\n\n\n// ====================================================\n// ADMIN: View all membership requests\n// ====================================================\nexport const getAllMembershipRequests = async (req, res) => {\n    try {\n        const pool = await sql.connect(dbConfig);\n        const result = await pool\n            .request()\n            .query(\"SELECT TOP (1000) * FROM MembershipRequests ORDER BY RequestedAt DESC\");\n\n        res.status(200).json({ success: true, data: result.recordset });\n    } catch (err) {\n        console.error(\"âŒ getAllMembershipRequests Error:\", err);\n        res.status(500).json({ success: false, message: \"Server error\" });\n    }\n};\n\n// ====================================================\n// ADMIN: Approve membership request\n// ====================================================\nexport const approveMembershipRequest = async (req, res) => {\n   const { RequestID } = req.params;\n\n   try {\n    const pool = await sql.connect(dbConfig);\n\n    // 1. Get request details\n    const requestResult = await pool\n        .request()\n        .input(\"RequestID\", sql.Int, RequestID)\n        .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n\n    if (requestResult.recordset.length === 0) {\n       return res.status(404).json({ success: false, message: \"Request not found\" });\n    }\n\n    const r = requestResult.recordset[0];\n\n    // 2. ðŸ”¥ MANUALLY CALCULATE NEXT RecordID (CRITICAL FIX)\n    const maxRecordResult = await pool.request().query(\n        \"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\"\n    );\n    const nextRecordID = maxRecordResult.recordset[0].maxID + 1;\n    \n    // 3. Update status to Approved\n    await pool\n        .request()\n        .input(\"RequestID\", sql.Int, RequestID)\n        .query(\"UPDATE MembershipRequests SET Status = 'Approved' WHERE RequestID = @RequestID\");\n\n    // 4. Move approved request into MembershipRecords\n    await pool\n        .request()\n        .input(\"RequestID\", sql.Int, RequestID)\n        .input(\"RecordID\", sql.Int, nextRecordID) // <-- NEW: Input the calculated ID\n        .input(\"ResidentName\", sql.NVarChar(100), r.ResidentName)\n        .input(\"NationalID\", sql.NVarChar(50), r.NationalID)\n        .input(\"PhoneNumber\", sql.NVarChar(50), r.PhoneNumber)\n        .input(\"Email\", sql.NVarChar(100), r.Email)\n        .input(\"HouseNumber\", sql.NVarChar(50), r.HouseNumber)\n        .input(\"CourtName\", sql.NVarChar(50), r.CourtName)\n        .input(\"RoleName\", sql.NVarChar(50), r.RoleName)\n        .input(\"Status\", sql.NVarChar(50), \"Approved\")\n        .input(\"RequestedAt\", sql.DateTime, r.RequestedAt)\n        .input(\"Action\", sql.NVarChar(50), r.Action)\n        .query(`\n         INSERT INTO MembershipRecords\n         (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n         VALUES (@RecordID, @RequestID, @ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @Status, @RequestedAt, @Action)\n        `); \n\n    res.json({\n       success: true,\n       message: \"Request approved and moved to records successfully\",\n    });\n   } catch (err) {\n    console.error(\"âŒ approveMembershipRequest Error:\", err);\n    res.status(500).json({ success: false, message: \"Server error\" });\n   }\n};\n\n// ====================================================\n// ADMIN: Sync MembershipRequests â†’ MembershipRecords\n// ====================================================\nexport const syncMembershipRecords = async (req, res) => {\n   try {\n    const pool = await sql.connect(dbConfig);\n\n    // 1. Fetch the current maximum RecordID\n    const maxRecordResult = await pool.request().query(\n        \"SELECT ISNULL(MAX(RecordID), 0) AS maxID FROM MembershipRecords\"\n    );\n    const startingRecordID = maxRecordResult.recordset[0].maxID;\n\n    // 2. Perform the bulk insert using the startingRecordID to offset the Row Number.\n    const syncResult = await pool\n            .request()\n            .input(\"StartingID\", sql.Int, startingRecordID) \n            .query(`\n                -- CTE to identify requests that need to be synced\n                WITH RequestsToSync AS (\n                    SELECT \n                        r.RequestID, \n                        r.ResidentName, \n                        r.NationalID, \n                        r.PhoneNumber, \n                        r.Email, \n                        r.HouseNumber, \n                        r.CourtName, \n                        r.RoleName, \n                        r.Status, \n                        r.RequestedAt, \n                        r.Action\n                    FROM MembershipRequests r\n                    WHERE NOT EXISTS (\n                        SELECT 1 FROM MembershipRecords m WHERE m.RequestID = r.RequestID\n                    )\n                ),\n                -- CTE to assign a sequential row number to the new records\n                NumberedRequests AS (\n                    SELECT \n                        *,\n                        ROW_NUMBER() OVER (ORDER BY RequestedAt ASC) as RowNum\n                    FROM RequestsToSync\n                )\n                -- Final Insert statement\n            INSERT INTO MembershipRecords\n            (RecordID, RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt, Action)\n            SELECT \n                        (@StartingID + nr.RowNum) as CalculatedRecordID, -- Calculate new unique ID: MAX(ID) + RowNum\n                        nr.RequestID, \n                        nr.ResidentName, \n                        nr.NationalID, \n                        nr.PhoneNumber, \n                        nr.Email, \n                        nr.HouseNumber, \n                        nr.CourtName, \n                        nr.RoleName, \n                        nr.Status, \n                        nr.RequestedAt, \n                        nr.Action\n            FROM NumberedRequests nr;\n    `);\n    \n    const rowsInserted = syncResult.rowsAffected[0];\n\n    res.json({ \n        success: true, \n        message: `${rowsInserted} record(s) synced successfully.` \n    });\n\n   } catch (err) {\n    console.error(\"âŒ syncMembershipRecords Error:\", err);\n    res.status(500).json({ success: false, message: \"Sync failed. Check server logs for SQL error.\" });\n   }\n};\n\n\n// ====================================================\n// ADMIN: Get latest RequestID and RecordID for frontend\n// ====================================================\nexport const getLatestMembershipIDs = async (req, res) => {\n    try {\n        const pool = await sql.connect(dbConfig);\n\n        const result = await pool.request().query(`\n            SELECT \n                (SELECT ISNULL(MAX(RequestID), 0) FROM MembershipRequests) AS lastRequestID,\n                (SELECT ISNULL(MAX(RecordID), 0) FROM MembershipRecords) AS lastRecordID;\n        `);\n\n        const { lastRequestID, lastRecordID } = result.recordset[0];\n\n        res.status(200).json({\n            success: true,\n            lastRequestID,\n            lastRecordID\n        });\n\n    } catch (err) {\n        console.error(\"âŒ getLatestMembershipIDs Error:\", err);\n        res.status(500).json({\n            success: false,\n            message: \"Failed to retrieve latest IDs.\",\n            lastRequestID: 0,\n            lastRecordID: 0\n        });\n    }\n};\n\n// ====================================================\n// ADMIN: Delete membership request (PLACEHOLDER)\n// ====================================================\nexport const deleteMembershipRequest = async (req, res) => {\n    const { RequestID } = req.params;\n    try {\n        const pool = await sql.connect(dbConfig);\n        const result = await pool\n            .request()\n            .input(\"RequestID\", sql.Int, RequestID)\n            .query(\"DELETE FROM MembershipRequests WHERE RequestID = @RequestID\");\n        \n        if (result.rowsAffected[0] === 0) {\n            return res.status(404).json({ success: false, message: \"Request not found\" });\n        }\n        res.status(200).json({ success: true, message: \"Request deleted successfully\" });\n    } catch (err) {\n        console.error(\"âŒ deleteMembershipRequest Error:\", err);\n        res.status(500).json({ success: false, message: \"Server error\" });\n    }\n};\n\n// ====================================================\n// ADMIN: Reject membership request (PLACEHOLDER)\n// ====================================================\nexport const rejectMembershipRequest = async (req, res) => {\n    const { RequestID } = req.params;\n    try {\n        const pool = await sql.connect(dbConfig);\n        await pool\n            .request()\n            .input(\"RequestID\", sql.Int, RequestID)\n            .query(\"UPDATE MembershipRequests SET Status = 'Rejected' WHERE RequestID = @RequestID\");\n\n        res.status(200).json({ success: true, message: \"Request rejected successfully\" });\n    } catch (err) {\n        console.error(\"âŒ rejectMembershipRequest Error:\", err);\n        res.status(500).json({ success: false, message: \"Server error\" });\n    }\n};\n\n// ====================================================\n// ADMIN: Get all membership records (PLACEHOLDER)\n// ====================================================\nexport const getAllMembershipRecords = async (req, res) => {\n    try {\n        const pool = await sql.connect(dbConfig);\n        const result = await pool\n            .request()\n            .query(\"SELECT TOP (1000) * FROM MembershipRecords ORDER BY RequestedAt DESC\");\n\n        res.status(200).json({ success: true, data: result.recordset });\n    } catch (err) {\n        console.error(\"âŒ getAllMembershipRecords Error:\", err);\n        res.status(500).json({ success: false, message: \"Server error\" });\n    }\n};"
        }
    ]
}