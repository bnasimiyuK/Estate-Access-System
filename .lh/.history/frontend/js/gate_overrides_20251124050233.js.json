{
    "sourceFile": ".history/frontend/js/gate_overrides_20251124050233.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763950814987,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763950814987,
            "name": "Commit-0",
            "content": "// Global variables/constants for API configuration\r\nconst API_HOST = \"http://localhost:4050\"; // Placeholder: Replace with your actual backend host\r\nconst ENDPOINTS = {\r\n    // The backend route '/api/logs/gate_overrides' MUST execute the SQL query provided:\r\n    // SELECT TOP (1000) [id], [gateId], [action], [reason], [userId], [createdAt] FROM [EstateAccessManagementSystem].[dbo].[gate_overrides]\r\n    GATE_OVERRIDES: \"/api/logs/gate_overrides\", \r\n};\r\n\r\n// The Admin JWT token should be securely provided by the embedding application environment.\r\nconst token = window.adminToken || ''; \r\n\r\n// Data store\r\nlet gateOverridesData = [];\r\n\r\n/**\r\n * Fetches gate override log data from the backend API.\r\n */\r\nasync function fetchGateOverrideLogs() {\r\n    const statusMessage = document.getElementById('statusMessage');\r\n    const logsTableBody = document.getElementById('logsTableBody');\r\n    statusMessage.classList.add('hidden');\r\n    logsTableBody.innerHTML = `<tr><td colspan=\"6\" class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center\">Fetching data...</td></tr>`;\r\n\r\n    if (!token) {\r\n        logsTableBody.innerHTML = `<tr><td colspan=\"6\" class=\"px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center font-semibold\">\r\n            Error: Authentication token is missing. Access Denied.\r\n        </td></tr>`;\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const url = `${API_HOST}${ENDPOINTS.GATE_OVERRIDES}`;\r\n        \r\n        // Exponential backoff retry mechanism for API calls\r\n        const MAX_RETRIES = 3;\r\n        let response;\r\n        for (let i = 0; i < MAX_RETRIES; i++) {\r\n            response = await fetch(url, {\r\n                method: 'GET',\r\n                headers: {\r\n                    'Authorization': `Bearer ${token}`, \r\n                    'Content-Type': 'application/json',\r\n                }\r\n            });\r\n\r\n            if (response.ok) break;\r\n\r\n            if (i < MAX_RETRIES - 1) {\r\n                const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s\r\n                await new Promise(resolve => setTimeout(resolve, delay));\r\n            }\r\n        }\r\n\r\n        if (!response.ok) {\r\n            const errorDetail = await response.text();\r\n            throw new Error(`HTTP error! Status: ${response.status}. Detail: ${errorDetail.substring(0, 100)}...`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        \r\n        // Assuming data is an array of log objects matching the SQL columns\r\n        gateOverridesData = Array.isArray(data) ? data : (data.logs || []);\r\n        \r\n        // Initial render of all fetched data\r\n        renderLogs(gateOverridesData);\r\n\r\n    } catch (error) {\r\n        console.error('Error fetching gate override logs:', error);\r\n        statusMessage.textContent = `Failed to load logs. Ensure the API server is running at ${API_HOST} and the endpoint ${ENDPOINTS.GATE_OVERRIDES} is correct.`;\r\n        statusMessage.classList.remove('hidden');\r\n        logsTableBody.innerHTML = `<tr><td colspan=\"6\" class=\"px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center\">\r\n            Data fetch failed. See console for details.\r\n        </td></tr>`;\r\n    }\r\n}\r\n\r\n/**\r\n * Renders the filtered log data into the HTML table.\r\n * Note: Property names (id, gateId, etc.) match the SQL column names exactly.\r\n * @param {Array<Object>} logs The array of log objects to render.\r\n */\r\nfunction renderLogs(logs) {\r\n    const logsTableBody = document.getElementById('logsTableBody');\r\n    logsTableBody.innerHTML = ''; // Clear previous data\r\n\r\n    if (logs.length === 0) {\r\n        logsTableBody.innerHTML = `<tr><td colspan=\"6\" class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center\">\r\n            No gate override logs found matching criteria.\r\n        </td></tr>`;\r\n        return;\r\n    }\r\n\r\n    logs.forEach(log => {\r\n        const row = document.createElement('tr');\r\n        row.className = 'table-row-hover';\r\n        \r\n        // Format the timestamp for better readability\r\n        const formattedDate = new Date(log.createdAt).toLocaleString('en-US', {\r\n            year: 'numeric', month: 'short', day: '2-digit',\r\n            hour: '2-digit', minute: '2-digit', second: '2-digit'\r\n        });\r\n\r\n        // Determine action styling\r\n        let actionClass;\r\n        if (log.action === 'OPEN') {\r\n            actionClass = 'bg-green-100 text-green-800';\r\n        } else if (log.action === 'CLOSE') {\r\n            actionClass = 'bg-yellow-100 text-yellow-800';\r\n        } else {\r\n            actionClass = 'bg-red-100 text-red-800';\r\n        }\r\n\r\n        row.innerHTML = `\r\n            <td class=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">${log.id}</td>\r\n            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-700\">${log.gateId || 'N/A'}</td>\r\n            <td class=\"px-6 py-4 whitespace-nowrap text-sm\">\r\n                <span class=\"px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${actionClass}\">\r\n                    ${log.action || 'Unknown'}\r\n                </span>\r\n            </td>\r\n            <td class=\"px-6 py-4 whitespace-pre-wrap text-sm text-gray-500 max-w-xs\">${log.reason || 'None provided'}</td>\r\n            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${log.userId || 'System'}</td>\r\n            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${formattedDate}</td>\r\n        `;\r\n        logsTableBody.appendChild(row);\r\n    });\r\n}\r\n\r\n/**\r\n * Applies client-side filters to the log data.\r\n */\r\nfunction applyLogsFilters() {\r\n    const filterGateId = document.getElementById('filterGateId').value.toLowerCase();\r\n    const filterAction = document.getElementById('filterAction').value.toLowerCase();\r\n\r\n    const filteredLogs = gateOverridesData.filter(log => {\r\n        const gateMatch = log.gateId && log.gateId.toLowerCase().includes(filterGateId);\r\n        const actionMatch = log.action && log.action.toLowerCase().includes(filterAction);\r\n        return gateMatch && actionMatch;\r\n    });\r\n\r\n    renderLogs(filteredLogs);\r\n}\r\n\r\n/**\r\n * Exports the currently displayed logs to a CSV file.\r\n */\r\nfunction exportLogsToCSV() {\r\n    // Use the data currently rendered (which is already filtered)\r\n    const rows = Array.from(document.getElementById('logsTableBody').getElementsByTagName('tr'));\r\n    if (rows.length === 0 || rows[0].getAttribute('colspan') === '6') {\r\n         document.getElementById('statusMessage').textContent = \"No data to export.\";\r\n         document.getElementById('statusMessage').classList.remove('hidden');\r\n         setTimeout(() => document.getElementById('statusMessage').classList.add('hidden'), 3000);\r\n         return;\r\n    }\r\n\r\n    let csvContent = \"data:text/csv;charset=utf-8,\";\r\n    \r\n    // 1. Headers (Matching the SQL column names)\r\n    const headers = [\"id\", \"gateId\", \"action\", \"reason\", \"userId\", \"createdAt\"];\r\n    csvContent += headers.join(\",\") + \"\\r\\n\";\r\n\r\n    // 2. Data Rows\r\n    // Fetch data directly from the logs currently displayed in the table (which respects filtering)\r\n    rows.forEach(row => {\r\n        const rowData = Array.from(row.getElementsByTagName('td')).map(cell => {\r\n            // Clean up text content and remove inner spans/extra whitespace\r\n            let text = cell.textContent.trim().replace(/\\s\\s+/g, ' '); \r\n            // Escape double quotes by doubling them\r\n            if (text.includes(',')) {\r\n                return `\"${text.replace(/\"/g, '\"\"')}\"`;\r\n            }\r\n            return text;\r\n        });\r\n        csvContent += rowData.join(\",\") + \"\\r\\n\";\r\n    });\r\n\r\n    // Create and trigger download link\r\n    const encodedUri = encodeURI(csvContent);\r\n    const link = document.createElement(\"a\");\r\n    link.setAttribute(\"href\", encodedUri);\r\n    link.setAttribute(\"download\", \"gate_override_logs_\" + new Date().toISOString().slice(0, 10) + \".csv\");\r\n    document.body.appendChild(link); // Required for Firefox\r\n    link.click();\r\n    document.body.removeChild(link);\r\n}\r\n\r\n/**\r\n * Attaches all necessary event listeners to the input fields and buttons.\r\n */\r\nfunction attachLogsListeners() {\r\n    document.getElementById('filterGateId').addEventListener('input', applyLogsFilters);\r\n    document.getElementById('filterAction').addEventListener('input', applyLogsFilters);\r\n    document.getElementById('exportLogsBtn').addEventListener('click', exportLogsToCSV);\r\n}\r\n\r\n// Initialize the page once the DOM is ready\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    // 1. Attach listeners for filtering and export functionality\r\n    attachLogsListeners();\r\n    \r\n    // 2. Fetch the data from the server\r\n    fetchGateOverrideLogs();\r\n});"
        }
    ]
}