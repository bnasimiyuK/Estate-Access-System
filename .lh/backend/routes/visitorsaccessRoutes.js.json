{
    "sourceFile": "backend/routes/visitorsaccessRoutes.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1763866196955,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763866221167,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -82,9 +82,9 @@\n     console.error(\"❌ APPROVE visitor error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n   }\r\n });\r\n-\r\n+router.get(\"/requests\", getVisitorRequests);\r\n /* ===============================\r\n    REJECT visitor (Admin/Security)\r\n =============================== */\r\n router.put(\"/:id/reject\", verifyToken, async (req, res) => {\r\n"
                },
                {
                    "date": 1763866660980,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n import verifyToken from \"../middleware/verifyToken.js\";\r\n import { authenticateJWT, authorizeRole } from \"../middleware/authMiddleware.js\";\r\n import { getPool, sql } from \"../db.js\";\r\n import dbConfig from \"../config/db.js\";\r\n-import { getVisitorRequests } from \"../controllers/visitorController.js\";\r\n+import { getVisitorRequests } from \"../controllers/visitoraccessController.js\";\r\n const router = express.Router();\r\n \r\n /* ===============================\r\n    GET all visitors (Admin only)\r\n"
                },
                {
                    "date": 1763866677785,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n import verifyToken from \"../middleware/verifyToken.js\";\r\n import { authenticateJWT, authorizeRole } from \"../middleware/authMiddleware.js\";\r\n import { getPool, sql } from \"../db.js\";\r\n import dbConfig from \"../config/db.js\";\r\n-import { getVisitorRequests } from \"../controllers/visitoraccessController.js\";\r\n+import { getVisitorRequests } from \"../controllers/visitorsaccessController.js\";\r\n const router = express.Router();\r\n \r\n /* ===============================\r\n    GET all visitors (Admin only)\r\n"
                },
                {
                    "date": 1763867580908,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,23 +1,21 @@\n+// backend/routes/visitorsaccessRoutes.js\r\n import express from \"express\";\r\n-import verifyToken from \"../middleware/verifyToken.js\";\r\n import { authenticateJWT, authorizeRole } from \"../middleware/authMiddleware.js\";\r\n+import { getVisitorRequests } from \"../controllers/visitorController.js\";\r\n import { getPool, sql } from \"../db.js\";\r\n import dbConfig from \"../config/db.js\";\r\n-import { getVisitorRequests } from \"../controllers/visitorsaccessController.js\";\r\n+\r\n const router = express.Router();\r\n \r\n /* ===============================\r\n    GET all visitors (Admin only)\r\n =============================== */\r\n-router.get(\"/\", verifyToken, async (req, res) => {\r\n+router.get(\"/\", authenticateJWT, authorizeRole([\"admin\"]), async (req, res) => {\r\n   try {\r\n-    if (req.user.role !== \"Admin\") return res.status(403).json({ error: \"Forbidden\" });\r\n-\r\n     const pool = await sql.connect(dbConfig);\r\n     const result = await pool.request()\r\n       .query(\"SELECT * FROM Visitors ORDER BY Date DESC\");\r\n-\r\n     res.json(result.recordset);\r\n   } catch (err) {\r\n     console.error(\"❌ GET /visitors error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n@@ -26,15 +24,14 @@\n \r\n /* ===============================\r\n    GET own visitors (Resident)\r\n =============================== */\r\n-router.get(\"/my\", verifyToken, async (req, res) => {\r\n+router.get(\"/my\", authenticateJWT, authorizeRole([\"resident\"]), async (req, res) => {\r\n   try {\r\n     const pool = await sql.connect(dbConfig);\r\n     const result = await pool.request()\r\n       .input(\"ResidentId\", sql.Int, req.user.userId)\r\n       .query(\"SELECT * FROM Visitors WHERE ResidentId=@ResidentId ORDER BY Date DESC\");\r\n-\r\n     res.json(result.recordset);\r\n   } catch (err) {\r\n     console.error(\"❌ GET /visitors/my error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n@@ -43,22 +40,19 @@\n \r\n /* ===============================\r\n    CREATE visitor (Resident)\r\n =============================== */\r\n-router.post(\"/\", verifyToken, async (req, res) => {\r\n+router.post(\"/\", authenticateJWT, authorizeRole([\"resident\"]), async (req, res) => {\r\n   const { VisitorName, Date } = req.body;\r\n \r\n   try {\r\n     const pool = await sql.connect(dbConfig);\r\n     await pool.request()\r\n       .input(\"VisitorName\", sql.VarChar, VisitorName)\r\n       .input(\"Date\", sql.Date, Date)\r\n       .input(\"ResidentId\", sql.Int, req.user.userId)\r\n-      .query(`\r\n-        INSERT INTO Visitors (VisitorName, Date, ResidentId, Status)\r\n-        VALUES (@VisitorName, @Date, @ResidentId, 'Pending')\r\n-      `);\r\n-\r\n+      .query(`INSERT INTO Visitors (VisitorName, Date, ResidentId, Status) \r\n+              VALUES (@VisitorName, @Date, @ResidentId, 'Pending')`);\r\n     res.json({ message: \"Visitor request submitted.\" });\r\n   } catch (err) {\r\n     console.error(\"❌ POST /visitors error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n@@ -67,36 +61,30 @@\n \r\n /* ===============================\r\n    APPROVE visitor (Admin/Security)\r\n =============================== */\r\n-router.put(\"/:id/approve\", verifyToken, async (req, res) => {\r\n+router.put(\"/:id/approve\", authenticateJWT, authorizeRole([\"admin\",\"security\"]), async (req, res) => {\r\n   try {\r\n-    if (![\"Admin\",\"Security\"].includes(req.user.role)) return res.status(403).json({ error: \"Forbidden\" });\r\n-\r\n     const pool = await sql.connect(dbConfig);\r\n     await pool.request()\r\n       .input(\"VisitorId\", sql.Int, req.params.id)\r\n       .query(\"UPDATE Visitors SET Status='Approved' WHERE VisitorId=@VisitorId\");\r\n-\r\n     res.json({ message: \"Visitor approved.\" });\r\n   } catch (err) {\r\n     console.error(\"❌ APPROVE visitor error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n   }\r\n });\r\n-router.get(\"/requests\", getVisitorRequests);\r\n+\r\n /* ===============================\r\n    REJECT visitor (Admin/Security)\r\n =============================== */\r\n-router.put(\"/:id/reject\", verifyToken, async (req, res) => {\r\n+router.put(\"/:id/reject\", authenticateJWT, authorizeRole([\"admin\",\"security\"]), async (req, res) => {\r\n   try {\r\n-    if (![\"Admin\",\"Security\"].includes(req.user.role)) return res.status(403).json({ error: \"Forbidden\" });\r\n-\r\n     const pool = await sql.connect(dbConfig);\r\n     await pool.request()\r\n       .input(\"VisitorId\", sql.Int, req.params.id)\r\n       .query(\"UPDATE Visitors SET Status='Rejected' WHERE VisitorId=@VisitorId\");\r\n-\r\n     res.json({ message: \"Visitor rejected.\" });\r\n   } catch (err) {\r\n     console.error(\"❌ REJECT visitor error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n@@ -105,16 +93,13 @@\n \r\n /* ===============================\r\n    GET pending visitors (Admin only)\r\n =============================== */\r\n-router.get(\"/pending\", verifyToken, async (req, res) => {\r\n+router.get(\"/pending\", authenticateJWT, authorizeRole([\"admin\"]), async (req, res) => {\r\n   try {\r\n-    if (req.user.role !== \"Admin\") return res.status(403).json({ error: \"Forbidden\" });\r\n-\r\n     const pool = await sql.connect(dbConfig);\r\n     const result = await pool.request()\r\n       .query(\"SELECT * FROM Visitors WHERE Status='Pending' ORDER BY Date DESC\");\r\n-\r\n     res.json(result.recordset);\r\n   } catch (err) {\r\n     console.error(\"❌ GET /visitors/pending error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n@@ -132,9 +117,8 @@\n     const pool = await getPool();\r\n     await pool.request()\r\n       .input(\"code\", sql.NVarChar(50), code)\r\n       .query(\"UPDATE visitor_passes SET status='checked-in', checkInTime=GETDATE() WHERE passCode=@code\");\r\n-\r\n     res.json({ message: `Visitor ${code} checked in` });\r\n   } catch(err) {\r\n     console.error(err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n@@ -152,9 +136,8 @@\n     const pool = await getPool();\r\n     await pool.request()\r\n       .input(\"code\", sql.NVarChar(50), code)\r\n       .query(\"UPDATE visitor_passes SET status='checked-out', checkOutTime=GETDATE() WHERE passCode=@code\");\r\n-\r\n     res.json({ message: `Visitor ${code} checked out` });\r\n   } catch(err) {\r\n     console.error(err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n@@ -162,9 +145,8 @@\n });\r\n \r\n /* ===============================\r\n    L2 Pending Approvals (Security/Admin)\r\n-   Full route: /api/visitors/l2/pending\r\n =============================== */\r\n router.get(\"/l2/pending\", authenticateJWT, authorizeRole([\"admin\",\"security\"]), async (req,res)=>{\r\n   try {\r\n     const pool = await getPool();\r\n@@ -189,13 +171,17 @@\n     await pool.request()\r\n       .input(\"code\", sql.NVarChar(50), code)\r\n       .input(\"approve\", sql.Bit, approve)\r\n       .query(\"UPDATE visitor_passes SET l2Approved=@approve WHERE passCode=@code\");\r\n-\r\n     res.json({ message: `Visitor ${code} L2 approval set to ${approve}` });\r\n   } catch(err){\r\n     console.error(\"❌ POST /visitors/approve-l2 error:\", err);\r\n     res.status(500).json({ error: \"Server error\" });\r\n   }\r\n });\r\n \r\n+/* ===============================\r\n+   Visitor Requests (Admin/Security)\r\n+=============================== */\r\n+router.get(\"/requests\", authenticateJWT, authorizeRole([\"admin\",\"security\"]), getVisitorRequests);\r\n+\r\n export default router;\r\n"
                },
                {
                    "date": 1763867613845,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n // backend/routes/visitorsaccessRoutes.js\r\n import express from \"express\";\r\n import { authenticateJWT, authorizeRole } from \"../middleware/authMiddleware.js\";\r\n-import { getVisitorRequests } from \"../controllers/visitorController.js\";\r\n+import { getVisitorRequests } from \"../controllers/visitorsaccessController.js\";\r\n import { getPool, sql } from \"../db.js\";\r\n import dbConfig from \"../config/db.js\";\r\n \r\n const router = express.Router();\r\n"
                }
            ],
            "date": 1763866196955,
            "name": "Commit-0",
            "content": "import express from \"express\";\r\nimport verifyToken from \"../middleware/verifyToken.js\";\r\nimport { authenticateJWT, authorizeRole } from \"../middleware/authMiddleware.js\";\r\nimport { getPool, sql } from \"../db.js\";\r\nimport dbConfig from \"../config/db.js\";\r\nimport { getVisitorRequests } from \"../controllers/visitorController.js\";\r\nconst router = express.Router();\r\n\r\n/* ===============================\r\n   GET all visitors (Admin only)\r\n=============================== */\r\nrouter.get(\"/\", verifyToken, async (req, res) => {\r\n  try {\r\n    if (req.user.role !== \"Admin\") return res.status(403).json({ error: \"Forbidden\" });\r\n\r\n    const pool = await sql.connect(dbConfig);\r\n    const result = await pool.request()\r\n      .query(\"SELECT * FROM Visitors ORDER BY Date DESC\");\r\n\r\n    res.json(result.recordset);\r\n  } catch (err) {\r\n    console.error(\"❌ GET /visitors error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   GET own visitors (Resident)\r\n=============================== */\r\nrouter.get(\"/my\", verifyToken, async (req, res) => {\r\n  try {\r\n    const pool = await sql.connect(dbConfig);\r\n    const result = await pool.request()\r\n      .input(\"ResidentId\", sql.Int, req.user.userId)\r\n      .query(\"SELECT * FROM Visitors WHERE ResidentId=@ResidentId ORDER BY Date DESC\");\r\n\r\n    res.json(result.recordset);\r\n  } catch (err) {\r\n    console.error(\"❌ GET /visitors/my error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   CREATE visitor (Resident)\r\n=============================== */\r\nrouter.post(\"/\", verifyToken, async (req, res) => {\r\n  const { VisitorName, Date } = req.body;\r\n\r\n  try {\r\n    const pool = await sql.connect(dbConfig);\r\n    await pool.request()\r\n      .input(\"VisitorName\", sql.VarChar, VisitorName)\r\n      .input(\"Date\", sql.Date, Date)\r\n      .input(\"ResidentId\", sql.Int, req.user.userId)\r\n      .query(`\r\n        INSERT INTO Visitors (VisitorName, Date, ResidentId, Status)\r\n        VALUES (@VisitorName, @Date, @ResidentId, 'Pending')\r\n      `);\r\n\r\n    res.json({ message: \"Visitor request submitted.\" });\r\n  } catch (err) {\r\n    console.error(\"❌ POST /visitors error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   APPROVE visitor (Admin/Security)\r\n=============================== */\r\nrouter.put(\"/:id/approve\", verifyToken, async (req, res) => {\r\n  try {\r\n    if (![\"Admin\",\"Security\"].includes(req.user.role)) return res.status(403).json({ error: \"Forbidden\" });\r\n\r\n    const pool = await sql.connect(dbConfig);\r\n    await pool.request()\r\n      .input(\"VisitorId\", sql.Int, req.params.id)\r\n      .query(\"UPDATE Visitors SET Status='Approved' WHERE VisitorId=@VisitorId\");\r\n\r\n    res.json({ message: \"Visitor approved.\" });\r\n  } catch (err) {\r\n    console.error(\"❌ APPROVE visitor error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   REJECT visitor (Admin/Security)\r\n=============================== */\r\nrouter.put(\"/:id/reject\", verifyToken, async (req, res) => {\r\n  try {\r\n    if (![\"Admin\",\"Security\"].includes(req.user.role)) return res.status(403).json({ error: \"Forbidden\" });\r\n\r\n    const pool = await sql.connect(dbConfig);\r\n    await pool.request()\r\n      .input(\"VisitorId\", sql.Int, req.params.id)\r\n      .query(\"UPDATE Visitors SET Status='Rejected' WHERE VisitorId=@VisitorId\");\r\n\r\n    res.json({ message: \"Visitor rejected.\" });\r\n  } catch (err) {\r\n    console.error(\"❌ REJECT visitor error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   GET pending visitors (Admin only)\r\n=============================== */\r\nrouter.get(\"/pending\", verifyToken, async (req, res) => {\r\n  try {\r\n    if (req.user.role !== \"Admin\") return res.status(403).json({ error: \"Forbidden\" });\r\n\r\n    const pool = await sql.connect(dbConfig);\r\n    const result = await pool.request()\r\n      .query(\"SELECT * FROM Visitors WHERE Status='Pending' ORDER BY Date DESC\");\r\n\r\n    res.json(result.recordset);\r\n  } catch (err) {\r\n    console.error(\"❌ GET /visitors/pending error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   Visitor Check-In (Security/Admin)\r\n=============================== */\r\nrouter.post(\"/checkin\", authenticateJWT, authorizeRole([\"security\",\"admin\"]), async (req,res)=>{\r\n  const { code } = req.body;\r\n  if (!code) return res.status(400).json({ error: \"Missing code\" });\r\n\r\n  try {\r\n    const pool = await getPool();\r\n    await pool.request()\r\n      .input(\"code\", sql.NVarChar(50), code)\r\n      .query(\"UPDATE visitor_passes SET status='checked-in', checkInTime=GETDATE() WHERE passCode=@code\");\r\n\r\n    res.json({ message: `Visitor ${code} checked in` });\r\n  } catch(err) {\r\n    console.error(err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   Visitor Check-Out (Security/Admin)\r\n=============================== */\r\nrouter.post(\"/checkout\", authenticateJWT, authorizeRole([\"security\",\"admin\"]), async (req,res)=>{\r\n  const { code } = req.body;\r\n  if (!code) return res.status(400).json({ error: \"Missing code\" });\r\n\r\n  try {\r\n    const pool = await getPool();\r\n    await pool.request()\r\n      .input(\"code\", sql.NVarChar(50), code)\r\n      .query(\"UPDATE visitor_passes SET status='checked-out', checkOutTime=GETDATE() WHERE passCode=@code\");\r\n\r\n    res.json({ message: `Visitor ${code} checked out` });\r\n  } catch(err) {\r\n    console.error(err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   L2 Pending Approvals (Security/Admin)\r\n   Full route: /api/visitors/l2/pending\r\n=============================== */\r\nrouter.get(\"/l2/pending\", authenticateJWT, authorizeRole([\"admin\",\"security\"]), async (req,res)=>{\r\n  try {\r\n    const pool = await getPool();\r\n    const result = await pool.request()\r\n      .query(\"SELECT * FROM visitor_passes WHERE l2Approved IS NULL\");\r\n    res.json(result.recordset);\r\n  } catch(err){\r\n    console.error(\"❌ GET /visitors/l2/pending error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\n/* ===============================\r\n   L2 Approve / Reject (Security/Admin)\r\n=============================== */\r\nrouter.post(\"/approve-l2\", authenticateJWT, authorizeRole([\"admin\",\"security\"]), async (req,res)=>{\r\n  const { code, approve } = req.body;\r\n  if (!code || typeof approve !== \"boolean\") return res.status(400).json({ error: \"Missing code or approve status\" });\r\n\r\n  try {\r\n    const pool = await getPool();\r\n    await pool.request()\r\n      .input(\"code\", sql.NVarChar(50), code)\r\n      .input(\"approve\", sql.Bit, approve)\r\n      .query(\"UPDATE visitor_passes SET l2Approved=@approve WHERE passCode=@code\");\r\n\r\n    res.json({ message: `Visitor ${code} L2 approval set to ${approve}` });\r\n  } catch(err){\r\n    console.error(\"❌ POST /visitors/approve-l2 error:\", err);\r\n    res.status(500).json({ error: \"Server error\" });\r\n  }\r\n});\r\n\r\nexport default router;\r\n"
        }
    ]
}