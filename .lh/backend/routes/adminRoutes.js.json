{
    "sourceFile": "backend/routes/adminRoutes.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763783827213,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763783827213,
            "name": "Commit-0",
            "content": "import { Router } from 'express';\nimport sql from 'mssql';\nimport { dbPool } from '../server.js'; // Import the established pool connection\nimport { authenticateJWT } from '../middleware/authMiddleware.js'; // Assuming you have an auth middleware\n\nconst router = Router();\n\n// Apply token verification to all admin routes\nrouter.use(authenticateJWT);\n\n// ---\n/**\n * @route GET /api/admin/summary\n * @description Fetches the main dashboard summary counts.\n * FIX: Used dbo.accesslogs and dbo.Residents to resolve \"Invalid object name\" errors.\n */\nrouter.get('/summary', async (req, res) => {\n    try {\n        const pool = await dbPool;\n\n        // 1. Total Residents\n        // FIX: Corrected SQL syntax by comparing Status to the integer 1 (for active)\n        const residentsResult = await pool.request()\n            .query(\"SELECT COUNT(*) AS total FROM dbo.Residents WHERE Status = 'Active'\");\n        const totalResidents = residentsResult.recordset[0].total;\n\n        // 2. Pending Payments (Assuming Status column exists in dbo.Payments)\n        const paymentsResult = await pool.request()\n            .query(\"SELECT COUNT(*) AS pending FROM dbo.Payments WHERE Status = 'pending'\");\n        const pendingPayments = paymentsResult.recordset[0].pending;\n\n        // 3. Gate Overrides Today (Assuming Overrides are logged in dbo.accesslogs with Type='Override')\n        const overridesResult = await pool.request()\n            .query(`\n                SELECT COUNT(*) AS overrides\n                FROM dbo.accesslogs\n                WHERE LogType = 'Override' \n                AND TimestampUtc >= CAST(GETDATE() AS DATE)\n            `);\n        const overrideCount = overridesResult.recordset[0].overrides;\n\n        // 4. Compliance Percentage (Simple calculation: (Total Residents - Pending Payments) / Total Residents * 100)\n        let compliancePct = 0;\n        if (totalResidents > 0) {\n            compliancePct = Math.round(((totalResidents - pendingPayments) / totalResidents) * 100);\n        }\n\n        res.json({\n            residents: totalResidents,\n            pendingPayments: pendingPayments,\n            compliance: compliancePct,\n            overrides: overrideCount\n        });\n\n    } catch (error) {\n        // Log the detailed error on the server\n        console.error(\"Summary API Error (500):\", error.message || error);\n        res.status(500).json({ message: \"Server error\" });\n    }\n});\n\n// ---\n\n/**\n * @route GET /api/admin/accesschart\n * @description Fetches 14 days of access attempt data for the chart.\n * FIX: Used dbo.accesslogs to resolve \"Invalid object name\" errors.\n */\nrouter.get('/accesschart', async (req, res) => {\n    try {\n        const pool = await dbPool;\n\n        // SQL query to count access attempts (including successful and denied) by date for the last 14 days\n        const chartResult = await pool.request().query(`\n            SELECT\n                CAST(TimestampUtc AS DATE) AS LogDate,\n                COUNT(*) AS AccessCount\n            FROM dbo.accesslogs\n            WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n            GROUP BY CAST(TimestampUtc AS DATE)\n            ORDER BY LogDate;\n        `);\n\n        // Prepare data for Chart.js (filling in zero for days with no logs)\n        const days = [];\n        const counts = [];\n        const dataMap = new Map();\n\n        // Map results for quick lookup\n        chartResult.recordset.forEach(row => {\n            // ISO Date format: YYYY-MM-DD\n            dataMap.set(row.LogDate.toISOString().substring(0, 10), row.AccessCount);\n        });\n\n        // Generate the last 14 days and populate counts\n        for (let i = 13; i >= 0; i--) {\n            const date = new Date();\n            date.setDate(date.getDate() - i);\n            const dateString = date.toISOString().substring(0, 10);\n            \n            days.push(dateString);\n            counts.push(dataMap.get(dateString) || 0);\n        }\n\n        res.json({ days, counts });\n\n    } catch (error) {\n        // Log the detailed error on the server\n        console.error(\"Access Chart API Error (500):\", error.message || error);\n        res.status(500).json({ message: \"Server error\" });\n    }\n});\n\nexport default router;"
        }
    ]
}