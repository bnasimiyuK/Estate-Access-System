{
    "sourceFile": "backend/controllers/residentsController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 11,
            "patches": [
                {
                    "date": 1763641226781,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763697101451,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,15 +1,12 @@\n-// residentsController.js\n+// backend/controllers/residentsController.js\n \n-// ============================================================\n-// IMPORTS\n-// ============================================================\n import sql from \"mssql\";\n import { dbPool } from \"../server.js\";\n \n-// ============================================================\n-// DASHBOARD SUMMARY (ADMIN)\n-// ============================================================\n+/* ===========================================================\n+   DASHBOARD SUMMARY (Admin)\n+=========================================================== */\n export const getDashboardSummary = async (req, res) => {\n     const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n     const OVERRIDES_TABLE = \"[EstateAccessManagementSystem].[dbo].[gate_overrides]\";\n \n@@ -71,11 +68,11 @@\n         res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// ACCESS CHART (ADMIN)\n-// ============================================================\n+/* ===========================================================\n+   ACCESS CHART DATA (Admin)\n+=========================================================== */\n export const getAccessChartData = async (req, res) => {\n     const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n \n     try {\n@@ -100,18 +97,17 @@\n         res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// RESIDENT PROFILE\n-// ============================================================\n+/* ===========================================================\n+   RESIDENT PROFILE\n+=========================================================== */\n export const getResidentProfile = async (req, res) => {\n     try {\n         const residentId = req.user?.ResidentID;\n         if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n \n         const pool = await dbPool;\n-\n         const result = await pool.request()\n             .input(\"ResidentID\", sql.Int, residentId)\n             .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n \n@@ -123,11 +119,11 @@\n         res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// ALL RESIDENTS (ADMIN)\n-// ============================================================\n+/* ===========================================================\n+   ALL RESIDENTS (Admin)\n+=========================================================== */\n export const getAllResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const result = await pool.request().query(\"SELECT * FROM Residents ORDER BY ResidentName ASC\");\n@@ -136,11 +132,11 @@\n         res.status(500).json({ error: \"Failed to load residents\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// VISITOR ACCESS\n-// ============================================================\n+/* ===========================================================\n+   VISITOR ACCESS\n+=========================================================== */\n export const getVisitorsAccess = async (req, res) => {\n     try {\n         const residentId = req.user?.ResidentID;\n         if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n@@ -156,11 +152,11 @@\n         res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// VISITOR PASSES\n-// ============================================================\n+/* ===========================================================\n+   VISITOR PASSES\n+=========================================================== */\n export const getVisitorPasses = async (req, res) => {\n     const residentID = req.user?.ResidentID;\n     if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n \n@@ -181,45 +177,36 @@\n         res.status(500).json({ error: \"Failed to retrieve visitor passes\" });\n     }\n };\n \n-// ============================================================\n-// MEMBERSHIP REQUESTS (MODIFIED for Admin/Resident split)\n-// ============================================================\n+/* ===========================================================\n+   MEMBERSHIP REQUESTS\n+=========================================================== */\n export const getMembershipRequests = async (req, res) => {\n     const residentNationalID = req.user?.NationalID;\n-    const residentRole = req.user?.RoleName; // Assuming RoleName is passed in the token\n-    \n-    // Determine if the user is an Admin (or similar high-privilege role)\n-    // IMPORTANT: Adjust this check if your admin role is named differently or if you use a dedicated isAdmin flag.\n-    const isAdmin = residentRole && residentRole.toLowerCase() === 'admin';\n-    \n+    const role = req.user?.role;\n+\n     try {\n         const pool = await dbPool;\n+        let request = pool.request();\n         let query;\n-        let request = pool.request();\n \n-        if (isAdmin) {\n-            // Admin: Fetch all membership requests\n+        if (role === 'admin') {\n             query = `\n-                SELECT \n-                    RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n+                SELECT RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n                 FROM MembershipRequests \n                 ORDER BY RequestedAt DESC\n             `;\n         } else if (residentNationalID) {\n-            // Resident: Fetch only their own requests\n             request = request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n             query = `\n-                SELECT \n-                    RequestID, ResidentName, Status, RequestedAt \n+                SELECT RequestID, ResidentName, Status, RequestedAt \n                 FROM MembershipRequests \n                 WHERE NationalID = @NationalID \n                 ORDER BY RequestedAt DESC\n             `;\n         } else {\n-            // Unauthorized or invalid token for non-admin\n-             return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n+            return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n         }\n \n         const result = await request.query(query);\n         res.status(200).json(result.recordset);\n@@ -229,11 +216,11 @@\n         res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// ADMIN ACTION: APPROVE RESIDENT\n-// ============================================================\n+/* ===========================================================\n+   APPROVE / REJECT / SYNC RESIDENTS (Admin)\n+=========================================================== */\n export const approveResidentController = async (req, res) => {\n     const { requestID } = req.body;\n     if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n \n@@ -242,40 +229,32 @@\n         const tx = new sql.Transaction(pool);\n         await tx.begin();\n \n         try {\n-            // 1. Update MembershipRequest status to 'Approved'\n-            const updateRequestResult = await tx.request()\n+            const updateRequest = await tx.request()\n                 .input(\"RequestID\", sql.Int, requestID)\n                 .input(\"StatusApproved\", sql.NVarChar, 'Approved')\n                 .query(\"UPDATE MembershipRequests SET Status = @StatusApproved WHERE RequestID = @RequestID AND Status <> 'Synced'\");\n \n-            if (updateRequestResult.rowsAffected[0] === 0) {\n-                 await tx.rollback();\n-                 return res.status(404).json({ error: \"Request not found or already processed.\" });\n+            if (updateRequest.rowsAffected[0] === 0) {\n+                await tx.rollback();\n+                return res.status(404).json({ error: \"Request not found or already processed.\" });\n             }\n \n-            // 2. Insert the resident into the Residents table (sync logic)\n             const requestDataResult = await tx.request()\n                 .input(\"RequestID\", sql.Int, requestID)\n                 .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n             \n             const r = requestDataResult.recordset[0];\n-            if (!r) {\n-                await tx.rollback();\n-                return res.status(404).json({ error: \"Original request data not found.\" });\n-            }\n-            \n-            // Check if the resident already exists in the Residents table (optional, for safety)\n+            if (!r) { await tx.rollback(); return res.status(404).json({ error: \"Request data not found.\" }); }\n+\n             const existingResidentCheck = await tx.request()\n                 .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                 .query(\"SELECT ResidentID FROM Residents WHERE NationalID = @NationalID\");\n-            \n+\n             let newResidentID;\n-            \n             if (existingResidentCheck.recordset.length === 0) {\n-                 // Insert new resident\n-                 const insertResult = await tx.request()\n+                const insertResult = await tx.request()\n                     .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n                     .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                     .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n                     .input(\"Email\", sql.NVarChar, r.Email)\n@@ -289,40 +268,31 @@\n                         (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n                         OUTPUT INSERTED.ResidentID\n                         VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n                     `);\n-                    newResidentID = insertResult.recordset[0].ResidentID;\n+                newResidentID = insertResult.recordset[0].ResidentID;\n             } else {\n-                 // Resident already exists, use existing ID and update request status to synced\n-                 newResidentID = existingResidentCheck.recordset[0].ResidentID;\n+                newResidentID = existingResidentCheck.recordset[0].ResidentID;\n             }\n \n-            // 3. Update the Request with the new ResidentID (RecordID) and set status to Synced\n             await tx.request()\n                 .input(\"RecordID\", sql.Int, newResidentID)\n                 .input(\"RequestID\", sql.Int, requestID)\n                 .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n                 .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n \n-\n             await tx.commit();\n             res.status(200).json({ message: \"Resident approved and synced successfully.\", residentID: newResidentID });\n-\n         } catch (err) {\n             await tx.rollback();\n             throw err;\n         }\n-\n     } catch (err) {\n         console.error(\"Approve resident error:\", err);\n         res.status(500).json({ error: \"Failed to approve resident\", details: err.message });\n     }\n };\n \n-\n-// ============================================================\n-// ADMIN ACTION: REJECT RESIDENT\n-// ============================================================\n export const rejectResidentController = async (req, res) => {\n     const { requestID, reason } = req.body;\n     if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n \n@@ -333,40 +303,36 @@\n             .input(\"StatusRejected\", sql.NVarChar(50), 'Rejected')\n             .input(\"Reason\", sql.NVarChar(255), reason || 'Rejected by administrator.')\n             .query(\"UPDATE MembershipRequests SET Status = @StatusRejected, AdminNotes = @Reason WHERE RequestID = @RequestID AND Status = 'Pending'\");\n \n-        if (result.rowsAffected[0] === 0) {\n-            return res.status(404).json({ error: \"Request not found or already processed.\" });\n-        }\n+        if (result.rowsAffected[0] === 0) return res.status(404).json({ error: \"Request not found or already processed.\" });\n \n         res.status(200).json({ message: `Membership request ${requestID} rejected.` });\n-\n     } catch (err) {\n         console.error(\"Reject resident error:\", err);\n         res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n     }\n };\n \n-\n-// ============================================================\n-// APPROVED RESIDENTS\n-// ============================================================\n+/* ===========================================================\n+   APPROVED RESIDENTS LIST\n+=========================================================== */\n export const getApprovedResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const result = await pool.request()\n-            .input(\"StatusApproved\", sql.NVarChar(50), 'Active') // Fetches 'Active' status from Residents table\n+            .input(\"StatusApproved\", sql.NVarChar(50), 'Active')\n             .query(\"SELECT * FROM Residents WHERE Status = @StatusApproved ORDER BY ResidentName ASC\");\n         res.status(200).json(result.recordset);\n     } catch (err) {\n         console.error(err);\n         res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n     }\n };\n \n-// ============================================================\n-// PAYMENT STATUS\n-// ============================================================\n+/* ===========================================================\n+   PAYMENT STATUS\n+=========================================================== */\n export const getPaymentStatusController = async (req, res) => {\n     const phone = req.query.phone;\n     if (!phone) return res.status(400).json({ error: \"Phone required\" });\n \n@@ -393,17 +359,13 @@\n         res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n     }\n };\n \n-// Alias for backward compatibility\n export const loadPaymentStatus = getPaymentStatusController;\n \n-// ============================================================\n-// PAY FOR SERVICE\n-// ============================================================\n-// ------------------------------------------------------------------\n-// PAY FOR SERVICE (records in Payments + PaymentHistory)\n-// ------------------------------------------------------------------\n+/* ===========================================================\n+   PAY FOR SERVICE\n+=========================================================== */\n export const payForService = async (req, res) => {\n     try {\n         const { phone, serviceName, amount } = req.body;\n         const nationalID = req.user.NationalID;\n@@ -416,9 +378,8 @@\n             return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n \n         const pool = await dbPool;\n \n-        // 1️⃣ Insert into Payments\n         const result = await pool.request()\n             .input(\"PhoneNumber\", sql.VarChar(20), phone)\n             .input(\"NationalID\", sql.VarChar(50), nationalID)\n             .input(\"ResidentID\", sql.Int, residentID)\n@@ -427,22 +388,21 @@\n             .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n             .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n             .query(`\n                 INSERT INTO Payments\n-                    (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n+                (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n                 OUTPUT INSERTED.*\n                 VALUES\n-                    (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n+                (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n             `);\n \n-        // 2️⃣ Insert into PaymentHistory with additional columns\n         await pool.request()\n             .input(\"ResidentID\", sql.Int, residentID)\n             .input(\"Amount\", sql.Decimal(18, 2), amount)\n             .input(\"NationalID\", sql.VarChar(50), nationalID)\n             .input(\"ServiceName\", sql.NVarChar(100), serviceName || null)\n             .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .input(\"VerifiedDate\", sql.DateTime, null) // initially null\n+            .input(\"VerifiedDate\", sql.DateTime, null)\n             .input(\"Reference\", sql.VarChar(100), serviceName || null)\n             .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n             .query(`\n                 INSERT INTO PaymentHistory \n@@ -450,9 +410,8 @@\n                 VALUES \n                 (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n             `);\n \n-\n         res.status(201).json({\n             message: \"Payment initialized and history recorded\",\n             payment: result.recordset[0],\n         });\n@@ -464,12 +423,13 @@\n         });\n     }\n };\n \n+export const payController = payForService;\n \n-// ============================================================\n-// SYNC RESIDENTS (Utility function, kept for reference but logic moved to approveResidentController)\n-// ============================================================\n+/* ===========================================================\n+   SYNC RESIDENTS\n+=========================================================== */\n export const syncResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const tx = new sql.Transaction(pool);\n@@ -528,5 +488,4 @@\n         console.error(err);\n         res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n     }\n };\n-export const payController = payForService;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763844144425,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -311,9 +311,20 @@\n         console.error(\"Reject resident error:\", err);\n         res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n     }\n };\n-\n+export const getResidentIDs = async (req, res) => {\n+  try {\n+    const pool = await dbPool;\n+    const result = await pool.request().query(`\n+      SELECT TOP 100 ResidentID, ResidentName FROM Residents ORDER BY ResidentName\n+    `);\n+    res.json(result.recordset);\n+  } catch (err) {\n+    console.error(\"Error fetching resident IDs:\", err);\n+    res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n+  }\n+};\n /* ===========================================================\n    APPROVED RESIDENTS LIST\n =========================================================== */\n export const getApprovedResidents = async (req, res) => {\n"
                },
                {
                    "date": 1763845300703,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,502 +1,53 @@\n-// backend/controllers/residentsController.js\n-\n+import { dbPool } from \"../server.js\";\n import sql from \"mssql\";\n-import { dbPool } from \"../server.js\";\n \n-/* ===========================================================\n-   DASHBOARD SUMMARY (Admin)\n-=========================================================== */\n-export const getDashboardSummary = async (req, res) => {\n-    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n-    const OVERRIDES_TABLE = \"[EstateAccessManagementSystem].[dbo].[gate_overrides]\";\n-\n-    try {\n-        const pool = await dbPool;\n-\n-        const totalResidentsResult = await pool.request().query(\n-            \"SELECT COUNT(ResidentID) AS residents FROM Residents\"\n-        );\n-        const residents = totalResidentsResult.recordset[0]?.residents || 0;\n-\n-        const pendingPaymentsResult = await pool\n-            .request()\n-            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n-            .query(\"SELECT COUNT(PaymentID) AS pendingPayments FROM Payments WHERE Status = @StatusPending\");\n-        const pendingPayments = pendingPaymentsResult.recordset[0]?.pendingPayments || 0;\n-\n-        const paidResidentsCountResult = await pool\n-            .request()\n-            .input(\"StatusVerified\", sql.NVarChar(50), 'Verified')\n-            .query(\"SELECT COUNT(DISTINCT ResidentID) AS paidResidents FROM Payments WHERE Status = @StatusVerified\");\n-        const paidResidents = paidResidentsCountResult.recordset[0]?.paidResidents || 0;\n-\n-        const compliance = residents > 0 ? Math.round((parseFloat(paidResidents) / residents) * 100) : 0;\n-\n-        const overrideMetricsResult = await pool.request().query(`\n-            SELECT COUNT(id) AS overrideCount\n-            FROM ${OVERRIDES_TABLE}\n-            WHERE CAST(createdAt AS DATE) = CAST(GETDATE() AS DATE);\n-        `);\n-        const overrideCount = overrideMetricsResult.recordset[0]?.overrideCount || 0;\n-\n-        const accessMetricsResult = await pool.request().query(`\n-            SELECT \n-                SUM(CASE WHEN [Action] = 'CheckIn' THEN 1 ELSE 0 END) AS visitorscheckedin,\n-                SUM(CASE WHEN [Action] = 'CheckOut' THEN 1 ELSE 0 END) AS visitorscheckedout,\n-                SUM(CASE WHEN [Action] = 'Access Denied' THEN 1 ELSE 0 END) AS rejects \n-            FROM ${ACCESS_LOGS_TABLE}\n-            WHERE CAST(TimestampUtc AS DATE) = CAST(GETDATE() AS DATE);\n-        `);\n-        const accessData = accessMetricsResult.recordset[0] || {\n-            visitorscheckedin: 0,\n-            visitorscheckedout: 0,\n-            rejects: 0,\n-        };\n-\n-        res.status(200).json({\n-            residents,\n-            pendingPayments,\n-            compliance,\n-            overrideCount,\n-            visitorscheckedin: accessData.visitorscheckedin,\n-            visitorscheckedout: accessData.visitorscheckedout,\n-            rejects: accessData.rejects,\n-        });\n-\n-    } catch (err) {\n-        console.error(\"Dashboard summary error:\", err.stack);\n-        res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n-    }\n-};\n-\n-/* ===========================================================\n-   ACCESS CHART DATA (Admin)\n-=========================================================== */\n-export const getAccessChartData = async (req, res) => {\n-    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n-\n-    try {\n-        const pool = await dbPool;\n-\n-        const result = await pool.request().query(`\n-            SELECT \n-                FORMAT(TimestampUtc, 'MM/dd') AS DayLabel,\n-                COUNT(*) AS AccessCount\n-            FROM ${ACCESS_LOGS_TABLE}\n-            WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n-            GROUP BY FORMAT(TimestampUtc, 'MM/dd')\n-            ORDER BY MIN(TimestampUtc) ASC;\n-        `);\n-\n-        res.status(200).json({\n-            days: result.recordset.map(r => r.DayLabel),\n-            counts: result.recordset.map(r => r.AccessCount),\n-        });\n-    } catch (err) {\n-        console.error(\"Access chart error:\", err.stack);\n-        res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n-    }\n-};\n-\n-/* ===========================================================\n-   RESIDENT PROFILE\n-=========================================================== */\n-export const getResidentProfile = async (req, res) => {\n-    try {\n-        const residentId = req.user?.ResidentID;\n-        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n-\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input(\"ResidentID\", sql.Int, residentId)\n-            .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n-\n-        if (!result.recordset.length) return res.status(404).json({ error: \"Resident not found\" });\n-\n-        res.status(200).json(result.recordset[0]);\n-    } catch (err) {\n-        console.error(\"Resident profile error:\", err);\n-        res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n-    }\n-};\n-\n-/* ===========================================================\n-   ALL RESIDENTS (Admin)\n-=========================================================== */\n-export const getAllResidents = async (req, res) => {\n-    try {\n-        const pool = await dbPool;\n-        const result = await pool.request().query(\"SELECT * FROM Residents ORDER BY ResidentName ASC\");\n-        res.status(200).json(result.recordset);\n-    } catch (err) {\n-        res.status(500).json({ error: \"Failed to load residents\", details: err.message });\n-    }\n-};\n-\n-/* ===========================================================\n-   VISITOR ACCESS\n-=========================================================== */\n-export const getVisitorsAccess = async (req, res) => {\n-    try {\n-        const residentId = req.user?.ResidentID;\n-        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n-\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input(\"ResidentID\", sql.Int, residentId)\n-            .query(\"SELECT TOP 50 * FROM Visitors WHERE ResidentID = @ResidentID ORDER BY VisitDate DESC\");\n-\n-        res.status(200).json({ visitors: result.recordset });\n-    } catch (err) {\n-        console.error(\"Failed to load visitor access\", err);\n-        res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n-    }\n-};\n-\n-/* ===========================================================\n-   VISITOR PASSES\n-=========================================================== */\n-export const getVisitorPasses = async (req, res) => {\n-    const residentID = req.user?.ResidentID;\n-    if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n-\n-    try {\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input('ResidentID', sql.Int, residentID)\n-            .query(`\n-                SELECT VisitorName, AccessCode, Status \n-                FROM VisitorsAccess\n-                WHERE ResidentID = @ResidentID\n-                ORDER BY CreatedAt DESC\n-            `);\n-\n-        res.status(200).json(result.recordset || []);\n-    } catch (err) {\n-        console.error(\"Error retrieving visitor passes:\", err);\n-        res.status(500).json({ error: \"Failed to retrieve visitor passes\" });\n-    }\n-};\n-\n-/* ===========================================================\n-   MEMBERSHIP REQUESTS\n-=========================================================== */\n-export const getMembershipRequests = async (req, res) => {\n-    const residentNationalID = req.user?.NationalID;\n-    const role = req.user?.role;\n-\n-    try {\n-        const pool = await dbPool;\n-        let request = pool.request();\n-        let query;\n-\n-        if (role === 'admin') {\n-            query = `\n-                SELECT RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n-                FROM MembershipRequests \n-                ORDER BY RequestedAt DESC\n-            `;\n-        } else if (residentNationalID) {\n-            request = request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n-            query = `\n-                SELECT RequestID, ResidentName, Status, RequestedAt \n-                FROM MembershipRequests \n-                WHERE NationalID = @NationalID \n-                ORDER BY RequestedAt DESC\n-            `;\n-        } else {\n-            return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n-        }\n-\n-        const result = await request.query(query);\n-        res.status(200).json(result.recordset);\n-\n-    } catch (err) {\n-        console.error(\"Failed to load membership requests:\", err);\n-        res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n-    }\n-};\n-\n-/* ===========================================================\n-   APPROVE / REJECT / SYNC RESIDENTS (Admin)\n-=========================================================== */\n-export const approveResidentController = async (req, res) => {\n-    const { requestID } = req.body;\n-    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n-\n-    try {\n-        const pool = await dbPool;\n-        const tx = new sql.Transaction(pool);\n-        await tx.begin();\n-\n-        try {\n-            const updateRequest = await tx.request()\n-                .input(\"RequestID\", sql.Int, requestID)\n-                .input(\"StatusApproved\", sql.NVarChar, 'Approved')\n-                .query(\"UPDATE MembershipRequests SET Status = @StatusApproved WHERE RequestID = @RequestID AND Status <> 'Synced'\");\n-\n-            if (updateRequest.rowsAffected[0] === 0) {\n-                await tx.rollback();\n-                return res.status(404).json({ error: \"Request not found or already processed.\" });\n-            }\n-\n-            const requestDataResult = await tx.request()\n-                .input(\"RequestID\", sql.Int, requestID)\n-                .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n-            \n-            const r = requestDataResult.recordset[0];\n-            if (!r) { await tx.rollback(); return res.status(404).json({ error: \"Request data not found.\" }); }\n-\n-            const existingResidentCheck = await tx.request()\n-                .input(\"NationalID\", sql.NVarChar, r.NationalID)\n-                .query(\"SELECT ResidentID FROM Residents WHERE NationalID = @NationalID\");\n-\n-            let newResidentID;\n-            if (existingResidentCheck.recordset.length === 0) {\n-                const insertResult = await tx.request()\n-                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n-                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n-                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n-                    .input(\"Email\", sql.NVarChar, r.Email)\n-                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n-                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n-                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n-                    .input(\"DateJoined\", sql.DateTime, new Date())\n-                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n-                    .query(`\n-                        INSERT INTO Residents\n-                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n-                        OUTPUT INSERTED.ResidentID\n-                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n-                    `);\n-                newResidentID = insertResult.recordset[0].ResidentID;\n-            } else {\n-                newResidentID = existingResidentCheck.recordset[0].ResidentID;\n-            }\n-\n-            await tx.request()\n-                .input(\"RecordID\", sql.Int, newResidentID)\n-                .input(\"RequestID\", sql.Int, requestID)\n-                .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n-                .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n-\n-            await tx.commit();\n-            res.status(200).json({ message: \"Resident approved and synced successfully.\", residentID: newResidentID });\n-        } catch (err) {\n-            await tx.rollback();\n-            throw err;\n-        }\n-    } catch (err) {\n-        console.error(\"Approve resident error:\", err);\n-        res.status(500).json({ error: \"Failed to approve resident\", details: err.message });\n-    }\n-};\n-\n-export const rejectResidentController = async (req, res) => {\n-    const { requestID, reason } = req.body;\n-    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n-\n-    try {\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input(\"RequestID\", sql.Int, requestID)\n-            .input(\"StatusRejected\", sql.NVarChar(50), 'Rejected')\n-            .input(\"Reason\", sql.NVarChar(255), reason || 'Rejected by administrator.')\n-            .query(\"UPDATE MembershipRequests SET Status = @StatusRejected, AdminNotes = @Reason WHERE RequestID = @RequestID AND Status = 'Pending'\");\n-\n-        if (result.rowsAffected[0] === 0) return res.status(404).json({ error: \"Request not found or already processed.\" });\n-\n-        res.status(200).json({ message: `Membership request ${requestID} rejected.` });\n-    } catch (err) {\n-        console.error(\"Reject resident error:\", err);\n-        res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n-    }\n-};\n-export const getResidentIDs = async (req, res) => {\n+// Get all resident IDs and names (for dropdown)\n+export async function getResidentIDs(req, res) {\n   try {\n     const pool = await dbPool;\n     const result = await pool.request().query(`\n-      SELECT TOP 100 ResidentID, ResidentName FROM Residents ORDER BY ResidentName\n+      SELECT ResidentID, ResidentName FROM Residents ORDER BY ResidentName\n     `);\n     res.json(result.recordset);\n   } catch (err) {\n     console.error(\"Error fetching resident IDs:\", err);\n-    res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n+    res.status(500).json({ message: \"Error fetching resident IDs\" });\n   }\n-};\n-/* ===========================================================\n-   APPROVED RESIDENTS LIST\n-=========================================================== */\n-export const getApprovedResidents = async (req, res) => {\n-    try {\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input(\"StatusApproved\", sql.NVarChar(50), 'Active')\n-            .query(\"SELECT * FROM Residents WHERE Status = @StatusApproved ORDER BY ResidentName ASC\");\n-        res.status(200).json(result.recordset);\n-    } catch (err) {\n-        console.error(err);\n-        res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n-    }\n-};\n+}\n \n-/* ===========================================================\n-   PAYMENT STATUS\n-=========================================================== */\n-export const getPaymentStatusController = async (req, res) => {\n-    const phone = req.query.phone;\n-    if (!phone) return res.status(400).json({ error: \"Phone required\" });\n+// Fetch all payments\n+export async function getAllPayments(req, res) {\n+  try {\n+    const pool = await dbPool;\n+    const result = await pool.request().query(`\n+      SELECT p.PaymentID, p.ResidentID, p.Amount, p.PaymentDate, p.Status,\n+             p.Reference, p.PaymentMethod, p.PhoneNumber, p.VerifiedDate\n+      FROM Payments p\n+      ORDER BY p.PaymentDate DESC\n+    `);\n+    res.json(result.recordset);\n+  } catch (err) {\n+    console.error(\"Error fetching payments:\", err);\n+    res.status(500).json({ message: \"Error fetching payments\" });\n+  }\n+}\n \n-    try {\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .query(\"SELECT TOP 1 * FROM Payments WHERE PhoneNumber = @PhoneNumber ORDER BY PaymentID DESC\");\n-\n-        if (!result.recordset.length) return res.status(200).json({ isPaid: false, status: \"No Record Found\", phone });\n-\n-        const p = result.recordset[0];\n-        const isPaid = [\"paid\", \"verified\"].includes(p.Status?.toLowerCase());\n-\n-        res.status(200).json({\n-            phone: p.PhoneNumber,\n-            status: p.Status,\n-            amount: p.Amount,\n-            paymentDate: p.PaymentDate,\n-            isPaid,\n-        });\n-    } catch (err) {\n-        console.error(err);\n-        res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n-    }\n-};\n-\n-export const loadPaymentStatus = getPaymentStatusController;\n-\n-/* ===========================================================\n-   PAY FOR SERVICE\n-=========================================================== */\n-export const payForService = async (req, res) => {\n-    try {\n-        const { phone, serviceName, amount } = req.body;\n-        const nationalID = req.user.NationalID;\n-        const residentID = req.user.ResidentID;\n-\n-        if (!nationalID || !residentID)\n-            return res.status(401).json({ error: \"Missing resident data in token\" });\n-\n-        if (!phone || !serviceName || !amount)\n-            return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n-\n-        const pool = await dbPool;\n-\n-        const result = await pool.request()\n-            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .input(\"NationalID\", sql.VarChar(50), nationalID)\n-            .input(\"ResidentID\", sql.Int, residentID)\n-            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n-            .input(\"Amount\", sql.Decimal(18, 2), amount)\n-            .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n-            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n-            .query(`\n-                INSERT INTO Payments\n-                (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n-                OUTPUT INSERTED.*\n-                VALUES\n-                (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n-            `);\n-\n-        await pool.request()\n-            .input(\"ResidentID\", sql.Int, residentID)\n-            .input(\"Amount\", sql.Decimal(18, 2), amount)\n-            .input(\"NationalID\", sql.VarChar(50), nationalID)\n-            .input(\"ServiceName\", sql.NVarChar(100), serviceName || null)\n-            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .input(\"VerifiedDate\", sql.DateTime, null)\n-            .input(\"Reference\", sql.VarChar(100), serviceName || null)\n-            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n-            .query(`\n-                INSERT INTO PaymentHistory \n-                (ResidentID, Amount, NationalID, ServiceName, PhoneNumber, VerifiedDate, Status, PaymentDate, Reference)\n-                VALUES \n-                (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n-            `);\n-\n-        res.status(201).json({\n-            message: \"Payment initialized and history recorded\",\n-            payment: result.recordset[0],\n-        });\n-\n-    } catch (err) {\n-        res.status(500).json({\n-            error: \"Payment failed\",\n-            details: err.message,\n-        });\n-    }\n-};\n-\n-export const payController = payForService;\n-\n-/* ===========================================================\n-   SYNC RESIDENTS\n-=========================================================== */\n-export const syncResidents = async (req, res) => {\n-    try {\n-        const pool = await dbPool;\n-        const tx = new sql.Transaction(pool);\n-        await tx.begin();\n-\n-        try {\n-            const pendingRequestsResult = await tx.request()\n-                .input(\"StatusApproved\", sql.NVarChar(50), 'Approved')\n-                .query(\"SELECT * FROM MembershipRequests WHERE Status = @StatusApproved AND RecordID IS NULL\");\n-\n-            const pending = pendingRequestsResult.recordset;\n-            if (!pending.length) {\n-                await tx.commit();\n-                return res.status(200).json({ message: \"No new residents to sync.\" });\n-            }\n-\n-            let synced = 0;\n-            for (const r of pending) {\n-                const insertResult = await tx.request()\n-                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n-                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n-                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n-                    .input(\"Email\", sql.NVarChar, r.Email)\n-                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n-                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n-                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n-                    .input(\"DateJoined\", sql.DateTime, new Date())\n-                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n-                    .query(`\n-                        INSERT INTO Residents\n-                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n-                        OUTPUT INSERTED.ResidentID\n-                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n-                    `);\n-\n-                const newResidentID = insertResult.recordset[0].ResidentID;\n-\n-                await tx.request()\n-                    .input(\"RecordID\", sql.Int, newResidentID)\n-                    .input(\"RequestID\", sql.Int, r.RequestID)\n-                    .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n-                    .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n-\n-                synced++;\n-            }\n-\n-            await tx.commit();\n-            res.status(200).json({ message: `Successfully synced ${synced} resident(s).` });\n-\n-        } catch (err) {\n-            await tx.rollback();\n-            throw err;\n-        }\n-\n-    } catch (err) {\n-        console.error(err);\n-        res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n-    }\n-};\n+// Fetch balances\n+export async function getBalances(req, res) {\n+  try {\n+    const pool = await dbPool;\n+    const result = await pool.request().query(`\n+      SELECT r.ResidentID, r.ResidentName,\n+             ISNULL(SUM(p.Amount),0) AS TotalPaid,\n+             ISNULL(r.TotalDue,0) AS TotalDue,\n+             ISNULL(r.TotalDue,0) - ISNULL(SUM(p.Amount),0) AS Balance\n+      FROM Residents r\n+      LEFT JOIN Payments p ON r.ResidentID = p.ResidentID AND p.Status='Verified'\n+      GROUP BY r.ResidentID, r.ResidentName, r.TotalDue\n+    `);\n+    res.json(result.recordset);\n+  } catch (err) {\n+    console.error(\"Error fetching balances:\", err);\n+    res.status(500).json({ message: \"Error fetching balances\" });\n+  }\n+}\n"
                },
                {
                    "date": 1763845612397,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,53 +1,503 @@\n+// backend/controllers/residentsController.js\n+\n+import sql from \"mssql\";\n import { dbPool } from \"../server.js\";\n-import sql from \"mssql\";\n \n-// Get all resident IDs and names (for dropdown)\n-export async function getResidentIDs(req, res) {\n+/* ===========================================================\n+   DASHBOARD SUMMARY (Admin)\n+=========================================================== */\n+export const getDashboardSummary = async (req, res) => {\n+    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n+    const OVERRIDES_TABLE = \"[EstateAccessManagementSystem].[dbo].[gate_overrides]\";\n+\n+    try {\n+        const pool = await dbPool;\n+\n+        const totalResidentsResult = await pool.request().query(\n+            \"SELECT COUNT(ResidentID) AS residents FROM Residents\"\n+        );\n+        const residents = totalResidentsResult.recordset[0]?.residents || 0;\n+\n+        const pendingPaymentsResult = await pool\n+            .request()\n+            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n+            .query(\"SELECT COUNT(PaymentID) AS pendingPayments FROM Payments WHERE Status = @StatusPending\");\n+        const pendingPayments = pendingPaymentsResult.recordset[0]?.pendingPayments || 0;\n+\n+        const paidResidentsCountResult = await pool\n+            .request()\n+            .input(\"StatusVerified\", sql.NVarChar(50), 'Verified')\n+            .query(\"SELECT COUNT(DISTINCT ResidentID) AS paidResidents FROM Payments WHERE Status = @StatusVerified\");\n+        const paidResidents = paidResidentsCountResult.recordset[0]?.paidResidents || 0;\n+\n+        const compliance = residents > 0 ? Math.round((parseFloat(paidResidents) / residents) * 100) : 0;\n+\n+        const overrideMetricsResult = await pool.request().query(`\n+            SELECT COUNT(id) AS overrideCount\n+            FROM ${OVERRIDES_TABLE}\n+            WHERE CAST(createdAt AS DATE) = CAST(GETDATE() AS DATE);\n+        `);\n+        const overrideCount = overrideMetricsResult.recordset[0]?.overrideCount || 0;\n+\n+        const accessMetricsResult = await pool.request().query(`\n+            SELECT \n+                SUM(CASE WHEN [Action] = 'CheckIn' THEN 1 ELSE 0 END) AS visitorscheckedin,\n+                SUM(CASE WHEN [Action] = 'CheckOut' THEN 1 ELSE 0 END) AS visitorscheckedout,\n+                SUM(CASE WHEN [Action] = 'Access Denied' THEN 1 ELSE 0 END) AS rejects \n+            FROM ${ACCESS_LOGS_TABLE}\n+            WHERE CAST(TimestampUtc AS DATE) = CAST(GETDATE() AS DATE);\n+        `);\n+        const accessData = accessMetricsResult.recordset[0] || {\n+            visitorscheckedin: 0,\n+            visitorscheckedout: 0,\n+            rejects: 0,\n+        };\n+\n+        res.status(200).json({\n+            residents,\n+            pendingPayments,\n+            compliance,\n+            overrideCount,\n+            visitorscheckedin: accessData.visitorscheckedin,\n+            visitorscheckedout: accessData.visitorscheckedout,\n+            rejects: accessData.rejects,\n+        });\n+\n+    } catch (err) {\n+        console.error(\"Dashboard summary error:\", err.stack);\n+        res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n+    }\n+};\n+\n+/* ===========================================================\n+   ACCESS CHART DATA (Admin)\n+=========================================================== */\n+export const getAccessChartData = async (req, res) => {\n+    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n+\n+    try {\n+        const pool = await dbPool;\n+\n+        const result = await pool.request().query(`\n+            SELECT \n+                FORMAT(TimestampUtc, 'MM/dd') AS DayLabel,\n+                COUNT(*) AS AccessCount\n+            FROM ${ACCESS_LOGS_TABLE}\n+            WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n+            GROUP BY FORMAT(TimestampUtc, 'MM/dd')\n+            ORDER BY MIN(TimestampUtc) ASC;\n+        `);\n+\n+        res.status(200).json({\n+            days: result.recordset.map(r => r.DayLabel),\n+            counts: result.recordset.map(r => r.AccessCount),\n+        });\n+    } catch (err) {\n+        console.error(\"Access chart error:\", err.stack);\n+        res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n+    }\n+};\n+\n+\n+/* ===========================================================\n+   RESIDENT PROFILE\n+=========================================================== */\n+export const getResidentProfile = async (req, res) => {\n+    try {\n+        const residentId = req.user?.ResidentID;\n+        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n+\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input(\"ResidentID\", sql.Int, residentId)\n+            .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n+\n+        if (!result.recordset.length) return res.status(404).json({ error: \"Resident not found\" });\n+\n+        res.status(200).json(result.recordset[0]);\n+    } catch (err) {\n+        console.error(\"Resident profile error:\", err);\n+        res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n+    }\n+};\n+\n+/* ===========================================================\n+   ALL RESIDENTS (Admin)\n+=========================================================== */\n+export const getAllResidents = async (req, res) => {\n+    try {\n+        const pool = await dbPool;\n+        const result = await pool.request().query(\"SELECT * FROM Residents ORDER BY ResidentName ASC\");\n+        res.status(200).json(result.recordset);\n+    } catch (err) {\n+        res.status(500).json({ error: \"Failed to load residents\", details: err.message });\n+    }\n+};\n+\n+/* ===========================================================\n+   VISITOR ACCESS\n+=========================================================== */\n+export const getVisitorsAccess = async (req, res) => {\n+    try {\n+        const residentId = req.user?.ResidentID;\n+        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n+\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input(\"ResidentID\", sql.Int, residentId)\n+            .query(\"SELECT TOP 50 * FROM Visitors WHERE ResidentID = @ResidentID ORDER BY VisitDate DESC\");\n+\n+        res.status(200).json({ visitors: result.recordset });\n+    } catch (err) {\n+        console.error(\"Failed to load visitor access\", err);\n+        res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n+    }\n+};\n+\n+/* ===========================================================\n+   VISITOR PASSES\n+=========================================================== */\n+export const getVisitorPasses = async (req, res) => {\n+    const residentID = req.user?.ResidentID;\n+    if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n+\n+    try {\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input('ResidentID', sql.Int, residentID)\n+            .query(`\n+                SELECT VisitorName, AccessCode, Status \n+                FROM VisitorsAccess\n+                WHERE ResidentID = @ResidentID\n+                ORDER BY CreatedAt DESC\n+            `);\n+\n+        res.status(200).json(result.recordset || []);\n+    } catch (err) {\n+        console.error(\"Error retrieving visitor passes:\", err);\n+        res.status(500).json({ error: \"Failed to retrieve visitor passes\" });\n+    }\n+};\n+\n+/* ===========================================================\n+   MEMBERSHIP REQUESTS\n+=========================================================== */\n+export const getMembershipRequests = async (req, res) => {\n+    const residentNationalID = req.user?.NationalID;\n+    const role = req.user?.role;\n+\n+    try {\n+        const pool = await dbPool;\n+        let request = pool.request();\n+        let query;\n+\n+        if (role === 'admin') {\n+            query = `\n+                SELECT RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n+                FROM MembershipRequests \n+                ORDER BY RequestedAt DESC\n+            `;\n+        } else if (residentNationalID) {\n+            request = request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n+            query = `\n+                SELECT RequestID, ResidentName, Status, RequestedAt \n+                FROM MembershipRequests \n+                WHERE NationalID = @NationalID \n+                ORDER BY RequestedAt DESC\n+            `;\n+        } else {\n+            return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n+        }\n+\n+        const result = await request.query(query);\n+        res.status(200).json(result.recordset);\n+\n+    } catch (err) {\n+        console.error(\"Failed to load membership requests:\", err);\n+        res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n+    }\n+};\n+\n+/* ===========================================================\n+   APPROVE / REJECT / SYNC RESIDENTS (Admin)\n+=========================================================== */\n+export const approveResidentController = async (req, res) => {\n+    const { requestID } = req.body;\n+    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n+\n+    try {\n+        const pool = await dbPool;\n+        const tx = new sql.Transaction(pool);\n+        await tx.begin();\n+\n+        try {\n+            const updateRequest = await tx.request()\n+                .input(\"RequestID\", sql.Int, requestID)\n+                .input(\"StatusApproved\", sql.NVarChar, 'Approved')\n+                .query(\"UPDATE MembershipRequests SET Status = @StatusApproved WHERE RequestID = @RequestID AND Status <> 'Synced'\");\n+\n+            if (updateRequest.rowsAffected[0] === 0) {\n+                await tx.rollback();\n+                return res.status(404).json({ error: \"Request not found or already processed.\" });\n+            }\n+\n+            const requestDataResult = await tx.request()\n+                .input(\"RequestID\", sql.Int, requestID)\n+                .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n+            \n+            const r = requestDataResult.recordset[0];\n+            if (!r) { await tx.rollback(); return res.status(404).json({ error: \"Request data not found.\" }); }\n+\n+            const existingResidentCheck = await tx.request()\n+                .input(\"NationalID\", sql.NVarChar, r.NationalID)\n+                .query(\"SELECT ResidentID FROM Residents WHERE NationalID = @NationalID\");\n+\n+            let newResidentID;\n+            if (existingResidentCheck.recordset.length === 0) {\n+                const insertResult = await tx.request()\n+                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n+                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n+                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n+                    .input(\"Email\", sql.NVarChar, r.Email)\n+                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n+                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n+                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n+                    .input(\"DateJoined\", sql.DateTime, new Date())\n+                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n+                    .query(`\n+                        INSERT INTO Residents\n+                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n+                        OUTPUT INSERTED.ResidentID\n+                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n+                    `);\n+                newResidentID = insertResult.recordset[0].ResidentID;\n+            } else {\n+                newResidentID = existingResidentCheck.recordset[0].ResidentID;\n+            }\n+\n+            await tx.request()\n+                .input(\"RecordID\", sql.Int, newResidentID)\n+                .input(\"RequestID\", sql.Int, requestID)\n+                .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n+                .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n+\n+            await tx.commit();\n+            res.status(200).json({ message: \"Resident approved and synced successfully.\", residentID: newResidentID });\n+        } catch (err) {\n+            await tx.rollback();\n+            throw err;\n+        }\n+    } catch (err) {\n+        console.error(\"Approve resident error:\", err);\n+        res.status(500).json({ error: \"Failed to approve resident\", details: err.message });\n+    }\n+};\n+\n+export const rejectResidentController = async (req, res) => {\n+    const { requestID, reason } = req.body;\n+    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n+\n+    try {\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input(\"RequestID\", sql.Int, requestID)\n+            .input(\"StatusRejected\", sql.NVarChar(50), 'Rejected')\n+            .input(\"Reason\", sql.NVarChar(255), reason || 'Rejected by administrator.')\n+            .query(\"UPDATE MembershipRequests SET Status = @StatusRejected, AdminNotes = @Reason WHERE RequestID = @RequestID AND Status = 'Pending'\");\n+\n+        if (result.rowsAffected[0] === 0) return res.status(404).json({ error: \"Request not found or already processed.\" });\n+\n+        res.status(200).json({ message: `Membership request ${requestID} rejected.` });\n+    } catch (err) {\n+        console.error(\"Reject resident error:\", err);\n+        res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n+    }\n+};\n+export const getResidentIDs = async (req, res) => {\n   try {\n     const pool = await dbPool;\n     const result = await pool.request().query(`\n-      SELECT ResidentID, ResidentName FROM Residents ORDER BY ResidentName\n+      SELECT TOP 100 ResidentID, ResidentName FROM Residents ORDER BY ResidentName\n     `);\n     res.json(result.recordset);\n   } catch (err) {\n     console.error(\"Error fetching resident IDs:\", err);\n-    res.status(500).json({ message: \"Error fetching resident IDs\" });\n+    res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n   }\n-}\n+};\n+/* ===========================================================\n+   APPROVED RESIDENTS LIST\n+=========================================================== */\n+export const getApprovedResidents = async (req, res) => {\n+    try {\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input(\"StatusApproved\", sql.NVarChar(50), 'Active')\n+            .query(\"SELECT * FROM Residents WHERE Status = @StatusApproved ORDER BY ResidentName ASC\");\n+        res.status(200).json(result.recordset);\n+    } catch (err) {\n+        console.error(err);\n+        res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n+    }\n+};\n \n-// Fetch all payments\n-export async function getAllPayments(req, res) {\n-  try {\n-    const pool = await dbPool;\n-    const result = await pool.request().query(`\n-      SELECT p.PaymentID, p.ResidentID, p.Amount, p.PaymentDate, p.Status,\n-             p.Reference, p.PaymentMethod, p.PhoneNumber, p.VerifiedDate\n-      FROM Payments p\n-      ORDER BY p.PaymentDate DESC\n-    `);\n-    res.json(result.recordset);\n-  } catch (err) {\n-    console.error(\"Error fetching payments:\", err);\n-    res.status(500).json({ message: \"Error fetching payments\" });\n-  }\n-}\n+/* ===========================================================\n+   PAYMENT STATUS\n+=========================================================== */\n+export const getPaymentStatusController = async (req, res) => {\n+    const phone = req.query.phone;\n+    if (!phone) return res.status(400).json({ error: \"Phone required\" });\n \n-// Fetch balances\n-export async function getBalances(req, res) {\n-  try {\n-    const pool = await dbPool;\n-    const result = await pool.request().query(`\n-      SELECT r.ResidentID, r.ResidentName,\n-             ISNULL(SUM(p.Amount),0) AS TotalPaid,\n-             ISNULL(r.TotalDue,0) AS TotalDue,\n-             ISNULL(r.TotalDue,0) - ISNULL(SUM(p.Amount),0) AS Balance\n-      FROM Residents r\n-      LEFT JOIN Payments p ON r.ResidentID = p.ResidentID AND p.Status='Verified'\n-      GROUP BY r.ResidentID, r.ResidentName, r.TotalDue\n-    `);\n-    res.json(result.recordset);\n-  } catch (err) {\n-    console.error(\"Error fetching balances:\", err);\n-    res.status(500).json({ message: \"Error fetching balances\" });\n-  }\n-}\n+    try {\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n+            .query(\"SELECT TOP 1 * FROM Payments WHERE PhoneNumber = @PhoneNumber ORDER BY PaymentID DESC\");\n+\n+        if (!result.recordset.length) return res.status(200).json({ isPaid: false, status: \"No Record Found\", phone });\n+\n+        const p = result.recordset[0];\n+        const isPaid = [\"paid\", \"verified\"].includes(p.Status?.toLowerCase());\n+\n+        res.status(200).json({\n+            phone: p.PhoneNumber,\n+            status: p.Status,\n+            amount: p.Amount,\n+            paymentDate: p.PaymentDate,\n+            isPaid,\n+        });\n+    } catch (err) {\n+        console.error(err);\n+        res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n+    }\n+};\n+\n+export const loadPaymentStatus = getPaymentStatusController;\n+\n+/* ===========================================================\n+   PAY FOR SERVICE\n+=========================================================== */\n+export const payForService = async (req, res) => {\n+    try {\n+        const { phone, serviceName, amount } = req.body;\n+        const nationalID = req.user.NationalID;\n+        const residentID = req.user.ResidentID;\n+\n+        if (!nationalID || !residentID)\n+            return res.status(401).json({ error: \"Missing resident data in token\" });\n+\n+        if (!phone || !serviceName || !amount)\n+            return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n+\n+        const pool = await dbPool;\n+\n+        const result = await pool.request()\n+            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n+            .input(\"NationalID\", sql.VarChar(50), nationalID)\n+            .input(\"ResidentID\", sql.Int, residentID)\n+            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n+            .input(\"Amount\", sql.Decimal(18, 2), amount)\n+            .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n+            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n+            .query(`\n+                INSERT INTO Payments\n+                (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n+                OUTPUT INSERTED.*\n+                VALUES\n+                (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n+            `);\n+\n+        await pool.request()\n+            .input(\"ResidentID\", sql.Int, residentID)\n+            .input(\"Amount\", sql.Decimal(18, 2), amount)\n+            .input(\"NationalID\", sql.VarChar(50), nationalID)\n+            .input(\"ServiceName\", sql.NVarChar(100), serviceName || null)\n+            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n+            .input(\"VerifiedDate\", sql.DateTime, null)\n+            .input(\"Reference\", sql.VarChar(100), serviceName || null)\n+            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n+            .query(`\n+                INSERT INTO PaymentHistory \n+                (ResidentID, Amount, NationalID, ServiceName, PhoneNumber, VerifiedDate, Status, PaymentDate, Reference)\n+                VALUES \n+                (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n+            `);\n+\n+        res.status(201).json({\n+            message: \"Payment initialized and history recorded\",\n+            payment: result.recordset[0],\n+        });\n+\n+    } catch (err) {\n+        res.status(500).json({\n+            error: \"Payment failed\",\n+            details: err.message,\n+        });\n+    }\n+};\n+\n+export const payController = payForService;\n+\n+/* ===========================================================\n+   SYNC RESIDENTS\n+=========================================================== */\n+export const syncResidents = async (req, res) => {\n+    try {\n+        const pool = await dbPool;\n+        const tx = new sql.Transaction(pool);\n+        await tx.begin();\n+\n+        try {\n+            const pendingRequestsResult = await tx.request()\n+                .input(\"StatusApproved\", sql.NVarChar(50), 'Approved')\n+                .query(\"SELECT * FROM MembershipRequests WHERE Status = @StatusApproved AND RecordID IS NULL\");\n+\n+            const pending = pendingRequestsResult.recordset;\n+            if (!pending.length) {\n+                await tx.commit();\n+                return res.status(200).json({ message: \"No new residents to sync.\" });\n+            }\n+\n+            let synced = 0;\n+            for (const r of pending) {\n+                const insertResult = await tx.request()\n+                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n+                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n+                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n+                    .input(\"Email\", sql.NVarChar, r.Email)\n+                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n+                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n+                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n+                    .input(\"DateJoined\", sql.DateTime, new Date())\n+                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n+                    .query(`\n+                        INSERT INTO Residents\n+                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n+                        OUTPUT INSERTED.ResidentID\n+                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n+                    `);\n+\n+                const newResidentID = insertResult.recordset[0].ResidentID;\n+\n+                await tx.request()\n+                    .input(\"RecordID\", sql.Int, newResidentID)\n+                    .input(\"RequestID\", sql.Int, r.RequestID)\n+                    .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n+                    .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n+\n+                synced++;\n+            }\n+\n+            await tx.commit();\n+            res.status(200).json({ message: `Successfully synced ${synced} resident(s).` });\n+\n+        } catch (err) {\n+            await tx.rollback();\n+            throw err;\n+        }\n+\n+    } catch (err) {\n+        console.error(err);\n+        res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n+    }\n+};\n"
                },
                {
                    "date": 1763846073211,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,22 +1,16 @@\n // backend/controllers/residentsController.js\n-\n import sql from \"mssql\";\n import { dbPool } from \"../server.js\";\n \n /* ===========================================================\n    DASHBOARD SUMMARY (Admin)\n =========================================================== */\n export const getDashboardSummary = async (req, res) => {\n-    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n-    const OVERRIDES_TABLE = \"[EstateAccessManagementSystem].[dbo].[gate_overrides]\";\n-\n     try {\n         const pool = await dbPool;\n \n-        const totalResidentsResult = await pool.request().query(\n-            \"SELECT COUNT(ResidentID) AS residents FROM Residents\"\n-        );\n+        const totalResidentsResult = await pool.request().query(\"SELECT COUNT(ResidentID) AS residents FROM Residents\");\n         const residents = totalResidentsResult.recordset[0]?.residents || 0;\n \n         const pendingPaymentsResult = await pool\n             .request()\n@@ -31,39 +25,13 @@\n         const paidResidents = paidResidentsCountResult.recordset[0]?.paidResidents || 0;\n \n         const compliance = residents > 0 ? Math.round((parseFloat(paidResidents) / residents) * 100) : 0;\n \n-        const overrideMetricsResult = await pool.request().query(`\n-            SELECT COUNT(id) AS overrideCount\n-            FROM ${OVERRIDES_TABLE}\n-            WHERE CAST(createdAt AS DATE) = CAST(GETDATE() AS DATE);\n-        `);\n-        const overrideCount = overrideMetricsResult.recordset[0]?.overrideCount || 0;\n-\n-        const accessMetricsResult = await pool.request().query(`\n-            SELECT \n-                SUM(CASE WHEN [Action] = 'CheckIn' THEN 1 ELSE 0 END) AS visitorscheckedin,\n-                SUM(CASE WHEN [Action] = 'CheckOut' THEN 1 ELSE 0 END) AS visitorscheckedout,\n-                SUM(CASE WHEN [Action] = 'Access Denied' THEN 1 ELSE 0 END) AS rejects \n-            FROM ${ACCESS_LOGS_TABLE}\n-            WHERE CAST(TimestampUtc AS DATE) = CAST(GETDATE() AS DATE);\n-        `);\n-        const accessData = accessMetricsResult.recordset[0] || {\n-            visitorscheckedin: 0,\n-            visitorscheckedout: 0,\n-            rejects: 0,\n-        };\n-\n         res.status(200).json({\n             residents,\n             pendingPayments,\n             compliance,\n-            overrideCount,\n-            visitorscheckedin: accessData.visitorscheckedin,\n-            visitorscheckedout: accessData.visitorscheckedout,\n-            rejects: accessData.rejects,\n         });\n-\n     } catch (err) {\n         console.error(\"Dashboard summary error:\", err.stack);\n         res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n     }\n@@ -72,18 +40,14 @@\n /* ===========================================================\n    ACCESS CHART DATA (Admin)\n =========================================================== */\n export const getAccessChartData = async (req, res) => {\n-    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n-\n     try {\n         const pool = await dbPool;\n \n         const result = await pool.request().query(`\n-            SELECT \n-                FORMAT(TimestampUtc, 'MM/dd') AS DayLabel,\n-                COUNT(*) AS AccessCount\n-            FROM ${ACCESS_LOGS_TABLE}\n+            SELECT FORMAT(TimestampUtc, 'MM/dd') AS DayLabel, COUNT(*) AS AccessCount\n+            FROM accesslogs\n             WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n             GROUP BY FORMAT(TimestampUtc, 'MM/dd')\n             ORDER BY MIN(TimestampUtc) ASC;\n         `);\n@@ -97,9 +61,8 @@\n         res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n     }\n };\n \n-\n /* ===========================================================\n    RESIDENT PROFILE\n =========================================================== */\n export const getResidentProfile = async (req, res) => {\n@@ -112,18 +75,17 @@\n             .input(\"ResidentID\", sql.Int, residentId)\n             .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n \n         if (!result.recordset.length) return res.status(404).json({ error: \"Resident not found\" });\n-\n         res.status(200).json(result.recordset[0]);\n     } catch (err) {\n         console.error(\"Resident profile error:\", err);\n         res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n     }\n };\n \n /* ===========================================================\n-   ALL RESIDENTS (Admin)\n+   GET ALL RESIDENTS (Admin)\n =========================================================== */\n export const getAllResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n@@ -134,8 +96,24 @@\n     }\n };\n \n /* ===========================================================\n+   GET APPROVED RESIDENTS\n+=========================================================== */\n+export const getApprovedResidents = async (req, res) => {\n+    try {\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input(\"StatusActive\", sql.NVarChar(50), 'Active')\n+            .query(\"SELECT * FROM Residents WHERE Status = @StatusActive ORDER BY ResidentName ASC\");\n+        res.status(200).json(result.recordset);\n+    } catch (err) {\n+        console.error(err);\n+        res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n+    }\n+};\n+\n+/* ===========================================================\n    VISITOR ACCESS\n =========================================================== */\n export const getVisitorsAccess = async (req, res) => {\n     try {\n@@ -146,9 +124,9 @@\n         const result = await pool.request()\n             .input(\"ResidentID\", sql.Int, residentId)\n             .query(\"SELECT TOP 50 * FROM Visitors WHERE ResidentID = @ResidentID ORDER BY VisitDate DESC\");\n \n-        res.status(200).json({ visitors: result.recordset });\n+        res.status(200).json(result.recordset);\n     } catch (err) {\n         console.error(\"Failed to load visitor access\", err);\n         res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n     }\n@@ -157,21 +135,16 @@\n /* ===========================================================\n    VISITOR PASSES\n =========================================================== */\n export const getVisitorPasses = async (req, res) => {\n-    const residentID = req.user?.ResidentID;\n-    if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n+    try {\n+        const residentID = req.user?.ResidentID;\n+        if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n \n-    try {\n         const pool = await dbPool;\n         const result = await pool.request()\n-            .input('ResidentID', sql.Int, residentID)\n-            .query(`\n-                SELECT VisitorName, AccessCode, Status \n-                FROM VisitorsAccess\n-                WHERE ResidentID = @ResidentID\n-                ORDER BY CreatedAt DESC\n-            `);\n+            .input(\"ResidentID\", sql.Int, residentID)\n+            .query(\"SELECT VisitorName, AccessCode, Status FROM VisitorsAccess WHERE ResidentID = @ResidentID ORDER BY CreatedAt DESC\");\n \n         res.status(200).json(result.recordset || []);\n     } catch (err) {\n         console.error(\"Error retrieving visitor passes:\", err);\n@@ -182,174 +155,56 @@\n /* ===========================================================\n    MEMBERSHIP REQUESTS\n =========================================================== */\n export const getMembershipRequests = async (req, res) => {\n-    const residentNationalID = req.user?.NationalID;\n-    const role = req.user?.role;\n+    try {\n+        const residentNationalID = req.user?.NationalID;\n+        const role = req.user?.role;\n \n-    try {\n         const pool = await dbPool;\n-        let request = pool.request();\n+        const request = pool.request();\n         let query;\n \n         if (role === 'admin') {\n-            query = `\n-                SELECT RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n-                FROM MembershipRequests \n-                ORDER BY RequestedAt DESC\n-            `;\n+            query = \"SELECT * FROM MembershipRequests ORDER BY RequestedAt DESC\";\n         } else if (residentNationalID) {\n-            request = request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n-            query = `\n-                SELECT RequestID, ResidentName, Status, RequestedAt \n-                FROM MembershipRequests \n-                WHERE NationalID = @NationalID \n-                ORDER BY RequestedAt DESC\n-            `;\n+            request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n+            query = \"SELECT * FROM MembershipRequests WHERE NationalID = @NationalID ORDER BY RequestedAt DESC\";\n         } else {\n             return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n         }\n \n         const result = await request.query(query);\n         res.status(200).json(result.recordset);\n-\n     } catch (err) {\n         console.error(\"Failed to load membership requests:\", err);\n         res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n     }\n };\n \n /* ===========================================================\n-   APPROVE / REJECT / SYNC RESIDENTS (Admin)\n+   RESIDENT IDs\n =========================================================== */\n-export const approveResidentController = async (req, res) => {\n-    const { requestID } = req.body;\n-    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n-\n-    try {\n-        const pool = await dbPool;\n-        const tx = new sql.Transaction(pool);\n-        await tx.begin();\n-\n-        try {\n-            const updateRequest = await tx.request()\n-                .input(\"RequestID\", sql.Int, requestID)\n-                .input(\"StatusApproved\", sql.NVarChar, 'Approved')\n-                .query(\"UPDATE MembershipRequests SET Status = @StatusApproved WHERE RequestID = @RequestID AND Status <> 'Synced'\");\n-\n-            if (updateRequest.rowsAffected[0] === 0) {\n-                await tx.rollback();\n-                return res.status(404).json({ error: \"Request not found or already processed.\" });\n-            }\n-\n-            const requestDataResult = await tx.request()\n-                .input(\"RequestID\", sql.Int, requestID)\n-                .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n-            \n-            const r = requestDataResult.recordset[0];\n-            if (!r) { await tx.rollback(); return res.status(404).json({ error: \"Request data not found.\" }); }\n-\n-            const existingResidentCheck = await tx.request()\n-                .input(\"NationalID\", sql.NVarChar, r.NationalID)\n-                .query(\"SELECT ResidentID FROM Residents WHERE NationalID = @NationalID\");\n-\n-            let newResidentID;\n-            if (existingResidentCheck.recordset.length === 0) {\n-                const insertResult = await tx.request()\n-                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n-                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n-                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n-                    .input(\"Email\", sql.NVarChar, r.Email)\n-                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n-                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n-                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n-                    .input(\"DateJoined\", sql.DateTime, new Date())\n-                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n-                    .query(`\n-                        INSERT INTO Residents\n-                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n-                        OUTPUT INSERTED.ResidentID\n-                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n-                    `);\n-                newResidentID = insertResult.recordset[0].ResidentID;\n-            } else {\n-                newResidentID = existingResidentCheck.recordset[0].ResidentID;\n-            }\n-\n-            await tx.request()\n-                .input(\"RecordID\", sql.Int, newResidentID)\n-                .input(\"RequestID\", sql.Int, requestID)\n-                .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n-                .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n-\n-            await tx.commit();\n-            res.status(200).json({ message: \"Resident approved and synced successfully.\", residentID: newResidentID });\n-        } catch (err) {\n-            await tx.rollback();\n-            throw err;\n-        }\n-    } catch (err) {\n-        console.error(\"Approve resident error:\", err);\n-        res.status(500).json({ error: \"Failed to approve resident\", details: err.message });\n-    }\n-};\n-\n-export const rejectResidentController = async (req, res) => {\n-    const { requestID, reason } = req.body;\n-    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n-\n-    try {\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input(\"RequestID\", sql.Int, requestID)\n-            .input(\"StatusRejected\", sql.NVarChar(50), 'Rejected')\n-            .input(\"Reason\", sql.NVarChar(255), reason || 'Rejected by administrator.')\n-            .query(\"UPDATE MembershipRequests SET Status = @StatusRejected, AdminNotes = @Reason WHERE RequestID = @RequestID AND Status = 'Pending'\");\n-\n-        if (result.rowsAffected[0] === 0) return res.status(404).json({ error: \"Request not found or already processed.\" });\n-\n-        res.status(200).json({ message: `Membership request ${requestID} rejected.` });\n-    } catch (err) {\n-        console.error(\"Reject resident error:\", err);\n-        res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n-    }\n-};\n export const getResidentIDs = async (req, res) => {\n-  try {\n-    const pool = await dbPool;\n-    const result = await pool.request().query(`\n-      SELECT TOP 100 ResidentID, ResidentName FROM Residents ORDER BY ResidentName\n-    `);\n-    res.json(result.recordset);\n-  } catch (err) {\n-    console.error(\"Error fetching resident IDs:\", err);\n-    res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n-  }\n-};\n-/* ===========================================================\n-   APPROVED RESIDENTS LIST\n-=========================================================== */\n-export const getApprovedResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const result = await pool.request()\n-            .input(\"StatusApproved\", sql.NVarChar(50), 'Active')\n-            .query(\"SELECT * FROM Residents WHERE Status = @StatusApproved ORDER BY ResidentName ASC\");\n-        res.status(200).json(result.recordset);\n+            .query(\"SELECT TOP 100 ResidentID, ResidentName FROM Residents ORDER BY ResidentName\");\n+        res.json(result.recordset);\n     } catch (err) {\n-        console.error(err);\n-        res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n+        console.error(\"Error fetching resident IDs:\", err);\n+        res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n     }\n };\n \n /* ===========================================================\n    PAYMENT STATUS\n =========================================================== */\n-export const getPaymentStatusController = async (req, res) => {\n-    const phone = req.query.phone;\n-    if (!phone) return res.status(400).json({ error: \"Phone required\" });\n+export const loadPaymentStatus = async (req, res) => {\n+    try {\n+        const phone = req.query.phone;\n+        if (!phone) return res.status(400).json({ error: \"Phone required\" });\n \n-    try {\n         const pool = await dbPool;\n         const result = await pool.request()\n             .input(\"PhoneNumber\", sql.VarChar(20), phone)\n             .query(\"SELECT TOP 1 * FROM Payments WHERE PhoneNumber = @PhoneNumber ORDER BY PaymentID DESC\");\n@@ -371,31 +226,27 @@\n         res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n     }\n };\n \n-export const loadPaymentStatus = getPaymentStatusController;\n-\n /* ===========================================================\n    PAY FOR SERVICE\n =========================================================== */\n export const payForService = async (req, res) => {\n     try {\n         const { phone, serviceName, amount } = req.body;\n-        const nationalID = req.user.NationalID;\n-        const residentID = req.user.ResidentID;\n+        const residentID = req.user?.ResidentID;\n+        const nationalID = req.user?.NationalID;\n \n-        if (!nationalID || !residentID)\n-            return res.status(401).json({ error: \"Missing resident data in token\" });\n+        if (!residentID || !nationalID) return res.status(401).json({ error: \"Missing resident data in token\" });\n+        if (!phone || !serviceName || !amount) return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n \n-        if (!phone || !serviceName || !amount)\n-            return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n-\n         const pool = await dbPool;\n \n-        const result = await pool.request()\n+        // Insert into Payments table\n+        const paymentResult = await pool.request()\n             .input(\"PhoneNumber\", sql.VarChar(20), phone)\n+            .input(\"ResidentID\", sql.Int, residentID)\n             .input(\"NationalID\", sql.VarChar(50), nationalID)\n-            .input(\"ResidentID\", sql.Int, residentID)\n             .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n             .input(\"Amount\", sql.Decimal(18, 2), amount)\n             .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n             .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n@@ -406,39 +257,35 @@\n                 VALUES\n                 (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n             `);\n \n+        // Insert into PaymentHistory\n         await pool.request()\n             .input(\"ResidentID\", sql.Int, residentID)\n             .input(\"Amount\", sql.Decimal(18, 2), amount)\n             .input(\"NationalID\", sql.VarChar(50), nationalID)\n-            .input(\"ServiceName\", sql.NVarChar(100), serviceName || null)\n+            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n             .input(\"PhoneNumber\", sql.VarChar(20), phone)\n             .input(\"VerifiedDate\", sql.DateTime, null)\n-            .input(\"Reference\", sql.VarChar(100), serviceName || null)\n-            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n+            .input(\"Reference\", sql.VarChar(100), serviceName)\n+            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n             .query(`\n-                INSERT INTO PaymentHistory \n+                INSERT INTO PaymentHistory\n                 (ResidentID, Amount, NationalID, ServiceName, PhoneNumber, VerifiedDate, Status, PaymentDate, Reference)\n-                VALUES \n+                VALUES\n                 (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n             `);\n \n         res.status(201).json({\n-            message: \"Payment initialized and history recorded\",\n-            payment: result.recordset[0],\n+            message: \"Payment initialized and recorded\",\n+            payment: paymentResult.recordset[0],\n         });\n-\n     } catch (err) {\n-        res.status(500).json({\n-            error: \"Payment failed\",\n-            details: err.message,\n-        });\n+        console.error(err);\n+        res.status(500).json({ error: \"Payment failed\", details: err.message });\n     }\n };\n \n-export const payController = payForService;\n-\n /* ===========================================================\n    SYNC RESIDENTS\n =========================================================== */\n export const syncResidents = async (req, res) => {\n@@ -489,14 +336,12 @@\n             }\n \n             await tx.commit();\n             res.status(200).json({ message: `Successfully synced ${synced} resident(s).` });\n-\n         } catch (err) {\n             await tx.rollback();\n             throw err;\n         }\n-\n     } catch (err) {\n         console.error(err);\n         res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n     }\n"
                },
                {
                    "date": 1763967866450,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,17 +85,37 @@\n \n /* ===========================================================\n    GET ALL RESIDENTS (Admin)\n =========================================================== */\n-export const getAllResidents = async (req, res) => {\n+export async function getAllResidents(req, res) {\n     try {\n-        const pool = await dbPool;\n-        const result = await pool.request().query(\"SELECT * FROM Residents ORDER BY ResidentName ASC\");\n-        res.status(200).json(result.recordset);\n+        const pool = await connectDB();\n+        const result = await pool.request().query(`\n+            SELECT \n+                ResidentID,\n+                UserID,\n+                NationalID,\n+                HouseNumber,\n+                Occupation,\n+                DateJoined,\n+                Status,\n+                ResidentName,\n+                PhoneNumber,\n+                Email,\n+                CourtName,\n+                RoleName,\n+                TotalDue\n+            FROM Residents\n+            ORDER BY ResidentID DESC\n+        `);\n+\n+        res.json(result.recordset);\n+\n     } catch (err) {\n-        res.status(500).json({ error: \"Failed to load residents\", details: err.message });\n+        console.error(\"❌ Error fetching residents:\", err);\n+        res.status(500).json({ message: \"Error loading residents\" });\n     }\n-};\n+}\n \n /* ===========================================================\n    GET APPROVED RESIDENTS\n =========================================================== */\n"
                },
                {
                    "date": 1763967912374,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,26 +64,46 @@\n \n /* ===========================================================\n    RESIDENT PROFILE\n =========================================================== */\n-export const getResidentProfile = async (req, res) => {\n+export async function getResidentProfile(req, res) {\n     try {\n-        const residentId = req.user?.ResidentID;\n-        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n+        const userId = req.user.id; // JWT contains user ID\n \n-        const pool = await dbPool;\n+        const pool = await connectDB();\n         const result = await pool.request()\n-            .input(\"ResidentID\", sql.Int, residentId)\n-            .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n+            .input(\"UserID\", sql.Int, userId)\n+            .query(`\n+                SELECT \n+                    ResidentID,\n+                    UserID,\n+                    NationalID,\n+                    HouseNumber,\n+                    Occupation,\n+                    DateJoined,\n+                    Status,\n+                    ResidentName,\n+                    PhoneNumber,\n+                    Email,\n+                    CourtName,\n+                    RoleName,\n+                    TotalDue\n+                FROM Residents\n+                WHERE UserID = @UserID\n+            `);\n \n-        if (!result.recordset.length) return res.status(404).json({ error: \"Resident not found\" });\n-        res.status(200).json(result.recordset[0]);\n+        if (result.recordset.length === 0)\n+            return res.status(404).json({ message: \"Resident not found\" });\n+\n+        res.json(result.recordset[0]);\n+\n     } catch (err) {\n-        console.error(\"Resident profile error:\", err);\n-        res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n+        console.error(\"❌ Error loading resident profile:\", err);\n+        res.status(500).json({ message: \"Error loading resident profile\" });\n     }\n-};\n+}\n \n+\n /* ===========================================================\n    GET ALL RESIDENTS (Admin)\n =========================================================== */\n export async function getAllResidents(req, res) {\n"
                },
                {
                    "date": 1763968165847,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,4 @@\n-// backend/controllers/residentsController.js\n import sql from \"mssql\";\n import { dbPool } from \"../server.js\";\n \n /* ===========================================================\n@@ -8,33 +7,45 @@\n export const getDashboardSummary = async (req, res) => {\n     try {\n         const pool = await dbPool;\n \n-        const totalResidentsResult = await pool.request().query(\"SELECT COUNT(ResidentID) AS residents FROM Residents\");\n-        const residents = totalResidentsResult.recordset[0]?.residents || 0;\n+        const totalResidents = await pool.request().query(`\n+            SELECT COUNT(ResidentID) AS residents FROM Residents\n+        `);\n \n-        const pendingPaymentsResult = await pool\n-            .request()\n-            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n-            .query(\"SELECT COUNT(PaymentID) AS pendingPayments FROM Payments WHERE Status = @StatusPending\");\n-        const pendingPayments = pendingPaymentsResult.recordset[0]?.pendingPayments || 0;\n+        const pendingPayments = await pool.request()\n+            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n+            .query(`\n+                SELECT COUNT(PaymentID) AS pendingPayments \n+                FROM Payments \n+                WHERE Status = @StatusPending\n+            `);\n \n-        const paidResidentsCountResult = await pool\n-            .request()\n-            .input(\"StatusVerified\", sql.NVarChar(50), 'Verified')\n-            .query(\"SELECT COUNT(DISTINCT ResidentID) AS paidResidents FROM Payments WHERE Status = @StatusVerified\");\n-        const paidResidents = paidResidentsCountResult.recordset[0]?.paidResidents || 0;\n+        const paidResidents = await pool.request()\n+            .input(\"StatusVerified\", sql.NVarChar(50), \"Verified\")\n+            .query(`\n+                SELECT COUNT(DISTINCT ResidentID) AS paidResidents \n+                FROM Payments \n+                WHERE Status = @StatusVerified\n+            `);\n \n-        const compliance = residents > 0 ? Math.round((parseFloat(paidResidents) / residents) * 100) : 0;\n+        const residents = totalResidents.recordset[0].residents || 0;\n+        const pending = pendingPayments.recordset[0].pendingPayments || 0;\n+        const paid = paidResidents.recordset[0].paidResidents || 0;\n \n-        res.status(200).json({\n+        const compliance =\n+            residents > 0 ? Math.round((paid / residents) * 100) : 0;\n+\n+        res.json({\n             residents,\n-            pendingPayments,\n+            pendingPayments: pending,\n+            paidResidents: paid,\n             compliance,\n         });\n+\n     } catch (err) {\n-        console.error(\"Dashboard summary error:\", err.stack);\n-        res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n+        console.error(\"Dashboard summary error:\", err);\n+        res.status(500).json({ error: \"Failed to load dashboard summary\" });\n     }\n };\n \n /* ===========================================================\n@@ -44,33 +55,35 @@\n     try {\n         const pool = await dbPool;\n \n         const result = await pool.request().query(`\n-            SELECT FORMAT(TimestampUtc, 'MM/dd') AS DayLabel, COUNT(*) AS AccessCount\n+            SELECT FORMAT(TimestampUtc, 'MM/dd') AS DayLabel,\n+                   COUNT(*) AS AccessCount\n             FROM accesslogs\n             WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n             GROUP BY FORMAT(TimestampUtc, 'MM/dd')\n-            ORDER BY MIN(TimestampUtc) ASC;\n+            ORDER BY MIN(TimestampUtc)\n         `);\n \n-        res.status(200).json({\n+        res.json({\n             days: result.recordset.map(r => r.DayLabel),\n             counts: result.recordset.map(r => r.AccessCount),\n         });\n+\n     } catch (err) {\n-        console.error(\"Access chart error:\", err.stack);\n-        res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n+        console.error(\"Access chart error:\", err);\n+        res.status(500).json({ error: \"Failed to load chart\" });\n     }\n };\n \n /* ===========================================================\n    RESIDENT PROFILE\n =========================================================== */\n-export async function getResidentProfile(req, res) {\n+export const getResidentProfile = async (req, res) => {\n     try {\n-        const userId = req.user.id; // JWT contains user ID\n+        const userId = req.user.id;\n \n-        const pool = await connectDB();\n+        const pool = await dbPool;\n         const result = await pool.request()\n             .input(\"UserID\", sql.Int, userId)\n             .query(`\n                 SELECT \n@@ -96,20 +109,19 @@\n \n         res.json(result.recordset[0]);\n \n     } catch (err) {\n-        console.error(\"❌ Error loading resident profile:\", err);\n+        console.error(\"Profile error:\", err);\n         res.status(500).json({ message: \"Error loading resident profile\" });\n     }\n-}\n+};\n \n-\n /* ===========================================================\n-   GET ALL RESIDENTS (Admin)\n+   ALL RESIDENTS (Admin)\n =========================================================== */\n-export async function getAllResidents(req, res) {\n+export const getAllResidents = async (req, res) => {\n     try {\n-        const pool = await connectDB();\n+        const pool = await dbPool;\n         const result = await pool.request().query(`\n             SELECT \n                 ResidentID,\n                 UserID,\n@@ -130,65 +142,85 @@\n \n         res.json(result.recordset);\n \n     } catch (err) {\n-        console.error(\"❌ Error fetching residents:\", err);\n-        res.status(500).json({ message: \"Error loading residents\" });\n+        console.error(\"Error fetching residents:\", err);\n+        res.status(500).json({ error: \"Error loading residents\" });\n     }\n-}\n+};\n \n /* ===========================================================\n-   GET APPROVED RESIDENTS\n+   APPROVED RESIDENTS\n =========================================================== */\n export const getApprovedResidents = async (req, res) => {\n     try {\n         const pool = await dbPool;\n         const result = await pool.request()\n-            .input(\"StatusActive\", sql.NVarChar(50), 'Active')\n-            .query(\"SELECT * FROM Residents WHERE Status = @StatusActive ORDER BY ResidentName ASC\");\n-        res.status(200).json(result.recordset);\n+            .input(\"StatusActive\", sql.NVarChar(50), \"Active\")\n+            .query(`\n+                SELECT * \n+                FROM Residents \n+                WHERE Status = @StatusActive \n+                ORDER BY ResidentName ASC\n+            `);\n+\n+        res.json(result.recordset);\n+\n     } catch (err) {\n         console.error(err);\n-        res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n+        res.status(500).json({ error: \"Failed to load approved residents\" });\n     }\n };\n \n /* ===========================================================\n    VISITOR ACCESS\n =========================================================== */\n export const getVisitorsAccess = async (req, res) => {\n     try {\n-        const residentId = req.user?.ResidentID;\n-        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n+        const residentId = req.user.ResidentID;\n \n+        if (!residentId)\n+            return res.status(400).json({ error: \"Resident ID missing\" });\n+\n         const pool = await dbPool;\n         const result = await pool.request()\n             .input(\"ResidentID\", sql.Int, residentId)\n-            .query(\"SELECT TOP 50 * FROM Visitors WHERE ResidentID = @ResidentID ORDER BY VisitDate DESC\");\n+            .query(`\n+                SELECT TOP 50 *\n+                FROM Visitors\n+                WHERE ResidentID = @ResidentID\n+                ORDER BY VisitDate DESC\n+            `);\n \n-        res.status(200).json(result.recordset);\n+        res.json(result.recordset);\n+\n     } catch (err) {\n-        console.error(\"Failed to load visitor access\", err);\n-        res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n+        console.error(\"Visitor access error:\", err);\n+        res.status(500).json({ error: \"Failed to load visitor access\" });\n     }\n };\n \n /* ===========================================================\n    VISITOR PASSES\n =========================================================== */\n export const getVisitorPasses = async (req, res) => {\n     try {\n-        const residentID = req.user?.ResidentID;\n-        if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n+        const residentID = req.user.ResidentID;\n \n         const pool = await dbPool;\n         const result = await pool.request()\n             .input(\"ResidentID\", sql.Int, residentID)\n-            .query(\"SELECT VisitorName, AccessCode, Status FROM VisitorsAccess WHERE ResidentID = @ResidentID ORDER BY CreatedAt DESC\");\n+            .query(`\n+                SELECT VisitorName, AccessCode, Status\n+                FROM VisitorsAccess\n+                WHERE ResidentID = @ResidentID\n+                ORDER BY CreatedAt DESC\n+            `);\n \n-        res.status(200).json(result.recordset || []);\n+        res.json(result.recordset);\n+\n     } catch (err) {\n-        console.error(\"Error retrieving visitor passes:\", err);\n+        console.error(\"Visitor passes error:\", err);\n         res.status(500).json({ error: \"Failed to retrieve visitor passes\" });\n     }\n };\n \n@@ -196,193 +228,51 @@\n    MEMBERSHIP REQUESTS\n =========================================================== */\n export const getMembershipRequests = async (req, res) => {\n     try {\n-        const residentNationalID = req.user?.NationalID;\n-        const role = req.user?.role;\n+        const role = req.user.role;\n+        const nationalID = req.user.NationalID;\n \n         const pool = await dbPool;\n         const request = pool.request();\n         let query;\n \n-        if (role === 'admin') {\n+        if (role === \"admin\") {\n             query = \"SELECT * FROM MembershipRequests ORDER BY RequestedAt DESC\";\n-        } else if (residentNationalID) {\n-            request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n-            query = \"SELECT * FROM MembershipRequests WHERE NationalID = @NationalID ORDER BY RequestedAt DESC\";\n         } else {\n-            return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n+            request.input(\"NationalID\", sql.VarChar(50), nationalID);\n+            query = `\n+                SELECT * \n+                FROM MembershipRequests \n+                WHERE NationalID = @NationalID \n+                ORDER BY RequestedAt DESC\n+            `;\n         }\n \n         const result = await request.query(query);\n-        res.status(200).json(result.recordset);\n-    } catch (err) {\n-        console.error(\"Failed to load membership requests:\", err);\n-        res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n-    }\n-};\n-\n-/* ===========================================================\n-   RESIDENT IDs\n-=========================================================== */\n-export const getResidentIDs = async (req, res) => {\n-    try {\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .query(\"SELECT TOP 100 ResidentID, ResidentName FROM Residents ORDER BY ResidentName\");\n         res.json(result.recordset);\n-    } catch (err) {\n-        console.error(\"Error fetching resident IDs:\", err);\n-        res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n-    }\n-};\n \n-/* ===========================================================\n-   PAYMENT STATUS\n-=========================================================== */\n-export const loadPaymentStatus = async (req, res) => {\n-    try {\n-        const phone = req.query.phone;\n-        if (!phone) return res.status(400).json({ error: \"Phone required\" });\n-\n-        const pool = await dbPool;\n-        const result = await pool.request()\n-            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .query(\"SELECT TOP 1 * FROM Payments WHERE PhoneNumber = @PhoneNumber ORDER BY PaymentID DESC\");\n-\n-        if (!result.recordset.length) return res.status(200).json({ isPaid: false, status: \"No Record Found\", phone });\n-\n-        const p = result.recordset[0];\n-        const isPaid = [\"paid\", \"verified\"].includes(p.Status?.toLowerCase());\n-\n-        res.status(200).json({\n-            phone: p.PhoneNumber,\n-            status: p.Status,\n-            amount: p.Amount,\n-            paymentDate: p.PaymentDate,\n-            isPaid,\n-        });\n     } catch (err) {\n-        console.error(err);\n-        res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n+        console.error(\"Membership error:\", err);\n+        res.status(500).json({ error: \"Failed to load membership requests\" });\n     }\n };\n \n /* ===========================================================\n-   PAY FOR SERVICE\n+   RESIDENT ID LIST\n =========================================================== */\n-export const payForService = async (req, res) => {\n+export const getResidentIDs = async (req, res) => {\n     try {\n-        const { phone, serviceName, amount } = req.body;\n-        const residentID = req.user?.ResidentID;\n-        const nationalID = req.user?.NationalID;\n-\n-        if (!residentID || !nationalID) return res.status(401).json({ error: \"Missing resident data in token\" });\n-        if (!phone || !serviceName || !amount) return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n-\n         const pool = await dbPool;\n+        const result = await pool.request().query(`\n+            SELECT TOP 100 ResidentID, ResidentName \n+            FROM Residents \n+            ORDER BY ResidentName\n+        `);\n \n-        // Insert into Payments table\n-        const paymentResult = await pool.request()\n-            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .input(\"ResidentID\", sql.Int, residentID)\n-            .input(\"NationalID\", sql.VarChar(50), nationalID)\n-            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n-            .input(\"Amount\", sql.Decimal(18, 2), amount)\n-            .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n-            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n-            .query(`\n-                INSERT INTO Payments\n-                (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n-                OUTPUT INSERTED.*\n-                VALUES\n-                (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n-            `);\n+        res.json(result.recordset);\n \n-        // Insert into PaymentHistory\n-        await pool.request()\n-            .input(\"ResidentID\", sql.Int, residentID)\n-            .input(\"Amount\", sql.Decimal(18, 2), amount)\n-            .input(\"NationalID\", sql.VarChar(50), nationalID)\n-            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n-            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n-            .input(\"VerifiedDate\", sql.DateTime, null)\n-            .input(\"Reference\", sql.VarChar(100), serviceName)\n-            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n-            .query(`\n-                INSERT INTO PaymentHistory\n-                (ResidentID, Amount, NationalID, ServiceName, PhoneNumber, VerifiedDate, Status, PaymentDate, Reference)\n-                VALUES\n-                (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n-            `);\n-\n-        res.status(201).json({\n-            message: \"Payment initialized and recorded\",\n-            payment: paymentResult.recordset[0],\n-        });\n     } catch (err) {\n-        console.error(err);\n-        res.status(500).json({ error: \"Payment failed\", details: err.message });\n+        console.error(\"ID error:\", err);\n+        res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n     }\n };\n-\n-/* ===========================================================\n-   SYNC RESIDENTS\n-=========================================================== */\n-export const syncResidents = async (req, res) => {\n-    try {\n-        const pool = await dbPool;\n-        const tx = new sql.Transaction(pool);\n-        await tx.begin();\n-\n-        try {\n-            const pendingRequestsResult = await tx.request()\n-                .input(\"StatusApproved\", sql.NVarChar(50), 'Approved')\n-                .query(\"SELECT * FROM MembershipRequests WHERE Status = @StatusApproved AND RecordID IS NULL\");\n-\n-            const pending = pendingRequestsResult.recordset;\n-            if (!pending.length) {\n-                await tx.commit();\n-                return res.status(200).json({ message: \"No new residents to sync.\" });\n-            }\n-\n-            let synced = 0;\n-            for (const r of pending) {\n-                const insertResult = await tx.request()\n-                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n-                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n-                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n-                    .input(\"Email\", sql.NVarChar, r.Email)\n-                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n-                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n-                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n-                    .input(\"DateJoined\", sql.DateTime, new Date())\n-                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n-                    .query(`\n-                        INSERT INTO Residents\n-                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n-                        OUTPUT INSERTED.ResidentID\n-                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n-                    `);\n-\n-                const newResidentID = insertResult.recordset[0].ResidentID;\n-\n-                await tx.request()\n-                    .input(\"RecordID\", sql.Int, newResidentID)\n-                    .input(\"RequestID\", sql.Int, r.RequestID)\n-                    .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n-                    .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n-\n-                synced++;\n-            }\n-\n-            await tx.commit();\n-            res.status(200).json({ message: `Successfully synced ${synced} resident(s).` });\n-        } catch (err) {\n-            await tx.rollback();\n-            throw err;\n-        }\n-    } catch (err) {\n-        console.error(err);\n-        res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n-    }\n-};\n"
                },
                {
                    "date": 1763968274508,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -275,4 +275,36 @@\n         console.error(\"ID error:\", err);\n         res.status(500).json({ message: \"Failed to fetch resident IDs\" });\n     }\n };\n+export const loadPaymentStatus = async (req, res) => {\n+    try {\n+        const phone = req.query.phone;\n+        if (!phone) return res.status(400).json({ error: \"Phone required\" });\n+\n+        const pool = await dbPool;\n+        const result = await pool.request()\n+            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n+            .query(\"SELECT TOP 1 * FROM Payments WHERE PhoneNumber = @PhoneNumber ORDER BY PaymentID DESC\");\n+\n+        if (!result.recordset.length) return res.status(200).json({\n+            isPaid: false,\n+            status: \"No Record Found\",\n+            phone\n+        });\n+\n+        const p = result.recordset[0];\n+        const isPaid = [\"paid\", \"verified\"].includes(p.Status?.toLowerCase());\n+\n+        res.status(200).json({\n+            phone: p.PhoneNumber,\n+            status: p.Status,\n+            amount: p.Amount,\n+            paymentDate: p.PaymentDate,\n+            isPaid\n+        });\n+\n+    } catch (err) {\n+        console.error(\"loadPaymentStatus error:\", err);\n+        res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n+    }\n+};\n"
                },
                {
                    "date": 1763968367373,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -307,4 +307,63 @@\n         console.error(\"loadPaymentStatus error:\", err);\n         res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n     }\n };\n+export const payForService = async (req, res) => {\n+    try {\n+        const { phone, serviceName, amount } = req.body;\n+        const residentID = req.user?.ResidentID;\n+        const nationalID = req.user?.NationalID;\n+\n+        if (!residentID || !nationalID) {\n+            return res.status(401).json({ error: \"Missing resident data in token\" });\n+        }\n+        if (!phone || !serviceName || !amount) {\n+            return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n+        }\n+\n+        const pool = await dbPool;\n+\n+        // Insert into Payments table\n+        const paymentResult = await pool.request()\n+            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n+            .input(\"ResidentID\", sql.Int, residentID)\n+            .input(\"NationalID\", sql.VarChar(50), nationalID)\n+            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n+            .input(\"Amount\", sql.Decimal(18,2), amount)\n+            .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n+            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n+            .query(`\n+                INSERT INTO Payments \n+                (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n+                OUTPUT INSERTED.*\n+                VALUES \n+                (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n+            `);\n+\n+        // Insert into PaymentHistory table\n+        await pool.request()\n+            .input(\"ResidentID\", sql.Int, residentID)\n+            .input(\"Amount\", sql.Decimal(18, 2), amount)\n+            .input(\"NationalID\", sql.VarChar(50), nationalID)\n+            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n+            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n+            .input(\"VerifiedDate\", sql.DateTime, null)\n+            .input(\"Reference\", sql.VarChar(100), serviceName)\n+            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n+            .query(`\n+                INSERT INTO PaymentHistory\n+                (ResidentID, Amount, NationalID, ServiceName, PhoneNumber, VerifiedDate, Status, PaymentDate, Reference)\n+                VALUES\n+                (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n+            `);\n+\n+        res.status(201).json({\n+            message: \"Payment initialized successfully\",\n+            payment: paymentResult.recordset[0]\n+        });\n+\n+    } catch (err) {\n+        console.error(\"payForService error:\", err);\n+        res.status(500).json({ error: \"Payment failed\", details: err.message });\n+    }\n+};\n"
                },
                {
                    "date": 1763968566212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -366,4 +366,23 @@\n         console.error(\"payForService error:\", err);\n         res.status(500).json({ error: \"Payment failed\", details: err.message });\n     }\n };\n+/* ===========================================================\n+   SYNC RESIDENTS (Admin)\n+=========================================================== */\n+export const syncResidents = async (req, res) => {\n+    try {\n+        console.log(\"Sync triggered by admin:\", req.user?.id);\n+\n+        // If you plan to sync external DB, add logic here.\n+        // For now, respond OK so backend does not crash.\n+\n+        res.json({\n+            message: \"Residents synced successfully (placeholder).\"\n+        });\n+\n+    } catch (err) {\n+        console.error(\"syncResidents error:\", err);\n+        res.status(500).json({ error: \"Failed to sync residents\" });\n+    }\n+};\n"
                }
            ],
            "date": 1763641226781,
            "name": "Commit-0",
            "content": "// residentsController.js\n\n// ============================================================\n// IMPORTS\n// ============================================================\nimport sql from \"mssql\";\nimport { dbPool } from \"../server.js\";\n\n// ============================================================\n// DASHBOARD SUMMARY (ADMIN)\n// ============================================================\nexport const getDashboardSummary = async (req, res) => {\n    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n    const OVERRIDES_TABLE = \"[EstateAccessManagementSystem].[dbo].[gate_overrides]\";\n\n    try {\n        const pool = await dbPool;\n\n        const totalResidentsResult = await pool.request().query(\n            \"SELECT COUNT(ResidentID) AS residents FROM Residents\"\n        );\n        const residents = totalResidentsResult.recordset[0]?.residents || 0;\n\n        const pendingPaymentsResult = await pool\n            .request()\n            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n            .query(\"SELECT COUNT(PaymentID) AS pendingPayments FROM Payments WHERE Status = @StatusPending\");\n        const pendingPayments = pendingPaymentsResult.recordset[0]?.pendingPayments || 0;\n\n        const paidResidentsCountResult = await pool\n            .request()\n            .input(\"StatusVerified\", sql.NVarChar(50), 'Verified')\n            .query(\"SELECT COUNT(DISTINCT ResidentID) AS paidResidents FROM Payments WHERE Status = @StatusVerified\");\n        const paidResidents = paidResidentsCountResult.recordset[0]?.paidResidents || 0;\n\n        const compliance = residents > 0 ? Math.round((parseFloat(paidResidents) / residents) * 100) : 0;\n\n        const overrideMetricsResult = await pool.request().query(`\n            SELECT COUNT(id) AS overrideCount\n            FROM ${OVERRIDES_TABLE}\n            WHERE CAST(createdAt AS DATE) = CAST(GETDATE() AS DATE);\n        `);\n        const overrideCount = overrideMetricsResult.recordset[0]?.overrideCount || 0;\n\n        const accessMetricsResult = await pool.request().query(`\n            SELECT \n                SUM(CASE WHEN [Action] = 'CheckIn' THEN 1 ELSE 0 END) AS visitorscheckedin,\n                SUM(CASE WHEN [Action] = 'CheckOut' THEN 1 ELSE 0 END) AS visitorscheckedout,\n                SUM(CASE WHEN [Action] = 'Access Denied' THEN 1 ELSE 0 END) AS rejects \n            FROM ${ACCESS_LOGS_TABLE}\n            WHERE CAST(TimestampUtc AS DATE) = CAST(GETDATE() AS DATE);\n        `);\n        const accessData = accessMetricsResult.recordset[0] || {\n            visitorscheckedin: 0,\n            visitorscheckedout: 0,\n            rejects: 0,\n        };\n\n        res.status(200).json({\n            residents,\n            pendingPayments,\n            compliance,\n            overrideCount,\n            visitorscheckedin: accessData.visitorscheckedin,\n            visitorscheckedout: accessData.visitorscheckedout,\n            rejects: accessData.rejects,\n        });\n\n    } catch (err) {\n        console.error(\"Dashboard summary error:\", err.stack);\n        res.status(500).json({ error: \"Failed to load dashboard summary\", details: err.message });\n    }\n};\n\n// ============================================================\n// ACCESS CHART (ADMIN)\n// ============================================================\nexport const getAccessChartData = async (req, res) => {\n    const ACCESS_LOGS_TABLE = \"[EstateAccessManagementSystem].[dbo].[accesslogs]\";\n\n    try {\n        const pool = await dbPool;\n\n        const result = await pool.request().query(`\n            SELECT \n                FORMAT(TimestampUtc, 'MM/dd') AS DayLabel,\n                COUNT(*) AS AccessCount\n            FROM ${ACCESS_LOGS_TABLE}\n            WHERE TimestampUtc >= DATEADD(day, -14, GETDATE())\n            GROUP BY FORMAT(TimestampUtc, 'MM/dd')\n            ORDER BY MIN(TimestampUtc) ASC;\n        `);\n\n        res.status(200).json({\n            days: result.recordset.map(r => r.DayLabel),\n            counts: result.recordset.map(r => r.AccessCount),\n        });\n    } catch (err) {\n        console.error(\"Access chart error:\", err.stack);\n        res.status(500).json({ error: \"Failed to load chart\", details: err.message });\n    }\n};\n\n// ============================================================\n// RESIDENT PROFILE\n// ============================================================\nexport const getResidentProfile = async (req, res) => {\n    try {\n        const residentId = req.user?.ResidentID;\n        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n\n        const pool = await dbPool;\n\n        const result = await pool.request()\n            .input(\"ResidentID\", sql.Int, residentId)\n            .query(\"SELECT * FROM Residents WHERE ResidentID = @ResidentID\");\n\n        if (!result.recordset.length) return res.status(404).json({ error: \"Resident not found\" });\n\n        res.status(200).json(result.recordset[0]);\n    } catch (err) {\n        console.error(\"Resident profile error:\", err);\n        res.status(500).json({ error: \"Failed to load profile\", details: err.message });\n    }\n};\n\n// ============================================================\n// ALL RESIDENTS (ADMIN)\n// ============================================================\nexport const getAllResidents = async (req, res) => {\n    try {\n        const pool = await dbPool;\n        const result = await pool.request().query(\"SELECT * FROM Residents ORDER BY ResidentName ASC\");\n        res.status(200).json(result.recordset);\n    } catch (err) {\n        res.status(500).json({ error: \"Failed to load residents\", details: err.message });\n    }\n};\n\n// ============================================================\n// VISITOR ACCESS\n// ============================================================\nexport const getVisitorsAccess = async (req, res) => {\n    try {\n        const residentId = req.user?.ResidentID;\n        if (!residentId) return res.status(400).json({ error: \"Resident ID missing in token\" });\n\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"ResidentID\", sql.Int, residentId)\n            .query(\"SELECT TOP 50 * FROM Visitors WHERE ResidentID = @ResidentID ORDER BY VisitDate DESC\");\n\n        res.status(200).json({ visitors: result.recordset });\n    } catch (err) {\n        console.error(\"Failed to load visitor access\", err);\n        res.status(500).json({ error: \"Failed to load visitor access\", details: err.message });\n    }\n};\n\n// ============================================================\n// VISITOR PASSES\n// ============================================================\nexport const getVisitorPasses = async (req, res) => {\n    const residentID = req.user?.ResidentID;\n    if (!residentID) return res.status(401).json({ error: \"Unauthorized or missing user context in token.\" });\n\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input('ResidentID', sql.Int, residentID)\n            .query(`\n                SELECT VisitorName, AccessCode, Status \n                FROM VisitorsAccess\n                WHERE ResidentID = @ResidentID\n                ORDER BY CreatedAt DESC\n            `);\n\n        res.status(200).json(result.recordset || []);\n    } catch (err) {\n        console.error(\"Error retrieving visitor passes:\", err);\n        res.status(500).json({ error: \"Failed to retrieve visitor passes\" });\n    }\n};\n\n// ============================================================\n// MEMBERSHIP REQUESTS (MODIFIED for Admin/Resident split)\n// ============================================================\nexport const getMembershipRequests = async (req, res) => {\n    const residentNationalID = req.user?.NationalID;\n    const residentRole = req.user?.RoleName; // Assuming RoleName is passed in the token\n    \n    // Determine if the user is an Admin (or similar high-privilege role)\n    // IMPORTANT: Adjust this check if your admin role is named differently or if you use a dedicated isAdmin flag.\n    const isAdmin = residentRole && residentRole.toLowerCase() === 'admin';\n    \n    try {\n        const pool = await dbPool;\n        let query;\n        let request = pool.request();\n\n        if (isAdmin) {\n            // Admin: Fetch all membership requests\n            query = `\n                SELECT \n                    RequestID, ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, Status, RequestedAt \n                FROM MembershipRequests \n                ORDER BY RequestedAt DESC\n            `;\n        } else if (residentNationalID) {\n            // Resident: Fetch only their own requests\n            request = request.input(\"NationalID\", sql.VarChar(50), residentNationalID);\n            query = `\n                SELECT \n                    RequestID, ResidentName, Status, RequestedAt \n                FROM MembershipRequests \n                WHERE NationalID = @NationalID \n                ORDER BY RequestedAt DESC\n            `;\n        } else {\n            // Unauthorized or invalid token for non-admin\n             return res.status(401).json({ error: \"Unauthorized or missing user context.\" });\n        }\n\n        const result = await request.query(query);\n        res.status(200).json(result.recordset);\n\n    } catch (err) {\n        console.error(\"Failed to load membership requests:\", err);\n        res.status(500).json({ error: \"Failed to load membership requests\", details: err.message });\n    }\n};\n\n// ============================================================\n// ADMIN ACTION: APPROVE RESIDENT\n// ============================================================\nexport const approveResidentController = async (req, res) => {\n    const { requestID } = req.body;\n    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n\n    try {\n        const pool = await dbPool;\n        const tx = new sql.Transaction(pool);\n        await tx.begin();\n\n        try {\n            // 1. Update MembershipRequest status to 'Approved'\n            const updateRequestResult = await tx.request()\n                .input(\"RequestID\", sql.Int, requestID)\n                .input(\"StatusApproved\", sql.NVarChar, 'Approved')\n                .query(\"UPDATE MembershipRequests SET Status = @StatusApproved WHERE RequestID = @RequestID AND Status <> 'Synced'\");\n\n            if (updateRequestResult.rowsAffected[0] === 0) {\n                 await tx.rollback();\n                 return res.status(404).json({ error: \"Request not found or already processed.\" });\n            }\n\n            // 2. Insert the resident into the Residents table (sync logic)\n            const requestDataResult = await tx.request()\n                .input(\"RequestID\", sql.Int, requestID)\n                .query(\"SELECT * FROM MembershipRequests WHERE RequestID = @RequestID\");\n            \n            const r = requestDataResult.recordset[0];\n            if (!r) {\n                await tx.rollback();\n                return res.status(404).json({ error: \"Original request data not found.\" });\n            }\n            \n            // Check if the resident already exists in the Residents table (optional, for safety)\n            const existingResidentCheck = await tx.request()\n                .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                .query(\"SELECT ResidentID FROM Residents WHERE NationalID = @NationalID\");\n            \n            let newResidentID;\n            \n            if (existingResidentCheck.recordset.length === 0) {\n                 // Insert new resident\n                 const insertResult = await tx.request()\n                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n                    .input(\"Email\", sql.NVarChar, r.Email)\n                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n                    .input(\"DateJoined\", sql.DateTime, new Date())\n                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n                    .query(`\n                        INSERT INTO Residents\n                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n                        OUTPUT INSERTED.ResidentID\n                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n                    `);\n                    newResidentID = insertResult.recordset[0].ResidentID;\n            } else {\n                 // Resident already exists, use existing ID and update request status to synced\n                 newResidentID = existingResidentCheck.recordset[0].ResidentID;\n            }\n\n            // 3. Update the Request with the new ResidentID (RecordID) and set status to Synced\n            await tx.request()\n                .input(\"RecordID\", sql.Int, newResidentID)\n                .input(\"RequestID\", sql.Int, requestID)\n                .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n                .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n\n\n            await tx.commit();\n            res.status(200).json({ message: \"Resident approved and synced successfully.\", residentID: newResidentID });\n\n        } catch (err) {\n            await tx.rollback();\n            throw err;\n        }\n\n    } catch (err) {\n        console.error(\"Approve resident error:\", err);\n        res.status(500).json({ error: \"Failed to approve resident\", details: err.message });\n    }\n};\n\n\n// ============================================================\n// ADMIN ACTION: REJECT RESIDENT\n// ============================================================\nexport const rejectResidentController = async (req, res) => {\n    const { requestID, reason } = req.body;\n    if (!requestID) return res.status(400).json({ error: \"Request ID is required.\" });\n\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"RequestID\", sql.Int, requestID)\n            .input(\"StatusRejected\", sql.NVarChar(50), 'Rejected')\n            .input(\"Reason\", sql.NVarChar(255), reason || 'Rejected by administrator.')\n            .query(\"UPDATE MembershipRequests SET Status = @StatusRejected, AdminNotes = @Reason WHERE RequestID = @RequestID AND Status = 'Pending'\");\n\n        if (result.rowsAffected[0] === 0) {\n            return res.status(404).json({ error: \"Request not found or already processed.\" });\n        }\n\n        res.status(200).json({ message: `Membership request ${requestID} rejected.` });\n\n    } catch (err) {\n        console.error(\"Reject resident error:\", err);\n        res.status(500).json({ error: \"Failed to reject resident\", details: err.message });\n    }\n};\n\n\n// ============================================================\n// APPROVED RESIDENTS\n// ============================================================\nexport const getApprovedResidents = async (req, res) => {\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"StatusApproved\", sql.NVarChar(50), 'Active') // Fetches 'Active' status from Residents table\n            .query(\"SELECT * FROM Residents WHERE Status = @StatusApproved ORDER BY ResidentName ASC\");\n        res.status(200).json(result.recordset);\n    } catch (err) {\n        console.error(err);\n        res.status(500).json({ error: \"Failed to load approved residents\", details: err.message });\n    }\n};\n\n// ============================================================\n// PAYMENT STATUS\n// ============================================================\nexport const getPaymentStatusController = async (req, res) => {\n    const phone = req.query.phone;\n    if (!phone) return res.status(400).json({ error: \"Phone required\" });\n\n    try {\n        const pool = await dbPool;\n        const result = await pool.request()\n            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n            .query(\"SELECT TOP 1 * FROM Payments WHERE PhoneNumber = @PhoneNumber ORDER BY PaymentID DESC\");\n\n        if (!result.recordset.length) return res.status(200).json({ isPaid: false, status: \"No Record Found\", phone });\n\n        const p = result.recordset[0];\n        const isPaid = [\"paid\", \"verified\"].includes(p.Status?.toLowerCase());\n\n        res.status(200).json({\n            phone: p.PhoneNumber,\n            status: p.Status,\n            amount: p.Amount,\n            paymentDate: p.PaymentDate,\n            isPaid,\n        });\n    } catch (err) {\n        console.error(err);\n        res.status(500).json({ error: \"Failed to fetch payment status\", details: err.message });\n    }\n};\n\n// Alias for backward compatibility\nexport const loadPaymentStatus = getPaymentStatusController;\n\n// ============================================================\n// PAY FOR SERVICE\n// ============================================================\n// ------------------------------------------------------------------\n// PAY FOR SERVICE (records in Payments + PaymentHistory)\n// ------------------------------------------------------------------\nexport const payForService = async (req, res) => {\n    try {\n        const { phone, serviceName, amount } = req.body;\n        const nationalID = req.user.NationalID;\n        const residentID = req.user.ResidentID;\n\n        if (!nationalID || !residentID)\n            return res.status(401).json({ error: \"Missing resident data in token\" });\n\n        if (!phone || !serviceName || !amount)\n            return res.status(400).json({ error: \"phone, serviceName & amount required\" });\n\n        const pool = await dbPool;\n\n        // 1️⃣ Insert into Payments\n        const result = await pool.request()\n            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n            .input(\"NationalID\", sql.VarChar(50), nationalID)\n            .input(\"ResidentID\", sql.Int, residentID)\n            .input(\"ServiceName\", sql.NVarChar(100), serviceName)\n            .input(\"Amount\", sql.Decimal(18, 2), amount)\n            .input(\"PaymentMethod\", sql.NVarChar(50), \"M-Pesa\")\n            .input(\"StatusPending\", sql.NVarChar(50), \"Pending\")\n            .query(`\n                INSERT INTO Payments\n                    (PhoneNumber, NationalID, ResidentID, ServiceName, Amount, PaymentMethod, Status, PaymentDate)\n                OUTPUT INSERTED.*\n                VALUES\n                    (@PhoneNumber, @NationalID, @ResidentID, @ServiceName, @Amount, @PaymentMethod, @StatusPending, GETDATE())\n            `);\n\n        // 2️⃣ Insert into PaymentHistory with additional columns\n        await pool.request()\n            .input(\"ResidentID\", sql.Int, residentID)\n            .input(\"Amount\", sql.Decimal(18, 2), amount)\n            .input(\"NationalID\", sql.VarChar(50), nationalID)\n            .input(\"ServiceName\", sql.NVarChar(100), serviceName || null)\n            .input(\"PhoneNumber\", sql.VarChar(20), phone)\n            .input(\"VerifiedDate\", sql.DateTime, null) // initially null\n            .input(\"Reference\", sql.VarChar(100), serviceName || null)\n            .input(\"StatusPending\", sql.NVarChar(50), 'Pending')\n            .query(`\n                INSERT INTO PaymentHistory \n                (ResidentID, Amount, NationalID, ServiceName, PhoneNumber, VerifiedDate, Status, PaymentDate, Reference)\n                VALUES \n                (@ResidentID, @Amount, @NationalID, @ServiceName, @PhoneNumber, @VerifiedDate, @StatusPending, GETDATE(), @Reference)\n            `);\n\n\n        res.status(201).json({\n            message: \"Payment initialized and history recorded\",\n            payment: result.recordset[0],\n        });\n\n    } catch (err) {\n        res.status(500).json({\n            error: \"Payment failed\",\n            details: err.message,\n        });\n    }\n};\n\n\n// ============================================================\n// SYNC RESIDENTS (Utility function, kept for reference but logic moved to approveResidentController)\n// ============================================================\nexport const syncResidents = async (req, res) => {\n    try {\n        const pool = await dbPool;\n        const tx = new sql.Transaction(pool);\n        await tx.begin();\n\n        try {\n            const pendingRequestsResult = await tx.request()\n                .input(\"StatusApproved\", sql.NVarChar(50), 'Approved')\n                .query(\"SELECT * FROM MembershipRequests WHERE Status = @StatusApproved AND RecordID IS NULL\");\n\n            const pending = pendingRequestsResult.recordset;\n            if (!pending.length) {\n                await tx.commit();\n                return res.status(200).json({ message: \"No new residents to sync.\" });\n            }\n\n            let synced = 0;\n            for (const r of pending) {\n                const insertResult = await tx.request()\n                    .input(\"ResidentName\", sql.NVarChar, r.ResidentName)\n                    .input(\"NationalID\", sql.NVarChar, r.NationalID)\n                    .input(\"PhoneNumber\", sql.NVarChar, r.PhoneNumber)\n                    .input(\"Email\", sql.NVarChar, r.Email)\n                    .input(\"HouseNumber\", sql.NVarChar, r.HouseNumber)\n                    .input(\"CourtName\", sql.NVarChar, r.CourtName)\n                    .input(\"RoleName\", sql.NVarChar, r.RoleName)\n                    .input(\"DateJoined\", sql.DateTime, new Date())\n                    .input(\"StatusActive\", sql.NVarChar, 'Active')\n                    .query(`\n                        INSERT INTO Residents\n                        (ResidentName, NationalID, PhoneNumber, Email, HouseNumber, CourtName, RoleName, DateJoined, Status)\n                        OUTPUT INSERTED.ResidentID\n                        VALUES (@ResidentName, @NationalID, @PhoneNumber, @Email, @HouseNumber, @CourtName, @RoleName, @DateJoined, @StatusActive)\n                    `);\n\n                const newResidentID = insertResult.recordset[0].ResidentID;\n\n                await tx.request()\n                    .input(\"RecordID\", sql.Int, newResidentID)\n                    .input(\"RequestID\", sql.Int, r.RequestID)\n                    .input(\"StatusSynced\", sql.NVarChar, 'Synced')\n                    .query(\"UPDATE MembershipRequests SET RecordID = @RecordID, Status = @StatusSynced WHERE RequestID = @RequestID\");\n\n                synced++;\n            }\n\n            await tx.commit();\n            res.status(200).json({ message: `Successfully synced ${synced} resident(s).` });\n\n        } catch (err) {\n            await tx.rollback();\n            throw err;\n        }\n\n    } catch (err) {\n        console.error(err);\n        res.status(500).json({ error: \"Failed to sync residents\", details: err.message });\n    }\n};\nexport const payController = payForService;"
        }
    ]
}