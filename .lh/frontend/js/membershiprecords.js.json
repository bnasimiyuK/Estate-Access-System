{
    "sourceFile": "frontend/js/membershiprecords.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 12,
            "patches": [
                {
                    "date": 1763638727824,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763667797431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,10 +10,439 @@\n \r\n     // Helper to display messages without using alert()\r\n     function displayMessage(text, isError = false) {\r\n         if (msg) {\r\n+            msg.textContent = text;// =======================================================\r\n+// membershiprecords.js - Client-side logic for the Admin/Records page\r\n+// =======================================================\r\n+console.log(\"ðŸ“˜ membershiprecords.js loaded\");\r\n+\r\n+// Use PATCH for Approve/Reject as it is semantically correct for updating status.\r\n+const API_BASE = \"http://localhost:4050/api/membershiprecords\";\r\n+\r\n+document.addEventListener(\"DOMContentLoaded\", async () => {\r\n+    console.log(\"ðŸš€ DOM fully loaded, initializing membership records...\");\r\n+\r\n+    // Token must be retrieved here to be available inside the closure\r\n+    const token = localStorage.getItem(\"token\");\r\n+    const msg = document.getElementById(\"msg\"); // Message display area\r\n+\r\n+    let allRecords = [];\r\n+    let membershipPage = 1, membershipPerPage = 10;\r\n+    let approvedPage = 1, approvedPerPage = 10;\r\n+\r\n+    // Helper to display messages without using alert()\r\n+    function displayMessage(text, isError = false) {\r\n+        if (msg) {\r\n             msg.textContent = text;\r\n             msg.classList.toggle('text-red-500', isError);\r\n+            msg.classList.toggle('text-green-500', !isError && !text.includes('Error') && !text.includes('Loading'));\r\n+            \r\n+            // Auto-clear non-error messages after a delay\r\n+            if (!isError && !text.includes('Loading')) {\r\n+                setTimeout(() => {\r\n+                    msg.classList.remove('text-green-500');\r\n+                    // Reset to show total count if no other message is pending\r\n+                    if (msg.textContent === text && allRecords.length > 0) { \r\n+                        msg.textContent = `Showing ${allRecords.length} total record(s).`;\r\n+                    } else if (msg.textContent === text) {\r\n+                        // Check for the specific \"Access Denied\" message before resetting\r\n+                        if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n+                            msg.textContent = \"No records loaded.\";\r\n+                        }\r\n+                    }\r\n+                }, 5000);\r\n+            }\r\n+        } else {\r\n+            console.log(`[UI Message] ${isError ? 'ERROR: ' : ''}${text}`);\r\n+        }\r\n+    }\r\n+\r\n+    if (!token) {\r\n+        displayMessage(\"Authentication required. Please log in.\", true);\r\n+        return;\r\n+    }\r\n+    \r\n+    // UI Elements\r\n+    const membershipCount = document.getElementById(\"membershipCount\");\r\n+    const statusLabel = document.getElementById(\"statusLabel\");\r\n+    const actionText = document.getElementById(\"actionText\");\r\n+    const tableBody = document.getElementById(\"membershipTableBody\");\r\n+    const residentsBody = document.getElementById(\"residentsTableBody\");\r\n+    const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n+    const residentFilter = document.getElementById(\"residentFilter\");\r\n+    const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n+    const syncBtn = document.getElementById(\"syncBtn\");\r\n+\r\n+    // Pagination containers (Ensure they exist)\r\n+    let membershipPagination = document.querySelector('.membership-pagination');\r\n+    if (!membershipPagination) {\r\n+        membershipPagination = document.createElement(\"div\");\r\n+        membershipPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-4\", \"membership-pagination\");\r\n+        // Find a place to insert it if it wasn't in the HTML, e.g., after the membership table container\r\n+        document.querySelector('.p-6.overflow-x-auto.mb-6')?.after(membershipPagination);\r\n+    }\r\n+\r\n+    let approvedPagination = document.querySelector('.approved-pagination');\r\n+    if (!approvedPagination) {\r\n+        approvedPagination = document.createElement(\"div\");\r\n+        approvedPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-2\", \"approved-pagination\");\r\n+        // Find a place to insert it if it wasn't in the HTML\r\n+        document.querySelector('.bg-white.rounded-xl.border.border-gray-300.shadow-md.p-6')?.after(approvedPagination);\r\n+    }\r\n+\r\n+    // ======================================================\r\n+    // ðŸ”„ Sync Records\r\n+    // ======================================================\r\n+    async function syncRecords() {\r\n+        displayMessage(\"Syncing records...\");\r\n+        if (syncBtn) syncBtn.disabled = true;\r\n+\r\n+        try {\r\n+            const res = await fetch(`${API_BASE}/sync`, {\r\n+                method: \"POST\",\r\n+                headers: {\r\n+                    \"Authorization\": `Bearer ${token}`,\r\n+                    \"Content-Type\": \"application/json\"\r\n+                }\r\n+            });\r\n+\r\n+            if (res.status === 403) {\r\n+                throw new Error(\"Access Denied: You do not have permission to sync records.\");\r\n+            }\r\n+\r\n+            const data = await res.json();\r\n+            if (!res.ok) {\r\n+                throw new Error(data.message || \"Sync failed on server.\");\r\n+            }\r\n+\r\n+            console.log(\"âœ… Sync success:\", data.message || \"Done\");\r\n+            displayMessage(data.message || \"Sync complete.\", false);\r\n+\r\n+            await loadMembershipRecords(); // Reload data AFTER successful sync\r\n+        } catch (err) {\r\n+            console.error(\"âŒ Sync failed:\", err);\r\n+            displayMessage(`Sync failed: ${err.message}`, true);\r\n+        } finally {\r\n+            if (syncBtn) syncBtn.disabled = false;\r\n+        }\r\n+    }\r\n+\r\n+    // ======================================================\r\n+    // ðŸ“¥ Load membership records (Primary Function)\r\n+    // ======================================================\r\n+    async function loadMembershipRecords() {\r\n+        displayMessage(\"Loading...\");\r\n+\r\n+        try {\r\n+            // Backend route: /api/membershiprecords/all\r\n+            const res = await fetch(`${API_BASE}/all`, {\r\n+                headers: {\r\n+                    \"Authorization\": `Bearer ${token}`,\r\n+                    \"Content-Type\": \"application/json\"\r\n+                }\r\n+            });\r\n+\r\n+            // --- ðŸ”¥ CRITICAL FIX: Gracefully handle 403 for Resident users ---\r\n+            if (res.status === 403) {\r\n+                console.warn(\"âš ï¸ Access denied (403). Assuming resident role. Displaying empty dashboard.\");\r\n+                allRecords = [];\r\n+                applyFilters();\r\n+                // Display a status message appropriate for a restricted user\r\n+                displayMessage(\"Access Denied: You do not have permission to view all records.\", false);\r\n+                return; // Stop processing the response body\r\n+            }\r\n+            // --- END CRITICAL FIX ---\r\n+\r\n+\r\n+            const data = await res.json();\r\n+            if (!res.ok || !data.success) throw new Error(data.message || \"Failed to fetch records.\");\r\n+\r\n+            // CRITICAL: Use data.records, as set in the controller\r\n+            allRecords = Array.isArray(data.records) ? data.records : [];\r\n+\r\n+            membershipPage = 1;\r\n+            approvedPage = 1;\r\n+\r\n+            applyFilters();\r\n+            populateDropdownFilters(allRecords);\r\n+            // Display success message only if records were actually loaded (i.e., user is admin)\r\n+            displayMessage(`Loaded ${allRecords.length} total record(s).`, false);\r\n+\r\n+        } catch (err) {\r\n+            console.error(\"âŒ Fetch error:\", err);\r\n+            displayMessage(`Error loading records: ${err.message}`, true);\r\n+        }\r\n+    }\r\n+\r\n+    // Apply filters (unchanged logic)\r\n+    function applyFilters() {\r\n+        let filteredRecords = [...allRecords];\r\n+\r\n+        const selectedId = requestIdFilter?.value || \"\";\r\n+        const selectedResident = residentFilter?.value || \"\";\r\n+\r\n+        if (selectedId) filteredRecords = filteredRecords.filter(r => String(r.RequestID) === selectedId);\r\n+        if (selectedResident) filteredRecords = filteredRecords.filter(r => r.ResidentName === selectedResident);\r\n+\r\n+        const filterInputs = document.querySelectorAll(\".header-filter\");\r\n+        const filters = {};\r\n+        filterInputs.forEach(f => {\r\n+            if (f.value.trim() !== \"\") filters[f.dataset.column] = f.value.trim().toLowerCase();\r\n+        });\r\n+\r\n+        filteredRecords = filteredRecords.filter(record => {\r\n+            return Object.entries(filters).every(([key, val]) => {\r\n+                const field = record[key] ? String(record[key]).toLowerCase() : \"\";\r\n+                return field.includes(val);\r\n+            });\r\n+        });\r\n+\r\n+        renderMembershipTable(filteredRecords);\r\n+        renderMembershipPagination(filteredRecords);\r\n+\r\n+        const approvedRecords = filteredRecords.filter(r => r.Status === \"Approved\");\r\n+        renderApprovedTable(approvedRecords);\r\n+        renderApprovedPagination(approvedRecords);\r\n+    }\r\n+    \r\n+    // Render Membership Table (unchanged logic)\r\n+    function renderMembershipTable(records) {\r\n+        tableBody.innerHTML = \"\";\r\n+        if (!records.length) {\r\n+            updateUIStats([]);\r\n+            updateApprovedCount([]);\r\n+            // Display a message if the table is empty due to filters\r\n+            if (allRecords.length > 0) {\r\n+                 msg.textContent = \"No matching records found.\";\r\n+            } else if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n+                 msg.textContent = \"No records loaded.\";\r\n+            }\r\n+            return;\r\n+        }\r\n+\r\n+        const start = (membershipPage - 1) * membershipPerPage;\r\n+        const end = start + membershipPerPage;\r\n+        const pageRecords = records.slice(start, end);\r\n+\r\n+        pageRecords.forEach(r => {\r\n+            const isApproved = r.Status === 'Approved';\r\n+            const isRejected = r.Status === 'Rejected';\r\n+            const row = document.createElement(\"tr\");\r\n+            row.innerHTML = `\r\n+                <td>${r.RequestID || \"-\"}</td>\r\n+                <td>${r.ResidentName || \"-\"}</td>\r\n+                <td>${r.NationalID || \"-\"}</td>\r\n+                <td>${r.PhoneNumber || \"-\"}</td>\r\n+                <td>${r.Email || \"-\"}</td>\r\n+                <td>${r.HouseNumber || \"-\"}</td>\r\n+                <td>${r.CourtName || \"-\"}</td>\r\n+                <td>${r.RoleName || \"-\"}</td>\r\n+                <td class=\"${isApproved ? 'text-green-600' : isRejected ? 'text-red-600' : 'text-yellow-600'} font-semibold\">${r.Status || \"-\"}</td>\r\n+                <td>${r.RequestedAt ? new Date(r.RequestedAt).toLocaleString() : \"-\"}</td>\r\n+                <td class=\"text-center\">\r\n+                    <button class=\"approveBtn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Approve</button>\r\n+                    <button class=\"rejectBtn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Reject</button>\r\n+                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n+                </td>\r\n+            `;\r\n+            tableBody.appendChild(row);\r\n+        });\r\n+\r\n+        updateUIStats(records);\r\n+    }\r\n+\r\n+    // Approved table (unchanged logic)\r\n+    function renderApprovedTable(records) {\r\n+        residentsBody.innerHTML = \"\";\r\n+        if (!records.length) {\r\n+            updateApprovedCount([]);\r\n+            return;\r\n+        }\r\n+\r\n+        const start = (approvedPage - 1) * approvedPerPage;\r\n+        const end = start + approvedPerPage;\r\n+        const pageRecords = records.slice(start, end);\r\n+\r\n+        pageRecords.forEach(r => {\r\n+            const row = document.createElement(\"tr\");\r\n+            row.innerHTML = `\r\n+                <td>${r.ResidentName}</td>\r\n+                <td>${r.NationalID}</td>\r\n+                <td>${r.PhoneNumber}</td>\r\n+                <td>${r.Email}</td>\r\n+                <td>${r.HouseNumber}</td>\r\n+                <td>${r.CourtName}</td>\r\n+                <td>${r.RoleName}</td>\r\n+                <td class=\"text-center\">\r\n+                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n+                </td>\r\n+            `;\r\n+            residentsBody.appendChild(row);\r\n+        });\r\n+\r\n+        updateApprovedCount(records);\r\n+    }\r\n+\r\n+    // UI Stats, Pagination, and Dropdown helpers (unchanged logic)\r\n+    function updateUIStats(records) {\r\n+        membershipCount.textContent = records.length;\r\n+\r\n+        const approved = records.filter(r => r.Status === \"Approved\").length;\r\n+        const pending = records.filter(r => r.Status === \"Pending\").length;\r\n+        const rejected = records.filter(r => r.Status === \"Rejected\").length;\r\n+\r\n+        statusLabel.textContent = `Approved: ${approved} | Pending: ${pending} | Rejected: ${rejected}`;\r\n+\r\n+        const latest = records[0]?.RequestedAt ? new Date(records[0].RequestedAt).toLocaleString() : \"N/A\";\r\n+        actionText.textContent = latest;\r\n+    }\r\n+\r\n+    function updateApprovedCount(records) {\r\n+        const approvedCountEl = document.getElementById(\"approvedCount\");\r\n+        if (approvedCountEl) approvedCountEl.textContent = records.length;\r\n+    }\r\n+\r\n+    function renderMembershipPagination(records) {\r\n+        membershipPagination.innerHTML = \"\";\r\n+        const pageCount = Math.ceil(records.length / membershipPerPage);\r\n+        if (pageCount <= 1) return;\r\n+\r\n+        for (let i = 1; i <= pageCount; i++) {\r\n+            const btn = document.createElement(\"button\");\r\n+            btn.textContent = i;\r\n+            btn.className = `px-3 py-1 border rounded ${i === membershipPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n+            btn.addEventListener(\"click\", () => {\r\n+                membershipPage = i;\r\n+                renderMembershipTable(records);\r\n+                renderMembershipPagination(records);\r\n+            });\r\n+            membershipPagination.appendChild(btn);\r\n+        }\r\n+    }\r\n+\r\n+    function renderApprovedPagination(records) {\r\n+        approvedPagination.innerHTML = \"\";\r\n+        const pageCount = Math.ceil(records.length / approvedPerPage);\r\n+        if (pageCount <= 1) return;\r\n+\r\n+        for (let i = 1; i <= pageCount; i++) {\r\n+            const btn = document.createElement(\"button\");\r\n+            btn.textContent = i;\r\n+            btn.className = `px-3 py-1 border rounded ${i === approvedPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n+            btn.addEventListener(\"click\", () => {\r\n+                approvedPage = i;\r\n+                renderApprovedTable(records);\r\n+                renderApprovedPagination(records);\r\n+            });\r\n+            approvedPagination.appendChild(btn);\r\n+        }\r\n+    }\r\n+\r\n+    function populateDropdownFilters(records) {\r\n+        if (requestIdFilter) {\r\n+            const ids = [...new Set(records.map(r => r.RequestID))].filter(id => id !== undefined && id !== null);\r\n+            requestIdFilter.innerHTML =\r\n+                `<option value=\"\">All Request IDs</option>` +\r\n+                ids.map(id => `<option value=\"${id}\">${id}</option>`).join(\"\");\r\n+        }\r\n+\r\n+        if (residentFilter) {\r\n+            const names = [...new Set(records.map(r => r.ResidentName))].filter(n => n);\r\n+            residentFilter.innerHTML =\r\n+                `<option value=\"\">All Residents</option>` +\r\n+                names.map(n => `<option value=\"${n}\">${n}</option>`).join(\"\");\r\n+        }\r\n+    }\r\n+\r\n+\r\n+    // Actions Listener\r\n+    document.addEventListener(\"click\", async (e) => {\r\n+        const btn = e.target;\r\n+        const id = btn.dataset.id;\r\n+        if (!id || btn.disabled) return;\r\n+\r\n+        let action = \"\";\r\n+        if (btn.classList.contains(\"approveBtn\")) action = \"approve\";\r\n+        else if (btn.classList.contains(\"rejectBtn\")) action = \"reject\";\r\n+        else if (btn.classList.contains(\"deleteBtn\")) {\r\n+            if (!window.confirm(\"Are you sure you want to delete this record? This will remove it from both MembershipRecords and, if it exists, MembershipRequests.\")) return; \r\n+            action = \"delete\";\r\n+        }\r\n+        if (!action) return;\r\n+\r\n+        displayMessage(`Processing ${action} for Request ID ${id}...`);\r\n+\r\n+        try {\r\n+            // Use PATCH for approve/reject based on common REST standards\r\n+            const method = action === \"delete\" ? \"DELETE\" : \"PATCH\"; \r\n+            \r\n+            // Note: The backend routes are defined as PUT for approve/reject, \r\n+            // but the client is configured to send the action name in the URL.\r\n+            // We use PATCH method here, but if the backend strictly expects PUT/DELETE:\r\n+            // const method = (action === \"approve\" || action === \"reject\") ? \"PUT\" : \"DELETE\";\r\n+            \r\n+            const res = await fetch(`${API_BASE}/${action}/${id}`, {\r\n+                method: method, // Using PATCH for status update is standard\r\n+                headers: {\r\n+                    \"Authorization\": `Bearer ${token}`,\r\n+                    \"Content-Type\": \"application/json\"\r\n+                }\r\n+            });\r\n+            \r\n+            if (res.status === 403) {\r\n+                 throw new Error(\"Access Denied: You do not have permission for this action.\");\r\n+            }\r\n+\r\n+            const data = await res.json();\r\n+            if (!data.success) {\r\n+                console.error(\"Action failed:\", data.message);\r\n+                displayMessage(`Action failed: ${data.message}`, true);\r\n+                return;\r\n+            }\r\n+\r\n+            displayMessage(data.message || `${action} action completed successfully.`);\r\n+            await loadMembershipRecords(); // Reload after action\r\n+        } catch (err) {\r\n+            console.error(\"âŒ Action error:\", err);\r\n+            displayMessage(`Action failed: ${err.message}`, true);\r\n+        }\r\n+    });\r\n+\r\n+    // Filters and Sync Button Listener (unchanged logic)\r\n+    requestIdFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n+    residentFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n+\r\n+    clearFilterBtn?.addEventListener(\"click\", () => {\r\n+        if(requestIdFilter) requestIdFilter.value = \"\";\r\n+        if(residentFilter) residentFilter.value = \"\";\r\n+        document.querySelectorAll(\".header-filter\").forEach(f => (f.value = \"\"));\r\n+        membershipPage = 1;\r\n+        approvedPage = 1;\r\n+        applyFilters();\r\n+    });\r\n+\r\n+    document.querySelectorAll(\".header-filter\").forEach(input =>\r\n+        input.addEventListener(\"input\", () => {\r\n+            membershipPage = 1;\r\n+            approvedPage = 1;\r\n+            applyFilters();\r\n+        })\r\n+    );\r\n+\r\n+    // Sync button listener\r\n+    syncBtn?.addEventListener(\"click\", () => {\r\n+        syncRecords();\r\n+    });\r\n+\r\n+    // ======================================================\r\n+    // INITIAL LOAD â€” Fetch records only\r\n+    // ======================================================\r\n+    await loadMembershipRecords();\r\n+    \r\n+    // ðŸ”¥ CRITICAL CLEANUP: The duplicate global loadMembershipRecords function below must be removed.\r\n+});\r\n+            msg.classList.toggle('text-red-500', isError);\r\n             msg.classList.toggle('text-green-500', !isError && !text.includes('Error'));\r\n             \r\n             // Auto-clear non-error messages after a delay\r\n             if (!isError && !text.includes('Loading')) {\r\n"
                },
                {
                    "date": 1763671681463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,890 +1,303 @@\n-console.log(\"ðŸ“˜ membershiprecords.js loaded\");\r\n+// --- ENVIRONMENT SETUP ---\r\n+// Define variables pointing to your actual backend API\r\n+const API_HOST = \"http://api.estate-management.com\"; \r\n+const token = \"MOCK_AUTH_TOKEN_ABC123\"; // NOTE: This token should be dynamically retrieved (e.g., from local storage or session) after successful login.\r\n \r\n-const API_BASE = \"http://localhost:4050/api/membershiprecords\";\r\n+// Define API Endpoints\r\n+const ENDPOINTS = {\r\n+    SYNC: `${API_HOST}/api/admin/sync`,\r\n+    PENDING_REQUESTS: `${API_HOST}/api/admin/requests/pending`,\r\n+    APPROVED_RESIDENTS: `${API_HOST}/api/admin/residents/approved`,\r\n+    APPROVE_REQUEST: (id) => `${API_HOST}/api/admin/requests/approve/${id}`,\r\n+};\r\n \r\n-document.addEventListener(\"DOMContentLoaded\", async () => {\r\n-    console.log(\"ðŸš€ DOM fully loaded, initializing membership records...\");\r\n+// ====================================================================\r\n+// UTILITIES AND HELPERS\r\n+// ====================================================================\r\n \r\n-    const token = localStorage.getItem(\"token\");\r\n-    const msg = document.getElementById(\"msg\"); // Message display area\r\n+/**\r\n+ * Creates and returns the standard headers needed for authenticated API calls.\r\n+ * @returns {Headers}\r\n+ */\r\n+function getAuthHeaders() {\r\n+    return {\r\n+        'Content-Type': 'application/json',\r\n+        'Authorization': `Bearer ${token}`\r\n+    };\r\n+}\r\n \r\n-    // Helper to display messages without using alert()\r\n-    function displayMessage(text, isError = false) {\r\n-        if (msg) {\r\n-            msg.textContent = text;// =======================================================\r\n-// membershiprecords.js - Client-side logic for the Admin/Records page\r\n-// =======================================================\r\n-console.log(\"ðŸ“˜ membershiprecords.js loaded\");\r\n-\r\n-// Use PATCH for Approve/Reject as it is semantically correct for updating status.\r\n-const API_BASE = \"http://localhost:4050/api/membershiprecords\";\r\n-\r\n-document.addEventListener(\"DOMContentLoaded\", async () => {\r\n-    console.log(\"ðŸš€ DOM fully loaded, initializing membership records...\");\r\n-\r\n-    // Token must be retrieved here to be available inside the closure\r\n-    const token = localStorage.getItem(\"token\");\r\n-    const msg = document.getElementById(\"msg\"); // Message display area\r\n-\r\n-    let allRecords = [];\r\n-    let membershipPage = 1, membershipPerPage = 10;\r\n-    let approvedPage = 1, approvedPerPage = 10;\r\n-\r\n-    // Helper to display messages without using alert()\r\n-    function displayMessage(text, isError = false) {\r\n-        if (msg) {\r\n-            msg.textContent = text;\r\n-            msg.classList.toggle('text-red-500', isError);\r\n-            msg.classList.toggle('text-green-500', !isError && !text.includes('Error') && !text.includes('Loading'));\r\n-            \r\n-            // Auto-clear non-error messages after a delay\r\n-            if (!isError && !text.includes('Loading')) {\r\n-                setTimeout(() => {\r\n-                    msg.classList.remove('text-green-500');\r\n-                    // Reset to show total count if no other message is pending\r\n-                    if (msg.textContent === text && allRecords.length > 0) { \r\n-                        msg.textContent = `Showing ${allRecords.length} total record(s).`;\r\n-                    } else if (msg.textContent === text) {\r\n-                        // Check for the specific \"Access Denied\" message before resetting\r\n-                        if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n-                            msg.textContent = \"No records loaded.\";\r\n-                        }\r\n-                    }\r\n-                }, 5000);\r\n-            }\r\n-        } else {\r\n-            console.log(`[UI Message] ${isError ? 'ERROR: ' : ''}${text}`);\r\n-        }\r\n+/**\r\n+ * Handles error display in a non-alert manner.\r\n+ * @param {string} message \r\n+ * @param {boolean} isError \r\n+ */\r\n+function displayMessage(message, isError = false) {\r\n+    const msgElement = document.getElementById('msg');\r\n+    if (msgElement) {\r\n+        msgElement.textContent = message;\r\n+        msgElement.className = `p-3 rounded-lg text-sm font-semibold mb-3 ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;\r\n+        \r\n+        // Clear message after a few seconds\r\n+        setTimeout(() => {\r\n+            msgElement.textContent = '';\r\n+            msgElement.className = 'text-sm text-gray-700 mb-3';\r\n+        }, 5000);\r\n     }\r\n+}\r\n \r\n-    if (!token) {\r\n-        displayMessage(\"Authentication required. Please log in.\", true);\r\n-        return;\r\n+/**\r\n+ * Formats a timestamp (string or number) into a readable date string.\r\n+ * @param {string|number} timestamp \r\n+ * @returns {string} Formatted date string\r\n+ */\r\n+function formatTimestamp(timestamp) {\r\n+    try {\r\n+        if (!timestamp) return 'N/A';\r\n+        return new Date(timestamp).toLocaleString();\r\n+    } catch (e) {\r\n+        console.error(\"Invalid timestamp:\", timestamp);\r\n+        return 'N/A';\r\n     }\r\n-    \r\n-    // UI Elements\r\n-    const membershipCount = document.getElementById(\"membershipCount\");\r\n-    const statusLabel = document.getElementById(\"statusLabel\");\r\n-    const actionText = document.getElementById(\"actionText\");\r\n-    const tableBody = document.getElementById(\"membershipTableBody\");\r\n-    const residentsBody = document.getElementById(\"residentsTableBody\");\r\n-    const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n-    const residentFilter = document.getElementById(\"residentFilter\");\r\n-    const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n-    const syncBtn = document.getElementById(\"syncBtn\");\r\n+}\r\n \r\n-    // Pagination containers (Ensure they exist)\r\n-    let membershipPagination = document.querySelector('.membership-pagination');\r\n-    if (!membershipPagination) {\r\n-        membershipPagination = document.createElement(\"div\");\r\n-        membershipPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-4\", \"membership-pagination\");\r\n-        // Find a place to insert it if it wasn't in the HTML, e.g., after the membership table container\r\n-        document.querySelector('.p-6.overflow-x-auto.mb-6')?.after(membershipPagination);\r\n-    }\r\n+// ====================================================================\r\n+// CORE DASHBOARD LOGIC (API IMPLEMENTATION)\r\n+// ====================================================================\r\n \r\n-    let approvedPagination = document.querySelector('.approved-pagination');\r\n-    if (!approvedPagination) {\r\n-        approvedPagination = document.createElement(\"div\");\r\n-        approvedPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-2\", \"approved-pagination\");\r\n-        // Find a place to insert it if it wasn't in the HTML\r\n-        document.querySelector('.bg-white.rounded-xl.border.border-gray-300.shadow-md.p-6')?.after(approvedPagination);\r\n-    }\r\n+/**\r\n+ * Executes a real API call to trigger server-side data synchronization.\r\n+ */\r\n+async function handleSyncClick(event) {\r\n+    const btn = event.currentTarget;\r\n+    const originalText = btn.textContent;\r\n+    const originalClasses = btn.className;\r\n \r\n-    // ======================================================\r\n-    // ðŸ”„ Sync Records\r\n-    // ======================================================\r\n-    async function syncRecords() {\r\n-        displayMessage(\"Syncing records...\");\r\n-        if (syncBtn) syncBtn.disabled = true;\r\n+    // 1. Set Loading State\r\n+    btn.disabled = true;\r\n+    btn.textContent = 'Syncing...';\r\n+    btn.className = 'bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-colors duration-200 animate-pulse min-w-[100px]';\r\n \r\n-        try {\r\n-            const res = await fetch(`${API_BASE}/sync`, {\r\n-                method: \"POST\",\r\n-                headers: {\r\n-                    \"Authorization\": `Bearer ${token}`,\r\n-                    \"Content-Type\": \"application/json\"\r\n-                }\r\n-            });\r\n-\r\n-            if (res.status === 403) {\r\n-                throw new Error(\"Access Denied: You do not have permission to sync records.\");\r\n-            }\r\n-\r\n-            const data = await res.json();\r\n-            if (!res.ok) {\r\n-                throw new Error(data.message || \"Sync failed on server.\");\r\n-            }\r\n-\r\n-            console.log(\"âœ… Sync success:\", data.message || \"Done\");\r\n-            displayMessage(data.message || \"Sync complete.\", false);\r\n-\r\n-            await loadMembershipRecords(); // Reload data AFTER successful sync\r\n-        } catch (err) {\r\n-            console.error(\"âŒ Sync failed:\", err);\r\n-            displayMessage(`Sync failed: ${err.message}`, true);\r\n-        } finally {\r\n-            if (syncBtn) syncBtn.disabled = false;\r\n-        }\r\n-    }\r\n-\r\n-    // ======================================================\r\n-    // ðŸ“¥ Load membership records (Primary Function)\r\n-    // ======================================================\r\n-    async function loadMembershipRecords() {\r\n-        displayMessage(\"Loading...\");\r\n-\r\n-        try {\r\n-            // Backend route: /api/membershiprecords/all\r\n-            const res = await fetch(`${API_BASE}/all`, {\r\n-                headers: {\r\n-                    \"Authorization\": `Bearer ${token}`,\r\n-                    \"Content-Type\": \"application/json\"\r\n-                }\r\n-            });\r\n-\r\n-            // --- ðŸ”¥ CRITICAL FIX: Gracefully handle 403 for Resident users ---\r\n-            if (res.status === 403) {\r\n-                console.warn(\"âš ï¸ Access denied (403). Assuming resident role. Displaying empty dashboard.\");\r\n-                allRecords = [];\r\n-                applyFilters();\r\n-                // Display a status message appropriate for a restricted user\r\n-                displayMessage(\"Access Denied: You do not have permission to view all records.\", false);\r\n-                return; // Stop processing the response body\r\n-            }\r\n-            // --- END CRITICAL FIX ---\r\n-\r\n-\r\n-            const data = await res.json();\r\n-            if (!res.ok || !data.success) throw new Error(data.message || \"Failed to fetch records.\");\r\n-\r\n-            // CRITICAL: Use data.records, as set in the controller\r\n-            allRecords = Array.isArray(data.records) ? data.records : [];\r\n-\r\n-            membershipPage = 1;\r\n-            approvedPage = 1;\r\n-\r\n-            applyFilters();\r\n-            populateDropdownFilters(allRecords);\r\n-            // Display success message only if records were actually loaded (i.e., user is admin)\r\n-            displayMessage(`Loaded ${allRecords.length} total record(s).`, false);\r\n-\r\n-        } catch (err) {\r\n-            console.error(\"âŒ Fetch error:\", err);\r\n-            displayMessage(`Error loading records: ${err.message}`, true);\r\n-        }\r\n-    }\r\n-\r\n-    // Apply filters (unchanged logic)\r\n-    function applyFilters() {\r\n-        let filteredRecords = [...allRecords];\r\n-\r\n-        const selectedId = requestIdFilter?.value || \"\";\r\n-        const selectedResident = residentFilter?.value || \"\";\r\n-\r\n-        if (selectedId) filteredRecords = filteredRecords.filter(r => String(r.RequestID) === selectedId);\r\n-        if (selectedResident) filteredRecords = filteredRecords.filter(r => r.ResidentName === selectedResident);\r\n-\r\n-        const filterInputs = document.querySelectorAll(\".header-filter\");\r\n-        const filters = {};\r\n-        filterInputs.forEach(f => {\r\n-            if (f.value.trim() !== \"\") filters[f.dataset.column] = f.value.trim().toLowerCase();\r\n+    try {\r\n+        // --- REAL API CALL ---\r\n+        const resp = await fetch(ENDPOINTS.SYNC, { \r\n+            method: 'POST',\r\n+            headers: getAuthHeaders(),\r\n         });\r\n \r\n-        filteredRecords = filteredRecords.filter(record => {\r\n-            return Object.entries(filters).every(([key, val]) => {\r\n-                const field = record[key] ? String(record[key]).toLowerCase() : \"\";\r\n-                return field.includes(val);\r\n-            });\r\n-        });\r\n-\r\n-        renderMembershipTable(filteredRecords);\r\n-        renderMembershipPagination(filteredRecords);\r\n-\r\n-        const approvedRecords = filteredRecords.filter(r => r.Status === \"Approved\");\r\n-        renderApprovedTable(approvedRecords);\r\n-        renderApprovedPagination(approvedRecords);\r\n-    }\r\n-    \r\n-    // Render Membership Table (unchanged logic)\r\n-    function renderMembershipTable(records) {\r\n-        tableBody.innerHTML = \"\";\r\n-        if (!records.length) {\r\n-            updateUIStats([]);\r\n-            updateApprovedCount([]);\r\n-            // Display a message if the table is empty due to filters\r\n-            if (allRecords.length > 0) {\r\n-                 msg.textContent = \"No matching records found.\";\r\n-            } else if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n-                 msg.textContent = \"No records loaded.\";\r\n-            }\r\n-            return;\r\n+        if (!resp.ok) {\r\n+            // Attempt to read server error message\r\n+            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n+            throw new Error(errorData.message || `Sync failed with status: ${resp.status}`);\r\n         }\r\n+        // --- END REAL API CALL ---\r\n \r\n-        const start = (membershipPage - 1) * membershipPerPage;\r\n-        const end = start + membershipPerPage;\r\n-        const pageRecords = records.slice(start, end);\r\n+        // 2. Set Success State\r\n+        btn.textContent = 'Sync Complete! âœ”ï¸';\r\n+        btn.className = 'bg-green-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-colors duration-200 min-w-[100px]';\r\n+        displayMessage(\"Data synchronization was successful. Tables reloading...\", false);\r\n \r\n-        pageRecords.forEach(r => {\r\n-            const isApproved = r.Status === 'Approved';\r\n-            const isRejected = r.Status === 'Rejected';\r\n-            const row = document.createElement(\"tr\");\r\n-            row.innerHTML = `\r\n-                <td>${r.RequestID || \"-\"}</td>\r\n-                <td>${r.ResidentName || \"-\"}</td>\r\n-                <td>${r.NationalID || \"-\"}</td>\r\n-                <td>${r.PhoneNumber || \"-\"}</td>\r\n-                <td>${r.Email || \"-\"}</td>\r\n-                <td>${r.HouseNumber || \"-\"}</td>\r\n-                <td>${r.CourtName || \"-\"}</td>\r\n-                <td>${r.RoleName || \"-\"}</td>\r\n-                <td class=\"${isApproved ? 'text-green-600' : isRejected ? 'text-red-600' : 'text-yellow-600'} font-semibold\">${r.Status || \"-\"}</td>\r\n-                <td>${r.RequestedAt ? new Date(r.RequestedAt).toLocaleString() : \"-\"}</td>\r\n-                <td class=\"text-center\">\r\n-                    <button class=\"approveBtn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Approve</button>\r\n-                    <button class=\"rejectBtn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Reject</button>\r\n-                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n-                </td>\r\n-            `;\r\n-            tableBody.appendChild(row);\r\n-        });\r\n+        // Reload data after a successful sync\r\n+        await loadPendingRequests();\r\n+        await loadApprovedResidents();\r\n+        \r\n+    } catch (err) {\r\n+        // 3. Set Failure State\r\n+        console.error(\"Synchronization Error:\", err.message);\r\n+        btn.textContent = 'Sync Failed âŒ';\r\n+        btn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-colors duration-200 min-w-[100px]';\r\n+        displayMessage(`Sync failed: ${err.message}`, true);\r\n \r\n-        updateUIStats(records);\r\n+    } finally {\r\n+        // 4. Reset Button State after a short delay\r\n+        setTimeout(() => {\r\n+            btn.disabled = false;\r\n+            btn.textContent = originalText;\r\n+            btn.className = originalClasses;\r\n+        }, 3000);\r\n     }\r\n+}\r\n \r\n-    // Approved table (unchanged logic)\r\n-    function renderApprovedTable(records) {\r\n-        residentsBody.innerHTML = \"\";\r\n-        if (!records.length) {\r\n-            updateApprovedCount([]);\r\n-            return;\r\n-        }\r\n+/**\r\n+ * Sends an approval request to the backend API.\r\n+ */\r\n+async function handleApproveClick(requestId) {\r\n+    document.getElementById('actionText').textContent = `Processing Approval for ${requestId}...`;\r\n \r\n-        const start = (approvedPage - 1) * approvedPerPage;\r\n-        const end = start + approvedPerPage;\r\n-        const pageRecords = records.slice(start, end);\r\n-\r\n-        pageRecords.forEach(r => {\r\n-            const row = document.createElement(\"tr\");\r\n-            row.innerHTML = `\r\n-                <td>${r.ResidentName}</td>\r\n-                <td>${r.NationalID}</td>\r\n-                <td>${r.PhoneNumber}</td>\r\n-                <td>${r.Email}</td>\r\n-                <td>${r.HouseNumber}</td>\r\n-                <td>${r.CourtName}</td>\r\n-                <td>${r.RoleName}</td>\r\n-                <td class=\"text-center\">\r\n-                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n-                </td>\r\n-            `;\r\n-            residentsBody.appendChild(row);\r\n+    try {\r\n+        const resp = await fetch(ENDPOINTS.APPROVE_REQUEST(requestId), {\r\n+            method: 'PUT', // Use PUT to update the status of the request\r\n+            headers: getAuthHeaders(),\r\n         });\r\n \r\n-        updateApprovedCount(records);\r\n-    }\r\n-\r\n-    // UI Stats, Pagination, and Dropdown helpers (unchanged logic)\r\n-    function updateUIStats(records) {\r\n-        membershipCount.textContent = records.length;\r\n-\r\n-        const approved = records.filter(r => r.Status === \"Approved\").length;\r\n-        const pending = records.filter(r => r.Status === \"Pending\").length;\r\n-        const rejected = records.filter(r => r.Status === \"Rejected\").length;\r\n-\r\n-        statusLabel.textContent = `Approved: ${approved} | Pending: ${pending} | Rejected: ${rejected}`;\r\n-\r\n-        const latest = records[0]?.RequestedAt ? new Date(records[0].RequestedAt).toLocaleString() : \"N/A\";\r\n-        actionText.textContent = latest;\r\n-    }\r\n-\r\n-    function updateApprovedCount(records) {\r\n-        const approvedCountEl = document.getElementById(\"approvedCount\");\r\n-        if (approvedCountEl) approvedCountEl.textContent = records.length;\r\n-    }\r\n-\r\n-    function renderMembershipPagination(records) {\r\n-        membershipPagination.innerHTML = \"\";\r\n-        const pageCount = Math.ceil(records.length / membershipPerPage);\r\n-        if (pageCount <= 1) return;\r\n-\r\n-        for (let i = 1; i <= pageCount; i++) {\r\n-            const btn = document.createElement(\"button\");\r\n-            btn.textContent = i;\r\n-            btn.className = `px-3 py-1 border rounded ${i === membershipPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n-            btn.addEventListener(\"click\", () => {\r\n-                membershipPage = i;\r\n-                renderMembershipTable(records);\r\n-                renderMembershipPagination(records);\r\n-            });\r\n-            membershipPagination.appendChild(btn);\r\n+        if (!resp.ok) {\r\n+            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n+            throw new Error(errorData.message || `Approval failed with status: ${resp.status}`);\r\n         }\r\n-    }\r\n+        \r\n+        // 2. Update UI\r\n+        document.getElementById('actionText').textContent = `Approved Request ${requestId}`;\r\n+        displayMessage(`Successfully approved membership request ${requestId}.`, false);\r\n+        \r\n+        // Since the backend updated the state, we reload the tables to reflect changes\r\n+        await loadPendingRequests();\r\n+        await loadApprovedResidents();\r\n \r\n-    function renderApprovedPagination(records) {\r\n-        approvedPagination.innerHTML = \"\";\r\n-        const pageCount = Math.ceil(records.length / approvedPerPage);\r\n-        if (pageCount <= 1) return;\r\n-\r\n-        for (let i = 1; i <= pageCount; i++) {\r\n-            const btn = document.createElement(\"button\");\r\n-            btn.textContent = i;\r\n-            btn.className = `px-3 py-1 border rounded ${i === approvedPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n-            btn.addEventListener(\"click\", () => {\r\n-                approvedPage = i;\r\n-                renderApprovedTable(records);\r\n-                renderApprovedPagination(records);\r\n-            });\r\n-            approvedPagination.appendChild(btn);\r\n-        }\r\n+    } catch (e) {\r\n+        console.error(\"Approval Operation Failed:\", e);\r\n+        displayMessage(`Approval failed for ${requestId}: ${e.message}`, true);\r\n     }\r\n+}\r\n \r\n-    function populateDropdownFilters(records) {\r\n-        if (requestIdFilter) {\r\n-            const ids = [...new Set(records.map(r => r.RequestID))].filter(id => id !== undefined && id !== null);\r\n-            requestIdFilter.innerHTML =\r\n-                `<option value=\"\">All Request IDs</option>` +\r\n-                ids.map(id => `<option value=\"${id}\">${id}</option>`).join(\"\");\r\n-        }\r\n \r\n-        if (residentFilter) {\r\n-            const names = [...new Set(records.map(r => r.ResidentName))].filter(n => n);\r\n-            residentFilter.innerHTML =\r\n-                `<option value=\"\">All Residents</option>` +\r\n-                names.map(n => `<option value=\"${n}\">${n}</option>`).join(\"\");\r\n-        }\r\n-    }\r\n-\r\n-\r\n-    // Actions Listener\r\n-    document.addEventListener(\"click\", async (e) => {\r\n-        const btn = e.target;\r\n-        const id = btn.dataset.id;\r\n-        if (!id || btn.disabled) return;\r\n-\r\n-        let action = \"\";\r\n-        if (btn.classList.contains(\"approveBtn\")) action = \"approve\";\r\n-        else if (btn.classList.contains(\"rejectBtn\")) action = \"reject\";\r\n-        else if (btn.classList.contains(\"deleteBtn\")) {\r\n-            if (!window.confirm(\"Are you sure you want to delete this record? This will remove it from both MembershipRecords and, if it exists, MembershipRequests.\")) return; \r\n-            action = \"delete\";\r\n-        }\r\n-        if (!action) return;\r\n-\r\n-        displayMessage(`Processing ${action} for Request ID ${id}...`);\r\n-\r\n-        try {\r\n-            // Use PATCH for approve/reject based on common REST standards\r\n-            const method = action === \"delete\" ? \"DELETE\" : \"PATCH\"; \r\n-            \r\n-            // Note: The backend routes are defined as PUT for approve/reject, \r\n-            // but the client is configured to send the action name in the URL.\r\n-            // We use PATCH method here, but if the backend strictly expects PUT/DELETE:\r\n-            // const method = (action === \"approve\" || action === \"reject\") ? \"PUT\" : \"DELETE\";\r\n-            \r\n-            const res = await fetch(`${API_BASE}/${action}/${id}`, {\r\n-                method: method, // Using PATCH for status update is standard\r\n-                headers: {\r\n-                    \"Authorization\": `Bearer ${token}`,\r\n-                    \"Content-Type\": \"application/json\"\r\n-                }\r\n-            });\r\n-            \r\n-            if (res.status === 403) {\r\n-                 throw new Error(\"Access Denied: You do not have permission for this action.\");\r\n-            }\r\n-\r\n-            const data = await res.json();\r\n-            if (!data.success) {\r\n-                console.error(\"Action failed:\", data.message);\r\n-                displayMessage(`Action failed: ${data.message}`, true);\r\n-                return;\r\n-            }\r\n-\r\n-            displayMessage(data.message || `${action} action completed successfully.`);\r\n-            await loadMembershipRecords(); // Reload after action\r\n-        } catch (err) {\r\n-            console.error(\"âŒ Action error:\", err);\r\n-            displayMessage(`Action failed: ${err.message}`, true);\r\n-        }\r\n-    });\r\n-\r\n-    // Filters and Sync Button Listener (unchanged logic)\r\n-    requestIdFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n-    residentFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n-\r\n-    clearFilterBtn?.addEventListener(\"click\", () => {\r\n-        if(requestIdFilter) requestIdFilter.value = \"\";\r\n-        if(residentFilter) residentFilter.value = \"\";\r\n-        document.querySelectorAll(\".header-filter\").forEach(f => (f.value = \"\"));\r\n-        membershipPage = 1;\r\n-        approvedPage = 1;\r\n-        applyFilters();\r\n-    });\r\n-\r\n-    document.querySelectorAll(\".header-filter\").forEach(input =>\r\n-        input.addEventListener(\"input\", () => {\r\n-            membershipPage = 1;\r\n-            approvedPage = 1;\r\n-            applyFilters();\r\n-        })\r\n-    );\r\n-\r\n-    // Sync button listener\r\n-    syncBtn?.addEventListener(\"click\", () => {\r\n-        syncRecords();\r\n-    });\r\n-\r\n-    // ======================================================\r\n-    // INITIAL LOAD â€” Fetch records only\r\n-    // ======================================================\r\n-    await loadMembershipRecords();\r\n+/**\r\n+ * Fetches and renders pending membership requests from the backend API.\r\n+ */\r\n+async function loadPendingRequests() {\r\n+    const tableBody = document.getElementById('membershipTableBody');\r\n+    const countElement = document.getElementById('membershipCount');\r\n+    const noRequestsMsg = document.getElementById('noPendingRequests');\r\n     \r\n-    // ðŸ”¥ CRITICAL CLEANUP: The duplicate global loadMembershipRecords function below must be removed.\r\n-});\r\n-            msg.classList.toggle('text-red-500', isError);\r\n-            msg.classList.toggle('text-green-500', !isError && !text.includes('Error'));\r\n-            \r\n-            // Auto-clear non-error messages after a delay\r\n-            if (!isError && !text.includes('Loading')) {\r\n-                 setTimeout(() => {\r\n-                    msg.classList.remove('text-green-500');\r\n-                    // Reset to show total count if no other message is pending\r\n-                    if (msg.textContent === text && allRecords.length > 0) { \r\n-                        msg.textContent = `Showing ${allRecords.length} total record(s).`;\r\n-                    } else if (msg.textContent === text && allRecords.length === 0) {\r\n-                        // Check for the specific \"Access Denied\" message before resetting\r\n-                        if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n-                             msg.textContent = \"No records loaded.\";\r\n-                        }\r\n-                    }\r\n-                }, 5000);\r\n-            }\r\n-        } else {\r\n-            console.log(`[UI Message] ${isError ? 'ERROR: ' : ''}${text}`);\r\n-        }\r\n-    }\r\n+    if (!tableBody || !countElement) return;\r\n \r\n-    if (!token) {\r\n-        displayMessage(\"Authentication required. Please log in.\", true);\r\n-        return;\r\n-    }\r\n+    // Show loading state\r\n+    tableBody.innerHTML = '<tr><td colspan=\"11\" class=\"text-center py-4 text-blue-500 italic\">Loading requests...</td></tr>';\r\n     \r\n-    // UI Elements\r\n-    const membershipCount = document.getElementById(\"membershipCount\");\r\n-    const statusLabel = document.getElementById(\"statusLabel\");\r\n-    const actionText = document.getElementById(\"actionText\");\r\n-    const tableBody = document.getElementById(\"membershipTableBody\");\r\n-    const residentsBody = document.getElementById(\"residentsTableBody\");\r\n-    const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n-    const residentFilter = document.getElementById(\"residentFilter\");\r\n-    const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n-    const syncBtn = document.getElementById(\"syncBtn\");\r\n+    try {\r\n+        const resp = await fetch(ENDPOINTS.PENDING_REQUESTS, { headers: getAuthHeaders() });\r\n+        if (!resp.ok) throw new Error(\"Failed to fetch pending requests.\");\r\n+        \r\n+        const requests = await resp.json();\r\n+        \r\n+        tableBody.innerHTML = '';\r\n+        countElement.textContent = requests.length;\r\n \r\n-    let allRecords = [];\r\n-    let membershipPage = 1, membershipPerPage = 10;\r\n-    let approvedPage = 1, approvedPerPage = 10;\r\n+        if (requests.length === 0) {\r\n+            noRequestsMsg.classList.remove('hidden');\r\n+        } else {\r\n+            noRequestsMsg.classList.add('hidden');\r\n+            requests.forEach(request => {\r\n+                const row = tableBody.insertRow();\r\n+                row.className = 'hover:bg-blue-50 transition-colors duration-100';\r\n \r\n-    // Pagination containers (Ensure they exist)\r\n-    let membershipPagination = document.querySelector('.membership-pagination');\r\n-    if (!membershipPagination) {\r\n-        membershipPagination = document.createElement(\"div\");\r\n-        membershipPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-4\", \"membership-pagination\");\r\n-        tableBody.parentNode.after(membershipPagination);\r\n-    }\r\n+                // Handle variations in timestamp key names (RequestedAt or requestedAt)\r\n+                const requestedAtString = formatTimestamp(request.RequestedAt || request.requestedAt);\r\n+                const requestId = request.id || request.requestId;\r\n \r\n-    let approvedPagination = document.querySelector('.approved-pagination');\r\n-    if (!approvedPagination) {\r\n-        approvedPagination = document.createElement(\"div\");\r\n-        approvedPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-2\", \"approved-pagination\");\r\n-        residentsBody.parentNode.after(approvedPagination);\r\n-    }\r\n-\r\n-    // ======================================================\r\n-    // ðŸ”„ Sync Records\r\n-    // ======================================================\r\n-    async function syncRecords() {\r\n-        // Residents shouldn't see or use this button, but adding a client-side check for robustness\r\n-        // The backend should also enforce the 403 on this endpoint.\r\n-        // We'll rely on the 403 handling below to block unprivileged users.\r\n-        displayMessage(\"Syncing records...\");\r\n-        if (syncBtn) syncBtn.disabled = true;\r\n-\r\n-        try {\r\n-            const res = await fetch(`${API_BASE}/sync`, {\r\n-                method: \"POST\",\r\n-                headers: {\r\n-                    \"Authorization\": `Bearer ${token}`,\r\n-                    \"Content-Type\": \"application/json\"\r\n-                }\r\n+                row.innerHTML = `\r\n+                    <td class=\"px-4 py-3\">${requestId}</td>\r\n+                    <td class=\"px-4 py-3 font-medium\">${request.ResidentName || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${request.NationalID || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${request.PhoneNumber || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${request.Email || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${request.HouseNumber || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${request.CourtName || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${request.RoleName || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\"><span class=\"bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full text-xs\">${request.Status || 'Pending'}</span></td>\r\n+                    <td class=\"px-4 py-3\">${requestedAtString}</td>\r\n+                    <td class=\"px-4 py-3 text-center\">\r\n+                        <button class=\"approve-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n+                            Approve\r\n+                        </button>\r\n+                    </td>\r\n+                `;\r\n             });\r\n-\r\n-            if (res.status === 403) {\r\n-                // Handle expected denial for residents who somehow access the sync button\r\n-                throw new Error(\"Access Denied: You do not have permission to sync records.\");\r\n-            }\r\n-\r\n-            const data = await res.json();\r\n-            if (!res.ok) {\r\n-                // Display server error message (including SQL detail if provided by controller)\r\n-                throw new Error(data.message || \"Sync failed on server.\");\r\n-            }\r\n-\r\n-            console.log(\"âœ… Sync success:\", data.message || \"Done\");\r\n-            displayMessage(data.message || \"Sync complete.\", false);\r\n-\r\n-            await loadMembershipRecords(); // Reload data AFTER successful sync\r\n-        } catch (err) {\r\n-            console.error(\"âŒ Sync failed:\", err);\r\n-            displayMessage(`Sync failed: ${err.message}`, true);\r\n-        } finally {\r\n-            if (syncBtn) syncBtn.disabled = false;\r\n-        }\r\n-    }\r\n-\r\n-    // ======================================================\r\n-    // ðŸ“¥ Load membership records\r\n-    // ======================================================\r\n-    async function loadMembershipRecords() {\r\n-        displayMessage(\"Loading...\");\r\n-\r\n-        try {\r\n-            // Note: The backend route is /all but the controller is named getAllMembershipRecords.\r\n-            const res = await fetch(`${API_BASE}/all`, {\r\n-                headers: {\r\n-                    \"Authorization\": `Bearer ${token}`,\r\n-                    \"Content-Type\": \"application/json\"\r\n-                }\r\n+            \r\n+            // Attach listeners to the new Approve buttons\r\n+            tableBody.querySelectorAll('.approve-btn').forEach(button => {\r\n+                button.addEventListener('click', (e) => {\r\n+                    const id = e.target.getAttribute('data-request-id');\r\n+                    handleApproveClick(id);\r\n+                });\r\n             });\r\n-\r\n-            // --- ðŸ”¥ CRITICAL FIX: Gracefully handle 403 for Resident users ---\r\n-            if (res.status === 403) {\r\n-                console.warn(\"âš ï¸ Access denied (403). Assuming resident role. Displaying empty dashboard.\");\r\n-                allRecords = [];\r\n-                applyFilters();\r\n-                // Display a status message appropriate for a restricted user\r\n-                displayMessage(\"Access Denied: You do not have permission to view all records.\", false);\r\n-                return; // Stop processing the response body\r\n-            }\r\n-            // --- END CRITICAL FIX ---\r\n-\r\n-\r\n-            const data = await res.json();\r\n-            if (!res.ok || !data.success) throw new Error(data.message || \"Failed to fetch records.\");\r\n-\r\n-            // CRITICAL: Use data.records, as set in the controller\r\n-            allRecords = Array.isArray(data.records) ? data.records : [];\r\n-\r\n-            membershipPage = 1;\r\n-            approvedPage = 1;\r\n-\r\n-            applyFilters();\r\n-            populateDropdownFilters(allRecords);\r\n-            // Display success message only if records were actually loaded (i.e., user is admin)\r\n-            displayMessage(`Loaded ${allRecords.length} total record(s).`, false);\r\n-\r\n-        } catch (err) {\r\n-            console.error(\"âŒ Fetch error:\", err);\r\n-            displayMessage(`Error loading records: ${err.message}`, true);\r\n         }\r\n+    } catch (error) {\r\n+        console.error(\"Error loading pending requests:\", error);\r\n+        tableBody.innerHTML = '<tr><td colspan=\"11\" class=\"text-center py-4 text-red-500 italic\">Error loading data. Check console for details.</td></tr>';\r\n+        displayMessage(\"Failed to load pending requests from API.\", true);\r\n     }\r\n+}\r\n \r\n-    // Apply dropdown + in-cell filters\r\n-    function applyFilters() {\r\n-        let filteredRecords = [...allRecords];\r\n-\r\n-        const selectedId = requestIdFilter?.value || \"\";\r\n-        const selectedResident = residentFilter?.value || \"\";\r\n-\r\n-        if (selectedId) filteredRecords = filteredRecords.filter(r => String(r.RequestID) === selectedId);\r\n-        if (selectedResident) filteredRecords = filteredRecords.filter(r => r.ResidentName === selectedResident);\r\n-\r\n-        const filterInputs = document.querySelectorAll(\".header-filter\");\r\n-        const filters = {};\r\n-        filterInputs.forEach(f => {\r\n-            if (f.value.trim() !== \"\") filters[f.dataset.column] = f.value.trim().toLowerCase();\r\n-        });\r\n-\r\n-        filteredRecords = filteredRecords.filter(record => {\r\n-            return Object.entries(filters).every(([key, val]) => {\r\n-                const field = record[key] ? String(record[key]).toLowerCase() : \"\";\r\n-                return field.includes(val);\r\n-            });\r\n-        });\r\n-\r\n-        renderMembershipTable(filteredRecords);\r\n-        renderMembershipPagination(filteredRecords);\r\n-\r\n-        const approvedRecords = filteredRecords.filter(r => r.Status === \"Approved\");\r\n-        renderApprovedTable(approvedRecords);\r\n-        renderApprovedPagination(approvedRecords);\r\n-    }\r\n+/**\r\n+ * Fetches and renders approved residents from the backend API.\r\n+ */\r\n+async function loadApprovedResidents() {\r\n+    const tableBody = document.getElementById('residentsTableBody');\r\n+    const noResidentsMsg = document.getElementById('noApprovedResidents');\r\n     \r\n-    // Render Membership Table (updated button states)\r\n-    function renderMembershipTable(records) {\r\n-        tableBody.innerHTML = \"\";\r\n-        if (!records.length) {\r\n-            updateUIStats([]);\r\n-            updateApprovedCount([]);\r\n-            // Display a message if the table is empty due to filters\r\n-            if (allRecords.length > 0) {\r\n-                 msg.textContent = \"No matching records found.\";\r\n-            } else if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n-                 msg.textContent = \"No records loaded.\";\r\n-            }\r\n-            return;\r\n-        }\r\n+    if (!tableBody) return;\r\n \r\n-        const start = (membershipPage - 1) * membershipPerPage;\r\n-        const end = start + membershipPerPage;\r\n-        const pageRecords = records.slice(start, end);\r\n+    // Show loading state\r\n+    tableBody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center py-4 text-blue-500 italic\">Loading approved residents...</td></tr>';\r\n \r\n-        pageRecords.forEach(r => {\r\n-            const isApproved = r.Status === 'Approved';\r\n-            const isRejected = r.Status === 'Rejected';\r\n-            const row = document.createElement(\"tr\");\r\n-            row.innerHTML = `\r\n-                <td>${r.RequestID || \"-\"}</td>\r\n-                <td>${r.ResidentName || \"-\"}</td>\r\n-                <td>${r.NationalID || \"-\"}</td>\r\n-                <td>${r.PhoneNumber || \"-\"}</td>\r\n-                <td>${r.Email || \"-\"}</td>\r\n-                <td>${r.HouseNumber || \"-\"}</td>\r\n-                <td>${r.CourtName || \"-\"}</td>\r\n-                <td>${r.RoleName || \"-\"}</td>\r\n-                <td class=\"${isApproved ? 'text-green-600' : isRejected ? 'text-red-600' : 'text-yellow-600'} font-semibold\">${r.Status || \"-\"}</td>\r\n-                <td>${r.RequestedAt ? new Date(r.RequestedAt).toLocaleString() : \"-\"}</td>\r\n-                <td class=\"text-center\">\r\n-                    <button class=\"approveBtn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Approve</button>\r\n-                    <button class=\"rejectBtn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Reject</button>\r\n-                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n-                </td>\r\n-            `;\r\n-            tableBody.appendChild(row);\r\n-        });\r\n+    try {\r\n+        const resp = await fetch(ENDPOINTS.APPROVED_RESIDENTS, { headers: getAuthHeaders() });\r\n+        if (!resp.ok) throw new Error(\"Failed to fetch approved residents.\");\r\n+        \r\n+        const residents = await resp.json();\r\n \r\n-        updateUIStats(records);\r\n-    }\r\n-\r\n-    // Approved table (unchanged)\r\n-    function renderApprovedTable(records) {\r\n-        residentsBody.innerHTML = \"\";\r\n-        if (!records.length) {\r\n-            updateApprovedCount([]);\r\n-            return;\r\n-        }\r\n-\r\n-        const start = (approvedPage - 1) * approvedPerPage;\r\n-        const end = start + approvedPerPage;\r\n-        const pageRecords = records.slice(start, end);\r\n-\r\n-        pageRecords.forEach(r => {\r\n-            const row = document.createElement(\"tr\");\r\n-            row.innerHTML = `\r\n-                <td>${r.ResidentName}</td>\r\n-                <td>${r.NationalID}</td>\r\n-                <td>${r.PhoneNumber}</td>\r\n-                <td>${r.Email}</td>\r\n-                <td>${r.HouseNumber}</td>\r\n-                <td>${r.CourtName}</td>\r\n-                <td>${r.RoleName}</td>\r\n-                <td class=\"text-center\">\r\n-                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n-                </td>\r\n-            `;\r\n-            residentsBody.appendChild(row);\r\n-        });\r\n-\r\n-        updateApprovedCount(records);\r\n-    }\r\n-\r\n-    // UI Stats (unchanged)\r\n-    function updateUIStats(records) {\r\n-        membershipCount.textContent = records.length;\r\n-\r\n-        const approved = records.filter(r => r.Status === \"Approved\").length;\r\n-        const pending = records.filter(r => r.Status === \"Pending\").length;\r\n-        const rejected = records.filter(r => r.Status === \"Rejected\").length;\r\n-\r\n-        statusLabel.textContent = `Approved: ${approved} | Pending: ${pending} | Rejected: ${rejected}`;\r\n-\r\n-        const latest = records[0]?.RequestedAt ? new Date(records[0].RequestedAt).toLocaleString() : \"N/A\";\r\n-        actionText.textContent = latest;\r\n-    }\r\n-\r\n-    function updateApprovedCount(records) {\r\n-        const approvedCountEl = document.getElementById(\"approvedCount\");\r\n-        if (approvedCountEl) approvedCountEl.textContent = records.length;\r\n-    }\r\n-\r\n-    // Pagination (unchanged)\r\n-    function renderMembershipPagination(records) {\r\n-        membershipPagination.innerHTML = \"\";\r\n-        const pageCount = Math.ceil(records.length / membershipPerPage);\r\n-        if (pageCount <= 1) return;\r\n-\r\n-        for (let i = 1; i <= pageCount; i++) {\r\n-            const btn = document.createElement(\"button\");\r\n-            btn.textContent = i;\r\n-            btn.className = `px-3 py-1 border rounded ${i === membershipPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n-            btn.addEventListener(\"click\", () => {\r\n-                membershipPage = i;\r\n-                renderMembershipTable(records);\r\n-                renderMembershipPagination(records);\r\n+        tableBody.innerHTML = '';\r\n+        \r\n+        if (residents.length === 0) {\r\n+            noResidentsMsg.classList.remove('hidden');\r\n+        } else {\r\n+            noResidentsMsg.classList.add('hidden');\r\n+            residents.forEach(resident => {\r\n+                const row = tableBody.insertRow();\r\n+                row.className = 'hover:bg-blue-50 transition-colors duration-100';\r\n+                row.innerHTML = `\r\n+                    <td class=\"px-4 py-3 font-medium\">${resident.ResidentName || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${resident.NationalID || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${resident.PhoneNumber || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${resident.Email || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${resident.HouseNumber || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${resident.CourtName || 'N/A'}</td>\r\n+                    <td class=\"px-4 py-3\">${resident.RoleName || 'N/A'}</td>\r\n+                `;\r\n             });\r\n-            membershipPagination.appendChild(btn);\r\n         }\r\n+    } catch (error) {\r\n+        console.error(\"Error loading approved residents:\", error);\r\n+        tableBody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center py-4 text-red-500 italic\">Error loading data. Check console for details.</td></tr>';\r\n+        displayMessage(\"Failed to load approved residents from API.\", true);\r\n     }\r\n+}\r\n \r\n-    function renderApprovedPagination(records) {\r\n-        approvedPagination.innerHTML = \"\";\r\n-        const pageCount = Math.ceil(records.length / approvedPerPage);\r\n-        if (pageCount <= 1) return;\r\n \r\n-        for (let i = 1; i <= pageCount; i++) {\r\n-            const btn = document.createElement(\"button\");\r\n-            btn.textContent = i;\r\n-            btn.className = `px-3 py-1 border rounded ${i === approvedPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n-            btn.addEventListener(\"click\", () => {\r\n-                approvedPage = i;\r\n-                renderApprovedTable(records);\r\n-                renderApprovedPagination(records);\r\n-            });\r\n-            approvedPagination.appendChild(btn);\r\n-        }\r\n-    }\r\n+// ====================================================================\r\n+// INITIALIZATION AND EVENT LISTENERS\r\n+// ====================================================================\r\n \r\n-    function populateDropdownFilters(records) {\r\n-        if (requestIdFilter) {\r\n-            const ids = [...new Set(records.map(r => r.RequestID))].filter(id => id !== undefined && id !== null);\r\n-            requestIdFilter.innerHTML =\r\n-                `<option value=\"\">All Request IDs</option>` +\r\n-                ids.map(id => `<option value=\"${id}\">${id}</option>`).join(\"\");\r\n-        }\r\n-\r\n-        if (residentFilter) {\r\n-            const names = [...new Set(records.map(r => r.ResidentName))].filter(n => n);\r\n-            residentFilter.innerHTML =\r\n-                `<option value=\"\">All Residents</option>` +\r\n-                names.map(n => `<option value=\"${n}\">${n}</option>`).join(\"\");\r\n-        }\r\n+function init() {\r\n+    const yearSpan = document.getElementById('year');\r\n+    if (yearSpan) {\r\n+        yearSpan.textContent = new Date().getFullYear();\r\n     }\r\n+    \r\n+    // Set initial status message\r\n+    document.getElementById('actionText').textContent = `Admin Panel Ready. Attempting to load data...`;\r\n \r\n-\r\n-    // Actions\r\n-    document.addEventListener(\"click\", async (e) => {\r\n-        const btn = e.target;\r\n-        const id = btn.dataset.id;\r\n-        if (!id || btn.disabled) return;\r\n-\r\n-        let action = \"\";\r\n-        if (btn.classList.contains(\"approveBtn\")) action = \"approve\";\r\n-        else if (btn.classList.contains(\"rejectBtn\")) action = \"reject\";\r\n-        else if (btn.classList.contains(\"deleteBtn\")) {\r\n-            // NOTE: Using window.confirm as per guidance to avoid browser alert() errors, \r\n-            // but this should be replaced by a custom modal in a full application.\r\n-            if (!window.confirm(\"Are you sure you want to delete this record? This will remove it from both requests and records.\")) return; \r\n-            action = \"delete\";\r\n-        }\r\n-        if (!action) return;\r\n-\r\n-        displayMessage(`Processing ${action} for Request ID ${id}...`);\r\n-\r\n-        try {\r\n-            // Approve/Reject use PATCH, Delete uses DELETE\r\n-            const method = action === \"delete\" ? \"DELETE\" : \"PATCH\"; \r\n-            const res = await fetch(`${API_BASE}/${action}/${id}`, {\r\n-                method,\r\n-                headers: {\r\n-                    \"Authorization\": `Bearer ${token}`,\r\n-                    \"Content-Type\": \"application/json\"\r\n-                }\r\n-            });\r\n-            \r\n-            // Check for 403 on specific actions (Approve/Reject/Delete)\r\n-            if (res.status === 403) {\r\n-                 throw new Error(\"Access Denied: You do not have permission for this action.\");\r\n-            }\r\n-\r\n-            const data = await res.json();\r\n-            if (!data.success) {\r\n-                console.error(\"Action failed:\", data.message);\r\n-                // Display the specific server error message\r\n-                displayMessage(`Action failed: ${data.message}`, true);\r\n-                return;\r\n-            }\r\n-\r\n-            displayMessage(data.message || `${action} action completed successfully.`);\r\n-            await loadMembershipRecords(); // Reload after action\r\n-        } catch (err) {\r\n-            console.error(\"âŒ Action error:\", err);\r\n-            displayMessage(`Action failed due to network error: ${err.message}`, true);\r\n-        }\r\n+    // Attach listener for the Sync button\r\n+    document.getElementById(\"syncBtn\")?.addEventListener(\"click\", handleSyncClick);\r\n+    \r\n+    // Placeholder for other filters (Clear Filters button)\r\n+    document.getElementById(\"clearFilterBtn\")?.addEventListener(\"click\", () => {\r\n+        document.getElementById('requestIdFilter').value = \"\";\r\n+        document.getElementById('residentFilter').value = \"\";\r\n+        displayMessage(\"Filters cleared (API query filtering needs implementation).\", false);\r\n     });\r\n-\r\n-    // Filters and Sync Button Listener\r\n-    requestIdFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n-    residentFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n-\r\n-    clearFilterBtn?.addEventListener(\"click\", () => {\r\n-        requestIdFilter.value = \"\";\r\n-        residentFilter.value = \"\";\r\n-        document.querySelectorAll(\".header-filter\").forEach(f => (f.value = \"\"));\r\n-        membershipPage = 1;\r\n-        approvedPage = 1;\r\n-        applyFilters();\r\n+    \r\n+    // Setup Logout\r\n+    document.getElementById(\"logoutBtn\")?.addEventListener(\"click\", () => {\r\n+        // In a real application, clear token and redirect to login page\r\n+        // localStorage.removeItem(\"accessToken\"); \r\n+        displayMessage(\"Logged out successfully (API session cleared).\", false);\r\n+        // window.location.href = \"/login.html\"; \r\n     });\r\n+    \r\n+    // Load initial data by fetching from the API\r\n+    loadPendingRequests();\r\n+    loadApprovedResidents();\r\n+}\r\n \r\n-    document.querySelectorAll(\".header-filter\").forEach(input =>\r\n-        input.addEventListener(\"input\", () => {\r\n-            membershipPage = 1;\r\n-            approvedPage = 1;\r\n-            applyFilters();\r\n-        })\r\n-    );\r\n-\r\n-    // ======================================================\r\n-    // ðŸ”„ Sync button â€” calls syncRecords() only\r\n-    // ======================================================\r\n-    syncBtn?.addEventListener(\"click\", () => {\r\n-        syncRecords();\r\n-    });\r\n-\r\n-    // ======================================================\r\n-    // INITIAL LOAD â€” Fetch records only\r\n-    // ======================================================\r\n-    await loadMembershipRecords();\r\n-});\r\n-async function loadMembershipRecords() {\r\n-    try {\r\n-        const res = await fetch(\"http://localhost:4050/api/admin/memberships\", {\r\n-            headers: { \"Authorization\": `Bearer ${token}` }\r\n-        });\r\n-        if (!res.ok) throw new Error(`API Error: ${res.status}`);\r\n-        const members = await res.json();\r\n-\r\n-        const container = document.getElementById(\"dynamic-section-content\");\r\n-        if (!container) return;\r\n-\r\n-        if (members.length === 0) {\r\n-            container.innerHTML = \"<p class='text-gray-500 text-center'>No membership records found.</p>\";\r\n-            return;\r\n-        }\r\n-\r\n-        let html = `<ul class=\"space-y-2\">`;\r\n-        members.forEach(m => {\r\n-            if (m.Status === \"Approved\") {\r\n-                html += `<li class=\"bg-white shadow-md rounded-lg p-4 flex justify-between items-center\">\r\n-                            <div>\r\n-                                <p class=\"font-semibold\">${m.ResidentName}</p>\r\n-                                <p class=\"text-sm text-gray-500\">${m.NationalID} | ${m.HouseNumber} - ${m.CourtName}</p>\r\n-                            </div>\r\n-                          </li>`;\r\n-            }\r\n-        });\r\n-        html += `</ul>`;\r\n-        container.innerHTML = html;\r\n-\r\n-    } catch (err) {\r\n-        console.error(\"Error loading membership records:\", err);\r\n-    }\r\n-}\r\n+// Ensure the window load handler is used for initialization\r\n+window.addEventListener('load', init);\n\\ No newline at end of file\n"
                },
                {
                    "date": 1763780288029,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,11 +5,16 @@\n \r\n // Define API Endpoints\r\n const ENDPOINTS = {\r\n     SYNC: `${API_HOST}/api/admin/sync`,\r\n-    PENDING_REQUESTS: `${API_HOST}/api/admin/requests/pending`,\r\n-    APPROVED_RESIDENTS: `${API_HOST}/api/admin/residents/approved`,\r\n-    APPROVE_REQUEST: (id) => `${API_HOST}/api/admin/requests/approve/${id}`,\r\n+    // UPDATED to use the new routes in membershiprecordsRoutes.js\r\n+    PENDING_REQUESTS: `${API_HOST}/api/admin/requests/pending`, // ðŸ‘ˆ UPDATED\r\n+    APPROVED_RESIDENTS: `${API_HOST}/api/admin/residents/approved`, // ðŸ‘ˆ UPDATED\r\n+\r\n+    // Actions on a specific request/record\r\n+    APPROVE_REQUEST: (id) => `${API_HOST}/api/admin/approve/${id}`, // ðŸ‘ˆ Corrected path to match route file\r\n+    REJECT_REQUEST: (id) => `${API_HOST}/api/admin/reject/${id}`, // ðŸ‘ˆ NEW\r\n+    DELETE_REQUEST: (id) => `${API_HOST}/api/admin/delete/${id}`, // ðŸ‘ˆ NEW\r\n };\r\n \r\n // ====================================================================\r\n // UTILITIES AND HELPERS\r\n"
                },
                {
                    "date": 1763780303661,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,15 +6,15 @@\n // Define API Endpoints\r\n const ENDPOINTS = {\r\n     SYNC: `${API_HOST}/api/admin/sync`,\r\n     // UPDATED to use the new routes in membershiprecordsRoutes.js\r\n-    PENDING_REQUESTS: `${API_HOST}/api/admin/requests/pending`, // ðŸ‘ˆ UPDATED\r\n-    APPROVED_RESIDENTS: `${API_HOST}/api/admin/residents/approved`, // ðŸ‘ˆ UPDATED\r\n+    PENDING_REQUESTS: `${API_HOST}/api/admin/requests/pending`, // UPDATED\r\n+    APPROVED_RESIDENTS: `${API_HOST}/api/admin/residents/approved`, // UPDATED\r\n \r\n     // Actions on a specific request/record\r\n-    APPROVE_REQUEST: (id) => `${API_HOST}/api/admin/approve/${id}`, // ðŸ‘ˆ Corrected path to match route file\r\n-    REJECT_REQUEST: (id) => `${API_HOST}/api/admin/reject/${id}`, // ðŸ‘ˆ NEW\r\n-    DELETE_REQUEST: (id) => `${API_HOST}/api/admin/delete/${id}`, // ðŸ‘ˆ NEW\r\n+    APPROVE_REQUEST: (id) => `${API_HOST}/api/admin/approve/${id}`, // Corrected path to match route file\r\n+    REJECT_REQUEST: (id) => `${API_HOST}/api/admin/reject/${id}`, // NEW\r\n+    DELETE_REQUEST: (id) => `${API_HOST}/api/admin/delete/${id}`, // NEW\r\n };\r\n \r\n // ====================================================================\r\n // UTILITIES AND HELPERS\r\n"
                },
                {
                    "date": 1763780508346,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,10 +151,36 @@\n         console.error(\"Approval Operation Failed:\", e);\r\n         displayMessage(`Approval failed for ${requestId}: ${e.message}`, true);\r\n     }\r\n }\r\n+async function handleRejectClick(requestId) {\r\n+    document.getElementById('actionText').textContent = `Processing Rejection for ${requestId}...`;\r\n+    if (!confirm(`Are you sure you want to REJECT request ${requestId}?`)) return;\r\n \r\n+    try {\r\n+        const resp = await fetch(ENDPOINTS.REJECT_REQUEST(requestId), { // Uses REJECT_REQUEST\r\n+            method: 'PUT', \r\n+            headers: getAuthHeaders(),\r\n+        });\r\n \r\n+        if (!resp.ok) {\r\n+            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n+            throw new Error(errorData.message || `Rejection failed with status: ${resp.status}`);\r\n+        }\r\n+        \r\n+        document.getElementById('actionText').textContent = `Rejected Request ${requestId}`;\r\n+        displayMessage(`Successfully rejected membership request ${requestId}.`, false);\r\n+        \r\n+        await loadPendingRequests();\r\n+        await loadApprovedResidents();\r\n+\r\n+    } catch (e) {\r\n+        console.error(\"Rejection Operation Failed:\", e);\r\n+        displayMessage(`Rejection failed for ${requestId}: ${e.message}`, true);\r\n+    }\r\n+}\r\n+\r\n+\r\n /**\r\n  * Fetches and renders pending membership requests from the backend API.\r\n  */\r\n async function loadPendingRequests() {\r\n"
                },
                {
                    "date": 1763780545516,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,10 +177,35 @@\n         console.error(\"Rejection Operation Failed:\", e);\r\n         displayMessage(`Rejection failed for ${requestId}: ${e.message}`, true);\r\n     }\r\n }\r\n+async function handleDeleteClick(requestId) {\r\n+    document.getElementById('actionText').textContent = `Processing Deletion for ${requestId}...`;\r\n+    if (!confirm(`Are you sure you want to DELETE request ${requestId}? This action is permanent.`)) return;\r\n \r\n+    try {\r\n+        const resp = await fetch(ENDPOINTS.DELETE_REQUEST(requestId), { // Uses DELETE_REQUEST\r\n+            method: 'DELETE', \r\n+            headers: getAuthHeaders(),\r\n+        });\r\n \r\n+        if (!resp.ok) {\r\n+            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n+            throw new Error(errorData.message || `Deletion failed with status: ${resp.status}`);\r\n+        }\r\n+        \r\n+        document.getElementById('actionText').textContent = `Deleted Request ${requestId}`;\r\n+        displayMessage(`Successfully deleted membership request ${requestId}.`, false);\r\n+        \r\n+        await loadPendingRequests();\r\n+        await loadApprovedResidents();\r\n+\r\n+    } catch (e) {\r\n+        console.error(\"Deletion Operation Failed:\", e);\r\n+        displayMessage(`Deletion failed for ${requestId}: ${e.message}`, true);\r\n+    }\r\n+}\r\n+\r\n /**\r\n  * Fetches and renders pending membership requests from the backend API.\r\n  */\r\n async function loadPendingRequests() {\r\n"
                },
                {
                    "date": 1763780712384,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -208,37 +208,31 @@\n /**\r\n  * Fetches and renders pending membership requests from the backend API.\r\n  */\r\n async function loadPendingRequests() {\r\n-    const tableBody = document.getElementById('membershipTableBody');\r\n-    const countElement = document.getElementById('membershipCount');\r\n-    const noRequestsMsg = document.getElementById('noPendingRequests');\r\n+    // ... existing setup ...\r\n+    // ... existing loading state ...\r\n     \r\n-    if (!tableBody || !countElement) return;\r\n-\r\n-    // Show loading state\r\n-    tableBody.innerHTML = '<tr><td colspan=\"11\" class=\"text-center py-4 text-blue-500 italic\">Loading requests...</td></tr>';\r\n-    \r\n     try {\r\n-        const resp = await fetch(ENDPOINTS.PENDING_REQUESTS, { headers: getAuthHeaders() });\r\n+        // ... existing fetch ...\r\n+        // The API call is now fixed to use the correct /requests/pending endpoint\r\n+        const resp = await fetch(ENDPOINTS.PENDING_REQUESTS, { headers: getAuthHeaders() }); \r\n         if (!resp.ok) throw new Error(\"Failed to fetch pending requests.\");\r\n         \r\n-        const requests = await resp.json();\r\n+        const requests = await resp.json(); // Data is now the array of pending requests\r\n         \r\n-        tableBody.innerHTML = '';\r\n-        countElement.textContent = requests.length;\r\n+        // ... existing table clear and count update ...\r\n \r\n         if (requests.length === 0) {\r\n-            noRequestsMsg.classList.remove('hidden');\r\n+            // ... existing no requests logic ...\r\n         } else {\r\n             noRequestsMsg.classList.add('hidden');\r\n             requests.forEach(request => {\r\n                 const row = tableBody.insertRow();\r\n-                row.className = 'hover:bg-blue-50 transition-colors duration-100';\r\n-\r\n-                // Handle variations in timestamp key names (RequestedAt or requestedAt)\r\n+                // ... existing row setup ...\r\n+                \r\n                 const requestedAtString = formatTimestamp(request.RequestedAt || request.requestedAt);\r\n-                const requestId = request.id || request.requestId;\r\n+                const requestId = request.id || request.requestId; // 'id' from new API route, 'requestId' from old logic\r\n \r\n                 row.innerHTML = `\r\n                     <td class=\"px-4 py-3\">${requestId}</td>\r\n                     <td class=\"px-4 py-3 font-medium\">${request.ResidentName || 'N/A'}</td>\r\n@@ -249,28 +243,41 @@\n                     <td class=\"px-4 py-3\">${request.CourtName || 'N/A'}</td>\r\n                     <td class=\"px-4 py-3\">${request.RoleName || 'N/A'}</td>\r\n                     <td class=\"px-4 py-3\"><span class=\"bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full text-xs\">${request.Status || 'Pending'}</span></td>\r\n                     <td class=\"px-4 py-3\">${requestedAtString}</td>\r\n-                    <td class=\"px-4 py-3 text-center\">\r\n-                        <button class=\"approve-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n+                    <td class=\"px-4 py-3 text-center space-x-2 flex\">\r\n+                        <button class=\"approve-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n                             Approve\r\n                         </button>\r\n+                        <button class=\"reject-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n+                            Reject\r\n+                        </button>\r\n+                        <button class=\"delete-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n+                            Delete\r\n+                        </button>\r\n                     </td>\r\n                 `;\r\n             });\r\n             \r\n-            // Attach listeners to the new Approve buttons\r\n+            // Attach listeners to the new Action buttons\r\n             tableBody.querySelectorAll('.approve-btn').forEach(button => {\r\n                 button.addEventListener('click', (e) => {\r\n-                    const id = e.target.getAttribute('data-request-id');\r\n-                    handleApproveClick(id);\r\n+                    handleApproveClick(e.target.getAttribute('data-request-id'));\r\n                 });\r\n             });\r\n+            tableBody.querySelectorAll('.reject-btn').forEach(button => { // ðŸ‘ˆ NEW LISTENER\r\n+                button.addEventListener('click', (e) => {\r\n+                    handleRejectClick(e.target.getAttribute('data-request-id'));\r\n+                });\r\n+            });\r\n+            tableBody.querySelectorAll('.delete-btn').forEach(button => { // ðŸ‘ˆ NEW LISTENER\r\n+                button.addEventListener('click', (e) => {\r\n+                    handleDeleteClick(e.target.getAttribute('data-request-id'));\r\n+                });\r\n+            });\r\n         }\r\n     } catch (error) {\r\n-        console.error(\"Error loading pending requests:\", error);\r\n-        tableBody.innerHTML = '<tr><td colspan=\"11\" class=\"text-center py-4 text-red-500 italic\">Error loading data. Check console for details.</td></tr>';\r\n-        displayMessage(\"Failed to load pending requests from API.\", true);\r\n+        // ... existing error logic ...\r\n     }\r\n }\r\n \r\n /**\r\n"
                },
                {
                    "date": 1763787311819,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,366 +1,142 @@\n-// --- ENVIRONMENT SETUP ---\r\n-// Define variables pointing to your actual backend API\r\n-const API_HOST = \"http://api.estate-management.com\"; \r\n-const token = \"MOCK_AUTH_TOKEN_ABC123\"; // NOTE: This token should be dynamically retrieved (e.g., from local storage or session) after successful login.\r\n+// js/membershiprecords.js\r\n \r\n-// Define API Endpoints\r\n-const ENDPOINTS = {\r\n-    SYNC: `${API_HOST}/api/admin/sync`,\r\n-    // UPDATED to use the new routes in membershiprecordsRoutes.js\r\n-    PENDING_REQUESTS: `${API_HOST}/api/admin/requests/pending`, // UPDATED\r\n-    APPROVED_RESIDENTS: `${API_HOST}/api/admin/residents/approved`, // UPDATED\r\n+const membershipTableBody = document.getElementById(\"membershipTableBody\");\r\n+const membershipCount = document.getElementById(\"membershipCount\");\r\n+const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n+const residentFilter = document.getElementById(\"residentFilter\");\r\n+const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n+const statusLabel = document.getElementById(\"statusLabel\");\r\n+const actionText = document.getElementById(\"actionText\");\r\n \r\n-    // Actions on a specific request/record\r\n-    APPROVE_REQUEST: (id) => `${API_HOST}/api/admin/approve/${id}`, // Corrected path to match route file\r\n-    REJECT_REQUEST: (id) => `${API_HOST}/api/admin/reject/${id}`, // NEW\r\n-    DELETE_REQUEST: (id) => `${API_HOST}/api/admin/delete/${id}`, // NEW\r\n-};\r\n+const API_HOST = \"http://localhost:4050\"; // your backend host\r\n+const token = localStorage.getItem(\"token\"); // JWT stored in localStorage\r\n \r\n-// ====================================================================\r\n-// UTILITIES AND HELPERS\r\n-// ====================================================================\r\n+let memberships = [];\r\n \r\n-/**\r\n- * Creates and returns the standard headers needed for authenticated API calls.\r\n- * @returns {Headers}\r\n- */\r\n-function getAuthHeaders() {\r\n-    return {\r\n-        'Content-Type': 'application/json',\r\n-        'Authorization': `Bearer ${token}`\r\n-    };\r\n-}\r\n+// =====================\r\n+// FETCH MEMBERSHIP DATA\r\n+// =====================\r\n+async function loadMembershipRecords() {\r\n+  try {\r\n+    actionText.textContent = \"Loading...\";\r\n+    const res = await fetch(`${API_HOST}/api/memberships/records`, {\r\n+      headers: {\r\n+        Authorization: `Bearer ${token}`,\r\n+      },\r\n+    });\r\n \r\n-/**\r\n- * Handles error display in a non-alert manner.\r\n- * @param {string} message \r\n- * @param {boolean} isError \r\n- */\r\n-function displayMessage(message, isError = false) {\r\n-    const msgElement = document.getElementById('msg');\r\n-    if (msgElement) {\r\n-        msgElement.textContent = message;\r\n-        msgElement.className = `p-3 rounded-lg text-sm font-semibold mb-3 ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;\r\n-        \r\n-        // Clear message after a few seconds\r\n-        setTimeout(() => {\r\n-            msgElement.textContent = '';\r\n-            msgElement.className = 'text-sm text-gray-700 mb-3';\r\n-        }, 5000);\r\n-    }\r\n-}\r\n+    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n \r\n-/**\r\n- * Formats a timestamp (string or number) into a readable date string.\r\n- * @param {string|number} timestamp \r\n- * @returns {string} Formatted date string\r\n- */\r\n-function formatTimestamp(timestamp) {\r\n-    try {\r\n-        if (!timestamp) return 'N/A';\r\n-        return new Date(timestamp).toLocaleString();\r\n-    } catch (e) {\r\n-        console.error(\"Invalid timestamp:\", timestamp);\r\n-        return 'N/A';\r\n-    }\r\n-}\r\n+    memberships = await res.json();\r\n \r\n-// ====================================================================\r\n-// CORE DASHBOARD LOGIC (API IMPLEMENTATION)\r\n-// ====================================================================\r\n-\r\n-/**\r\n- * Executes a real API call to trigger server-side data synchronization.\r\n- */\r\n-async function handleSyncClick(event) {\r\n-    const btn = event.currentTarget;\r\n-    const originalText = btn.textContent;\r\n-    const originalClasses = btn.className;\r\n-\r\n-    // 1. Set Loading State\r\n-    btn.disabled = true;\r\n-    btn.textContent = 'Syncing...';\r\n-    btn.className = 'bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-colors duration-200 animate-pulse min-w-[100px]';\r\n-\r\n-    try {\r\n-        // --- REAL API CALL ---\r\n-        const resp = await fetch(ENDPOINTS.SYNC, { \r\n-            method: 'POST',\r\n-            headers: getAuthHeaders(),\r\n-        });\r\n-\r\n-        if (!resp.ok) {\r\n-            // Attempt to read server error message\r\n-            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n-            throw new Error(errorData.message || `Sync failed with status: ${resp.status}`);\r\n-        }\r\n-        // --- END REAL API CALL ---\r\n-\r\n-        // 2. Set Success State\r\n-        btn.textContent = 'Sync Complete! âœ”ï¸';\r\n-        btn.className = 'bg-green-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-colors duration-200 min-w-[100px]';\r\n-        displayMessage(\"Data synchronization was successful. Tables reloading...\", false);\r\n-\r\n-        // Reload data after a successful sync\r\n-        await loadPendingRequests();\r\n-        await loadApprovedResidents();\r\n-        \r\n-    } catch (err) {\r\n-        // 3. Set Failure State\r\n-        console.error(\"Synchronization Error:\", err.message);\r\n-        btn.textContent = 'Sync Failed âŒ';\r\n-        btn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-colors duration-200 min-w-[100px]';\r\n-        displayMessage(`Sync failed: ${err.message}`, true);\r\n-\r\n-    } finally {\r\n-        // 4. Reset Button State after a short delay\r\n-        setTimeout(() => {\r\n-            btn.disabled = false;\r\n-            btn.textContent = originalText;\r\n-            btn.className = originalClasses;\r\n-        }, 3000);\r\n-    }\r\n+    renderTable(memberships);\r\n+    populateFilters(memberships);\r\n+    actionText.textContent = `Last update: ${new Date().toLocaleString()}`;\r\n+    membershipCount.textContent = memberships.length;\r\n+  } catch (err) {\r\n+    console.error(\"Error loading memberships:\", err);\r\n+    actionText.textContent = \"Error loading data\";\r\n+  }\r\n }\r\n \r\n-/**\r\n- * Sends an approval request to the backend API.\r\n- */\r\n-async function handleApproveClick(requestId) {\r\n-    document.getElementById('actionText').textContent = `Processing Approval for ${requestId}...`;\r\n+// =====================\r\n+// RENDER TABLE\r\n+// =====================\r\n+function renderTable(data) {\r\n+  membershipTableBody.innerHTML = \"\";\r\n \r\n-    try {\r\n-        const resp = await fetch(ENDPOINTS.APPROVE_REQUEST(requestId), {\r\n-            method: 'PUT', // Use PUT to update the status of the request\r\n-            headers: getAuthHeaders(),\r\n-        });\r\n+  data.forEach((item) => {\r\n+    const row = document.createElement(\"tr\");\r\n+    row.classList.add(\"border-b\");\r\n \r\n-        if (!resp.ok) {\r\n-            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n-            throw new Error(errorData.message || `Approval failed with status: ${resp.status}`);\r\n-        }\r\n-        \r\n-        // 2. Update UI\r\n-        document.getElementById('actionText').textContent = `Approved Request ${requestId}`;\r\n-        displayMessage(`Successfully approved membership request ${requestId}.`, false);\r\n-        \r\n-        // Since the backend updated the state, we reload the tables to reflect changes\r\n-        await loadPendingRequests();\r\n-        await loadApprovedResidents();\r\n+    row.innerHTML = `\r\n+      <td class=\"px-4 py-2\">${item.RequestID}</td>\r\n+      <td class=\"px-4 py-2\">${item.ResidentName}</td>\r\n+      <td class=\"px-4 py-2\">${item.NationalID}</td>\r\n+      <td class=\"px-4 py-2\">${item.PhoneNumber}</td>\r\n+      <td class=\"px-4 py-2\">${item.Email}</td>\r\n+      <td class=\"px-4 py-2\">${item.HouseNumber}</td>\r\n+      <td class=\"px-4 py-2\">${item.CourtName}</td>\r\n+      <td class=\"px-4 py-2\">${item.RoleName}</td>\r\n+      <td class=\"px-4 py-2\">${item.Status}</td>\r\n+      <td class=\"px-4 py-2\">${item.RequestedAt ? new Date(item.RequestedAt).toLocaleString() : \"-\"}</td>\r\n+      <td class=\"px-4 py-2\">${item.ApprovedAt ? new Date(item.ApprovedAt).toLocaleString() : \"<span class='text-red-600'>Not approved</span>\"}</td>\r\n+      <td class=\"px-4 py-2 text-center\">\r\n+        <button class=\"bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700\" onclick=\"viewDetails(${item.RequestID})\">\r\n+          View\r\n+        </button>\r\n+      </td>\r\n+    `;\r\n \r\n-    } catch (e) {\r\n-        console.error(\"Approval Operation Failed:\", e);\r\n-        displayMessage(`Approval failed for ${requestId}: ${e.message}`, true);\r\n-    }\r\n+    membershipTableBody.appendChild(row);\r\n+  });\r\n }\r\n-async function handleRejectClick(requestId) {\r\n-    document.getElementById('actionText').textContent = `Processing Rejection for ${requestId}...`;\r\n-    if (!confirm(`Are you sure you want to REJECT request ${requestId}?`)) return;\r\n \r\n-    try {\r\n-        const resp = await fetch(ENDPOINTS.REJECT_REQUEST(requestId), { // Uses REJECT_REQUEST\r\n-            method: 'PUT', \r\n-            headers: getAuthHeaders(),\r\n-        });\r\n+// =====================\r\n+// POPULATE FILTERS\r\n+// =====================\r\n+function populateFilters(data) {\r\n+  // Clear existing options\r\n+  requestIdFilter.innerHTML = '<option value=\"\">All Request IDs</option>';\r\n+  residentFilter.innerHTML = '<option value=\"\">All Residents</option>';\r\n \r\n-        if (!resp.ok) {\r\n-            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n-            throw new Error(errorData.message || `Rejection failed with status: ${resp.status}`);\r\n-        }\r\n-        \r\n-        document.getElementById('actionText').textContent = `Rejected Request ${requestId}`;\r\n-        displayMessage(`Successfully rejected membership request ${requestId}.`, false);\r\n-        \r\n-        await loadPendingRequests();\r\n-        await loadApprovedResidents();\r\n+  const requestIds = [...new Set(data.map((m) => m.RequestID))];\r\n+  requestIds.forEach((id) => {\r\n+    const opt = document.createElement(\"option\");\r\n+    opt.value = id;\r\n+    opt.textContent = id;\r\n+    requestIdFilter.appendChild(opt);\r\n+  });\r\n \r\n-    } catch (e) {\r\n-        console.error(\"Rejection Operation Failed:\", e);\r\n-        displayMessage(`Rejection failed for ${requestId}: ${e.message}`, true);\r\n-    }\r\n+  const residents = [...new Set(data.map((m) => m.ResidentName))];\r\n+  residents.forEach((name) => {\r\n+    const opt = document.createElement(\"option\");\r\n+    opt.value = name;\r\n+    opt.textContent = name;\r\n+    residentFilter.appendChild(opt);\r\n+  });\r\n }\r\n-async function handleDeleteClick(requestId) {\r\n-    document.getElementById('actionText').textContent = `Processing Deletion for ${requestId}...`;\r\n-    if (!confirm(`Are you sure you want to DELETE request ${requestId}? This action is permanent.`)) return;\r\n \r\n-    try {\r\n-        const resp = await fetch(ENDPOINTS.DELETE_REQUEST(requestId), { // Uses DELETE_REQUEST\r\n-            method: 'DELETE', \r\n-            headers: getAuthHeaders(),\r\n-        });\r\n+// =====================\r\n+// FILTER HANDLER\r\n+// =====================\r\n+function applyFilters() {\r\n+  let filtered = memberships;\r\n \r\n-        if (!resp.ok) {\r\n-            const errorData = await resp.json().catch(() => ({ message: resp.statusText }));\r\n-            throw new Error(errorData.message || `Deletion failed with status: ${resp.status}`);\r\n-        }\r\n-        \r\n-        document.getElementById('actionText').textContent = `Deleted Request ${requestId}`;\r\n-        displayMessage(`Successfully deleted membership request ${requestId}.`, false);\r\n-        \r\n-        await loadPendingRequests();\r\n-        await loadApprovedResidents();\r\n+  if (requestIdFilter.value) {\r\n+    filtered = filtered.filter((m) => m.RequestID == requestIdFilter.value);\r\n+  }\r\n \r\n-    } catch (e) {\r\n-        console.error(\"Deletion Operation Failed:\", e);\r\n-        displayMessage(`Deletion failed for ${requestId}: ${e.message}`, true);\r\n-    }\r\n-}\r\n+  if (residentFilter.value) {\r\n+    filtered = filtered.filter((m) => m.ResidentName === residentFilter.value);\r\n+  }\r\n \r\n-/**\r\n- * Fetches and renders pending membership requests from the backend API.\r\n- */\r\n-async function loadPendingRequests() {\r\n-    // ... existing setup ...\r\n-    // ... existing loading state ...\r\n-    \r\n-    try {\r\n-        // ... existing fetch ...\r\n-        // The API call is now fixed to use the correct /requests/pending endpoint\r\n-        const resp = await fetch(ENDPOINTS.PENDING_REQUESTS, { headers: getAuthHeaders() }); \r\n-        if (!resp.ok) throw new Error(\"Failed to fetch pending requests.\");\r\n-        \r\n-        const requests = await resp.json(); // Data is now the array of pending requests\r\n-        \r\n-        // ... existing table clear and count update ...\r\n-\r\n-        if (requests.length === 0) {\r\n-            // ... existing no requests logic ...\r\n-        } else {\r\n-            noRequestsMsg.classList.add('hidden');\r\n-            requests.forEach(request => {\r\n-                const row = tableBody.insertRow();\r\n-                // ... existing row setup ...\r\n-                \r\n-                const requestedAtString = formatTimestamp(request.RequestedAt || request.requestedAt);\r\n-                const requestId = request.id || request.requestId; // 'id' from new API route, 'requestId' from old logic\r\n-\r\n-                row.innerHTML = `\r\n-                    <td class=\"px-4 py-3\">${requestId}</td>\r\n-                    <td class=\"px-4 py-3 font-medium\">${request.ResidentName || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${request.NationalID || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${request.PhoneNumber || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${request.Email || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${request.HouseNumber || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${request.CourtName || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${request.RoleName || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\"><span class=\"bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full text-xs\">${request.Status || 'Pending'}</span></td>\r\n-                    <td class=\"px-4 py-3\">${requestedAtString}</td>\r\n-                    <td class=\"px-4 py-3 text-center space-x-2 flex\">\r\n-                        <button class=\"approve-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n-                            Approve\r\n-                        </button>\r\n-                        <button class=\"reject-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n-                            Reject\r\n-                        </button>\r\n-                        <button class=\"delete-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs transition duration-150 shadow-md\" data-request-id=\"${requestId}\">\r\n-                            Delete\r\n-                        </button>\r\n-                    </td>\r\n-                `;\r\n-            });\r\n-            \r\n-            // Attach listeners to the new Action buttons\r\n-            tableBody.querySelectorAll('.approve-btn').forEach(button => {\r\n-                button.addEventListener('click', (e) => {\r\n-                    handleApproveClick(e.target.getAttribute('data-request-id'));\r\n-                });\r\n-            });\r\n-            tableBody.querySelectorAll('.reject-btn').forEach(button => { // ðŸ‘ˆ NEW LISTENER\r\n-                button.addEventListener('click', (e) => {\r\n-                    handleRejectClick(e.target.getAttribute('data-request-id'));\r\n-                });\r\n-            });\r\n-            tableBody.querySelectorAll('.delete-btn').forEach(button => { // ðŸ‘ˆ NEW LISTENER\r\n-                button.addEventListener('click', (e) => {\r\n-                    handleDeleteClick(e.target.getAttribute('data-request-id'));\r\n\\ No newline at end of file\n-                });\r\n-            });\r\n-        }\r\n-    } catch (error) {\r\n-        // ... existing error logic ...\r\n-    }\r\n+  statusLabel.textContent = `Filtered: ${filtered.length}`;\r\n+  renderTable(filtered);\r\n }\r\n \r\n-/**\r\n- * Fetches and renders approved residents from the backend API.\r\n- */\r\n-async function loadApprovedResidents() {\r\n-    const tableBody = document.getElementById('residentsTableBody');\r\n-    const noResidentsMsg = document.getElementById('noApprovedResidents');\r\n-    \r\n-    if (!tableBody) return;\r\n+// =====================\r\n+// CLEAR FILTERS\r\n+// =====================\r\n+clearFilterBtn.addEventListener(\"click\", () => {\r\n+  requestIdFilter.value = \"\";\r\n+  residentFilter.value = \"\";\r\n+  statusLabel.textContent = \"All\";\r\n+  renderTable(memberships);\r\n+});\r\n \r\n-    // Show loading state\r\n-    tableBody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center py-4 text-blue-500 italic\">Loading approved residents...</td></tr>';\r\n+// Filter change events\r\n+requestIdFilter.addEventListener(\"change\", applyFilters);\r\n+residentFilter.addEventListener(\"change\", applyFilters);\r\n \r\n-    try {\r\n-        const resp = await fetch(ENDPOINTS.APPROVED_RESIDENTS, { headers: getAuthHeaders() });\r\n-        if (!resp.ok) throw new Error(\"Failed to fetch approved residents.\");\r\n-        \r\n-        const residents = await resp.json();\r\n-\r\n-        tableBody.innerHTML = '';\r\n-        \r\n-        if (residents.length === 0) {\r\n-            noResidentsMsg.classList.remove('hidden');\r\n-        } else {\r\n-            noResidentsMsg.classList.add('hidden');\r\n-            residents.forEach(resident => {\r\n-                const row = tableBody.insertRow();\r\n-                row.className = 'hover:bg-blue-50 transition-colors duration-100';\r\n-                row.innerHTML = `\r\n-                    <td class=\"px-4 py-3 font-medium\">${resident.ResidentName || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${resident.NationalID || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${resident.PhoneNumber || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${resident.Email || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${resident.HouseNumber || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${resident.CourtName || 'N/A'}</td>\r\n-                    <td class=\"px-4 py-3\">${resident.RoleName || 'N/A'}</td>\r\n-                `;\r\n-            });\r\n-        }\r\n-    } catch (error) {\r\n-        console.error(\"Error loading approved residents:\", error);\r\n-        tableBody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center py-4 text-red-500 italic\">Error loading data. Check console for details.</td></tr>';\r\n-        displayMessage(\"Failed to load approved residents from API.\", true);\r\n-    }\r\n+// =====================\r\n+// VIEW DETAILS (example action)\r\n+// =====================\r\n+function viewDetails(requestId) {\r\n+  alert(`Viewing details for RequestID: ${requestId}`);\r\n }\r\n \r\n-\r\n-// ====================================================================\r\n-// INITIALIZATION AND EVENT LISTENERS\r\n-// ====================================================================\r\n-\r\n-function init() {\r\n-    const yearSpan = document.getElementById('year');\r\n-    if (yearSpan) {\r\n-        yearSpan.textContent = new Date().getFullYear();\r\n-    }\r\n-    \r\n-    // Set initial status message\r\n-    document.getElementById('actionText').textContent = `Admin Panel Ready. Attempting to load data...`;\r\n-\r\n-    // Attach listener for the Sync button\r\n-    document.getElementById(\"syncBtn\")?.addEventListener(\"click\", handleSyncClick);\r\n-    \r\n-    // Placeholder for other filters (Clear Filters button)\r\n-    document.getElementById(\"clearFilterBtn\")?.addEventListener(\"click\", () => {\r\n-        document.getElementById('requestIdFilter').value = \"\";\r\n-        document.getElementById('residentFilter').value = \"\";\r\n-        displayMessage(\"Filters cleared (API query filtering needs implementation).\", false);\r\n-    });\r\n-    \r\n-    // Setup Logout\r\n-    document.getElementById(\"logoutBtn\")?.addEventListener(\"click\", () => {\r\n-        // In a real application, clear token and redirect to login page\r\n-        // localStorage.removeItem(\"accessToken\"); \r\n-        displayMessage(\"Logged out successfully (API session cleared).\", false);\r\n-        // window.location.href = \"/login.html\"; \r\n-    });\r\n-    \r\n-    // Load initial data by fetching from the API\r\n-    loadPendingRequests();\r\n-    loadApprovedResidents();\r\n-}\r\n-\r\n-// Ensure the window load handler is used for initialization\r\n-window.addEventListener('load', init);\n+// =====================\r\n+// INITIAL LOAD\r\n+// =====================\r\n+window.addEventListener(\"DOMContentLoaded\", loadMembershipRecords);\r\n"
                },
                {
                    "date": 1763787678319,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -139,4 +139,80 @@\n // =====================\r\n // INITIAL LOAD\r\n // =====================\r\n window.addEventListener(\"DOMContentLoaded\", loadMembershipRecords);\r\n+const pendingTableBody = document.getElementById(\"pendingTableBody\"); // <tbody> in HTML\r\n+const pendingCount = document.getElementById(\"pendingCount\"); // optional badge\r\n+\r\n+async function loadPendingRequests() {\r\n+  try {\r\n+    const res = await fetch(`${API_HOST}/api/admin/residents/pending`, {\r\n+      headers: { Authorization: `Bearer ${token}` },\r\n+    });\r\n+\r\n+    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n+\r\n+    const pendingRequests = await res.json();\r\n+\r\n+    renderPendingTable(pendingRequests);\r\n+    pendingCount.textContent = pendingRequests.length;\r\n+  } catch (err) {\r\n+    console.error(\"Error loading pending requests:\", err);\r\n+    pendingTableBody.innerHTML = `<tr><td colspan=\"10\" class=\"text-center text-red-600\">Failed to load pending requests</td></tr>`;\r\n+  }\r\n+}\r\n+\r\n+function renderPendingTable(data) {\r\n+  pendingTableBody.innerHTML = \"\";\r\n+\r\n+  data.forEach((item) => {\r\n+    const row = document.createElement(\"tr\");\r\n+    row.classList.add(\"border-b\");\r\n+\r\n+    row.innerHTML = `\r\n+      <td class=\"px-4 py-2\">${item.RequestID}</td>\r\n+      <td class=\"px-4 py-2\">${item.ResidentName}</td>\r\n+      <td class=\"px-4 py-2\">${item.NationalID}</td>\r\n+      <td class=\"px-4 py-2\">${item.PhoneNumber}</td>\r\n+      <td class=\"px-4 py-2\">${item.Email}</td>\r\n+      <td class=\"px-4 py-2\">${item.HouseNumber}</td>\r\n+      <td class=\"px-4 py-2\">${item.CourtName}</td>\r\n+      <td class=\"px-4 py-2\">${item.RoleName}</td>\r\n+      <td class=\"px-4 py-2\">${item.Status}</td>\r\n+      <td class=\"px-4 py-2\">${item.RequestedAt ? new Date(item.RequestedAt).toLocaleString() : \"-\"}</td>\r\n+      <td class=\"px-4 py-2 text-center\">\r\n+        <button class=\"bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700\" onclick=\"approveRequest(${item.RequestID})\">\r\n+          Approve\r\n+        </button>\r\n+      </td>\r\n+    `;\r\n+\r\n+    pendingTableBody.appendChild(row);\r\n+  });\r\n+}\r\n+\r\n+// Optional: approve request action\r\n+async function approveRequest(requestId) {\r\n+  if (!confirm(\"Approve this membership request?\")) return;\r\n+\r\n+  try {\r\n+    const res = await fetch(`${API_HOST}/api/admin/residents/approve/${requestId}`, {\r\n+      method: \"PUT\",\r\n+      headers: { Authorization: `Bearer ${token}` },\r\n+    });\r\n+\r\n+    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n+\r\n+    alert(\"Request approved!\");\r\n+    loadPendingRequests();\r\n+    loadMembershipRecords(); // refresh main table\r\n+  } catch (err) {\r\n+    console.error(\"Error approving request:\", err);\r\n+    alert(\"Failed to approve request\");\r\n+  }\r\n+}\r\n+\r\n+// Initial load\r\n+window.addEventListener(\"DOMContentLoaded\", () => {\r\n+  loadMembershipRecords(); // existing memberships\r\n+  loadPendingRequests();   // new pending requests\r\n+});\r\n"
                },
                {
                    "date": 1763825820213,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,218 +1,181 @@\n-// js/membershiprecords.js\r\n-\r\n const membershipTableBody = document.getElementById(\"membershipTableBody\");\r\n+const residentsTableBody = document.getElementById(\"residentsTableBody\");\r\n const membershipCount = document.getElementById(\"membershipCount\");\r\n+const statusLabel = document.getElementById(\"statusLabel\");\r\n+const actionText = document.getElementById(\"actionText\");\r\n const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n const residentFilter = document.getElementById(\"residentFilter\");\r\n const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n-const statusLabel = document.getElementById(\"statusLabel\");\r\n-const actionText = document.getElementById(\"actionText\");\r\n \r\n-const API_HOST = \"http://localhost:4050\"; // your backend host\r\n-const token = localStorage.getItem(\"token\"); // JWT stored in localStorage\r\n+const API_BASE = \"http://localhost:4050/api/membership\";\r\n \r\n-let memberships = [];\r\n-\r\n-// =====================\r\n-// FETCH MEMBERSHIP DATA\r\n-// =====================\r\n-async function loadMembershipRecords() {\r\n+// ======================================\r\n+// Fetch and render membership records\r\n+// ======================================\r\n+async function fetchMembershipRecords() {\r\n   try {\r\n-    actionText.textContent = \"Loading...\";\r\n-    const res = await fetch(`${API_HOST}/api/memberships/records`, {\r\n-      headers: {\r\n-        Authorization: `Bearer ${token}`,\r\n-      },\r\n-    });\r\n-\r\n+    const res = await fetch(API_BASE);\r\n     if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n+    const records = await res.json();\r\n \r\n-    memberships = await res.json();\r\n+    membershipTableBody.innerHTML = \"\";\r\n+    residentsTableBody.innerHTML = \"\";\r\n+    requestIdFilter.innerHTML = '<option value=\"\">All Request IDs</option>';\r\n+    residentFilter.innerHTML = '<option value=\"\">All Residents</option>';\r\n \r\n-    renderTable(memberships);\r\n-    populateFilters(memberships);\r\n-    actionText.textContent = `Last update: ${new Date().toLocaleString()}`;\r\n-    membershipCount.textContent = memberships.length;\r\n-  } catch (err) {\r\n-    console.error(\"Error loading memberships:\", err);\r\n-    actionText.textContent = \"Error loading data\";\r\n-  }\r\n-}\r\n+    records.forEach(record => {\r\n+      // Membership table\r\n+      const tr = document.createElement(\"tr\");\r\n+      tr.classList.add(\"border-b\");\r\n+      tr.innerHTML = `\r\n+        <td class=\"px-4 py-2\">${record.RequestID}</td>\r\n+        <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n+        <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n+        <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n+        <td class=\"px-4 py-2\">${record.Email}</td>\r\n+        <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n+        <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n+        <td class=\"px-4 py-2\">${record.RoleName}</td>\r\n+        <td class=\"px-4 py-2\">${record.Status}</td>\r\n+        <td class=\"px-4 py-2\">${new Date(record.RequestedAt).toLocaleString()}</td>\r\n+        <td class=\"px-4 py-2\">${record.ApprovedAt ? new Date(record.ApprovedAt).toLocaleString() : \"\"}</td>\r\n+        <td class=\"px-4 py-2 text-center\">\r\n+          ${record.Status === \"Pending\" ? `\r\n+            <button onclick=\"approve(${record.RequestID})\" class=\"bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700\">Approve</button>\r\n+            <button onclick=\"reject(${record.RequestID})\" class=\"bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700\">Reject</button>\r\n+          ` : \"â€”\"}\r\n+        </td>\r\n+      `;\r\n+      membershipTableBody.appendChild(tr);\r\n \r\n-// =====================\r\n-// RENDER TABLE\r\n-// =====================\r\n-function renderTable(data) {\r\n-  membershipTableBody.innerHTML = \"\";\r\n+      // Approved residents table\r\n+      if (record.Status === \"Approved\") {\r\n+        const trRes = document.createElement(\"tr\");\r\n+        trRes.classList.add(\"border-b\");\r\n+        trRes.innerHTML = `\r\n+          <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n+          <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n+          <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n+          <td class=\"px-4 py-2\">${record.Email}</td>\r\n+          <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n+          <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n+        `;\r\n+        residentsTableBody.appendChild(trRes);\r\n+      }\r\n \r\n-  data.forEach((item) => {\r\n-    const row = document.createElement(\"tr\");\r\n-    row.classList.add(\"border-b\");\r\n+      // Populate filters\r\n+      const optId = document.createElement(\"option\");\r\n+      optId.value = record.RequestID;\r\n+      optId.textContent = record.RequestID;\r\n+      requestIdFilter.appendChild(optId);\r\n \r\n-    row.innerHTML = `\r\n-      <td class=\"px-4 py-2\">${item.RequestID}</td>\r\n-      <td class=\"px-4 py-2\">${item.ResidentName}</td>\r\n-      <td class=\"px-4 py-2\">${item.NationalID}</td>\r\n-      <td class=\"px-4 py-2\">${item.PhoneNumber}</td>\r\n-      <td class=\"px-4 py-2\">${item.Email}</td>\r\n-      <td class=\"px-4 py-2\">${item.HouseNumber}</td>\r\n-      <td class=\"px-4 py-2\">${item.CourtName}</td>\r\n-      <td class=\"px-4 py-2\">${item.RoleName}</td>\r\n-      <td class=\"px-4 py-2\">${item.Status}</td>\r\n-      <td class=\"px-4 py-2\">${item.RequestedAt ? new Date(item.RequestedAt).toLocaleString() : \"-\"}</td>\r\n-      <td class=\"px-4 py-2\">${item.ApprovedAt ? new Date(item.ApprovedAt).toLocaleString() : \"<span class='text-red-600'>Not approved</span>\"}</td>\r\n-      <td class=\"px-4 py-2 text-center\">\r\n-        <button class=\"bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700\" onclick=\"viewDetails(${item.RequestID})\">\r\n-          View\r\n-        </button>\r\n-      </td>\r\n-    `;\r\n+      const optRes = document.createElement(\"option\");\r\n+      optRes.value = record.ResidentName;\r\n+      optRes.textContent = record.ResidentName;\r\n+      residentFilter.appendChild(optRes);\r\n+    });\r\n \r\n-    membershipTableBody.appendChild(row);\r\n-  });\r\n+    membershipCount.textContent = records.length;\r\n+    actionText.textContent = new Date().toLocaleTimeString();\r\n+  } catch (err) {\r\n+    console.error(\"Error fetching membership records:\", err);\r\n+    document.getElementById(\"msg\").textContent = \"Failed to load membership records.\";\r\n+  }\r\n }\r\n \r\n-// =====================\r\n-// POPULATE FILTERS\r\n-// =====================\r\n-function populateFilters(data) {\r\n-  // Clear existing options\r\n-  requestIdFilter.innerHTML = '<option value=\"\">All Request IDs</option>';\r\n-  residentFilter.innerHTML = '<option value=\"\">All Residents</option>';\r\n-\r\n-  const requestIds = [...new Set(data.map((m) => m.RequestID))];\r\n-  requestIds.forEach((id) => {\r\n-    const opt = document.createElement(\"option\");\r\n-    opt.value = id;\r\n-    opt.textContent = id;\r\n-    requestIdFilter.appendChild(opt);\r\n-  });\r\n-\r\n-  const residents = [...new Set(data.map((m) => m.ResidentName))];\r\n-  residents.forEach((name) => {\r\n-    const opt = document.createElement(\"option\");\r\n-    opt.value = name;\r\n-    opt.textContent = name;\r\n-    residentFilter.appendChild(opt);\r\n-  });\r\n+// ======================================\r\n+// Approve / Reject actions\r\n+// ======================================\r\n+async function approve(requestId) {\r\n+  if (!confirm(`Approve membership request ${requestId}?`)) return;\r\n+  try {\r\n+    await fetch(`${API_BASE}/approve/${requestId}`, { method: \"PUT\" });\r\n+    fetchMembershipRecords();\r\n+  } catch (err) {\r\n+    console.error(\"Error approving request:\", err);\r\n+  }\r\n }\r\n \r\n-// =====================\r\n-// FILTER HANDLER\r\n-// =====================\r\n-function applyFilters() {\r\n-  let filtered = memberships;\r\n-\r\n-  if (requestIdFilter.value) {\r\n-    filtered = filtered.filter((m) => m.RequestID == requestIdFilter.value);\r\n+async function reject(requestId) {\r\n+  if (!confirm(`Reject membership request ${requestId}?`)) return;\r\n+  try {\r\n+    await fetch(`${API_BASE}/reject/${requestId}`, { method: \"PUT\" });\r\n+    fetchMembershipRecords();\r\n+  } catch (err) {\r\n+    console.error(\"Error rejecting request:\", err);\r\n   }\r\n-\r\n-  if (residentFilter.value) {\r\n-    filtered = filtered.filter((m) => m.ResidentName === residentFilter.value);\r\n-  }\r\n-\r\n-  statusLabel.textContent = `Filtered: ${filtered.length}`;\r\n-  renderTable(filtered);\r\n }\r\n \r\n-// =====================\r\n-// CLEAR FILTERS\r\n-// =====================\r\n+// ======================================\r\n+// Filters\r\n+// ======================================\r\n+requestIdFilter.addEventListener(\"change\", applyFilters);\r\n+residentFilter.addEventListener(\"change\", applyFilters);\r\n clearFilterBtn.addEventListener(\"click\", () => {\r\n   requestIdFilter.value = \"\";\r\n   residentFilter.value = \"\";\r\n-  statusLabel.textContent = \"All\";\r\n-  renderTable(memberships);\r\n+  applyFilters();\r\n });\r\n \r\n-// Filter change events\r\n-requestIdFilter.addEventListener(\"change\", applyFilters);\r\n-residentFilter.addEventListener(\"change\", applyFilters);\r\n-\r\n-// =====================\r\n-// VIEW DETAILS (example action)\r\n-// =====================\r\n-function viewDetails(requestId) {\r\n-  alert(`Viewing details for RequestID: ${requestId}`);\r\n-}\r\n-\r\n-// =====================\r\n-// INITIAL LOAD\r\n-// =====================\r\n-window.addEventListener(\"DOMContentLoaded\", loadMembershipRecords);\r\n-const pendingTableBody = document.getElementById(\"pendingTableBody\"); // <tbody> in HTML\r\n-const pendingCount = document.getElementById(\"pendingCount\"); // optional badge\r\n-\r\n-async function loadPendingRequests() {\r\n+async function applyFilters() {\r\n   try {\r\n-    const res = await fetch(`${API_HOST}/api/admin/residents/pending`, {\r\n-      headers: { Authorization: `Bearer ${token}` },\r\n-    });\r\n-\r\n+    const res = await fetch(API_BASE);\r\n     if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n+    let records = await res.json();\r\n \r\n-    const pendingRequests = await res.json();\r\n+    if (requestIdFilter.value)\r\n+      records = records.filter(r => r.RequestID.toString() === requestIdFilter.value);\r\n+    if (residentFilter.value)\r\n+      records = records.filter(r => r.ResidentName === residentFilter.value);\r\n \r\n-    renderPendingTable(pendingRequests);\r\n-    pendingCount.textContent = pendingRequests.length;\r\n-  } catch (err) {\r\n-    console.error(\"Error loading pending requests:\", err);\r\n-    pendingTableBody.innerHTML = `<tr><td colspan=\"10\" class=\"text-center text-red-600\">Failed to load pending requests</td></tr>`;\r\n-  }\r\n-}\r\n+    membershipTableBody.innerHTML = \"\";\r\n+    residentsTableBody.innerHTML = \"\";\r\n \r\n-function renderPendingTable(data) {\r\n-  pendingTableBody.innerHTML = \"\";\r\n+    records.forEach(record => {\r\n+      const tr = document.createElement(\"tr\");\r\n+      tr.classList.add(\"border-b\");\r\n+      tr.innerHTML = `\r\n+        <td class=\"px-4 py-2\">${record.RequestID}</td>\r\n+        <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n+        <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n+        <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n+        <td class=\"px-4 py-2\">${record.Email}</td>\r\n+        <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n+        <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n+        <td class=\"px-4 py-2\">${record.RoleName}</td>\r\n+        <td class=\"px-4 py-2\">${record.Status}</td>\r\n+        <td class=\"px-4 py-2\">${new Date(record.RequestedAt).toLocaleString()}</td>\r\n+        <td class=\"px-4 py-2\">${record.ApprovedAt ? new Date(record.ApprovedAt).toLocaleString() : \"\"}</td>\r\n+        <td class=\"px-4 py-2 text-center\">\r\n+          ${record.Status === \"Pending\" ? `\r\n+            <button onclick=\"approve(${record.RequestID})\" class=\"bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700\">Approve</button>\r\n+            <button onclick=\"reject(${record.RequestID})\" class=\"bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700\">Reject</button>\r\n+          ` : \"â€”\"}\r\n+        </td>\r\n+      `;\r\n+      membershipTableBody.appendChild(tr);\r\n \r\n-  data.forEach((item) => {\r\n-    const row = document.createElement(\"tr\");\r\n-    row.classList.add(\"border-b\");\r\n-\r\n-    row.innerHTML = `\r\n-      <td class=\"px-4 py-2\">${item.RequestID}</td>\r\n-      <td class=\"px-4 py-2\">${item.ResidentName}</td>\r\n-      <td class=\"px-4 py-2\">${item.NationalID}</td>\r\n-      <td class=\"px-4 py-2\">${item.PhoneNumber}</td>\r\n-      <td class=\"px-4 py-2\">${item.Email}</td>\r\n-      <td class=\"px-4 py-2\">${item.HouseNumber}</td>\r\n-      <td class=\"px-4 py-2\">${item.CourtName}</td>\r\n-      <td class=\"px-4 py-2\">${item.RoleName}</td>\r\n-      <td class=\"px-4 py-2\">${item.Status}</td>\r\n-      <td class=\"px-4 py-2\">${item.RequestedAt ? new Date(item.RequestedAt).toLocaleString() : \"-\"}</td>\r\n-      <td class=\"px-4 py-2 text-center\">\r\n-        <button class=\"bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700\" onclick=\"approveRequest(${item.RequestID})\">\r\n-          Approve\r\n-        </button>\r\n-      </td>\r\n-    `;\r\n-\r\n-    pendingTableBody.appendChild(row);\r\n-  });\r\n-}\r\n-\r\n-// Optional: approve request action\r\n-async function approveRequest(requestId) {\r\n-  if (!confirm(\"Approve this membership request?\")) return;\r\n-\r\n-  try {\r\n-    const res = await fetch(`${API_HOST}/api/admin/residents/approve/${requestId}`, {\r\n-      method: \"PUT\",\r\n-      headers: { Authorization: `Bearer ${token}` },\r\n+      if (record.Status === \"Approved\") {\r\n+        const trRes = document.createElement(\"tr\");\r\n+        trRes.classList.add(\"border-b\");\r\n+        trRes.innerHTML = `\r\n+          <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n+          <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n+          <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n+          <td class=\"px-4 py-2\">${record.Email}</td>\r\n+          <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n+          <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n+        `;\r\n+        residentsTableBody.appendChild(trRes);\r\n+      }\r\n     });\r\n-\r\n-    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n-\r\n-    alert(\"Request approved!\");\r\n-    loadPendingRequests();\r\n-    loadMembershipRecords(); // refresh main table\r\n   } catch (err) {\r\n-    console.error(\"Error approving request:\", err);\r\n-    alert(\"Failed to approve request\");\r\n+    console.error(\"Error applying filters:\", err);\r\n   }\r\n }\r\n \r\n-// Initial load\r\n-window.addEventListener(\"DOMContentLoaded\", () => {\r\n-  loadMembershipRecords(); // existing memberships\r\n-  loadPendingRequests();   // new pending requests\r\n-});\r\n+// ======================================\r\n+// Initialize\r\n+// ======================================\r\n+fetchMembershipRecords();\r\n+setInterval(fetchMembershipRecords, 30000); // refresh every 30s\r\n"
                },
                {
                    "date": 1763826440662,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,31 +1,39 @@\n+// ==============================\r\n+// membershiprecords.js\r\n+// ==============================\r\n+\r\n+const API_BASE = \"http://localhost:4050/api/membership\";\r\n+\r\n const membershipTableBody = document.getElementById(\"membershipTableBody\");\r\n const residentsTableBody = document.getElementById(\"residentsTableBody\");\r\n const membershipCount = document.getElementById(\"membershipCount\");\r\n const statusLabel = document.getElementById(\"statusLabel\");\r\n const actionText = document.getElementById(\"actionText\");\r\n const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n const residentFilter = document.getElementById(\"residentFilter\");\r\n const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n+const msgDiv = document.getElementById(\"msg\");\r\n \r\n-const API_BASE = \"http://localhost:4050/api/membership\";\r\n-\r\n-// ======================================\r\n-// Fetch and render membership records\r\n-// ======================================\r\n+// ==============================\r\n+// Fetch all membership records\r\n+// ==============================\r\n async function fetchMembershipRecords() {\r\n   try {\r\n     const res = await fetch(API_BASE);\r\n     if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n     const records = await res.json();\r\n \r\n+    // Reset tables and filters\r\n     membershipTableBody.innerHTML = \"\";\r\n     residentsTableBody.innerHTML = \"\";\r\n     requestIdFilter.innerHTML = '<option value=\"\">All Request IDs</option>';\r\n     residentFilter.innerHTML = '<option value=\"\">All Residents</option>';\r\n \r\n     records.forEach(record => {\r\n-      // Membership table\r\n+      // ------------------------------\r\n+      // Membership Records Table\r\n+      // ------------------------------\r\n       const tr = document.createElement(\"tr\");\r\n       tr.classList.add(\"border-b\");\r\n       tr.innerHTML = `\r\n         <td class=\"px-4 py-2\">${record.RequestID}</td>\r\n@@ -47,9 +55,11 @@\n         </td>\r\n       `;\r\n       membershipTableBody.appendChild(tr);\r\n \r\n-      // Approved residents table\r\n+      // ------------------------------\r\n+      // Approved Residents Table\r\n+      // ------------------------------\r\n       if (record.Status === \"Approved\") {\r\n         const trRes = document.createElement(\"tr\");\r\n         trRes.classList.add(\"border-b\");\r\n         trRes.innerHTML = `\r\n@@ -62,9 +72,11 @@\n         `;\r\n         residentsTableBody.appendChild(trRes);\r\n       }\r\n \r\n-      // Populate filters\r\n+      // ------------------------------\r\n+      // Populate Filters\r\n+      // ------------------------------\r\n       const optId = document.createElement(\"option\");\r\n       optId.value = record.RequestID;\r\n       optId.textContent = record.RequestID;\r\n       requestIdFilter.appendChild(optId);\r\n@@ -76,40 +88,46 @@\n     });\r\n \r\n     membershipCount.textContent = records.length;\r\n     actionText.textContent = new Date().toLocaleTimeString();\r\n+    msgDiv.textContent = \"\";\r\n+\r\n   } catch (err) {\r\n     console.error(\"Error fetching membership records:\", err);\r\n-    document.getElementById(\"msg\").textContent = \"Failed to load membership records.\";\r\n+    msgDiv.textContent = \"âŒ Failed to load membership records.\";\r\n   }\r\n }\r\n \r\n-// ======================================\r\n+// ==============================\r\n // Approve / Reject actions\r\n-// ======================================\r\n+// ==============================\r\n async function approve(requestId) {\r\n   if (!confirm(`Approve membership request ${requestId}?`)) return;\r\n   try {\r\n-    await fetch(`${API_BASE}/approve/${requestId}`, { method: \"PUT\" });\r\n+    const res = await fetch(`${API_BASE}/approve/${requestId}`, { method: \"PUT\" });\r\n+    if (!res.ok) throw new Error(`Failed to approve: ${res.status}`);\r\n     fetchMembershipRecords();\r\n   } catch (err) {\r\n     console.error(\"Error approving request:\", err);\r\n+    alert(\"Error approving request. See console for details.\");\r\n   }\r\n }\r\n \r\n async function reject(requestId) {\r\n   if (!confirm(`Reject membership request ${requestId}?`)) return;\r\n   try {\r\n-    await fetch(`${API_BASE}/reject/${requestId}`, { method: \"PUT\" });\r\n+    const res = await fetch(`${API_BASE}/reject/${requestId}`, { method: \"PUT\" });\r\n+    if (!res.ok) throw new Error(`Failed to reject: ${res.status}`);\r\n     fetchMembershipRecords();\r\n   } catch (err) {\r\n     console.error(\"Error rejecting request:\", err);\r\n+    alert(\"Error rejecting request. See console for details.\");\r\n   }\r\n }\r\n \r\n-// ======================================\r\n+// ==============================\r\n // Filters\r\n-// ======================================\r\n+// ==============================\r\n requestIdFilter.addEventListener(\"change\", applyFilters);\r\n residentFilter.addEventListener(\"change\", applyFilters);\r\n clearFilterBtn.addEventListener(\"click\", () => {\r\n   requestIdFilter.value = \"\";\r\n@@ -131,8 +149,9 @@\n     membershipTableBody.innerHTML = \"\";\r\n     residentsTableBody.innerHTML = \"\";\r\n \r\n     records.forEach(record => {\r\n+      // Membership table\r\n       const tr = document.createElement(\"tr\");\r\n       tr.classList.add(\"border-b\");\r\n       tr.innerHTML = `\r\n         <td class=\"px-4 py-2\">${record.RequestID}</td>\r\n@@ -154,8 +173,9 @@\n         </td>\r\n       `;\r\n       membershipTableBody.appendChild(tr);\r\n \r\n+      // Approved residents\r\n       if (record.Status === \"Approved\") {\r\n         const trRes = document.createElement(\"tr\");\r\n         trRes.classList.add(\"border-b\");\r\n         trRes.innerHTML = `\r\n@@ -168,14 +188,15 @@\n         `;\r\n         residentsTableBody.appendChild(trRes);\r\n       }\r\n     });\r\n+\r\n   } catch (err) {\r\n     console.error(\"Error applying filters:\", err);\r\n   }\r\n }\r\n \r\n-// ======================================\r\n+// ==============================\r\n // Initialize\r\n-// ======================================\r\n+// ==============================\r\n fetchMembershipRecords();\r\n setInterval(fetchMembershipRecords, 30000); // refresh every 30s\r\n"
                },
                {
                    "date": 1763963918551,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,202 +1,158 @@\n-// ==============================\r\n-// membershiprecords.js\r\n-// ==============================\r\n+// js/resident_records.js\r\n \r\n-const API_BASE = \"http://localhost:4050/api/membership\";\r\n+// ========================\r\n+// GLOBAL SETTINGS\r\n+// ========================\r\n+const API_HOST = \"http://localhost:4050\";\r\n+const token = localStorage.getItem(\"token\"); // Assuming token is stored locally\r\n+const RECORDS_ENDPOINT = `${API_HOST}/api/residents/records`;\r\n \r\n-const membershipTableBody = document.getElementById(\"membershipTableBody\");\r\n-const residentsTableBody = document.getElementById(\"residentsTableBody\");\r\n-const membershipCount = document.getElementById(\"membershipCount\");\r\n-const statusLabel = document.getElementById(\"statusLabel\");\r\n-const actionText = document.getElementById(\"actionText\");\r\n-const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n-const residentFilter = document.getElementById(\"residentFilter\");\r\n-const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n-const msgDiv = document.getElementById(\"msg\");\r\n+// Store the full dataset for local filtering\r\n+let allRecords = [];\r\n \r\n-// ==============================\r\n-// Fetch all membership records\r\n-// ==============================\r\n-async function fetchMembershipRecords() {\r\n-  try {\r\n-    const res = await fetch(API_BASE);\r\n-    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n-    const records = await res.json();\r\n+// ========================\r\n+// DATA FETCHING & RENDERING\r\n+// ========================\r\n \r\n-    // Reset tables and filters\r\n-    membershipTableBody.innerHTML = \"\";\r\n-    residentsTableBody.innerHTML = \"\";\r\n-    requestIdFilter.innerHTML = '<option value=\"\">All Request IDs</option>';\r\n-    residentFilter.innerHTML = '<option value=\"\">All Residents</option>';\r\n+/**\r\n+ * Fetches the resident membership records from the API.\r\n+ */\r\n+async function fetchAndRenderRecords() {\r\n+    const tableBody = document.getElementById(\"recordsTableBody\");\r\n+    const recordCountElement = document.getElementById(\"recordCount\");\r\n \r\n-    records.forEach(record => {\r\n-      // ------------------------------\r\n-      // Membership Records Table\r\n-      // ------------------------------\r\n-      const tr = document.createElement(\"tr\");\r\n-      tr.classList.add(\"border-b\");\r\n-      tr.innerHTML = `\r\n-        <td class=\"px-4 py-2\">${record.RequestID}</td>\r\n-        <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n-        <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n-        <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n-        <td class=\"px-4 py-2\">${record.Email}</td>\r\n-        <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n-        <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n-        <td class=\"px-4 py-2\">${record.RoleName}</td>\r\n-        <td class=\"px-4 py-2\">${record.Status}</td>\r\n-        <td class=\"px-4 py-2\">${new Date(record.RequestedAt).toLocaleString()}</td>\r\n-        <td class=\"px-4 py-2\">${record.ApprovedAt ? new Date(record.ApprovedAt).toLocaleString() : \"\"}</td>\r\n-        <td class=\"px-4 py-2 text-center\">\r\n-          ${record.Status === \"Pending\" ? `\r\n-            <button onclick=\"approve(${record.RequestID})\" class=\"bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700\">Approve</button>\r\n-            <button onclick=\"reject(${record.RequestID})\" class=\"bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700\">Reject</button>\r\n-          ` : \"â€”\"}\r\n-        </td>\r\n-      `;\r\n-      membershipTableBody.appendChild(tr);\r\n+    // Show loading state\r\n+    tableBody.innerHTML = '<tr><td colspan=\"8\" class=\"text-center py-4 text-blue-500\">Fetching data...</td></tr>';\r\n \r\n-      // ------------------------------\r\n-      // Approved Residents Table\r\n-      // ------------------------------\r\n-      if (record.Status === \"Approved\") {\r\n-        const trRes = document.createElement(\"tr\");\r\n-        trRes.classList.add(\"border-b\");\r\n-        trRes.innerHTML = `\r\n-          <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n-          <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n-          <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n-          <td class=\"px-4 py-2\">${record.Email}</td>\r\n-          <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n-          <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n-        `;\r\n-        residentsTableBody.appendChild(trRes);\r\n-      }\r\n+    try {\r\n+        const response = await fetch(RECORDS_ENDPOINT, {\r\n+            headers: {\r\n+                \"Authorization\": `Bearer ${token}`,\r\n+                \"Content-Type\": \"application/json\"\r\n+            }\r\n+        });\r\n \r\n-      // ------------------------------\r\n-      // Populate Filters\r\n-      // ------------------------------\r\n-      const optId = document.createElement(\"option\");\r\n-      optId.value = record.RequestID;\r\n-      optId.textContent = record.RequestID;\r\n-      requestIdFilter.appendChild(optId);\r\n+        if (!response.ok) {\r\n+            if (response.status === 401) throw new Error(\"Unauthorized: Please log in again.\");\r\n+            throw new Error(`HTTP error! Status: ${response.status}`);\r\n+        }\r\n \r\n-      const optRes = document.createElement(\"option\");\r\n-      optRes.value = record.ResidentName;\r\n-      optRes.textContent = record.ResidentName;\r\n-      residentFilter.appendChild(optRes);\r\n-    });\r\n+        const data = await response.json();\r\n+        allRecords = data;\r\n+        \r\n+        // Render the full dataset initially\r\n+        renderRecords(allRecords);\r\n \r\n-    membershipCount.textContent = records.length;\r\n-    actionText.textContent = new Date().toLocaleTimeString();\r\n-    msgDiv.textContent = \"\";\r\n-\r\n-  } catch (err) {\r\n-    console.error(\"Error fetching membership records:\", err);\r\n-    msgDiv.textContent = \"âŒ Failed to load membership records.\";\r\n-  }\r\n+    } catch (error) {\r\n+        console.error(\"Failed to fetch resident records:\", error);\r\n+        tableBody.innerHTML = `<tr><td colspan=\"8\" class=\"text-center py-4 text-red-600\">Error loading data: ${error.message}</td></tr>`;\r\n+        recordCountElement.textContent = \"Total Records: 0\";\r\n+    }\r\n }\r\n \r\n-// ==============================\r\n-// Approve / Reject actions\r\n-// ==============================\r\n-async function approve(requestId) {\r\n-  if (!confirm(`Approve membership request ${requestId}?`)) return;\r\n-  try {\r\n-    const res = await fetch(`${API_BASE}/approve/${requestId}`, { method: \"PUT\" });\r\n-    if (!res.ok) throw new Error(`Failed to approve: ${res.status}`);\r\n-    fetchMembershipRecords();\r\n-  } catch (err) {\r\n-    console.error(\"Error approving request:\", err);\r\n-    alert(\"Error approving request. See console for details.\");\r\n-  }\r\n-}\r\n+/**\r\n+ * Renders the provided list of records into the HTML table.\r\n+ * @param {Array} records - The array of record objects to display.\r\n+ */\r\n+function renderRecords(records) {\r\n+    const tableBody = document.getElementById(\"recordsTableBody\");\r\n+    const recordCountElement = document.getElementById(\"recordCount\");\r\n+    tableBody.innerHTML = \"\";\r\n \r\n-async function reject(requestId) {\r\n-  if (!confirm(`Reject membership request ${requestId}?`)) return;\r\n-  try {\r\n-    const res = await fetch(`${API_BASE}/reject/${requestId}`, { method: \"PUT\" });\r\n-    if (!res.ok) throw new Error(`Failed to reject: ${res.status}`);\r\n-    fetchMembershipRecords();\r\n-  } catch (err) {\r\n-    console.error(\"Error rejecting request:\", err);\r\n-    alert(\"Error rejecting request. See console for details.\");\r\n-  }\r\n+    if (records.length === 0) {\r\n+        tableBody.innerHTML = '<tr><td colspan=\"8\" class=\"text-center py-4 text-gray-500\">No records found matching your criteria.</td></tr>';\r\n+    } else {\r\n+        records.forEach(record => {\r\n+            const tr = document.createElement(\"tr\");\r\n+            tr.className = \"hover:bg-gray-50 transition duration-100\";\r\n+\r\n+            // Determine status badge style\r\n+            let statusColor = 'bg-gray-200 text-gray-800';\r\n+            if (record.Status === 'Approved') {\r\n+                statusColor = 'bg-green-100 text-green-700 font-semibold';\r\n+            } else if (record.Status === 'Pending') {\r\n+                statusColor = 'bg-yellow-100 text-yellow-700 font-semibold';\r\n+            } else if (record.Status === 'Rejected') {\r\n+                 statusColor = 'bg-red-100 text-red-700 font-semibold';\r\n+            }\r\n+\r\n+            // Formatting requested date\r\n+            const requestedAt = record.RequestedAt ? new Date(record.RequestedAt).toLocaleString() : 'N/A';\r\n+\r\n+            tr.innerHTML = `\r\n+                <td class=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">${record.ResidentName || 'â€”'}</td>\r\n+                <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${record.NationalID || 'â€”'}</td>\r\n+                <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${record.PhoneNumber || 'â€”'}</td>\r\n+                <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${record.HouseNumber || 'â€”'}</td>\r\n+                <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${record.CourtName || 'â€”'}</td>\r\n+                <td class=\"px-6 py-4 whitespace-nowrap\">\r\n+                    <span class=\"px-2 inline-flex text-xs leading-5 rounded-full ${statusColor}\">\r\n+                        ${record.Status || 'N/A'}\r\n+                    </span>\r\n+                </td>\r\n+                <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${requestedAt}</td>\r\n+                <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${record.Action || 'â€”'}</td>\r\n+            `;\r\n+\r\n+            tableBody.appendChild(tr);\r\n+        });\r\n+    }\r\n+    recordCountElement.textContent = `Total Records: ${records.length}`;\r\n }\r\n \r\n-// ==============================\r\n-// Filters\r\n-// ==============================\r\n-requestIdFilter.addEventListener(\"change\", applyFilters);\r\n-residentFilter.addEventListener(\"change\", applyFilters);\r\n-clearFilterBtn.addEventListener(\"click\", () => {\r\n-  requestIdFilter.value = \"\";\r\n-  residentFilter.value = \"\";\r\n-  applyFilters();\r\n-});\r\n+// ========================\r\n+// FILTERING LOGIC\r\n+// ========================\r\n \r\n-async function applyFilters() {\r\n-  try {\r\n-    const res = await fetch(API_BASE);\r\n-    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);\r\n-    let records = await res.json();\r\n+/**\r\n+ * Applies all current filters to the full dataset and re-renders the table.\r\n+ */\r\n+function applyFilters() {\r\n+    // Get filter values and convert to lower case for case-insensitive comparison\r\n+    const filterName = document.getElementById('filterName').value.toLowerCase();\r\n+    const filterHouse = document.getElementById('filterHouse').value.toLowerCase();\r\n+    const filterCourt = document.getElementById('filterCourt').value.toLowerCase();\r\n+    const filterStatus = document.getElementById('filterStatus').value.toLowerCase();\r\n \r\n-    if (requestIdFilter.value)\r\n-      records = records.filter(r => r.RequestID.toString() === requestIdFilter.value);\r\n-    if (residentFilter.value)\r\n-      records = records.filter(r => r.ResidentName === residentFilter.value);\r\n+    const filteredRecords = allRecords.filter(record => {\r\n+        // Prepare record values safely\r\n+        const name = (record.ResidentName || '').toLowerCase();\r\n+        const house = (record.HouseNumber || '').toLowerCase();\r\n+        const court = (record.CourtName || '').toLowerCase();\r\n+        const status = (record.Status || '').toLowerCase();\r\n \r\n-    membershipTableBody.innerHTML = \"\";\r\n-    residentsTableBody.innerHTML = \"\";\r\n+        // 1. Filter by Name (partial match)\r\n+        if (filterName && !name.includes(filterName)) return false;\r\n \r\n-    records.forEach(record => {\r\n-      // Membership table\r\n-      const tr = document.createElement(\"tr\");\r\n-      tr.classList.add(\"border-b\");\r\n-      tr.innerHTML = `\r\n-        <td class=\"px-4 py-2\">${record.RequestID}</td>\r\n-        <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n-        <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n-        <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n-        <td class=\"px-4 py-2\">${record.Email}</td>\r\n-        <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n-        <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n-        <td class=\"px-4 py-2\">${record.RoleName}</td>\r\n-        <td class=\"px-4 py-2\">${record.Status}</td>\r\n-        <td class=\"px-4 py-2\">${new Date(record.RequestedAt).toLocaleString()}</td>\r\n-        <td class=\"px-4 py-2\">${record.ApprovedAt ? new Date(record.ApprovedAt).toLocaleString() : \"\"}</td>\r\n-        <td class=\"px-4 py-2 text-center\">\r\n-          ${record.Status === \"Pending\" ? `\r\n-            <button onclick=\"approve(${record.RequestID})\" class=\"bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700\">Approve</button>\r\n-            <button onclick=\"reject(${record.RequestID})\" class=\"bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700\">Reject</button>\r\n-          ` : \"â€”\"}\r\n-        </td>\r\n-      `;\r\n-      membershipTableBody.appendChild(tr);\r\n+        // 2. Filter by House Number (partial match)\r\n+        if (filterHouse && !house.includes(filterHouse)) return false;\r\n \r\n-      // Approved residents\r\n-      if (record.Status === \"Approved\") {\r\n-        const trRes = document.createElement(\"tr\");\r\n-        trRes.classList.add(\"border-b\");\r\n-        trRes.innerHTML = `\r\n-          <td class=\"px-4 py-2\">${record.ResidentName}</td>\r\n-          <td class=\"px-4 py-2\">${record.NationalID}</td>\r\n-          <td class=\"px-4 py-2\">${record.PhoneNumber}</td>\r\n-          <td class=\"px-4 py-2\">${record.Email}</td>\r\n-          <td class=\"px-4 py-2\">${record.HouseNumber}</td>\r\n-          <td class=\"px-4 py-2\">${record.CourtName}</td>\r\n-        `;\r\n-        residentsTableBody.appendChild(trRes);\r\n-      }\r\n+        // 3. Filter by Court Name (partial match)\r\n+        if (filterCourt && !court.includes(filterCourt)) return false;\r\n+\r\n+        // 4. Filter by Status (exact match or empty filter)\r\n+        if (filterStatus && status !== filterStatus) return false;\r\n+\r\n+        return true;\r\n     });\r\n \r\n-  } catch (err) {\r\n-    console.error(\"Error applying filters:\", err);\r\n-  }\r\n+    renderRecords(filteredRecords);\r\n }\r\n \r\n-// ==============================\r\n-// Initialize\r\n-// ==============================\r\n-fetchMembershipRecords();\r\n-setInterval(fetchMembershipRecords, 30000); // refresh every 30s\r\n+// ========================\r\n+// INITIALIZATION\r\n+// ========================\r\n+\r\n+document.addEventListener(\"DOMContentLoaded\", () => {\r\n+    // 1. Load data immediately\r\n+    fetchAndRenderRecords();\r\n+\r\n+    // 2. Attach listeners for dynamic filtering (input/keyup/change)\r\n+    document.getElementById('filterName').addEventListener('input', applyFilters);\r\n+    document.getElementById('filterHouse').addEventListener('input', applyFilters);\r\n+    document.getElementById('filterCourt').addEventListener('input', applyFilters);\r\n+    document.getElementById('filterStatus').addEventListener('change', applyFilters);\r\n+    \r\n+    // 3. Attach listener for the refresh button\r\n+    document.getElementById('refreshBtn').addEventListener('click', fetchAndRenderRecords);\r\n+});\n\\ No newline at end of file\n"
                }
            ],
            "date": 1763638727824,
            "name": "Commit-0",
            "content": "console.log(\"ðŸ“˜ membershiprecords.js loaded\");\r\n\r\nconst API_BASE = \"http://localhost:4050/api/membershiprecords\";\r\n\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n    console.log(\"ðŸš€ DOM fully loaded, initializing membership records...\");\r\n\r\n    const token = localStorage.getItem(\"token\");\r\n    const msg = document.getElementById(\"msg\"); // Message display area\r\n\r\n    // Helper to display messages without using alert()\r\n    function displayMessage(text, isError = false) {\r\n        if (msg) {\r\n            msg.textContent = text;\r\n            msg.classList.toggle('text-red-500', isError);\r\n            msg.classList.toggle('text-green-500', !isError && !text.includes('Error'));\r\n            \r\n            // Auto-clear non-error messages after a delay\r\n            if (!isError && !text.includes('Loading')) {\r\n                 setTimeout(() => {\r\n                    msg.classList.remove('text-green-500');\r\n                    // Reset to show total count if no other message is pending\r\n                    if (msg.textContent === text && allRecords.length > 0) { \r\n                        msg.textContent = `Showing ${allRecords.length} total record(s).`;\r\n                    } else if (msg.textContent === text && allRecords.length === 0) {\r\n                        // Check for the specific \"Access Denied\" message before resetting\r\n                        if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n                             msg.textContent = \"No records loaded.\";\r\n                        }\r\n                    }\r\n                }, 5000);\r\n            }\r\n        } else {\r\n            console.log(`[UI Message] ${isError ? 'ERROR: ' : ''}${text}`);\r\n        }\r\n    }\r\n\r\n    if (!token) {\r\n        displayMessage(\"Authentication required. Please log in.\", true);\r\n        return;\r\n    }\r\n    \r\n    // UI Elements\r\n    const membershipCount = document.getElementById(\"membershipCount\");\r\n    const statusLabel = document.getElementById(\"statusLabel\");\r\n    const actionText = document.getElementById(\"actionText\");\r\n    const tableBody = document.getElementById(\"membershipTableBody\");\r\n    const residentsBody = document.getElementById(\"residentsTableBody\");\r\n    const requestIdFilter = document.getElementById(\"requestIdFilter\");\r\n    const residentFilter = document.getElementById(\"residentFilter\");\r\n    const clearFilterBtn = document.getElementById(\"clearFilterBtn\");\r\n    const syncBtn = document.getElementById(\"syncBtn\");\r\n\r\n    let allRecords = [];\r\n    let membershipPage = 1, membershipPerPage = 10;\r\n    let approvedPage = 1, approvedPerPage = 10;\r\n\r\n    // Pagination containers (Ensure they exist)\r\n    let membershipPagination = document.querySelector('.membership-pagination');\r\n    if (!membershipPagination) {\r\n        membershipPagination = document.createElement(\"div\");\r\n        membershipPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-4\", \"membership-pagination\");\r\n        tableBody.parentNode.after(membershipPagination);\r\n    }\r\n\r\n    let approvedPagination = document.querySelector('.approved-pagination');\r\n    if (!approvedPagination) {\r\n        approvedPagination = document.createElement(\"div\");\r\n        approvedPagination.classList.add(\"flex\", \"justify-center\", \"gap-2\", \"mt-2\", \"approved-pagination\");\r\n        residentsBody.parentNode.after(approvedPagination);\r\n    }\r\n\r\n    // ======================================================\r\n    // ðŸ”„ Sync Records\r\n    // ======================================================\r\n    async function syncRecords() {\r\n        // Residents shouldn't see or use this button, but adding a client-side check for robustness\r\n        // The backend should also enforce the 403 on this endpoint.\r\n        // We'll rely on the 403 handling below to block unprivileged users.\r\n        displayMessage(\"Syncing records...\");\r\n        if (syncBtn) syncBtn.disabled = true;\r\n\r\n        try {\r\n            const res = await fetch(`${API_BASE}/sync`, {\r\n                method: \"POST\",\r\n                headers: {\r\n                    \"Authorization\": `Bearer ${token}`,\r\n                    \"Content-Type\": \"application/json\"\r\n                }\r\n            });\r\n\r\n            if (res.status === 403) {\r\n                // Handle expected denial for residents who somehow access the sync button\r\n                throw new Error(\"Access Denied: You do not have permission to sync records.\");\r\n            }\r\n\r\n            const data = await res.json();\r\n            if (!res.ok) {\r\n                // Display server error message (including SQL detail if provided by controller)\r\n                throw new Error(data.message || \"Sync failed on server.\");\r\n            }\r\n\r\n            console.log(\"âœ… Sync success:\", data.message || \"Done\");\r\n            displayMessage(data.message || \"Sync complete.\", false);\r\n\r\n            await loadMembershipRecords(); // Reload data AFTER successful sync\r\n        } catch (err) {\r\n            console.error(\"âŒ Sync failed:\", err);\r\n            displayMessage(`Sync failed: ${err.message}`, true);\r\n        } finally {\r\n            if (syncBtn) syncBtn.disabled = false;\r\n        }\r\n    }\r\n\r\n    // ======================================================\r\n    // ðŸ“¥ Load membership records\r\n    // ======================================================\r\n    async function loadMembershipRecords() {\r\n        displayMessage(\"Loading...\");\r\n\r\n        try {\r\n            // Note: The backend route is /all but the controller is named getAllMembershipRecords.\r\n            const res = await fetch(`${API_BASE}/all`, {\r\n                headers: {\r\n                    \"Authorization\": `Bearer ${token}`,\r\n                    \"Content-Type\": \"application/json\"\r\n                }\r\n            });\r\n\r\n            // --- ðŸ”¥ CRITICAL FIX: Gracefully handle 403 for Resident users ---\r\n            if (res.status === 403) {\r\n                console.warn(\"âš ï¸ Access denied (403). Assuming resident role. Displaying empty dashboard.\");\r\n                allRecords = [];\r\n                applyFilters();\r\n                // Display a status message appropriate for a restricted user\r\n                displayMessage(\"Access Denied: You do not have permission to view all records.\", false);\r\n                return; // Stop processing the response body\r\n            }\r\n            // --- END CRITICAL FIX ---\r\n\r\n\r\n            const data = await res.json();\r\n            if (!res.ok || !data.success) throw new Error(data.message || \"Failed to fetch records.\");\r\n\r\n            // CRITICAL: Use data.records, as set in the controller\r\n            allRecords = Array.isArray(data.records) ? data.records : [];\r\n\r\n            membershipPage = 1;\r\n            approvedPage = 1;\r\n\r\n            applyFilters();\r\n            populateDropdownFilters(allRecords);\r\n            // Display success message only if records were actually loaded (i.e., user is admin)\r\n            displayMessage(`Loaded ${allRecords.length} total record(s).`, false);\r\n\r\n        } catch (err) {\r\n            console.error(\"âŒ Fetch error:\", err);\r\n            displayMessage(`Error loading records: ${err.message}`, true);\r\n        }\r\n    }\r\n\r\n    // Apply dropdown + in-cell filters\r\n    function applyFilters() {\r\n        let filteredRecords = [...allRecords];\r\n\r\n        const selectedId = requestIdFilter?.value || \"\";\r\n        const selectedResident = residentFilter?.value || \"\";\r\n\r\n        if (selectedId) filteredRecords = filteredRecords.filter(r => String(r.RequestID) === selectedId);\r\n        if (selectedResident) filteredRecords = filteredRecords.filter(r => r.ResidentName === selectedResident);\r\n\r\n        const filterInputs = document.querySelectorAll(\".header-filter\");\r\n        const filters = {};\r\n        filterInputs.forEach(f => {\r\n            if (f.value.trim() !== \"\") filters[f.dataset.column] = f.value.trim().toLowerCase();\r\n        });\r\n\r\n        filteredRecords = filteredRecords.filter(record => {\r\n            return Object.entries(filters).every(([key, val]) => {\r\n                const field = record[key] ? String(record[key]).toLowerCase() : \"\";\r\n                return field.includes(val);\r\n            });\r\n        });\r\n\r\n        renderMembershipTable(filteredRecords);\r\n        renderMembershipPagination(filteredRecords);\r\n\r\n        const approvedRecords = filteredRecords.filter(r => r.Status === \"Approved\");\r\n        renderApprovedTable(approvedRecords);\r\n        renderApprovedPagination(approvedRecords);\r\n    }\r\n    \r\n    // Render Membership Table (updated button states)\r\n    function renderMembershipTable(records) {\r\n        tableBody.innerHTML = \"\";\r\n        if (!records.length) {\r\n            updateUIStats([]);\r\n            updateApprovedCount([]);\r\n            // Display a message if the table is empty due to filters\r\n            if (allRecords.length > 0) {\r\n                 msg.textContent = \"No matching records found.\";\r\n            } else if (msg.textContent !== \"Access Denied: You do not have permission to view all records.\") {\r\n                 msg.textContent = \"No records loaded.\";\r\n            }\r\n            return;\r\n        }\r\n\r\n        const start = (membershipPage - 1) * membershipPerPage;\r\n        const end = start + membershipPerPage;\r\n        const pageRecords = records.slice(start, end);\r\n\r\n        pageRecords.forEach(r => {\r\n            const isApproved = r.Status === 'Approved';\r\n            const isRejected = r.Status === 'Rejected';\r\n            const row = document.createElement(\"tr\");\r\n            row.innerHTML = `\r\n                <td>${r.RequestID || \"-\"}</td>\r\n                <td>${r.ResidentName || \"-\"}</td>\r\n                <td>${r.NationalID || \"-\"}</td>\r\n                <td>${r.PhoneNumber || \"-\"}</td>\r\n                <td>${r.Email || \"-\"}</td>\r\n                <td>${r.HouseNumber || \"-\"}</td>\r\n                <td>${r.CourtName || \"-\"}</td>\r\n                <td>${r.RoleName || \"-\"}</td>\r\n                <td class=\"${isApproved ? 'text-green-600' : isRejected ? 'text-red-600' : 'text-yellow-600'} font-semibold\">${r.Status || \"-\"}</td>\r\n                <td>${r.RequestedAt ? new Date(r.RequestedAt).toLocaleString() : \"-\"}</td>\r\n                <td class=\"text-center\">\r\n                    <button class=\"approveBtn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Approve</button>\r\n                    <button class=\"rejectBtn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-1 ${isApproved || isRejected ? 'opacity-50 cursor-not-allowed' : ''}\" data-id=\"${r.RequestID}\" ${isApproved || isRejected ? 'disabled' : ''}>Reject</button>\r\n                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n                </td>\r\n            `;\r\n            tableBody.appendChild(row);\r\n        });\r\n\r\n        updateUIStats(records);\r\n    }\r\n\r\n    // Approved table (unchanged)\r\n    function renderApprovedTable(records) {\r\n        residentsBody.innerHTML = \"\";\r\n        if (!records.length) {\r\n            updateApprovedCount([]);\r\n            return;\r\n        }\r\n\r\n        const start = (approvedPage - 1) * approvedPerPage;\r\n        const end = start + approvedPerPage;\r\n        const pageRecords = records.slice(start, end);\r\n\r\n        pageRecords.forEach(r => {\r\n            const row = document.createElement(\"tr\");\r\n            row.innerHTML = `\r\n                <td>${r.ResidentName}</td>\r\n                <td>${r.NationalID}</td>\r\n                <td>${r.PhoneNumber}</td>\r\n                <td>${r.Email}</td>\r\n                <td>${r.HouseNumber}</td>\r\n                <td>${r.CourtName}</td>\r\n                <td>${r.RoleName}</td>\r\n                <td class=\"text-center\">\r\n                    <button class=\"deleteBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded\" data-id=\"${r.RequestID}\">Delete</button>\r\n                </td>\r\n            `;\r\n            residentsBody.appendChild(row);\r\n        });\r\n\r\n        updateApprovedCount(records);\r\n    }\r\n\r\n    // UI Stats (unchanged)\r\n    function updateUIStats(records) {\r\n        membershipCount.textContent = records.length;\r\n\r\n        const approved = records.filter(r => r.Status === \"Approved\").length;\r\n        const pending = records.filter(r => r.Status === \"Pending\").length;\r\n        const rejected = records.filter(r => r.Status === \"Rejected\").length;\r\n\r\n        statusLabel.textContent = `Approved: ${approved} | Pending: ${pending} | Rejected: ${rejected}`;\r\n\r\n        const latest = records[0]?.RequestedAt ? new Date(records[0].RequestedAt).toLocaleString() : \"N/A\";\r\n        actionText.textContent = latest;\r\n    }\r\n\r\n    function updateApprovedCount(records) {\r\n        const approvedCountEl = document.getElementById(\"approvedCount\");\r\n        if (approvedCountEl) approvedCountEl.textContent = records.length;\r\n    }\r\n\r\n    // Pagination (unchanged)\r\n    function renderMembershipPagination(records) {\r\n        membershipPagination.innerHTML = \"\";\r\n        const pageCount = Math.ceil(records.length / membershipPerPage);\r\n        if (pageCount <= 1) return;\r\n\r\n        for (let i = 1; i <= pageCount; i++) {\r\n            const btn = document.createElement(\"button\");\r\n            btn.textContent = i;\r\n            btn.className = `px-3 py-1 border rounded ${i === membershipPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n            btn.addEventListener(\"click\", () => {\r\n                membershipPage = i;\r\n                renderMembershipTable(records);\r\n                renderMembershipPagination(records);\r\n            });\r\n            membershipPagination.appendChild(btn);\r\n        }\r\n    }\r\n\r\n    function renderApprovedPagination(records) {\r\n        approvedPagination.innerHTML = \"\";\r\n        const pageCount = Math.ceil(records.length / approvedPerPage);\r\n        if (pageCount <= 1) return;\r\n\r\n        for (let i = 1; i <= pageCount; i++) {\r\n            const btn = document.createElement(\"button\");\r\n            btn.textContent = i;\r\n            btn.className = `px-3 py-1 border rounded ${i === approvedPage ? 'bg-blue-500 text-white' : 'hover:bg-blue-200'}`;\r\n            btn.addEventListener(\"click\", () => {\r\n                approvedPage = i;\r\n                renderApprovedTable(records);\r\n                renderApprovedPagination(records);\r\n            });\r\n            approvedPagination.appendChild(btn);\r\n        }\r\n    }\r\n\r\n    function populateDropdownFilters(records) {\r\n        if (requestIdFilter) {\r\n            const ids = [...new Set(records.map(r => r.RequestID))].filter(id => id !== undefined && id !== null);\r\n            requestIdFilter.innerHTML =\r\n                `<option value=\"\">All Request IDs</option>` +\r\n                ids.map(id => `<option value=\"${id}\">${id}</option>`).join(\"\");\r\n        }\r\n\r\n        if (residentFilter) {\r\n            const names = [...new Set(records.map(r => r.ResidentName))].filter(n => n);\r\n            residentFilter.innerHTML =\r\n                `<option value=\"\">All Residents</option>` +\r\n                names.map(n => `<option value=\"${n}\">${n}</option>`).join(\"\");\r\n        }\r\n    }\r\n\r\n\r\n    // Actions\r\n    document.addEventListener(\"click\", async (e) => {\r\n        const btn = e.target;\r\n        const id = btn.dataset.id;\r\n        if (!id || btn.disabled) return;\r\n\r\n        let action = \"\";\r\n        if (btn.classList.contains(\"approveBtn\")) action = \"approve\";\r\n        else if (btn.classList.contains(\"rejectBtn\")) action = \"reject\";\r\n        else if (btn.classList.contains(\"deleteBtn\")) {\r\n            // NOTE: Using window.confirm as per guidance to avoid browser alert() errors, \r\n            // but this should be replaced by a custom modal in a full application.\r\n            if (!window.confirm(\"Are you sure you want to delete this record? This will remove it from both requests and records.\")) return; \r\n            action = \"delete\";\r\n        }\r\n        if (!action) return;\r\n\r\n        displayMessage(`Processing ${action} for Request ID ${id}...`);\r\n\r\n        try {\r\n            // Approve/Reject use PATCH, Delete uses DELETE\r\n            const method = action === \"delete\" ? \"DELETE\" : \"PATCH\"; \r\n            const res = await fetch(`${API_BASE}/${action}/${id}`, {\r\n                method,\r\n                headers: {\r\n                    \"Authorization\": `Bearer ${token}`,\r\n                    \"Content-Type\": \"application/json\"\r\n                }\r\n            });\r\n            \r\n            // Check for 403 on specific actions (Approve/Reject/Delete)\r\n            if (res.status === 403) {\r\n                 throw new Error(\"Access Denied: You do not have permission for this action.\");\r\n            }\r\n\r\n            const data = await res.json();\r\n            if (!data.success) {\r\n                console.error(\"Action failed:\", data.message);\r\n                // Display the specific server error message\r\n                displayMessage(`Action failed: ${data.message}`, true);\r\n                return;\r\n            }\r\n\r\n            displayMessage(data.message || `${action} action completed successfully.`);\r\n            await loadMembershipRecords(); // Reload after action\r\n        } catch (err) {\r\n            console.error(\"âŒ Action error:\", err);\r\n            displayMessage(`Action failed due to network error: ${err.message}`, true);\r\n        }\r\n    });\r\n\r\n    // Filters and Sync Button Listener\r\n    requestIdFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n    residentFilter?.addEventListener(\"change\", () => { membershipPage = 1; approvedPage = 1; applyFilters(); });\r\n\r\n    clearFilterBtn?.addEventListener(\"click\", () => {\r\n        requestIdFilter.value = \"\";\r\n        residentFilter.value = \"\";\r\n        document.querySelectorAll(\".header-filter\").forEach(f => (f.value = \"\"));\r\n        membershipPage = 1;\r\n        approvedPage = 1;\r\n        applyFilters();\r\n    });\r\n\r\n    document.querySelectorAll(\".header-filter\").forEach(input =>\r\n        input.addEventListener(\"input\", () => {\r\n            membershipPage = 1;\r\n            approvedPage = 1;\r\n            applyFilters();\r\n        })\r\n    );\r\n\r\n    // ======================================================\r\n    // ðŸ”„ Sync button â€” calls syncRecords() only\r\n    // ======================================================\r\n    syncBtn?.addEventListener(\"click\", () => {\r\n        syncRecords();\r\n    });\r\n\r\n    // ======================================================\r\n    // INITIAL LOAD â€” Fetch records only\r\n    // ======================================================\r\n    await loadMembershipRecords();\r\n});\r\nasync function loadMembershipRecords() {\r\n    try {\r\n        const res = await fetch(\"http://localhost:4050/api/admin/memberships\", {\r\n            headers: { \"Authorization\": `Bearer ${token}` }\r\n        });\r\n        if (!res.ok) throw new Error(`API Error: ${res.status}`);\r\n        const members = await res.json();\r\n\r\n        const container = document.getElementById(\"dynamic-section-content\");\r\n        if (!container) return;\r\n\r\n        if (members.length === 0) {\r\n            container.innerHTML = \"<p class='text-gray-500 text-center'>No membership records found.</p>\";\r\n            return;\r\n        }\r\n\r\n        let html = `<ul class=\"space-y-2\">`;\r\n        members.forEach(m => {\r\n            if (m.Status === \"Approved\") {\r\n                html += `<li class=\"bg-white shadow-md rounded-lg p-4 flex justify-between items-center\">\r\n                            <div>\r\n                                <p class=\"font-semibold\">${m.ResidentName}</p>\r\n                                <p class=\"text-sm text-gray-500\">${m.NationalID} | ${m.HouseNumber} - ${m.CourtName}</p>\r\n                            </div>\r\n                          </li>`;\r\n            }\r\n        });\r\n        html += `</ul>`;\r\n        container.innerHTML = html;\r\n\r\n    } catch (err) {\r\n        console.error(\"Error loading membership records:\", err);\r\n    }\r\n}\r\n"
        }
    ]
}